"use strict";(()=>{var se=Object.create;var Y=Object.defineProperty;var ie=Object.getOwnPropertyDescriptor;var oe=Object.getOwnPropertyNames;var ne=Object.getPrototypeOf,ae=Object.prototype.hasOwnProperty;var U=(l,e)=>()=>(l&&(e=l(l=0)),e);var J=(l,e)=>()=>(e||l((e={exports:{}}).exports,e),e.exports);var re=(l,e,s,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of oe(e))!ae.call(l,i)&&i!==s&&Y(l,i,{get:()=>e[i],enumerable:!(t=ie(e,i))||t.enumerable});return l};var K=(l,e,s)=>(s=l!=null?se(ne(l)):{},re(e||!l||!l.__esModule?Y(s,"default",{value:l,enumerable:!0}):s,l));var b,E,D=U(()=>{"use strict";b="0.0.2.5",E=[]});async function B(){let l="mlmap:cache:checkLatestVersion",s=Date.now(),t=localStorage.getItem(l),i=null;if(t)try{i=JSON.parse(t)}catch{}if(i&&s-i.timestamp<3e5)return{current:b,latest:i.latest,requireUpdate:i.latest!==b};let o=new AbortController,y=setTimeout(()=>o.abort(),5e3);try{let c=await fetch("https://raw.githubusercontent.com/FJRG2007/mlmap/refs/heads/main/package.json",{signal:o.signal});clearTimeout(y);let d=await c.json();return i={latest:d.version,timestamp:s},localStorage.setItem(l,JSON.stringify(i)),{current:b,latest:d.version,requireUpdate:d.version!==b}}catch{return{current:b,latest:i?.latest||b,requireUpdate:!1}}}var A=U(()=>{"use strict";D()});var z=J(()=>{"use strict";A();document.addEventListener("DOMContentLoaded",async()=>{let l=await B();console.log(`Current version: ${l.current}`),console.log(`Latest version: ${l.latest}`),l.requireUpdate&&console.log("A new version is available!")})});var V=J(()=>{"use strict";var ge=K(z())});var ke=K(V());function N(l,e,s=[]){let t=0,i=0,o=0,a=100,y;do{y=!1,t=Math.random()*(window.innerWidth-l),i=Math.random()*(window.innerHeight-e);for(let c of s){let d=[Math.min(...c.targetPoints.map(h=>h[0])),Math.min(...c.targetPoints.map(h=>h[1])),Math.max(...c.targetPoints.map(h=>h[0])),Math.max(...c.targetPoints.map(h=>h[1]))];if(!(t+l<d[0]||t>d[2]||i+e<d[1]||i>d[3])){y=!0;break}}o++}while(y&&o<a);return[t,i]}function P(l){return l.map(e=>e.slice(0,2))}function O(l,e,s,t){return Math.hypot(s-l,t-e)}var F=(()=>{function l(c,d,h,p){if(h===d.length-1)return p(c);let u,g=d[h],x=Array(g);for(u=g-1;u>=0;--u)x[u]=l(c[u],d,h+1,p);return x}function e(c){let d=[];for(;typeof c=="object";)d.push(c.length),c=c[0];return d}function s(c){let d,h;return typeof c=="object"?(d=c[0],typeof d=="object"?(h=d[0],typeof h=="object"?e(c):[c.length,d.length]):[c.length]):[]}function t(c){let d,h=c.length,p=Array(h);for(d=h-1;d>=0;--d)p[d]=c[d];return p}function i(c){return typeof c!="object"?c:l(c,s(c),0,t)}function o(c,d){d=d||!1;let h,p,u,g,x,v,L,m,S,T=c.length,M=T-1,$=new Array(T);for(d||(c=i(c)),u=0;u<T;++u){for(L=u,v=c[u],S=y(v[u]),p=u+1;p<T;++p)g=y(c[p][u]),g>S&&(S=g,L=p);for($[u]=L,L!=u&&(c[u]=c[L],c[L]=v,v=c[u]),x=v[u],h=u+1;h<T;++h)c[h][u]/=x;for(h=u+1;h<T;++h){for(m=c[h],p=u+1;p<M;++p)m[p]-=m[u]*v[p],++p,m[p]-=m[u]*v[p];p===M&&(m[p]-=m[u]*v[p])}}return{LU:c,P:$}}function a(c,d){let h,p,u,g,x,v=c.LU,L=v.length,m=i(d),S=c.P;for(h=L-1;h>=0;--h)m[h]=d[h];for(h=0;h<L;++h)for(u=S[h],S[h]!==h&&(x=m[h],m[h]=m[u],m[u]=x),g=v[h],p=0;p<h;++p)m[h]-=m[p]*g[p];for(h=L-1;h>=0;--h){for(g=v[h],p=h+1;p<L;++p)m[h]-=m[p]*g[p];m[h]/=g[h]}return m}let y=Math.abs;return function(c,d,h){return a(o(c,h),d)}})();function I(l){localStorage.setItem(`mlmap:workspace<${l.id}>`,JSON.stringify(l))}function X(l){let e=localStorage.getItem("mlmap:currentWorkspaceId");if(!e){e=Date.now().toString(),localStorage.setItem("mlmap:currentWorkspaceId",e);let t={id:e,name:"New Workspace",version:"1.0",layout:{}};return localStorage.setItem(`mlmap:workspace<${e}>`,JSON.stringify(t)),t}let s=localStorage.getItem(`mlmap:workspace<${l||e}>`);return s?JSON.parse(s):null}function _(l){localStorage.removeItem(`mlmap:workspace<${l}>`)}function G(l){let e=`mlmap:workspace<${l}>`,s=JSON.parse(localStorage.getItem(e)||`{id:"${l}",name:"Reset Workspace",version:"1.0",layout:{}`);localStorage.setItem(e,JSON.stringify({id:l,name:s?.name,version:"1.0",layout:{}}))}function Q(){let l=[];for(let e=0;e<localStorage.length;e++){let s=localStorage.key(e);if(s&&s.startsWith("mlmap:workspace<")){let t=localStorage.getItem(s);t&&l.push(JSON.parse(t))}}return l}D();A();function ee(l){let e=document.createElement("div");e.id="controls";let s=b;e.innerHTML=`
    <div style="display:flex; justify-content:space-between; align-items:center;">
  <strong>Controls</strong>
  <button id="closeHelp" style="background:#808080;color:white;border:none;padding:2px 6px;cursor:pointer;">X</button>
</div>
<pre style="margin-top:5px;">
SHIFT-Space: Toggle edit mode

In Edit Mode

click / drag:       select and move quads/corner points
SHIFT + drag:       move selected quad/corner point with 10x precision
ALT + drag:         rotate/scale selected quad
Arrow keys:         move selected quad/corner point
SHIFT + Arrow keys: move selected quad/corner point by 10 pixels
ALT + Arrow keys:   rotate/scale selected quad
's':                Solo/unsolo selected quad
'c':                Toggle mouse cursor crosshairs
'r':                Rotate selected layer 90 degrees clock-wise
'h':                Flip selected layer horizontally
'v':                Flip selected layer vertically
'b':                Show/Hide projector bounds
'l':                Show/Hide layer labels
'\u232B'/'Del':         Delete selected layer

MLMap | v${b} ${s!==b?` (update to v${s})`:""}
</pre>
    `,Object.assign(e.style,{position:"fixed",top:"20px",left:"50%",transform:"translateX(-50%)",width:"600px",background:"#404040",color:"white",fontFamily:"monospace",padding:"10px",border:"2px solid #808080",zIndex:"1000001",cursor:"move",display:"none",userSelect:"none"}),document.body.appendChild(e),B().then(r=>{if(r.latest!==b){let n=e.querySelector("pre");n&&(n.innerHTML=n.innerHTML.replace(`v${b}`,`v${b} (update to v${r.latest})`))}}),document.getElementById("closeHelp")?.addEventListener("click",()=>{e.style.display="none"});let t=document.createElement("div");t.id="shapePanel",Object.assign(t.style,{position:"fixed",top:"10px",right:"10px",width:"200px",background:"#303030",color:"white",fontFamily:"monospace",padding:"10px",border:"2px solid #808080",zIndex:"1000002",cursor:"move",display:"none",userSelect:"none"}),t.innerHTML=`
    <strong>Shapes</strong>
    <div id="shapeList"></div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: 5px;">
        <button id="addSquare">Add Square</button>
        <button id="addCircle">Add Circle</button>
        <button id="addTriangle">Add Triangle</button>
    </div>
    <hr>
    <strong>Workspaces</strong>
    <select id="workspaceSelector" style="width:100%;margin-top:5px;"></select>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: 5px;">
        <button id="addWorkspace" title="Add Workspace" aria-label="Add Workspace">\u{1F195}</button>
        <button id="duplicateWorkspace" title="Duplicate Workspace" aria-label="Duplicate Workspace">\u{1F4CB}</button>
        <button id="renameWorkspace" title="Rename Workspace" aria-label="Rename Workspace">\u270F\uFE0F</button>
        <button id="resetWorkspace" title="Reset Workspace" aria-label="Reset Workspace">\u{1F9F9}</button>
        <button id="deleteWorkspace" title="Delete Workspace" aria-label="Delete Workspace">\u{1F5D1}\uFE0F</button>
    </div>
    `,document.body.appendChild(t);let i=!1,o=!1,a=0,y=0;e.addEventListener("mousedown",function(r){r?.target?.id!=="closeHelp"&&(i=!0,a=r.clientX-e.offsetLeft,y=r.clientY-e.offsetTop)}),t.addEventListener("mousedown",function(r){o=!0,a=r.clientX-t.offsetLeft,y=r.clientY-t.offsetTop}),document.addEventListener("mousemove",function(r){i&&(e.style.left=r.clientX-a+"px",e.style.top=r.clientY-y+"px",e.style.transform=""),o&&(t.style.left=r.clientX-a+"px",t.style.top=r.clientY-y+"px",t.style.transform="")}),document.addEventListener("mouseup",function(){i=!1,o=!1});let c=document.getElementById("shapeList"),d=document.getElementById("addSquare"),h=document.getElementById("addCircle"),p=document.getElementById("addTriangle"),u=new WeakMap,g=[];function x(r){let n=document.createElement("div");n.id=`shape_${Date.now()}`;let[k,W]=N(100,100);n.style.position="fixed",n.style.top=W+"px",n.style.left=k+"px",n.style.width="100px",n.style.height="100px",n.style.background=r==="triangle"?"transparent":"white",n.style.border=r==="triangle"?"2px solid white":"none",r==="circle"&&(n.style.borderRadius="50%"),r==="triangle"&&(n.style.width="0",n.style.height="0",n.style.borderLeft="50px solid transparent",n.style.borderRight="50px solid transparent",n.style.borderBottom="100px solid white",l.addLayer(n,P([[50,0],[100,100],[0,100],[50,100]]))),document.body.appendChild(n),l.addLayer(n),g.push({id:n.id,type:r,x:k,y:W}),v(),m()}function v(){c.innerHTML="",g.forEach(r=>{let n=document.createElement("div");n.style.display="flex",n.style.justifyContent="space-between",n.style.marginBottom="4px",n.innerHTML=`${r.type} <button data-id="${r.id}">Delete</button>`,c.appendChild(n),n.querySelector("button")?.addEventListener("click",()=>L(r.id))})}function L(r){let n=g.findIndex(k=>k.id===r);if(n!==-1){let k=document.getElementById(r);k&&k.remove(),g.splice(n,1),v(),m()}}function m(){localStorage.setItem("mlmap.dynamicShapes",JSON.stringify(g))}function S(){let r=localStorage.getItem("mlmap.dynamicShapes");r&&(g=JSON.parse(r),g.forEach(n=>T(n)),v())}function T(r){let n=document.createElement("div");n.id=r.id;let k=r.x??Math.random()*(window.innerWidth-100),W=r.y??Math.random()*(window.innerHeight-100);n.style.position="fixed",n.style.top=W+"px",n.style.left=k+"px",n.style.width="100px",n.style.height="100px",n.style.background=r.type==="triangle"?"transparent":"white",n.style.border=r.type==="triangle"?"2px solid white":"none",r.type==="circle"&&(n.style.borderRadius="50%"),r.type==="triangle"&&(n.style.width="0",n.style.height="0",n.style.borderLeft="50px solid transparent",n.style.borderRight="50px solid transparent",n.style.borderBottom="100px solid white"),document.body.appendChild(n),l.addLayer(n)}d.addEventListener("click",()=>x("square")),h.addEventListener("click",()=>x("circle")),p.addEventListener("click",()=>x("triangle")),document.addEventListener("keydown",r=>{r.shiftKey&&r.code==="Space"&&(r.preventDefault(),e.style.display=e.style.display==="none"?"block":"none",t.style.display=t.style.display==="none"?"block":"none")});let M=l.setConfigEnabled;l.setConfigEnabled=function(r){M(r),t.style.display=r?"block":"none"},S(),new MutationObserver(r=>{for(let n of r)n.type==="childList"&&n.removedNodes.length>0&&n.removedNodes.forEach(k=>{if(k instanceof HTMLElement){let W=g.findIndex(te=>te.id===k.id);W!==-1&&(g.splice(W,1),v(),m())}})}).observe(document.body,{childList:!0,subtree:!0});let H=t.querySelector("#workspaceSelector"),w=Q(),f=w.find(r=>r.id===localStorage.getItem("mlmap:currentWorkspaceId"))||null;!f&&w.length&&(f=w[0],localStorage.setItem("mlmap:currentWorkspaceId",f.id)),f&&l.setLayout(f.layout),w.length===1&&(document.getElementById("deleteWorkspace").disabled=!0);function C(){H.innerHTML="",w.forEach(r=>{let n=document.createElement("option");n.value=r.id,n.textContent=r.name,f&&f.id===r.id&&(n.selected=!0),H.appendChild(n)})}function q(r){localStorage.setItem("mlmap:currentWorkspaceId",r.id),window.location.reload()}document.getElementById("addWorkspace")?.addEventListener("click",()=>{let r=prompt("Workspace name:","New Workspace")||"New Workspace",n={id:Date.now().toString(),name:r,version:"1.0",layout:{}};w.push(n),I(n),q(n)}),document.getElementById("duplicateWorkspace")?.addEventListener("click",()=>{if(!f)return;let r=prompt("New name:",f.name+" (Copy)")||f.name+" (Copy)",n={id:Date.now().toString(),name:r,version:"1.0",layout:{}};w.push(n),I(n),q(n),C()}),document.getElementById("renameWorkspace")?.addEventListener("click",()=>{if(!f)return;let r=prompt("New name:",f.name)||f.name;f.name=r,I(f),C()}),document.getElementById("resetWorkspace")?.addEventListener("click",()=>{f&&(G(f.id),window.location.reload(),C())}),document.getElementById("deleteWorkspace")?.addEventListener("click",()=>{!f||w.length===1||(w.length===1&&(document.getElementById("deleteWorkspace").disabled=!0),_(f.id),w=w.filter(r=>r.id!==f?.id),f=w[0]||null,f&&l.setLayout(f.layout),C())}),H.addEventListener("change",()=>{let r=w.find(n=>n.id===H.value);r&&q(r)}),C(),l.layoutChangeListener=()=>{f&&(f.layout=l.getLayout(),I(f))}}D();var R=class{constructor(e={}){this.layers=[];this.configActive=!1;this.dragging=!1;this.dragOffset=[0,0];this.selectedLayer=null;this.selectedPoint=null;this.selectionRadius=20;this.hoveringPoint=null;this.hoveringLayer=null;this.isLayerSoloed=!1;this.mousePosition=[0,0];this.mouseDelta=[0,0];this.mouseDownPoint=[0,0];this.keyDown=this.keyDown.bind(this),this.setConfigEnabled=this.setConfigEnabled.bind(this),this.showLayerNames=this.getProp(e,"labels",!0),this.showCrosshairs=this.getProp(e,"crosshairs",!1),this.showScreenBounds=this.getProp(e,"screenbounds",!1),this.autoSave=this.getProp(e,"autoSave",!0),this.autoLoad=this.getProp(e,"autoLoad",!0),this.layerList=this.getProp(e,"layers",[]),this.layoutChangeListener=this.getProp(e,"onchange",()=>{}),this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.initCanvas(),this.loadSettings();for(let t of this.layerList)(t instanceof HTMLElement||typeof t=="string")&&this.addLayer(t);this.autoLoad&&this.loadSettings(),this.pushHistory(),new MutationObserver(t=>{t.forEach(i=>{i.removedNodes.forEach(o=>{this.layers.forEach((a,y)=>{a.element===o&&(a.overlay&&a.overlay.remove(),this.layers.splice(y,1))})})})}).observe(document.body,{childList:!0,subtree:!0})}getProp(e,s,t){return e&&e.hasOwnProperty(s)&&e[s]!==null?e[s]:t}initCanvas(){this.canvas.style.display="none",this.canvas.style.position="fixed",this.canvas.style.top="0px",this.canvas.style.left="0px",this.canvas.style.zIndex="1000000",this.context=this.canvas.getContext("2d"),document.body.appendChild(this.canvas),window.addEventListener("resize",this.resize.bind(this)),window.addEventListener("mousemove",this.mouseMove.bind(this)),window.addEventListener("mouseup",this.mouseUp.bind(this)),window.addEventListener("mousedown",this.mouseDown.bind(this)),window.addEventListener("keydown",this.keyDown.bind(this)),this.resize()}pushHistory(){let e=this.getLayout();E.push(JSON.stringify(e)),E.length>50&&E.shift()}saveSettings(){let e=X();I({id:e?.id,name:e?.name,version:e?.version,layout:this.getLayout()})}loadSettings(){try{let e=X();e?.version==="1.0"&&e?.layout?this.setLayout(e.layout):console.warn("MLMap: localStorage version mismatch, skipping load.")}catch(e){console.error("MLMap: Failed to parse layout from localStorage.",e)}}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.draw()}pointInTriangle(e,s,t,i){let o=s[1]*i[0]-s[0]*i[1]+(i[1]-s[1])*e[0]+(s[0]-i[0])*e[1],a=s[0]*t[1]-s[1]*t[0]+(s[1]-t[1])*e[0]+(t[0]-s[0])*e[1];if(o<0!=a<0)return!1;let y=-t[1]*i[0]+s[1]*(i[0]-t[0])+s[0]*(t[1]-i[1])+t[0]*i[1];return y<0&&(o=-o,a=-a,y=-y),o>0&&a>0&&o+a<y}pointInLayer(e,s){let[t,i,o,a]=s.targetPoints;return this.pointInTriangle(e,t,i,o)||this.pointInTriangle(e,a,t,o)}updateTransform(){let e=["","-webkit-","-moz-","-ms-","-o-"],s="transform";for(let t of e){let i=t+"transform";if(i in document.body.style){s=i;break}}for(let t=0;t<this.layers.length;t++){let i=[],o=[];for(let d=0,h=this.layers[t].sourcePoints.length;d<h;++d){let p=this.layers[t].sourcePoints[d],u=this.layers[t].targetPoints[d];i.push([p[0],p[1],1,0,0,0,-p[0]*u[0],-p[1]*u[0]]),o.push(u[0]),i.push([0,0,0,p[0],p[1],1,-p[0]*u[1],-p[1]*u[1]]),o.push(u[1])}let a=F(i,o,!0),y=[a[0],a[3],0,a[6],a[1],a[4],0,a[7],0,0,1,0,a[2],a[5],0,1],c=this.layers[t].element.style;c.setProperty(s,`matrix3d(${y.join(",")})`),c.setProperty(`${s}-origin`,"0px 0px 0px")}}rotateLayer(e,s){for(var t=Math.sin(s),i=Math.cos(s),o=[0,0],a=0;a<e.targetPoints.length;a++)o[0]+=e.targetPoints[a][0],o[1]+=e.targetPoints[a][1];o[0]/=4,o[1]/=4;for(var a=0;a<e.targetPoints.length;a++){var y=e.targetPoints[a][0]-o[0],c=e.targetPoints[a][1]-o[1];e.targetPoints[a][0]=y*i-c*t+o[0],e.targetPoints[a][1]=y*t+c*i+o[1]}}scaleLayer(e,s){for(var t=[0,0],i=0;i<e.targetPoints.length;i++)t[0]+=e.targetPoints[i][0],t[1]+=e.targetPoints[i][1];t[0]/=4,t[1]/=4;for(var i=0;i<e.targetPoints.length;i++){var o=e.targetPoints[i][0]-t[0],a=e.targetPoints[i][1]-t[1];e.targetPoints[i][0]=o*s+t[0],e.targetPoints[i][1]=a*s+t[1]}}undo(){if(E.length>1){E.pop();var e=JSON.parse(E[E.length-1]);this.setLayout(e),this.draw(),this.autoSave&&this.saveSettings()}}swapLayerPoints(e,s,t){var i=e[s][0],o=e[s][1];e[s][0]=e[t][0],e[s][1]=e[t][1],e[t][0]=i,e[t][1]=o}addLayer(e,s){let t=null;if(typeof e=="string"){if(t=document.getElementById(e),!t)throw new Error("MLMap: No element found with id: "+e)}else if(e instanceof HTMLElement)t=e;else throw new Error("MLMap: Invalid target");for(let o=0;o<this.layers.length;o++)if(this.layers[o].element.id===t.id){s&&(this.layers[o].targetPoints=P(s));return}t.style.position="fixed",t.style.display="block",t.style.top="0px",t.style.left="0px",t.style.padding="0px",t.style.margin="0px";let i={visible:!0,element:t,width:t.clientWidth,height:t.clientHeight,sourcePoints:[[0,0],[t.clientWidth,0],[t.clientWidth,t.clientHeight],[0,t.clientHeight]],targetPoints:[]};if(s)i.targetPoints=P(s);else{let[o,a]=N(i.width,i.height,this.layers);i.targetPoints=[[o,a],[o+i.width,a],[o+i.width,a+i.height],[o,a+i.height]]}this.layers.push(i),this.updateTransform()}removeLayer(e){let s=typeof e=="string"?document.getElementById(e):e;if(s){for(let t=this.layers.length-1;t>=0;t--)this.layers[t].element===s&&(this.layers[t].overlay&&this.layers[t].overlay?.remove(),this.layers.splice(t,1));this.updateTransform()}}setLayout(e){for(var s=0;s<e.length;s++){for(var t=!1,i=0;i<this.layers.length;i++)this.layers[i].element.id==e[s].id&&(console.log("Setting points."),this.layers[i].targetPoints=P(e[s].targetPoints),this.layers[i].sourcePoints=P(e[s].sourcePoints),t=!0);if(t)console.log('MLMap: Element "" + layout[i].id + "" is already mapped.');else{var o=document.getElementById(e[s].id);o?this.addLayer(o,e[s].targetPoints):console.log('MLMap: Can"t find element: '+e[s].id)}}this.updateTransform(),this.draw()}getLayout(){for(var e=[],s=0;s<this.layers.length;s++)e.push({id:this.layers[s].element.id,targetPoints:P(this.layers[s].targetPoints),sourcePoints:P(this.layers[s].sourcePoints)});return e}setConfigEnabled(e){this.configActive=e,this.canvas.style.display=e?"block":"none",e?this.draw():(this.selectedPoint=null,this.selectedLayer=null,this.dragging=!1,this.showScreenBounds=!1)}draw(){if(this.configActive){this.context.strokeStyle="red",this.context.lineWidth=2,this.context.clearRect(0,0,this.canvas.width,this.canvas.height);for(let e=0;e<this.layers.length;e++){let s=this.layers[e];if(s.visible){s.element.style.visibility="visible",this.context.beginPath(),s===this.hoveringLayer?this.context.strokeStyle="red":s===this.selectedLayer?this.context.strokeStyle="red":this.context.strokeStyle="white",this.context.moveTo(s.targetPoints[0][0],s.targetPoints[0][1]);for(let i=0;i<s.targetPoints.length;i++)this.context.lineTo(s.targetPoints[i][0],s.targetPoints[i][1]);this.context.lineTo(s.targetPoints[3][0],s.targetPoints[3][1]),this.context.closePath(),this.context.stroke();let t=[0,0];for(let i=0;i<s.targetPoints.length;i++)s.targetPoints[i]===this.hoveringPoint?this.context.strokeStyle="red":s.targetPoints[i]===this.selectedPoint?this.context.strokeStyle="red":this.context.strokeStyle="white",t[0]+=s.targetPoints[i][0],t[1]+=s.targetPoints[i][1],this.context.beginPath(),this.context.arc(s.targetPoints[i][0],s.targetPoints[i][1],this.selectionRadius/2,0,2*Math.PI,!1),this.context.stroke();if(t[0]/=4,t[1]/=4,this.showLayerNames){let i=s.element.id.toUpperCase();this.context.font="16px sans-serif",this.context.textAlign="center";let o=this.context.measureText(i),a=[o.width+8,32];this.context.fillStyle="white";let y=window.innerHeight*.01,c=t[0],d=t[1];(s.width<o.width+10||s.height<20)&&(d=t[1]-s.height/2-10-y,d-a[1]/2<y&&(d=t[1]+s.height/2+20+y)),this.context.fillRect(c-a[0]/2,d-a[1]/2,a[0],a[1]),this.context.fillStyle="black",this.context.font="14px sans-serif",this.context.fillText(i,c,d)}}else s.element.style.visibility="hidden"}if(this.showCrosshairs&&(this.context.strokeStyle="yellow",this.context.lineWidth=1,this.context.beginPath(),this.context.moveTo(this.mousePosition[0],0),this.context.lineTo(this.mousePosition[0],this.canvas.height),this.context.moveTo(0,this.mousePosition[1]),this.context.lineTo(this.canvas.width,this.mousePosition[1]),this.context.stroke()),this.showScreenBounds){this.context.fillStyle="black",this.context.lineWidth=4,this.context.fillRect(0,0,this.canvas.width,this.canvas.height),this.context.strokeStyle="#909090",this.context.beginPath();let e=this.canvas.width/10,s=this.canvas.height/10;for(let i=0;i<10;i++)this.context.moveTo(i*e,0),this.context.lineTo(i*e,this.canvas.height),this.context.moveTo(0,i*s),this.context.lineTo(this.canvas.width,i*s);this.context.stroke(),this.context.strokeStyle="white",this.context.strokeRect(2,2,this.canvas.width-4,this.canvas.height-4);let t=Math.round(s*.6);this.context.font=`${t}px mono, sans-serif`,this.context.fillRect(e*2+2,s*3+2,this.canvas.width-e*4-4,this.canvas.height-s*6-4),this.context.fillStyle="white",this.context.font="20px sans-serif",this.context.fillText(`${this.canvas.width} x ${this.canvas.height}`,this.canvas.width/2,this.canvas.height/2+t*.75),this.context.fillText("Display size",this.canvas.width/2,this.canvas.height/2-t*.75)}}}mouseMove(e){if(this.configActive){if(e.preventDefault(),this.mouseDelta[0]=e.clientX-this.mousePosition[0],this.mouseDelta[1]=e.clientY-this.mousePosition[1],this.mousePosition[0]=e.clientX,this.mousePosition[1]=e.clientY,this.dragging){let s=e.shiftKey?.1:1;if(this.selectedPoint)e.shiftKey?this.scaleLayer(this.selectedLayer,1+this.mouseDelta[0]*.01):(this.selectedPoint[0]+=this.mouseDelta[0]*s,this.selectedPoint[1]+=this.mouseDelta[1]*s);else if(this.selectedLayer)if(e.altKey&&this.rotateLayer(this.selectedLayer,this.mouseDelta[0]*(.01*s)),e.ctrlKey)this.scaleLayer(this.selectedLayer,this.mouseDelta[1]*(-.005*s)+1);else for(let t=0;t<this.selectedLayer.targetPoints.length;t++)this.selectedLayer.targetPoints[t][0]+=this.mouseDelta[0]*s,this.selectedLayer.targetPoints[t][1]+=this.mouseDelta[1]*s;this.updateTransform(),this.autoSave&&this.saveSettings(),this.draw(),this.layoutChangeListener();return}this.canvas.style.cursor="default",this.hoveringPoint=null,this.hoveringLayer=null;for(let s=this.layers.length-1;s>=0;s--){let t=this.layers[s];if(t.visible){for(let i=0;i<t.targetPoints.length;i++){let o=t.targetPoints[i];if(O(o[0],o[1],e.clientX,e.clientY)<this.selectionRadius){this.hoveringPoint=o,this.hoveringLayer=t,this.canvas.style.cursor="pointer";break}}if(this.hoveringPoint)break}}if(!this.hoveringPoint)for(let s=this.layers.length-1;s>=0;s--){let t=this.layers[s];if(t.visible&&this.pointInLayer(this.mousePosition,t)){this.hoveringLayer=t,this.canvas.style.cursor="pointer";break}}this.draw()}}mouseDown(e){if(this.configActive){this.mouseDownPoint=[e.clientX,e.clientY],this.selectedPoint=null,this.selectedLayer=null;for(let s=this.layers.length-1;s>=0;s--){let t=this.layers[s];if(t.visible){for(let i=0;i<t.targetPoints.length;i++){let o=t.targetPoints[i];if(O(o[0],o[1],e.clientX,e.clientY)<this.selectionRadius){this.selectedPoint=o,this.selectedLayer=t;break}}if(this.selectedLayer)break}}if(!this.selectedLayer)for(let s=this.layers.length-1;s>=0;s--){let t=this.layers[s];if(t.visible&&this.pointInLayer([e.clientX,e.clientY],t)){this.selectedLayer=t;break}}this.selectedLayer&&(this.dragging=!0,this.draw())}}mouseUp(e){this.configActive&&(this.dragging&&(this.pushHistory(),this.autoSave&&this.saveSettings()),this.dragging=!1,this.selectedPoint=null)}keyDown(e){if(!this.configActive)if(e.keyCode==32&&e.shiftKey){this.setConfigEnabled(!0);return}else return;var s=e.keyCode,t=e.shiftKey?10:1,i=!1,o=[0,0];switch(console.log(s),s){case 32:if(e.shiftKey){this.setConfigEnabled(!1);return}break;case 37:o[0]-=t;break;case 38:o[1]-=t;break;case 39:o[0]+=t;break;case 40:o[1]+=t;break;case 67:this.showCrosshairs=!this.showCrosshairs,i=!0;break;case 76:if(!this.configActive)return;this.showLayerNames=!this.showLayerNames,i=!0;break;case 83:if(this.isLayerSoloed){for(var a=0;a<this.layers.length;a++)this.layers[a].visible=!0;this.isLayerSoloed=!1,i=!0}else if(this.selectedLayer!=null){for(var a=0;a<this.layers.length;a++)this.layers[a].visible=!1;this.selectedLayer.visible=!0,i=!0,this.isLayerSoloed=!0}break;case 66:this.showScreenBounds=!this.showScreenBounds,this.draw();break;case 72:this.selectedLayer&&(this.swapLayerPoints(this.selectedLayer.sourcePoints,0,1),this.swapLayerPoints(this.selectedLayer.sourcePoints,3,2),this.updateTransform(),this.draw());break;case 86:this.selectedLayer&&(this.swapLayerPoints(this.selectedLayer.sourcePoints,0,3),this.swapLayerPoints(this.selectedLayer.sourcePoints,1,2),this.updateTransform(),this.draw());break;case 82:this.selectedLayer&&(this.rotateLayer(this.selectedLayer,Math.PI/2),this.updateTransform(),this.draw());break;case 90:e.ctrlKey&&this.undo();break;case 46:case 8:if(this.selectedLayer){this.selectedLayer.element.remove(),this.selectedLayer.overlay&&this.selectedLayer.overlay.remove();let y=this.layers.indexOf(this.selectedLayer);y>=0&&this.layers.splice(y,1),this.selectedLayer=null,i=!0,this.updateTransform(),this.draw()}break}if(!this.showScreenBounds){if(this.selectedPoint)this.selectedPoint[0]+=o[0],this.selectedPoint[1]+=o[1],i=!0;else if(this.selectedLayer){if(e.altKey==!0)this.rotateLayer(this.selectedLayer,o[0]*.01),this.scaleLayer(this.selectedLayer,o[1]*-.005+1);else for(var a=0;a<this.selectedLayer.targetPoints.length;a++)this.selectedLayer.targetPoints[a][0]+=o[0],this.selectedLayer.targetPoints[a][1]+=o[1];i=!0}}i&&(this.updateTransform(),this.draw(),this.autoSave&&this.saveSettings(),this.pushHistory(),this.layoutChangeListener())}},ce=new R({layers:[]});ee(ce);window.MLMap=R;})();
