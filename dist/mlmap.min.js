"use strict";(()=>{var bt=Object.create;var He=Object.defineProperty;var xt=Object.getOwnPropertyDescriptor;var wt=Object.getOwnPropertyNames;var Lt=Object.getPrototypeOf,Et=Object.prototype.hasOwnProperty;var Re=(d,e)=>()=>(d&&(e=d(d=0)),e);var Ne=(d,e)=>()=>(e||d((e={exports:{}}).exports,e),e.exports);var kt=(d,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of wt(e))!Et.call(d,i)&&i!==t&&He(d,i,{get:()=>e[i],enumerable:!(s=xt(e,i))||s.enumerable});return d};var We=(d,e,t)=>(t=d!=null?bt(Lt(d)):{},kt(e||!d||!d.__esModule?He(t,"default",{value:d,enumerable:!0}):t,d));var Y,G,re,Ue,le=Re(()=>{"use strict";Y="0.1.0.0",G=[],re=[],Ue="display.html"});async function ce(){let d="mlmap:cache:checkLatestVersion",t=Date.now(),s=localStorage.getItem(d),i=null;if(s)try{i=JSON.parse(s)}catch{}if(i&&t-i.timestamp<3e5)return{current:Y,latest:i.latest,requireUpdate:i.latest!==Y};let o=new AbortController,h=setTimeout(()=>o.abort(),5e3);try{let c=await fetch("https://raw.githubusercontent.com/FJRG2007/mlmap/refs/heads/main/package.json",{signal:o.signal});clearTimeout(h);let v=await c.json();return i={latest:v.version,timestamp:t},localStorage.setItem(d,JSON.stringify(i)),{current:Y,latest:v.version,requireUpdate:v.version!==Y}}catch{return{current:Y,latest:i?.latest||Y,requireUpdate:!1}}}var Le=Re(()=>{"use strict";le()});var Oe=Ne(()=>{"use strict";Le();document.addEventListener("DOMContentLoaded",async()=>{let d=await ce();console.log(`Current version: ${d.current}`),console.log(`Latest version: ${d.latest}`),d.requireUpdate&&console.log("A new version is available!")})});var ze=Ne(()=>{"use strict";var zt=We(Oe())});var li=We(ze());function Ve(d,e,t=[]){let s=0,i=0,o=0,n=100,h;do{h=!1,s=Math.random()*(window.innerWidth-d),i=Math.random()*(window.innerHeight-e);for(let c of t){let v=[Math.min(...c.targetPoints.map(u=>u[0])),Math.min(...c.targetPoints.map(u=>u[1])),Math.max(...c.targetPoints.map(u=>u[0])),Math.max(...c.targetPoints.map(u=>u[1]))];if(!(s+d<v[0]||s>v[2]||i+e<v[1]||i>v[3])){h=!0;break}}o++}while(h&&o<n);return[s,i]}function te(d){return d.map(e=>e.slice(0,2))}function Ee(d,e,t,s){return Math.hypot(t-d,s-e)}var $e=(()=>{function d(c,v,u,f){if(u===v.length-1)return f(c);let b,L=v[u],E=Array(L);for(b=L-1;b>=0;--b)E[b]=d(c[b],v,u+1,f);return E}function e(c){let v=[];for(;typeof c=="object";)v.push(c.length),c=c[0];return v}function t(c){let v,u;return typeof c=="object"?(v=c[0],typeof v=="object"?(u=v[0],typeof u=="object"?e(c):[c.length,v.length]):[c.length]):[]}function s(c){let v,u=c.length,f=Array(u);for(v=u-1;v>=0;--v)f[v]=c[v];return f}function i(c){return typeof c!="object"?c:d(c,t(c),0,s)}function o(c,v){v=v||!1;let u,f,b,L,E,S,P,C,A,_=c.length,K=_-1,J=new Array(_);for(v||(c=i(c)),b=0;b<_;++b){for(P=b,S=c[b],A=h(S[b]),f=b+1;f<_;++f)L=h(c[f][b]),L>A&&(A=L,P=f);for(J[b]=P,P!=b&&(c[b]=c[P],c[P]=S,S=c[b]),E=S[b],u=b+1;u<_;++u)c[u][b]/=E;for(u=b+1;u<_;++u){for(C=c[u],f=b+1;f<K;++f)C[f]-=C[b]*S[f],++f,C[f]-=C[b]*S[f];f===K&&(C[f]-=C[b]*S[f])}}return{LU:c,P:J}}function n(c,v){let u,f,b,L,E,S=c.LU,P=S.length,C=i(v),A=c.P;for(u=P-1;u>=0;--u)C[u]=v[u];for(u=0;u<P;++u)for(b=A[u],A[u]!==u&&(E=C[u],C[u]=C[b],C[b]=E),L=S[u],f=0;f<u;++f)C[u]-=C[f]*L[f];for(u=P-1;u>=0;--u){for(L=S[u],f=u+1;f<P;++f)C[u]-=C[f]*L[f];C[u]/=L[u]}return C}let h=Math.abs;return function(c,v,u){return n(o(c,u),v)}})();function ie(d){localStorage.setItem(`mlmap:workspace<${d.id}>`,JSON.stringify(d))}function ke(d){let e=localStorage.getItem("mlmap:currentWorkspaceId");if(!e){e=Date.now().toString(),localStorage.setItem("mlmap:currentWorkspaceId",e);let s={id:e,name:"New Workspace",version:"1.0",layout:{}};return localStorage.setItem(`mlmap:workspace<${e}>`,JSON.stringify(s)),s}let t=localStorage.getItem(`mlmap:workspace<${d||e}>`);return t?JSON.parse(t):null}function _e(d){localStorage.removeItem(`mlmap:workspace<${d}>`)}function Ye(d){let e=`mlmap:workspace<${d}>`,t=JSON.parse(localStorage.getItem(e)||`{id:"${d}",name:"Reset Workspace",version:"1.0",layout:{}`);localStorage.setItem(e,JSON.stringify({id:d,name:t?.name,version:"1.0",layout:{}}))}function Fe(){let d=[];for(let e=0;e<localStorage.length;e++){let t=localStorage.key(e);if(t&&t.startsWith("mlmap:workspace<")){let s=localStorage.getItem(t);s&&d.push(JSON.parse(s))}}return d}le();Le();var Je="mlmap-sync",je=2e3;var qe=6e3;function Ge(d,e){return{type:d,payload:e,timestamp:Date.now()}}var de=class{constructor(e){this.listeners=new Map;this.heartbeatTimer=null;this.lastPong=0;this._connected=!1;this.onConnectionChange=null;this.role=e,this.channel=new BroadcastChannel(Je),this.channel.onmessage=t=>this.handleMessage(t.data),e==="control"&&this.startHeartbeat(),e==="display"&&(this.on("PING",()=>this.send("PONG")),setTimeout(()=>this.send("DISPLAY_READY"),100))}get connected(){return this._connected}set onConnectionChanged(e){this.onConnectionChange=e}send(e,t){try{this.channel.postMessage(Ge(e,t))}catch(s){console.warn("ChannelBridge: Failed to send message",e,s)}}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){let s=this.listeners.get(e);if(s){let i=s.indexOf(t);i>=0&&s.splice(i,1)}}destroy(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.channel.close(),this.listeners.clear()}handleMessage(e){(e.type==="PONG"||e.type==="DISPLAY_READY")&&(this.lastPong=Date.now(),this.setConnected(!0));let t=this.listeners.get(e.type);t&&t.forEach(s=>s(e.payload))}startHeartbeat(){this.heartbeatTimer=window.setInterval(()=>{this.send("PING"),this._connected&&Date.now()-this.lastPong>qe&&this.setConnected(!1)},je)}setConnected(e){this._connected!==e&&(this._connected=e,this.onConnectionChange&&this.onConnectionChange(e))}};var Xe="mlmap:videoSources",pe=class{constructor(){this.sources=[];this.onChange=null;this.liveStreams=new Map;this.load()}set onChanged(e){this.onChange=e}getAll(){return[...this.sources]}getById(e){return this.sources.find(t=>t.id===e)}getStream(e){return this.liveStreams.get(e)}addUrl(e,t){let s=t||e.split("/").pop()||"video",i={id:`src-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,name:s,url:e,type:"url"};return this.sources.push(i),this.save(),this.notify(),i}addFile(e){let t=URL.createObjectURL(e),s={id:`src-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,name:e.name,url:t,type:"file"};return this.sources.push(s),this.notify(),s}addCapture(e,t){let s=`src-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,i={id:s,name:t,url:`capture:${s}`,type:"capture"};this.liveStreams.set(s,e),this.sources.push(i);let o=e.getTracks(),n=()=>{o.every(h=>h.readyState==="ended")&&this.liveStreams.delete(s)};return o.forEach(h=>h.addEventListener("ended",n)),this.notify(),i}remove(e){let t=this.sources.findIndex(s=>s.id===e);if(t>=0){let s=this.sources[t];if(s.type==="file"&&s.url.startsWith("blob:")&&URL.revokeObjectURL(s.url),s.type==="capture"){let i=this.liveStreams.get(e);i&&(i.getTracks().forEach(o=>o.stop()),this.liveStreams.delete(e))}this.sources.splice(t,1),this.save(),this.notify()}}save(){let e=this.sources.filter(t=>t.type==="url");localStorage.setItem(Xe,JSON.stringify(e))}load(){try{let e=localStorage.getItem(Xe);e&&(this.sources=JSON.parse(e))}catch{this.sources=[]}}notify(){this.onChange&&this.onChange()}};var Ze="mlmap:playlists",Te="mlmap:activePlaylist",he=class{constructor(){this.playlists=[];this.activeId=null;this.onChange=null;this.load()}set onChanged(e){this.onChange=e}getAll(){return[...this.playlists]}getActive(){return this.playlists.find(e=>e.id===this.activeId)||this.playlists[0]||null}setActive(e){this.activeId=e,localStorage.setItem(Te,e),this.notify()}create(e){let t={id:`pl-${Date.now()}`,name:e,items:[],loop:!0};return this.playlists.push(t),this.activeId||(this.activeId=t.id),this.save(),this.notify(),t}remove(e){this.playlists=this.playlists.filter(t=>t.id!==e),this.activeId===e&&(this.activeId=this.playlists[0]?.id||null),this.save(),this.notify()}addItem(e,t){let s=this.playlists.find(o=>o.id===e);if(!s)return;let i={id:`item-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,sourceId:t,order:s.items.length};s.items.push(i),this.save(),this.notify()}removeItem(e,t){let s=this.playlists.find(i=>i.id===e);s&&(s.items=s.items.filter(i=>i.id!==t),s.items.forEach((i,o)=>i.order=o),this.save(),this.notify())}moveItem(e,t,s){let i=this.playlists.find(h=>h.id===e);if(!i)return;let o=i.items.findIndex(h=>h.id===t);if(o<0)return;let n=s==="up"?o-1:o+1;n<0||n>=i.items.length||([i.items[o],i.items[n]]=[i.items[n],i.items[o]],i.items.forEach((h,c)=>h.order=c),this.save(),this.notify())}toggleLoop(e){let t=this.playlists.find(s=>s.id===e);t&&(t.loop=!t.loop,this.save(),this.notify())}save(){localStorage.setItem(Ze,JSON.stringify(this.playlists)),this.activeId&&localStorage.setItem(Te,this.activeId)}load(){try{let e=localStorage.getItem(Ze);e?this.playlists=JSON.parse(e):this.create("Default"),this.activeId=localStorage.getItem(Te)||this.playlists[0]?.id||null}catch{this.create("Default")}}notify(){this.onChange&&this.onChange()}};function Qe(d){if(!isFinite(d)||isNaN(d))return"0:00";let e=Math.floor(d/60),t=Math.floor(d%60);return`${e}:${t.toString().padStart(2,"0")}`}function et(d,e,t,s){let i=new pe,o=new he,n=null,h=0;d.innerHTML=`
        <div class="mlmap-section">
            <div class="mlmap-section-title">Media Library</div>
            <div style="display:flex;gap:4px;margin-bottom:4px;">
                <input id="vp-url" type="text" class="mlmap-input" placeholder="Video URL..." style="flex:1;min-width:0;">
                <button id="vp-addUrl" class="mlmap-btn">Add</button>
            </div>
            <div style="display:flex;gap:4px;margin-bottom:6px;">
                <input id="vp-file" type="file" accept="video/*" style="display:none;">
                <button id="vp-chooseFile" class="mlmap-btn" style="flex:1;">Browse file...</button>
            </div>
            <div style="display:flex;gap:4px;margin-bottom:6px;">
                <button id="vp-capture" class="mlmap-btn" style="flex:1;">Screen capture...</button>
                <button id="vp-webcam" class="mlmap-btn" style="flex:1;">Webcam...</button>
            </div>
            <div id="vp-library"></div>
        </div>
        <div class="mlmap-section">
            <div class="mlmap-section-title">Playlist</div>
            <div style="display:flex;gap:4px;align-items:center;margin-bottom:6px;">
                <select id="vp-plSelect" class="mlmap-select" style="flex:1;min-width:0;"></select>
                <button id="vp-plNew" class="mlmap-btn" title="New playlist">+</button>
                <button id="vp-plDel" class="mlmap-btn" title="Delete playlist">-</button>
            </div>
            <div id="vp-playlist" style="margin-bottom:4px;"></div>
            <button id="vp-loop" class="mlmap-btn" style="width:100%;font-size:10px;">Loop: ON</button>
        </div>
    `,e.innerHTML=`
        <div style="display:flex;align-items:center;gap:3px;">
            <button id="tp-prev" class="transport-btn" title="Previous">|&lt;</button>
            <button id="tp-rw" class="transport-btn" title="-10s">&lt;&lt;</button>
            <button id="tp-play" class="transport-btn" title="Play" style="width:38px;font-size:14px;">&#9654;</button>
            <button id="tp-ff" class="transport-btn" title="+10s">&gt;&gt;</button>
            <button id="tp-next" class="transport-btn" title="Next">&gt;|</button>
            <button id="tp-stop" class="transport-btn" title="Stop">&#9632;</button>
        </div>
        <input id="tp-seek" type="range" min="0" max="1000" value="0" step="1" class="mlmap-range" style="flex:1;min-width:80px;">
        <span id="tp-time" style="font-size:11px;white-space:nowrap;color:#aaa;min-width:85px;text-align:center;">0:00 / 0:00</span>
        <span id="tp-now" style="flex:1;font-size:11px;color:#888;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:center;">No media</span>
        <div style="display:flex;align-items:center;gap:4px;">
            <span style="font-size:10px;color:#666;">Vol</span>
            <input id="tp-vol" type="range" min="0" max="100" value="100" class="mlmap-range" style="width:70px;">
            <button id="tp-mute" class="transport-btn" style="width:28px;font-size:10px;" title="Mute/Unmute">M</button>
        </div>
        <select id="tp-audioOut" class="mlmap-select" style="max-width:120px;font-size:10px;" title="Audio output routing">
            <option value="editor">Audio: Editor</option>
            <option value="output">Audio: Output</option>
            <option value="both">Audio: Both</option>
        </select>
    `;let c=p=>document.getElementById(p);function v(p){n=p,p.addEventListener("timeupdate",W),p.addEventListener("play",()=>{n===p&&A(),W()}),p.addEventListener("pause",W),p.addEventListener("ended",L),p.addEventListener("loadedmetadata",W)}function u(p){let x=o.getActive();if(!x||!x.items[p]||!n)return;h=p;let k=x.items[p],I=i.getById(k.sourceId);I&&(n.src=I.url,n.load())}function f(){let p=o.getActive();if(!(!p||p.items.length===0)){if(h++,h>=p.items.length)if(p.loop)h=0;else{h=p.items.length-1;return}u(h),n&&n.play().catch(()=>{}),t.send("NEXT")}}function b(){let p=o.getActive();if(!(!p||p.items.length===0)){if(h--,h<0)if(p.loop)h=p.items.length-1;else{h=0;return}u(h),n&&n.play().catch(()=>{}),t.send("PREVIOUS")}}function L(){let p=o.getActive();p&&p.items.length>1?f():p&&p.loop&&n&&(n.currentTime=0,n.play().catch(()=>{}))}function E(){let p=o.getActive();if(p&&p.items[h]){let x=i.getById(p.items[h].sourceId);if(x)return x.name}if(n&&n.src&&n.src!==window.location.href){let x=n.src.split("/");return x[x.length-1]||"Video"}return""}c("vp-addUrl").addEventListener("click",()=>{let p=c("vp-url"),x=p.value.trim();x&&(i.addUrl(x),p.value="",X())}),c("vp-url").addEventListener("keydown",p=>{p.stopPropagation(),p.key==="Enter"&&c("vp-addUrl").click()}),c("vp-chooseFile").addEventListener("click",()=>c("vp-file").click()),c("vp-file").addEventListener("change",p=>{let x=p.target;x.files&&x.files[0]&&(i.addFile(x.files[0]),X(),x.value="")}),c("vp-capture").addEventListener("click",async()=>{try{let p=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!0}),k=p.getVideoTracks()[0]?.label||"Screen Capture",I=i.addCapture(p,k);X(),s(I.url,I.name,p)}catch{}}),c("vp-webcam").addEventListener("click",async()=>{try{let x=(await navigator.mediaDevices.enumerateDevices()).filter(H=>H.kind==="videoinput"),k={video:!0,audio:!0};if(x.length>1){let H=x.map((j,Q)=>`${Q+1}. ${j.label||`Camera ${Q+1}`}`).join(`
`),M=prompt(`Select camera:
${H}`,"1");if(!M)return;let T=parseInt(M)-1;T>=0&&T<x.length&&(k={video:{deviceId:{exact:x[T].deviceId}},audio:!0})}let I=await navigator.mediaDevices.getUserMedia(k),B=I.getVideoTracks()[0]?.label||"Webcam",O=i.addCapture(I,B);X(),s(O.url,O.name,I)}catch{}}),c("vp-plSelect").addEventListener("change",p=>{o.setActive(p.target.value),V()}),c("vp-plNew").addEventListener("click",()=>{let p=prompt("Playlist name:","New Playlist");if(p){let x=o.create(p);o.setActive(x.id),Z(),V()}}),c("vp-plDel").addEventListener("click",()=>{let p=o.getActive();p&&o.getAll().length>1&&(o.remove(p.id),Z(),V())}),c("vp-loop").addEventListener("click",()=>{let p=o.getActive();p&&(o.toggleLoop(p.id),V())});let S="mlmap:audioMode",P=localStorage.getItem(S)||"editor",C=!1;function A(){n&&(n.muted=C||P==="output"),t.send("SET_MUTED",{muted:C||P==="editor"}),W()}function _(){n&&(t.send("SEEK",{time:n.currentTime}),n.paused?t.send("PAUSE"):t.send("PLAY"),t.send("SET_VOLUME",{volume:n.volume}),t.send("SET_MUTED",{muted:C||P==="editor"}))}c("tp-play").addEventListener("click",()=>{if(!n){let p=o.getActive();if(p&&p.items.length>0){let x=p.items[0],k=i.getById(x.sourceId);k&&(s(k.url,k.name),setTimeout(()=>{n&&(C=!1,A(),u(0),setTimeout(()=>{n&&n.play().catch(()=>{}),U(),t.send("PLAY"),W()},200))},100))}return}if(n.paused){if(C=!1,A(),!n.src||n.src===window.location.href){let p=o.getActive();p&&p.items.length>0&&(u(0),setTimeout(()=>{n&&n.play().catch(()=>{}),W()},200))}else n.play().catch(()=>{});t.send("PLAY"),W()}else n.pause(),t.send("PAUSE")}),c("tp-stop").addEventListener("click",()=>{n&&(n.pause(),n.currentTime=0),t.send("STOP"),W()}),c("tp-prev").addEventListener("click",()=>b()),c("tp-next").addEventListener("click",()=>f()),c("tp-rw").addEventListener("click",()=>{if(n){let p=Math.max(0,n.currentTime-10);n.currentTime=p,t.send("SEEK",{time:p})}}),c("tp-ff").addEventListener("click",()=>{if(n){let p=n.currentTime+10;n.currentTime=p,t.send("SEEK",{time:p})}});let K=c("tp-seek"),J=!1;K.addEventListener("pointerdown",()=>{J=!0}),K.addEventListener("pointerup",()=>{J=!1}),K.addEventListener("input",()=>{if(n&&n.duration>0){let p=parseInt(K.value)/1e3*n.duration;n.currentTime=p,t.send("SEEK",{time:p})}}),c("tp-vol").addEventListener("input",p=>{let x=parseInt(p.target.value)/100;n&&(n.volume=x),t.send("SET_VOLUME",{volume:x})}),c("tp-mute").addEventListener("click",()=>{C=!C,A()}),c("tp-audioOut").value=P,c("tp-audioOut").addEventListener("change",p=>{P=p.target.value,localStorage.setItem(S,P),A()});function fe(p){n&&n!==p&&(n.muted=!0),n=p,p.addEventListener("timeupdate",W),p.addEventListener("play",()=>{n===p&&A(),W()}),p.addEventListener("pause",W),p.addEventListener("ended",L),p.addEventListener("loadedmetadata",W),A()}d.addEventListener("keydown",p=>{let x=p.target.tagName;(x==="INPUT"||x==="SELECT"||x==="TEXTAREA")&&p.stopPropagation()});function W(){let p=n,x=p?!p.paused:!1,k=p?.currentTime||0,I=p?.duration||0;c("tp-play").innerHTML=x?"&#9646;&#9646;":"&#9654;",I>0&&!J&&(K.value=String(Math.round(k/I*1e3))),c("tp-time").textContent=`${Qe(k)} / ${Qe(I)}`;let N=E();if(c("tp-now").textContent=N||"No media",p){c("tp-vol").value=String(Math.round(p.volume*100));let B=c("tp-mute");B.textContent=C?"M":"\u266A",B.style.color=C?"#f55":"#ccc"}}function X(){let p=c("vp-library");if(!p)return;let x=i.getAll();if(p.innerHTML="",x.length===0){p.innerHTML='<div style="color:#555;font-size:11px;padding:4px;">No media added yet</div>';return}x.forEach(k=>{let I=document.createElement("div");I.className="mlmap-media-item";let N=document.createElement("span");N.className="name",N.textContent=k.type==="capture"?`[LIVE] ${k.name}`:k.name,N.title=k.type==="capture"?"Screen capture":k.url,k.type==="capture"&&(N.style.color="#5f5");let B=document.createElement("span");B.style.cssText="display:flex;gap:2px;flex-shrink:0;";let O=document.createElement("button");O.className="mlmap-btn",O.textContent="Layer",O.title="Create video layer",O.style.cssText="font-size:10px;padding:2px 4px;",O.addEventListener("click",()=>{let T=i.getStream(k.id);s(k.url,k.name,T)});let H=document.createElement("button");k.type!=="capture"&&(H.className="mlmap-btn",H.textContent="+PL",H.title="Add to playlist",H.style.cssText="font-size:10px;padding:2px 4px;",H.addEventListener("click",()=>{let T=o.getActive();T&&(o.addItem(T.id,k.id),V())}));let M=document.createElement("button");M.className="mlmap-btn",M.textContent="x",M.title="Remove",M.style.cssText="font-size:10px;padding:2px 4px;color:#f55;",M.addEventListener("click",()=>{i.remove(k.id),X()}),B.appendChild(O),B.appendChild(H),B.appendChild(M),I.appendChild(N),I.appendChild(B),p.appendChild(I)})}function Z(){let p=c("vp-plSelect");if(!p)return;let x=o.getAll(),k=o.getActive();p.innerHTML="",x.forEach(I=>{let N=document.createElement("option");N.value=I.id,N.textContent=I.name,k&&k.id===I.id&&(N.selected=!0),p.appendChild(N)})}function V(){let p=c("vp-playlist");if(!p)return;let x=o.getActive();if(p.innerHTML="",!!x){if(c("vp-loop").textContent=`Loop: ${x.loop?"ON":"OFF"}`,x.items.length===0){p.innerHTML='<div style="color:#555;font-size:11px;padding:4px;">Playlist empty</div>';return}x.items.forEach((k,I)=>{let N=i.getById(k.sourceId),B=document.createElement("div");B.className="mlmap-pl-item";let O=document.createElement("span");O.className="name",O.textContent=`${I+1}. ${N?.name||"Unknown"}`;let H=document.createElement("span");H.style.cssText="display:flex;gap:1px;flex-shrink:0;";let M=document.createElement("button");M.className="mlmap-btn",M.innerHTML="&#9650;",M.style.cssText="font-size:8px;padding:1px 3px;",M.addEventListener("click",()=>{o.moveItem(x.id,k.id,"up"),V()});let T=document.createElement("button");T.className="mlmap-btn",T.innerHTML="&#9660;",T.style.cssText="font-size:8px;padding:1px 3px;",T.addEventListener("click",()=>{o.moveItem(x.id,k.id,"down"),V()});let j=document.createElement("button");j.className="mlmap-btn",j.textContent="x",j.style.cssText="font-size:9px;padding:1px 3px;color:#f55;",j.addEventListener("click",()=>{o.removeItem(x.id,k.id),V()}),H.appendChild(M),H.appendChild(T),H.appendChild(j),B.appendChild(O),B.appendChild(H),p.appendChild(B)})}}function U(){let p=o.getActive();if(!p)return;let x=p.items.map(k=>{let I=i.getById(k.sourceId);return{url:I?.url||"",name:I?.name||"Unknown"}}).filter(k=>k.url);t.send("LOAD_PLAYLIST",{items:x,loop:p.loop,startIndex:h})}return X(),Z(),V(),{sourceManager:i,playlistManager:o,sendPlaylistToDisplay:U,syncPlaybackToDisplay:_,registerVideoElement:v,setActiveVideo:fe,getActiveVideo:()=>n}}le();var tt="mlmap.managedLayers",Se="mlmap:videoSources",it="mlmap:playlists",st="mlmap:activePlaylist",nt="mlmap:currentWorkspaceId";function Ce(d){let e=localStorage.getItem(nt)||"default",t=localStorage.getItem(`mlmap:workspace<${e}>`),s=t?JSON.parse(t):{id:e,name:"Workspace",version:"1.0",layout:[]},i=[];try{let c=localStorage.getItem(tt);c&&(i=JSON.parse(c))}catch{}let o=[];try{let c=localStorage.getItem(Se);c&&(o=JSON.parse(c))}catch{}o=o.filter(c=>c.type==="url");let n=[];try{let c=localStorage.getItem(it);c&&(n=JSON.parse(c))}catch{}let h=localStorage.getItem(st);return{version:Y,name:d||s.name||"Workflow",timestamp:Date.now(),workspace:{id:s.id,name:s.name,layout:s.layout},managedLayers:i,videoSources:o,playlists:n,activePlaylistId:h}}function Pe(d){let e=Date.now().toString(),t={id:e,name:d.name||d.workspace.name||"Imported",version:"1.0",layout:d.workspace.layout||[]};if(localStorage.setItem(`mlmap:workspace<${e}>`,JSON.stringify(t)),localStorage.setItem(nt,e),d.managedLayers&&localStorage.setItem(tt,JSON.stringify(d.managedLayers)),d.videoSources&&d.videoSources.length>0){let s=[];try{let o=localStorage.getItem(Se);o&&(s=JSON.parse(o))}catch{}let i=new Set(s.map(o=>o.url));for(let o of d.videoSources)i.has(o.url)||(s.push(o),i.add(o.url));localStorage.setItem(Se,JSON.stringify(s))}d.playlists&&d.playlists.length>0&&localStorage.setItem(it,JSON.stringify(d.playlists)),d.activePlaylistId&&localStorage.setItem(st,d.activePlaylistId)}function St(d){let e=JSON.stringify(d),t=new TextEncoder().encode(e),s="";for(let i=0;i<t.length;i++)s+=String.fromCharCode(t[i]);return btoa(s).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function Ct(d){try{let e=d.replace(/-/g,"+").replace(/_/g,"/");for(;e.length%4;)e+="=";let t=atob(e),s=new Uint8Array(t.length);for(let n=0;n<t.length;n++)s[n]=t.charCodeAt(n);let i=new TextDecoder().decode(s),o=JSON.parse(i);return!o.workspace||!o.version?null:o}catch{return null}}function ot(d){let e=St(d);return`${window.location.origin+window.location.pathname}?workflow=${e}`}function at(){let e=new URLSearchParams(window.location.search).get("workflow");if(!e)return!1;let t=Ct(e);if(!t)return console.warn("MLMap: Invalid workflow data in URL"),!1;Pe(t);let s=window.location.origin+window.location.pathname;return window.history.replaceState({},document.title,s),!0}function rt(d){let e=JSON.stringify(d,null,2),t=new Blob([e],{type:"application/json"}),s=URL.createObjectURL(t),i=document.createElement("a");i.href=s,i.download=`${d.name.replace(/[^a-zA-Z0-9_-]/g,"_")}.mlmap`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s)}function lt(){return new Promise(d=>{let e=document.createElement("input");e.type="file",e.accept=".mlmap,.json",e.addEventListener("change",()=>{let t=e.files?.[0];if(!t){d(null);return}let s=new FileReader;s.onload=()=>{try{let i=JSON.parse(s.result);if(!i.workspace||!i.version){alert("Invalid workflow file."),d(null);return}d(i)}catch{alert("Failed to parse workflow file."),d(null)}},s.readAsText(t)}),e.click()})}var me=class{constructor(e){this.running=!1;this.rafId=0;this.zoom=1;this.getClipGroups=e,this.canvas=document.createElement("canvas"),this.canvas.style.position="fixed",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.zIndex="999999",this.canvas.style.pointerEvents="none",this.ctx=this.canvas.getContext("2d"),window.addEventListener("resize",()=>this.resize()),this.resize()}get canvasElement(){return this.canvas}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight}start(){this.running||(this.running=!0,this.render())}stop(){this.running=!1,this.rafId&&cancelAnimationFrame(this.rafId),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}render(){if(!this.running)return;let e=this.canvas.width,t=this.canvas.height;this.ctx.clearRect(0,0,e,t);let s=this.getClipGroups();if(this.zoom!==1){this.ctx.save();let i=e/2,o=t/2;this.ctx.translate(i,o),this.ctx.scale(this.zoom,this.zoom),this.ctx.translate(-i,-o)}for(let i of s){let o=i.video;if(o.readyState<2)continue;let n=i.baseTargetPoints,h=1/0,c=1/0,v=-1/0,u=-1/0;for(let L of n)L[0]<h&&(h=L[0]),L[1]<c&&(c=L[1]),L[0]>v&&(v=L[0]),L[1]>u&&(u=L[1]);let f=v-h,b=u-c;if(!(f<=0||b<=0))for(let L of i.masks){let E=L.targetPoints;if(!(!E||E.length<3)){this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(E[0][0],E[0][1]);for(let S=1;S<E.length;S++)this.ctx.lineTo(E[S][0],E[S][1]);this.ctx.closePath(),this.ctx.clip(),this.ctx.drawImage(o,h,c,f,b),this.ctx.restore()}}}this.zoom!==1&&this.ctx.restore(),this.rafId=requestAnimationFrame(()=>this.render())}};function ct(d){let e=window.innerWidth<900||window.innerHeight<500,t=window.matchMedia("(pointer: coarse)").matches&&!window.matchMedia("(pointer: fine)").matches;if(e||t){let a=document.createElement("div");a.id="mlmap-device-warning",a.style.cssText="position:fixed;inset:0;z-index:9999999;background:#111;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;font-family:-apple-system,'Segoe UI',Roboto,sans-serif;color:#ccc;padding:32px;",a.innerHTML=`
            <div style="font-size:48px;margin-bottom:16px;">\u{1F5A5}\uFE0F</div>
            <h2 style="color:#fff;margin:0 0 12px;font-size:20px;">Screen too small</h2>
            <p style="max-width:400px;line-height:1.6;margin:0 0 24px;color:#999;">
                MLMap requires a computer or tablet with a keyboard and mouse.<br>
                Minimum screen size: 900 &times; 500 px.
            </p>
            <p style="font-size:12px;color:#555;">Current: ${window.innerWidth} &times; ${window.innerHeight} px</p>
        `,document.body.appendChild(a),window.addEventListener("resize",()=>{window.innerWidth>=900&&window.innerHeight>=500&&a.parentElement&&a.remove()});return}let s=document.createElement("style");s.textContent=`
        #mlmap-app {
            position: fixed;
            inset: 0;
            display: grid;
            grid-template-rows: 38px 1fr 48px;
            grid-template-columns: 210px 1fr 270px;
            grid-template-areas:
                "toolbar toolbar toolbar"
                "left center right"
                "transport transport transport";
            z-index: 1000001;
            pointer-events: none;
            font-family: -apple-system, 'Segoe UI', Roboto, sans-serif;
            font-size: 12px;
            color: #ccc;
            user-select: none;
        }
        #mlmap-toolbar {
            grid-area: toolbar;
            pointer-events: auto;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
        }
        #mlmap-left {
            grid-area: left;
            pointer-events: auto;
            background: #222;
            border-right: 1px solid #333;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        #mlmap-right {
            grid-area: right;
            pointer-events: auto;
            background: #222;
            border-left: 1px solid #333;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        #mlmap-transport {
            grid-area: transport;
            pointer-events: auto;
            background: #1a1a1a;
            border-top: 1px solid #333;
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 8px;
        }
        .mlmap-section {
            padding: 8px;
            border-bottom: 1px solid #333;
        }
        .mlmap-section-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #888;
            margin-bottom: 6px;
        }
        .mlmap-btn {
            background: #383838;
            color: #ccc;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            font-family: inherit;
        }
        .mlmap-btn:hover { background: #484848; color: #fff; }
        .mlmap-btn:active { background: #555; }
        .mlmap-btn-primary { background: #2a6cb5; color: #fff; }
        .mlmap-btn-primary:hover { background: #3580d0; }
        .mlmap-input {
            background: #1a1a1a;
            color: #ccc;
            border: 1px solid #444;
            border-radius: 3px;
            padding: 4px 6px;
            font-size: 11px;
            font-family: inherit;
            outline: none;
        }
        .mlmap-input:focus { border-color: #2a6cb5; }
        .mlmap-select {
            background: #1a1a1a;
            color: #ccc;
            border: 1px solid #444;
            border-radius: 3px;
            padding: 4px 6px;
            font-size: 11px;
            font-family: inherit;
            outline: none;
        }
        .mlmap-layer-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 3px 6px;
            border-radius: 3px;
            cursor: default;
        }
        .mlmap-layer-item:hover { background: #2a2a2a; }
        .mlmap-layer-item .name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 11px;
        }
        .mlmap-layer-item .icon {
            width: 14px;
            text-align: center;
            flex-shrink: 0;
            font-size: 10px;
        }
        .mlmap-layer-item .del-btn {
            opacity: 0;
            cursor: pointer;
            color: #f55;
            background: none;
            border: none;
            font-size: 11px;
            padding: 0 2px;
        }
        .mlmap-layer-item:hover .del-btn { opacity: 1; }
        .mlmap-media-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 3px 6px;
            border-radius: 3px;
        }
        .mlmap-media-item:hover { background: #2a2a2a; }
        .mlmap-media-item .name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 11px;
        }
        .mlmap-pl-item {
            display: flex;
            align-items: center;
            gap: 2px;
            padding: 3px 4px;
            border-radius: 3px;
            font-size: 11px;
        }
        .mlmap-pl-item:hover { background: #2a2a2a; }
        .mlmap-pl-item .name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .transport-btn {
            background: #333;
            color: #ccc;
            border: none;
            width: 30px;
            height: 26px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .transport-btn:hover { background: #444; color: #fff; }
        .mlmap-range {
            -webkit-appearance: none;
            appearance: none;
            background: #333;
            height: 6px;
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }
        .mlmap-range::-webkit-slider-runnable-track {
            height: 6px;
            border-radius: 3px;
        }
        .mlmap-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #aaa;
            cursor: pointer;
            margin-top: -4px;
        }
        .mlmap-range::-webkit-slider-thumb:hover { background: #fff; }
        .mlmap-range::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #aaa;
            cursor: pointer;
            border: none;
        }
        .mlmap-range::-moz-range-track {
            height: 6px;
            border-radius: 3px;
            background: #333;
        }
        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .app-title {
            font-weight: 700;
            font-size: 14px;
            color: #fff;
            letter-spacing: -0.5px;
            margin-right: 8px;
        }
        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-dot.connected { background: #4CAF50; }
        .status-dot.disconnected { background: #555; }
        #mlmap-left::-webkit-scrollbar,
        #mlmap-right::-webkit-scrollbar { width: 5px; }
        #mlmap-left::-webkit-scrollbar-track,
        #mlmap-right::-webkit-scrollbar-track { background: #1a1a1a; }
        #mlmap-left::-webkit-scrollbar-thumb,
        #mlmap-right::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        .add-layer-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3px;
        }
        .ws-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 3px;
            margin-top: 4px;
        }
        /* Context menu */
        #mlmap-context-menu {
            position: fixed;
            background: #2a2a2a;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 4px 0;
            min-width: 180px;
            z-index: 1000010;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            font-family: -apple-system, 'Segoe UI', Roboto, sans-serif;
            font-size: 12px;
            color: #ccc;
            display: none;
            pointer-events: auto;
        }
        .ctx-item {
            padding: 6px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ctx-item:hover { background: #3a3a3a; color: #fff; }
        .ctx-item .shortcut { color: #666; font-size: 10px; margin-left: 16px; }
        .ctx-sep { height: 1px; background: #444; margin: 3px 8px; }
        .ctx-item.disabled { color: #555; pointer-events: none; }
        .ctx-has-sub {
            position: relative;
        }
        .ctx-has-sub > .ctx-item { cursor: default; }
        .ctx-arrow { margin-left: auto; padding-left: 12px; font-size: 10px; color: #666; }
        .ctx-submenu {
            position: absolute;
            left: 100%;
            top: -4px;
            background: #2a2a2a;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 4px 0;
            min-width: 170px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            display: none;
        }
        .ctx-has-sub:hover > .ctx-submenu { display: block; }
    `,document.head.appendChild(s);let i=new de("control"),o=null,n=[],h="mlmap.managedLayers",c=new me(()=>v());function v(){let a=[],l=d.getLayers(),r=new Map;for(let m of n){if(!m.clipTo)continue;let y=n.find(z=>z.id===m.clipTo);if(!y)continue;let g=l.find(z=>z.element.id===y.id),w=l.find(z=>z.element.id===m.id);if(!g||!w)continue;let D=document.getElementById(y.id);if(!D)continue;let $=D.querySelector("video");$&&(r.has(y.id)||r.set(y.id,{video:$,baseTargetPoints:g.targetPoints.map(z=>[z[0],z[1]]),masks:[]}),r.get(y.id).masks.push({targetPoints:w.targetPoints.map(z=>[z[0],z[1]])}))}for(let m of r.values())a.push(m);return a}function u(){return n.some(a=>!!a.clipTo)}function f(){u()?c.start():c.stop()}let b=document.createElement("div");b.id="mlmap-workspace",b.style.cssText="position:fixed;inset:0;transform-origin:center center;",document.body.appendChild(b);let L=document.createElement("div");L.id="mlmap-app",L.innerHTML=`
        <div id="mlmap-toolbar">
            <div class="toolbar-group">
                <span class="app-title">MLMap</span>
                <span style="font-size:10px;color:#666;">v${Y}</span>
                <button id="tb-toggleLeft" class="mlmap-btn" title="Toggle layers panel" style="font-size:10px;padding:4px 5px;">&laquo;</button>
            </div>
            <div class="toolbar-group">
                <span style="font-size:10px;color:#666;">Zoom</span>
                <input id="tb-zoom" type="range" min="25" max="100" value="100" class="mlmap-range" style="width:80px;" title="Workspace zoom">
                <span id="tb-zoomLabel" style="font-size:10px;color:#888;min-width:30px;">100%</span>
            </div>
            <div class="toolbar-group">
                <select id="tb-monitor" class="mlmap-select" title="Select output monitor" style="max-width:140px;">
                    <option value="">Monitor...</option>
                </select>
                <button id="tb-launch" class="mlmap-btn mlmap-btn-primary">Launch Output</button>
                <button id="tb-fullscreen" class="mlmap-btn" title="Fullscreen output">FS</button>
                <span class="status-dot disconnected" id="tb-status" title="Display disconnected"></span>
                <button id="tb-toggleRight" class="mlmap-btn" title="Toggle media panel" style="font-size:10px;padding:4px 5px;">&raquo;</button>
            </div>
        </div>
        <div id="mlmap-left"></div>
        <div id="mlmap-right"></div>
        <div id="mlmap-transport"></div>
    `,document.body.appendChild(L),L.addEventListener("mousedown",a=>a.stopPropagation());let E=document.createElement("div");E.id="mlmap-context-menu",document.body.appendChild(E),E.addEventListener("mousedown",a=>a.stopPropagation());let S=document.getElementById("mlmap-left"),P=document.getElementById("mlmap-right"),C=document.getElementById("mlmap-transport");S.innerHTML=`
        <div class="mlmap-section">
            <div class="mlmap-section-title">Layers</div>
            <div id="lp-layerList"></div>
            <div class="mlmap-section-title" style="margin-top:8px;">Add Layer</div>
            <div class="add-layer-grid">
                <button id="lp-addSquare" class="mlmap-btn">&#9633; Square</button>
                <button id="lp-addCircle" class="mlmap-btn">&#9675; Circle</button>
                <button id="lp-addTriangle" class="mlmap-btn">&#9651; Triangle</button>
                <button id="lp-addIframe" class="mlmap-btn">&#8865; iframe</button>
            </div>
            <div class="mlmap-section-title" style="margin-top:8px;">Options</div>
            <label style="display:flex;align-items:center;gap:4px;font-size:11px;cursor:pointer;">
                <input type="checkbox" id="lp-snap" checked> Snap to edges (G)
            </label>
        </div>
        <div class="mlmap-section">
            <div class="mlmap-section-title">Workspaces</div>
            <select id="lp-wsSelect" class="mlmap-select" style="width:100%;"></select>
            <div class="ws-grid">
                <button id="lp-wsAdd" class="mlmap-btn" title="New">+</button>
                <button id="lp-wsDup" class="mlmap-btn" title="Duplicate">&#128203;</button>
                <button id="lp-wsRen" class="mlmap-btn" title="Rename">&#9998;</button>
                <button id="lp-wsReset" class="mlmap-btn" title="Reset">&#8634;</button>
                <button id="lp-wsDel" class="mlmap-btn" title="Delete">&#128465;</button>
            </div>
            <div class="mlmap-section-title" style="margin-top:8px;">Import / Export</div>
            <div style="display:flex;flex-direction:column;gap:3px;">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;">
                    <button id="lp-wfExport" class="mlmap-btn" title="Export workflow to .mlmap file">Export File</button>
                    <button id="lp-wfImport" class="mlmap-btn" title="Import workflow from .mlmap file">Import File</button>
                </div>
                <button id="lp-wfShare" class="mlmap-btn mlmap-btn-primary" title="Copy share URL to clipboard" style="width:100%;">Copy Share URL</button>
            </div>
        </div>
        <div class="mlmap-section" style="border-bottom:none;">
            <div class="mlmap-section-title">Shortcuts</div>
            <pre style="font-size:10px;color:#666;margin:0;white-space:pre-wrap;line-height:1.5;">SHIFT+Space: Toggle edit mode
Drag: Move | SHIFT+Drag: Precise
ALT+Drag: Rotate/Scale
Ctrl+Click: Multi-select layers
Drag empty: Rubber band select
Arrows: Move | S: Solo | C: Cross
R: Rotate | H/V: Flip | B: Bounds
DEL: Delete | Ctrl+Z/Y: Undo/Redo
G: Toggle snap | Right-click: Menu</pre>
        </div>
    `;let A=et(P,C,i,K);function _(a,l){!l||!l.startsWith("blob:")||fetch(l).then(r=>r.arrayBuffer()).then(r=>{i.send("SEND_VIDEO_DATA",{layerId:a,data:r,mimeType:"video/mp4"})}).catch(()=>{})}function K(a,l,r){let m=`vlayer_${Date.now()}`,y=document.createElement("div");y.id=m,y.style.position="fixed",y.style.top="0px",y.style.left="0px",y.style.width="400px",y.style.height="300px",y.style.overflow="hidden",y.style.background="#000";let g=document.createElement("video");r?(g.srcObject=r,g.autoplay=!0):(g.src=a,g.preload="metadata"),g.style.width="100%",g.style.height="100%",g.style.objectFit="contain",g.muted=!0,g.playsInline=!0,y.appendChild(g),r&&r.getTracks().forEach(z=>{z.addEventListener("ended",()=>{if(r.getTracks().every(q=>q.readyState==="ended")){g.srcObject=null,y.innerHTML="";let q=document.createElement("div");q.className="mlmap-video-placeholder",q.style.cssText="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none;",q.innerHTML=`<span style="font-size:18px;color:#555;">&#9632;</span><span style="font-size:10px;color:#555;margin-top:2px;">${l}</span><span style="font-size:9px;color:#444;margin-top:2px;">Capture ended</span>`,y.appendChild(q),U()}})}),b.appendChild(y);let w=window.innerWidth/2,D=window.innerHeight/2;d.addLayer(y,[[w-200,D-150],[w+200,D-150],[w+200,D+150],[w-200,D+150]]),A.registerVideoElement(g);let $={id:m,name:l,type:"video",videoUrl:r?void 0:a,width:400,height:300};n.push($),p(),U(),i.send("ADD_LAYER",$),!r&&a&&_(m,a),setTimeout(()=>i.send("UPDATE_LAYOUT",{layout:d.getLayout()}),100)}function J(a){let l=`shape_${Date.now()}`,r=document.createElement("div");r.id=l;let m=window.innerWidth/2,y=window.innerHeight/2;r.style.position="fixed",r.style.top="0px",r.style.left="0px",r.style.width="100px",r.style.height="100px",r.style.background=a==="triangle"?"transparent":"white",r.style.border=a==="triangle"?"2px solid white":"none",a==="circle"&&(r.style.borderRadius="50%"),a==="triangle"&&(r.style.width="0",r.style.height="0",r.style.borderLeft="50px solid transparent",r.style.borderRight="50px solid transparent",r.style.borderBottom="100px solid white"),b.appendChild(r);let g=50,w=50,D=a==="triangle"?[[m,y-w],[m+g,y+w],[m-g,y+w],[m,y+w]]:[[m-g,y-w],[m+g,y-w],[m+g,y+w],[m-g,y+w]];d.addLayer(r,D);let $={id:l,name:`${a}`,type:"shape",shapeType:a,width:100,height:100};n.push($),p(),U(),i.send("ADD_LAYER",$),setTimeout(()=>i.send("UPDATE_LAYOUT",{layout:d.getLayout()}),100)}function fe(a){let l=`iframe_${Date.now()}`,r=document.createElement("div");r.id=l,r.style.position="fixed",r.style.top="0px",r.style.left="0px",r.style.width="400px",r.style.height="300px",r.style.overflow="hidden",r.style.background="#000";let m=document.createElement("iframe");m.src=a,m.style.width="100%",m.style.height="100%",m.style.border="none",m.style.pointerEvents="none",m.setAttribute("allow","autoplay; encrypted-media"),r.appendChild(m),b.appendChild(r);let y=window.innerWidth/2,g=window.innerHeight/2;d.addLayer(r,[[y-200,g-150],[y+200,g-150],[y+200,g+150],[y-200,g+150]]);let w=a.replace(/^https?:\/\//,"").split("/")[0]||"iframe",D={id:l,name:w,type:"iframe",iframeUrl:a,width:400,height:300};n.push(D),p(),U(),i.send("ADD_LAYER",D),setTimeout(()=>i.send("UPDATE_LAYOUT",{layout:d.getLayout()}),100)}function W(a){n.forEach(m=>{m.clipTo===a&&Z(m.id)}),n.find(m=>m.id===a)?.clipTo&&Z(a);let r=document.getElementById(a);r&&r.remove(),n=n.filter(m=>m.id!==a),p(),U(),i.send("REMOVE_LAYER",{id:a}),f()}function X(a){let l=n.find(w=>w.id===a);if(!l||l.type!=="shape")return;let r=n.indexOf(l),m=null;for(let w=r-1;w>=0;w--)if(n[w].type==="video"){m=n[w].id;break}if(!m){for(let w=r+1;w<n.length;w++)if(n[w].type==="video"){m=n[w].id;break}}if(!m)return;l.clipTo=m;let y=document.getElementById(m);y&&(y.style.opacity="0");let g=document.getElementById(a);if(g&&(g.style.opacity="0"),y){let w=y.querySelector("video");w&&(w.paused&&w.play().catch(()=>{}),A.setActiveVideo(w))}p(),U(),f(),i.send("ADD_LAYER",l)}function Z(a){let l=n.find(g=>g.id===a);if(!l||!l.clipTo)return;let r=l.clipTo;l.clipTo=void 0;let m=document.getElementById(a);if(m&&(m.style.opacity="1",l.shapeType==="triangle"?m.style.borderBottomColor="white":(l.shapeType,m.style.background="white")),!n.some(g=>g.clipTo===r)){let g=document.getElementById(r);g&&(g.style.opacity="1")}p(),U(),f(),i.send("ADD_LAYER",l)}function V(){let l=d.getLayers().map(r=>r.element.id);n.sort((r,m)=>{let y=l.indexOf(r.id),g=l.indexOf(m.id);return y-g}),p(),U()}function U(){let a=document.getElementById("lp-layerList");if(a.innerHTML="",n.length===0){a.innerHTML='<div style="color:#555;font-size:11px;padding:4px;">No layers</div>';return}n.forEach(l=>{let r=document.createElement("div");r.className="mlmap-layer-item",l.clipTo&&(r.style.paddingLeft="18px");let m=document.createElement("span");m.className="icon",l.type==="video"?m.textContent="\u25B6":l.type==="iframe"?m.textContent="\u29C9":l.shapeType==="circle"?m.textContent="\u25CF":l.shapeType==="triangle"?m.textContent="\u25B2":m.textContent="\u25A0";let y=l.type==="video"&&!document.getElementById(l.id)?.querySelector("video"),g=document.createElement("span");g.className="name",l.clipTo?g.textContent=`${l.name} (clip)`:y?(g.textContent=`${l.name}`,g.style.color="#f80"):g.textContent=l.name;let w=document.createElement("button");w.className="del-btn",w.textContent="\u2715",w.addEventListener("click",()=>W(l.id)),r.appendChild(m),r.appendChild(g),r.appendChild(w),a.appendChild(r)})}function p(){let a=n.map(l=>l.type==="video"?{...l,videoUrl:void 0}:l);localStorage.setItem(h,JSON.stringify(a))}function x(){try{let a=localStorage.getItem(h);a&&JSON.parse(a).forEach(m=>k(m));let l=localStorage.getItem("mlmap.dynamicShapes");l&&!a&&JSON.parse(l).forEach(m=>{let y={id:m.id,name:m.type,type:"shape",shapeType:m.type,width:100,height:100};k(y)})}catch{}U()}function k(a){let l=document.createElement("div");if(l.id=a.id,l.style.position="fixed",l.style.top="0px",l.style.left="0px",l.style.width=a.width+"px",l.style.height=a.height+"px",a.type==="video"){l.style.overflow="hidden",l.style.background="#111";let r=document.createElement("div");r.className="mlmap-video-placeholder",r.style.cssText="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none;",r.innerHTML=`<span style="font-size:18px;color:#555;">\u25B6</span><span style="font-size:10px;color:#555;margin-top:2px;">${a.name}</span><span style="font-size:9px;color:#444;margin-top:2px;">Re-import video</span>`,l.appendChild(r)}else if(a.type==="iframe"&&a.iframeUrl){l.style.overflow="hidden",l.style.background="#000";let r=document.createElement("iframe");r.src=a.iframeUrl,r.style.width="100%",r.style.height="100%",r.style.border="none",r.style.pointerEvents="none",r.setAttribute("allow","autoplay; encrypted-media"),l.appendChild(r)}else a.shapeType==="circle"?(l.style.background="white",l.style.borderRadius="50%"):a.shapeType==="triangle"?(l.style.width="0",l.style.height="0",l.style.borderLeft="50px solid transparent",l.style.borderRight="50px solid transparent",l.style.borderBottom="100px solid white",l.style.background="transparent"):l.style.background="white";b.appendChild(l),d.addLayer(l),n.push(a)}function I(a,l,r){let m=n.find(w=>w.id===a);if(!m||m.type!=="video")return;let y=document.getElementById(a);if(!y)return;y.innerHTML="",y.style.background="#000";let g=document.createElement("video");g.src=l,g.style.width="100%",g.style.height="100%",g.style.objectFit="contain",g.muted=!0,g.playsInline=!0,g.preload="metadata",y.appendChild(g),A.registerVideoElement(g),m.name=r,m.videoUrl=l,p(),U(),n.some(w=>w.clipTo===a)&&(g.play().catch(()=>{}),f()),i.send("ADD_LAYER",m),_(a,l),setTimeout(()=>i.send("UPDATE_LAYOUT",{layout:d.getLayout()}),100)}function N(a,l,r){let m=n.find(w=>w.id===a);if(!m||m.type!=="video")return;let y=document.getElementById(a);if(!y)return;y.innerHTML="",y.style.background="#000";let g=document.createElement("video");g.srcObject=l,g.autoplay=!0,g.style.width="100%",g.style.height="100%",g.style.objectFit="contain",g.muted=!0,g.playsInline=!0,y.appendChild(g),l.getTracks().forEach(w=>{w.addEventListener("ended",()=>{if(l.getTracks().every(D=>D.readyState==="ended")){g.srcObject=null,y.innerHTML="";let D=document.createElement("div");D.className="mlmap-video-placeholder",D.style.cssText="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none;",D.innerHTML=`<span style="font-size:18px;color:#555;">&#9632;</span><span style="font-size:10px;color:#555;margin-top:2px;">${r}</span><span style="font-size:9px;color:#444;margin-top:2px;">Capture ended</span>`,y.appendChild(D),U()}})}),A.registerVideoElement(g),m.name=r,m.videoUrl=void 0,p(),U(),n.some(w=>w.clipTo===a)&&f(),i.send("ADD_LAYER",m),setTimeout(()=>i.send("UPDATE_LAYOUT",{layout:d.getLayout()}),100)}document.getElementById("lp-addSquare").addEventListener("click",()=>J("square")),document.getElementById("lp-addCircle").addEventListener("click",()=>J("circle")),document.getElementById("lp-addTriangle").addEventListener("click",()=>J("triangle")),document.getElementById("lp-addIframe").addEventListener("click",()=>{let a=prompt("Enter URL for iframe:","https://");a&&a!=="https://"&&fe(a)});let B=document.getElementById("lp-snap");B.checked=d.snapEnabled,B.addEventListener("change",()=>{d.snapEnabled=B.checked}),d.onSnapChanged=a=>{B.checked=a};function O(a,l,r){d.selectLayer(r);let m=r.element.id,y=n.find(se=>se.id===m),g=y?.type==="shape",w=y?.type==="video",D=!!y?.clipTo,$="",z=n.some(se=>se.type==="video");g&&!D&&z?$="Create Clip Mask":D&&($="Release Clip Mask"),E.innerHTML=`
            <div class="ctx-item" data-action="center">Center on screen</div>
            <div class="ctx-sep"></div>
            ${w?`
            <div class="ctx-has-sub">
                <div class="ctx-item" style="color:#5af;">Assign Video<span class="ctx-arrow">\u25B6</span></div>
                <div class="ctx-submenu">
                    <div class="ctx-item" data-action="assignFile">Browse file...</div>
                    <div class="ctx-item" data-action="assignUrl">Enter URL...</div>
                    <div class="ctx-sep"></div>
                    <div class="ctx-item" data-action="assignCapture">Screen capture...</div>
                    <div class="ctx-item" data-action="assignWebcam">Webcam...</div>
                </div>
            </div>
            <div class="ctx-sep"></div>`:""}
            <div class="ctx-has-sub">
                <div class="ctx-item">Layer Order<span class="ctx-arrow">\u25B6</span></div>
                <div class="ctx-submenu">
                    <div class="ctx-item" data-action="moveUp">Move Up</div>
                    <div class="ctx-item" data-action="moveDown">Move Down</div>
                    <div class="ctx-sep"></div>
                    <div class="ctx-item" data-action="sendToTop">Send to Top</div>
                    <div class="ctx-item" data-action="sendToBottom">Send to Bottom</div>
                </div>
            </div>
            <div class="ctx-has-sub">
                <div class="ctx-item">Transform<span class="ctx-arrow">\u25B6</span></div>
                <div class="ctx-submenu">
                    <div class="ctx-item" data-action="rotate90">Rotate 90\xB0</div>
                    <div class="ctx-item" data-action="rotate180">Rotate 180\xB0</div>
                    <div class="ctx-item" data-action="rotate270">Rotate 270\xB0</div>
                    <div class="ctx-sep"></div>
                    <div class="ctx-item" data-action="flipH">Flip Horizontal</div>
                    <div class="ctx-item" data-action="flipV">Flip Vertical</div>
                    <div class="ctx-sep"></div>
                    <div class="ctx-item" data-action="scaleUp">Scale +10%</div>
                    <div class="ctx-item" data-action="scaleDown">Scale -10%</div>
                    <div class="ctx-sep"></div>
                    <div class="ctx-item" data-action="resetTransform">Reset Transform</div>
                </div>
            </div>
            <div class="ctx-sep"></div>
            ${$?`<div class="ctx-item" data-action="toggleClip">${$}</div><div class="ctx-sep"></div>`:""}
            <div class="ctx-item" data-action="solo">Solo / Unsolo<span class="shortcut">S</span></div>
            <div class="ctx-item" data-action="delete" style="color:#f55;">Delete layer<span class="shortcut">DEL</span></div>
        `;let q=200,Me=300,ut=a+q>window.innerWidth?a-q:a,ft=l+Me>window.innerHeight?l-Me:l;E.style.left=Math.max(0,ut)+"px",E.style.top=Math.max(0,ft)+"px",E.style.display="block",E.querySelectorAll(".ctx-item[data-action]").forEach(se=>{se.addEventListener("click",yt=>{switch(yt.stopPropagation(),se.dataset.action){case"center":d.centerLayer(r);break;case"moveUp":d.moveLayerUp(r),V();break;case"moveDown":d.moveLayerDown(r),V();break;case"sendToTop":d.moveLayerToTop(r),V();break;case"sendToBottom":d.moveLayerToBottom(r),V();break;case"rotate90":d.rotateLayerPublic(r,90);break;case"rotate180":d.rotateLayerPublic(r,180);break;case"rotate270":d.rotateLayerPublic(r,270);break;case"flipH":d.flipLayerH(r);break;case"flipV":d.flipLayerV(r);break;case"scaleUp":d.scaleLayerPublic(r,1.1);break;case"scaleDown":d.scaleLayerPublic(r,.9);break;case"resetTransform":d.resetLayerTransform(r);break;case"toggleClip":D?Z(m):X(m);break;case"assignFile":{let R=document.createElement("input");R.type="file",R.accept="video/*",R.onchange=()=>{let F=R.files?.[0];if(F){let ne=URL.createObjectURL(F);I(m,ne,F.name)}},R.click();break}case"assignUrl":{let R=prompt("Enter video URL:","https://");if(R&&R!=="https://"){let F=R.split("/").pop()||"Video URL";I(m,R,F)}break}case"assignCapture":{(async()=>{try{let R=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!0}),ne=R.getVideoTracks()[0]?.label||"Screen Capture";N(m,R,ne)}catch{}})();break}case"assignWebcam":{(async()=>{try{let F=(await navigator.mediaDevices.enumerateDevices()).filter(xe=>xe.kind==="videoinput"),ne={video:!0,audio:!0};if(F.length>1){let xe=F.map((vt,Be)=>`${Be+1}. ${vt.label||`Camera ${Be+1}`}`).join(`
`),Ae=prompt(`Select camera:
${xe}`,"1");if(!Ae)return;let we=parseInt(Ae)-1;we>=0&&we<F.length&&(ne={video:{deviceId:{exact:F[we].deviceId}},audio:!0})}let De=await navigator.mediaDevices.getUserMedia(ne),gt=De.getVideoTracks()[0]?.label||"Webcam";N(m,De,gt)}catch{}})();break}case"solo":let be=d.getLayers();be.some(R=>!R.visible)?be.forEach(R=>R.visible=!0):(be.forEach(R=>R.visible=!1),r.visible=!0);break;case"delete":W(m);break}H()})})}function H(){E.style.display="none"}document.addEventListener("contextmenu",a=>{let l=a.target;if(l.closest("#mlmap-app")||l.closest("#mlmap-context-menu"))return;let r=d.getLayerAtPoint(a.clientX,a.clientY);r&&(a.preventDefault(),O(a.clientX,a.clientY,r))}),document.addEventListener("mousedown",a=>{a.target.closest("#mlmap-context-menu")||H()}),document.addEventListener("keydown",a=>{a.key==="Escape"&&H()});let M=Fe(),T=M.find(a=>a.id===localStorage.getItem("mlmap:currentWorkspaceId"))||null;!T&&M.length&&(T=M[0],localStorage.setItem("mlmap:currentWorkspaceId",T.id));function j(){let a=document.getElementById("lp-wsSelect");a.innerHTML="",M.forEach(l=>{let r=document.createElement("option");r.value=l.id,r.textContent=l.name,T&&T.id===l.id&&(r.selected=!0),a.appendChild(r)})}function Q(a){localStorage.setItem("mlmap:currentWorkspaceId",a.id),window.location.reload()}document.getElementById("lp-wsAdd").addEventListener("click",()=>{let a=prompt("Workspace name:","New Workspace")||"New Workspace",l={id:Date.now().toString(),name:a,version:"1.0",layout:{}};M.push(l),ie(l),Q(l)}),document.getElementById("lp-wsDup").addEventListener("click",()=>{if(!T)return;let a=prompt("New name:",T.name+" (Copy)")||T.name+" (Copy)",l={id:Date.now().toString(),name:a,version:"1.0",layout:T.layout};M.push(l),ie(l),Q(l)}),document.getElementById("lp-wsRen").addEventListener("click",()=>{if(!T)return;let a=prompt("New name:",T.name);a&&(T.name=a,ie(T),j())}),document.getElementById("lp-wsReset").addEventListener("click",()=>{T&&confirm("Reset workspace? This will clear all layer positions.")&&(Ye(T.id),window.location.reload())}),document.getElementById("lp-wsDel").addEventListener("click",()=>{!T||M.length<=1||confirm("Delete workspace '"+T.name+"'?")&&(_e(T.id),M=M.filter(a=>a.id!==T?.id),M.length&&Q(M[0]))}),document.getElementById("lp-wsSelect").addEventListener("change",a=>{let l=M.find(r=>r.id===a.target.value);l&&Q(l)}),j(),document.getElementById("lp-wfExport").addEventListener("click",()=>{let a=Ce(T?.name);rt(a)}),document.getElementById("lp-wfImport").addEventListener("click",async()=>{let a=await lt();a&&(Pe(a),window.location.reload())}),document.getElementById("lp-wfShare").addEventListener("click",()=>{let a=Ce(T?.name),l=ot(a);navigator.clipboard.writeText(l).then(()=>{let r=document.getElementById("lp-wfShare"),m=r.textContent;r.textContent="Copied!",r.style.background="#4CAF50",setTimeout(()=>{r.textContent=m,r.style.background=""},2e3)}).catch(()=>{prompt("Share URL (copy manually):",l)})});let ee=document.getElementById("tb-launch");function ye(){o&&!o.closed?(ee.textContent="Stop Output",ee.classList.remove("mlmap-btn-primary"),ee.style.background="#a33"):(ee.textContent="Launch Output",ee.classList.add("mlmap-btn-primary"),ee.style.background="",o=null)}ee.addEventListener("click",()=>{if(o&&!o.closed){o.close(),o=null,ye();return}let a=document.getElementById("tb-monitor"),l=parseInt(a.value),r="width=1280,height=720";if(!isNaN(l)&&window._mlmapScreens&&window._mlmapScreens[l]){let y=window._mlmapScreens[l];r=`left=${y.availLeft},top=${y.availTop},width=${y.availWidth},height=${y.availHeight}`}o=window.open(Ue,"mlmap-display",r),ye();let m=setInterval(()=>{(!o||o.closed)&&(clearInterval(m),o=null,ye())},1e3)}),document.getElementById("tb-fullscreen").addEventListener("click",()=>{i.send("FULLSCREEN_ENTER")}),i.onConnectionChanged=a=>{let l=document.getElementById("tb-status");l.className=a?"status-dot connected":"status-dot disconnected",l.title=a?"Display connected":"Display disconnected"},i.on("DISPLAY_READY",()=>{n.forEach(a=>i.send("ADD_LAYER",a)),setTimeout(()=>{i.send("UPDATE_LAYOUT",{layout:d.getLayout()}),A.sendPlaylistToDisplay(),n.forEach(a=>{if(a.type==="video"){let r=document.getElementById(a.id)?.querySelector("video");r&&r.src&&r.src.startsWith("blob:")&&_(a.id,r.src)}}),setTimeout(()=>A.syncPlaybackToDisplay(),500)},200)});async function pt(){let a=document.getElementById("tb-monitor");try{if("getScreenDetails"in window){let l=await window.getScreenDetails();window._mlmapScreens=l.screens,a.innerHTML='<option value="">Select monitor...</option>',l.screens.forEach((r,m)=>{let y=document.createElement("option");y.value=String(m);let g=r.label||`Monitor ${m+1}`;y.textContent=`${g} (${r.width}x${r.height})`,r.isPrimary||(y.textContent+=" *"),a.appendChild(y)})}else a.innerHTML=`<option value="">Default (${screen.width}x${screen.height})</option>`}catch{a.innerHTML=`<option value="">Default (${screen.width}x${screen.height})</option>`}}pt();let oe=!0,ae=!0;function Ie(){let a=oe?"210px":"0px",l=ae?"270px":"0px";L.style.gridTemplateColumns=`${a} 1fr ${l}`,S.style.display=oe?"flex":"none",P.style.display=ae?"flex":"none",document.getElementById("tb-toggleLeft").innerHTML=oe?"&laquo;":"&raquo;",document.getElementById("tb-toggleRight").innerHTML=ae?"&raquo;":"&laquo;"}document.getElementById("tb-toggleLeft").addEventListener("click",()=>{oe=!oe,Ie()}),document.getElementById("tb-toggleRight").addEventListener("click",()=>{ae=!ae,Ie()});let ge=document.getElementById("tb-zoom"),ht=document.getElementById("tb-zoomLabel");ge.addEventListener("input",()=>{let a=parseInt(ge.value)/100;b.style.transform=a<1?`scale(${a})`:"",ht.textContent=`${ge.value}%`,d.setWorkspaceZoom(a),c.zoom=a}),document.body.appendChild(c.canvasElement);let mt=d.setConfigEnabled;d.setConfigEnabled=function(a){mt.call(d,a),L.style.display=a?"grid":"none",a||ve()};function ve(){let a=new Set;for(let l of n){if(!l.clipTo)continue;let r=document.getElementById(l.id);r&&(r.style.opacity="0"),a.add(l.clipTo)}for(let l of a){let r=document.getElementById(l);r&&(r.style.opacity="0")}}d.onAfterDraw=ve,d.layoutChangeListener=()=>{T&&(T.layout=d.getLayout(),ie(T)),i.send("UPDATE_LAYOUT",{layout:d.getLayout()})},document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&A.syncPlaybackToDisplay()}),new MutationObserver(a=>{for(let l of a)l.type==="childList"&&l.removedNodes.length>0&&l.removedNodes.forEach(r=>{if(r instanceof HTMLElement&&!r.isConnected){let m=n.findIndex(y=>y.id===r.id);m!==-1&&(n.splice(m,1),p(),U(),i.send("REMOVE_LAYER",{id:r.id}))}})}).observe(document.body,{childList:!0,subtree:!0}),x(),T?.layout&&d.setLayout(T.layout),ve(),f(),S.addEventListener("keydown",a=>{let l=a.target.tagName;(l==="INPUT"||l==="SELECT"||l==="TEXTAREA")&&a.stopPropagation()}),ce().then(a=>{if(a.latest!==Y){let l=L.querySelector(".app-title");l&&l.setAttribute("title",`Update available: v${a.latest}`)}})}le();var ue=class{constructor(e={}){this.onAfterDraw=null;this.layers=[];this.configActive=!1;this.dragging=!1;this.dragOffset=[0,0];this.selectedLayer=null;this.selectedLayers=[];this.selectedPoint=null;this.selectionRadius=20;this.hoveringPoint=null;this.hoveringLayer=null;this.isLayerSoloed=!1;this.snapEnabled=!0;this.onSnapChanged=null;this.SNAP_THRESHOLD=12;this.workspaceZoom=1;this.rubberBandActive=!1;this.rubberBandStart=[0,0];this.rubberBandEnd=[0,0];this.rubberBandBaseSelection=[];this.mousePosition=[0,0];this.mouseDelta=[0,0];this.mouseDownPoint=[0,0];this.keyDown=this.keyDown.bind(this),this.setConfigEnabled=this.setConfigEnabled.bind(this),this.showLayerNames=this.getProp(e,"labels",!0),this.showCrosshairs=this.getProp(e,"crosshairs",!1),this.showScreenBounds=this.getProp(e,"screenbounds",!1),this.autoSave=this.getProp(e,"autoSave",!0),this.autoLoad=this.getProp(e,"autoLoad",!0),this.layerList=this.getProp(e,"layers",[]),this.layoutChangeListener=this.getProp(e,"onchange",()=>{}),this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.initCanvas(),this.loadSettings();for(let s of this.layerList)(s instanceof HTMLElement||typeof s=="string")&&this.addLayer(s);this.autoLoad&&this.loadSettings(),this.pushHistory(),new MutationObserver(s=>{s.forEach(i=>{i.removedNodes.forEach(o=>{o.isConnected||this.layers.forEach((n,h)=>{n.element===o&&(n.overlay&&n.overlay.remove(),this.layers.splice(h,1))})})})}).observe(document.body,{childList:!0,subtree:!0})}getProp(e,t,s){return e&&e.hasOwnProperty(t)&&e[t]!==null?e[t]:s}initCanvas(){this.canvas.style.display="none",this.canvas.style.position="fixed",this.canvas.style.top="0px",this.canvas.style.left="0px",this.canvas.style.zIndex="1000000",this.context=this.canvas.getContext("2d"),document.body.appendChild(this.canvas),window.addEventListener("resize",this.resize.bind(this)),window.addEventListener("mousemove",this.mouseMove.bind(this)),window.addEventListener("mouseup",this.mouseUp.bind(this)),window.addEventListener("mousedown",this.mouseDown.bind(this)),window.addEventListener("keydown",this.keyDown.bind(this)),this.resize()}pushHistory(){let e=this.getLayout();G.push(JSON.stringify(e)),G.length>50&&G.shift(),re.length=0}saveSettings(){let e=ke();ie({id:e?.id,name:e?.name,version:e?.version,layout:this.getLayout()})}loadSettings(){try{let e=ke();e?.version==="1.0"&&e?.layout?this.setLayout(e.layout):console.warn("MLMap: localStorage version mismatch, skipping load.")}catch(e){console.error("MLMap: Failed to parse layout from localStorage.",e)}}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.draw()}pointInTriangle(e,t,s,i){let o=t[1]*i[0]-t[0]*i[1]+(i[1]-t[1])*e[0]+(t[0]-i[0])*e[1],n=t[0]*s[1]-t[1]*s[0]+(t[1]-s[1])*e[0]+(s[0]-t[0])*e[1];if(o<0!=n<0)return!1;let h=-s[1]*i[0]+t[1]*(i[0]-s[0])+t[0]*(s[1]-i[1])+s[0]*i[1];return h<0&&(o=-o,n=-n,h=-h),o>0&&n>0&&o+n<h}pointInLayer(e,t){let[s,i,o,n]=t.targetPoints;return this.pointInTriangle(e,s,i,o)||this.pointInTriangle(e,n,s,o)}updateTransform(){let e=["","-webkit-","-moz-","-ms-","-o-"],t="transform";for(let s of e){let i=s+"transform";if(i in document.body.style){t=i;break}}for(let s=0;s<this.layers.length;s++){let i=[],o=[];for(let v=0,u=this.layers[s].sourcePoints.length;v<u;++v){let f=this.layers[s].sourcePoints[v],b=this.layers[s].targetPoints[v];i.push([f[0],f[1],1,0,0,0,-f[0]*b[0],-f[1]*b[0]]),o.push(b[0]),i.push([0,0,0,f[0],f[1],1,-f[0]*b[1],-f[1]*b[1]]),o.push(b[1])}let n=$e(i,o,!0),h=[n[0],n[3],0,n[6],n[1],n[4],0,n[7],0,0,1,0,n[2],n[5],0,1],c=this.layers[s].element.style;c.setProperty(t,`matrix3d(${h.join(",")})`),c.setProperty(`${t}-origin`,"0px 0px 0px")}}rotateLayer(e,t){for(var s=Math.sin(t),i=Math.cos(t),o=[0,0],n=0;n<e.targetPoints.length;n++)o[0]+=e.targetPoints[n][0],o[1]+=e.targetPoints[n][1];o[0]/=4,o[1]/=4;for(var n=0;n<e.targetPoints.length;n++){var h=e.targetPoints[n][0]-o[0],c=e.targetPoints[n][1]-o[1];e.targetPoints[n][0]=h*i-c*s+o[0],e.targetPoints[n][1]=h*s+c*i+o[1]}}scaleLayer(e,t){for(var s=[0,0],i=0;i<e.targetPoints.length;i++)s[0]+=e.targetPoints[i][0],s[1]+=e.targetPoints[i][1];s[0]/=4,s[1]/=4;for(var i=0;i<e.targetPoints.length;i++){var o=e.targetPoints[i][0]-s[0],n=e.targetPoints[i][1]-s[1];e.targetPoints[i][0]=o*t+s[0],e.targetPoints[i][1]=n*t+s[1]}}undo(){if(G.length>1){re.push(G.pop());var e=JSON.parse(G[G.length-1]);this.setLayout(e),this.draw(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}}redo(){if(re.length>0){let e=re.pop();G.push(e),this.setLayout(JSON.parse(e)),this.draw(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}}swapLayerPoints(e,t,s){var i=e[t][0],o=e[t][1];e[t][0]=e[s][0],e[t][1]=e[s][1],e[s][0]=i,e[s][1]=o}addLayer(e,t){let s=null;if(typeof e=="string"){if(s=document.getElementById(e),!s)throw new Error("MLMap: No element found with id: "+e)}else if(e instanceof HTMLElement)s=e;else throw new Error("MLMap: Invalid target");for(let o=0;o<this.layers.length;o++)if(this.layers[o].element.id===s.id){t&&(this.layers[o].targetPoints=te(t));return}s.style.position="fixed",s.style.display="block",s.style.top="0px",s.style.left="0px",s.style.padding="0px",s.style.margin="0px";let i={visible:!0,element:s,width:s.clientWidth,height:s.clientHeight,sourcePoints:[[0,0],[s.clientWidth,0],[s.clientWidth,s.clientHeight],[0,s.clientHeight]],targetPoints:[]};if(t)i.targetPoints=te(t);else{let[o,n]=Ve(i.width,i.height,this.layers);i.targetPoints=[[o,n],[o+i.width,n],[o+i.width,n+i.height],[o,n+i.height]]}this.layers.push(i),s.parentElement?.appendChild(s),this.updateTransform()}removeLayer(e){let t=typeof e=="string"?document.getElementById(e):e;if(t){for(let s=this.layers.length-1;s>=0;s--)this.layers[s].element===t&&(this.layers[s].overlay&&this.layers[s].overlay?.remove(),this.layers.splice(s,1));this.updateTransform()}}setLayout(e){for(var t=0;t<e.length;t++){for(var s=!1,i=0;i<this.layers.length;i++)this.layers[i].element.id==e[t].id&&(console.log("Setting points."),this.layers[i].targetPoints=te(e[t].targetPoints),this.layers[i].sourcePoints=te(e[t].sourcePoints),s=!0);if(s)console.log('MLMap: Element "" + layout[i].id + "" is already mapped.');else{var o=document.getElementById(e[t].id);o?this.addLayer(o,e[t].targetPoints):console.log('MLMap: Can"t find element: '+e[t].id)}}this.updateTransform(),this.draw()}getLayout(){for(var e=[],t=0;t<this.layers.length;t++)e.push({id:this.layers[t].element.id,targetPoints:te(this.layers[t].targetPoints),sourcePoints:te(this.layers[t].sourcePoints)});return e}setConfigEnabled(e){this.configActive=e,this.canvas.style.display=e?"block":"none",e?this.draw():(this.selectedPoint=null,this.selectedLayer=null,this.selectedLayers=[],this.dragging=!1,this.rubberBandActive=!1,this.showScreenBounds=!1)}getSelectedLayer(){return this.selectedLayer}getLayers(){return this.layers}getLayerAtPoint(e,t){let[s,i]=this.toWorkspace(e,t);for(let o=this.layers.length-1;o>=0;o--){let n=this.layers[o];if(n.visible&&this.pointInLayer([s,i],n))return n}return null}selectLayer(e){this.selectedLayer=e,this.selectedLayers=e?[e]:[],this.selectedPoint=null,this.draw()}getSelectedLayers(){return[...this.selectedLayers]}centerLayer(e){let t=window.innerWidth/2,s=window.innerHeight/2,i=0,o=0;for(let c of e.targetPoints)i+=c[0],o+=c[1];i/=4,o/=4;let n=t-i,h=s-o;for(let c of e.targetPoints)c[0]+=n,c[1]+=h;this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}rotateLayerPublic(e,t){this.rotateLayer(e,t*Math.PI/180),this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}flipLayerH(e){this.swapLayerPoints(e.sourcePoints,0,1),this.swapLayerPoints(e.sourcePoints,3,2),this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}flipLayerV(e){this.swapLayerPoints(e.sourcePoints,0,3),this.swapLayerPoints(e.sourcePoints,1,2),this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}deleteSelectedLayer(e){e.element.remove(),e.overlay&&e.overlay.remove();let t=this.layers.indexOf(e);t>=0&&this.layers.splice(t,1),this.selectedLayer===e&&(this.selectedLayer=null);let s=this.selectedLayers.indexOf(e);s>=0&&this.selectedLayers.splice(s,1),this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}scaleLayerPublic(e,t){this.scaleLayer(e,t),this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}moveLayerUp(e){let t=this.layers.indexOf(e);t<0||t>=this.layers.length-1||(this.layers[t]=this.layers[t+1],this.layers[t+1]=e,this.reorderLayerDOM(),this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener())}moveLayerDown(e){let t=this.layers.indexOf(e);t<=0||(this.layers[t]=this.layers[t-1],this.layers[t-1]=e,this.reorderLayerDOM(),this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener())}moveLayerToTop(e){let t=this.layers.indexOf(e);t<0||t===this.layers.length-1||(this.layers.splice(t,1),this.layers.push(e),this.reorderLayerDOM(),this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener())}moveLayerToBottom(e){let t=this.layers.indexOf(e);t<=0||(this.layers.splice(t,1),this.layers.unshift(e),this.reorderLayerDOM(),this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener())}reorderLayerDOM(){for(let e of this.layers)e.element.parentElement?.appendChild(e.element)}resetLayerTransform(e){let t=window.innerWidth/2,s=window.innerHeight/2,i=e.width/2,o=e.height/2;e.targetPoints=[[t-i,s-o],[t+i,s-o],[t+i,s+o],[t-i,s+o]],e.sourcePoints=[[0,0],[e.width,0],[e.width,e.height],[0,e.height]],this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}layerIntersectsRect(e,t,s,i,o){let n=Math.min(t,i),h=Math.min(s,o),c=Math.max(t,i),v=Math.max(s,o),u=1/0,f=1/0,b=-1/0,L=-1/0;for(let E of e.targetPoints)E[0]<u&&(u=E[0]),E[1]<f&&(f=E[1]),E[0]>b&&(b=E[0]),E[1]>L&&(L=E[1]);return!(b<n||u>c||L<h||f>v)}draw(){if(this.configActive){if(this.context.strokeStyle="red",this.context.lineWidth=2,this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.workspaceZoom!==1){this.context.save();let e=this.canvas.width/2,t=this.canvas.height/2;this.context.translate(e,t),this.context.scale(this.workspaceZoom,this.workspaceZoom),this.context.translate(-e,-t)}for(let e=0;e<this.layers.length;e++){let t=this.layers[e];if(t.visible){t.element.style.visibility="visible",this.context.beginPath(),this.selectedLayers.includes(t)?this.context.strokeStyle="red":t===this.hoveringLayer?this.context.strokeStyle="red":this.context.strokeStyle="white",this.context.moveTo(t.targetPoints[0][0],t.targetPoints[0][1]);for(let i=0;i<t.targetPoints.length;i++)this.context.lineTo(t.targetPoints[i][0],t.targetPoints[i][1]);this.context.lineTo(t.targetPoints[3][0],t.targetPoints[3][1]),this.context.closePath(),this.context.stroke();let s=[0,0];for(let i=0;i<t.targetPoints.length;i++)t.targetPoints[i]===this.hoveringPoint?this.context.strokeStyle="red":t.targetPoints[i]===this.selectedPoint?this.context.strokeStyle="red":this.context.strokeStyle="white",s[0]+=t.targetPoints[i][0],s[1]+=t.targetPoints[i][1],this.context.beginPath(),this.context.arc(t.targetPoints[i][0],t.targetPoints[i][1],this.selectionRadius/2,0,2*Math.PI,!1),this.context.stroke();if(s[0]/=4,s[1]/=4,this.showLayerNames){let i=t.element.id.toUpperCase();this.context.font="16px sans-serif",this.context.textAlign="center";let o=this.context.measureText(i),n=[o.width+8,32];this.context.fillStyle="white";let h=window.innerHeight*.01,c=s[0],v=s[1];(t.width<o.width+10||t.height<20)&&(v=s[1]-t.height/2-10-h,v-n[1]/2<h&&(v=s[1]+t.height/2+20+h)),this.context.fillRect(c-n[0]/2,v-n[1]/2,n[0],n[1]),this.context.fillStyle="black",this.context.font="14px sans-serif",this.context.fillText(i,c,v)}}else t.element.style.visibility="hidden"}if(this.showCrosshairs&&(this.context.strokeStyle="yellow",this.context.lineWidth=1,this.context.beginPath(),this.context.moveTo(this.mousePosition[0],0),this.context.lineTo(this.mousePosition[0],this.canvas.height),this.context.moveTo(0,this.mousePosition[1]),this.context.lineTo(this.canvas.width,this.mousePosition[1]),this.context.stroke()),this.showScreenBounds){this.context.fillStyle="black",this.context.lineWidth=4,this.context.fillRect(0,0,this.canvas.width,this.canvas.height),this.context.strokeStyle="#909090",this.context.beginPath();let e=this.canvas.width/10,t=this.canvas.height/10;for(let i=0;i<10;i++)this.context.moveTo(i*e,0),this.context.lineTo(i*e,this.canvas.height),this.context.moveTo(0,i*t),this.context.lineTo(this.canvas.width,i*t);this.context.stroke(),this.context.strokeStyle="white",this.context.strokeRect(2,2,this.canvas.width-4,this.canvas.height-4);let s=Math.round(t*.6);this.context.font=`${s}px mono, sans-serif`,this.context.fillRect(e*2+2,t*3+2,this.canvas.width-e*4-4,this.canvas.height-t*6-4),this.context.fillStyle="white",this.context.font="20px sans-serif",this.context.fillText(`${this.canvas.width} x ${this.canvas.height}`,this.canvas.width/2,this.canvas.height/2+s*.75),this.context.fillText("Display size",this.canvas.width/2,this.canvas.height/2-s*.75)}if(this.rubberBandActive){let e=Math.min(this.rubberBandStart[0],this.rubberBandEnd[0]),t=Math.min(this.rubberBandStart[1],this.rubberBandEnd[1]),s=Math.abs(this.rubberBandEnd[0]-this.rubberBandStart[0]),i=Math.abs(this.rubberBandEnd[1]-this.rubberBandStart[1]);this.context.strokeStyle="rgba(51, 153, 255, 0.8)",this.context.fillStyle="rgba(51, 153, 255, 0.1)",this.context.lineWidth=1,this.context.fillRect(e,t,s,i),this.context.strokeRect(e,t,s,i)}this.workspaceZoom!==1&&this.context.restore(),this.onAfterDraw&&this.onAfterDraw()}}snapLayerToEdges(e){if(!this.snapEnabled)return;let t=this.SNAP_THRESHOLD,s=1/0,i=1/0,o=-1/0,n=-1/0;for(let f of e.targetPoints)f[0]<s&&(s=f[0]),f[1]<i&&(i=f[1]),f[0]>o&&(o=f[0]),f[1]>n&&(n=f[1]);let h=0,c=0,v=!1,u=!1;Math.abs(s)<t?(h=-s,v=!0):Math.abs(o-window.innerWidth)<t&&(h=window.innerWidth-o,v=!0),Math.abs(i)<t?(c=-i,u=!0):Math.abs(n-window.innerHeight)<t&&(c=window.innerHeight-n,u=!0);for(let f of this.layers){if(f===e||!f.visible)continue;let b=1/0,L=1/0,E=-1/0,S=-1/0;for(let P of f.targetPoints)P[0]<b&&(b=P[0]),P[1]<L&&(L=P[1]),P[0]>E&&(E=P[0]),P[1]>S&&(S=P[1]);if(v||(Math.abs(o-b)<t?(h=b-o,v=!0):Math.abs(s-E)<t?(h=E-s,v=!0):Math.abs(s-b)<t?(h=b-s,v=!0):Math.abs(o-E)<t&&(h=E-o,v=!0)),u||(Math.abs(n-L)<t?(c=L-n,u=!0):Math.abs(i-S)<t?(c=S-i,u=!0):Math.abs(i-L)<t?(c=L-i,u=!0):Math.abs(n-S)<t&&(c=S-n,u=!0)),v&&u)break}if(h!==0||c!==0)for(let f of e.targetPoints)f[0]+=h,f[1]+=c}toWorkspace(e,t){if(this.workspaceZoom===1)return[e,t];let s=window.innerWidth/2,i=window.innerHeight/2;return[(e-s)/this.workspaceZoom+s,(t-i)/this.workspaceZoom+i]}setWorkspaceZoom(e){this.workspaceZoom=Math.max(.1,Math.min(1,e)),this.draw()}mouseMove(e){if(!this.configActive)return;(this.dragging||this.rubberBandActive)&&e.preventDefault();let[t,s]=this.toWorkspace(e.clientX,e.clientY);if(this.mouseDelta[0]=t-this.mousePosition[0],this.mouseDelta[1]=s-this.mousePosition[1],this.mousePosition[0]=t,this.mousePosition[1]=s,this.rubberBandActive){this.rubberBandEnd=[t,s];let i=[];for(let n of this.layers)n.visible&&this.layerIntersectsRect(n,this.rubberBandStart[0],this.rubberBandStart[1],this.rubberBandEnd[0],this.rubberBandEnd[1])&&i.push(n);let o=[...this.rubberBandBaseSelection];for(let n of i)o.includes(n)||o.push(n);this.selectedLayers=o,this.selectedLayer=this.selectedLayers[this.selectedLayers.length-1]||null,this.draw();return}if(this.dragging){let i=e.shiftKey?.1:1;if(this.selectedPoint)e.shiftKey?this.scaleLayer(this.selectedLayer,1+this.mouseDelta[0]*.01):(this.selectedPoint[0]+=this.mouseDelta[0]*i,this.selectedPoint[1]+=this.mouseDelta[1]*i);else if(this.selectedLayers.length>0)if(e.altKey&&this.selectedLayer)this.rotateLayer(this.selectedLayer,this.mouseDelta[0]*(.01*i));else{for(let o of this.selectedLayers)for(let n=0;n<o.targetPoints.length;n++)o.targetPoints[n][0]+=this.mouseDelta[0]*i,o.targetPoints[n][1]+=this.mouseDelta[1]*i;this.selectedLayer&&this.snapLayerToEdges(this.selectedLayer)}this.updateTransform(),this.autoSave&&this.saveSettings(),this.draw(),this.layoutChangeListener();return}this.canvas.style.cursor="default",this.hoveringPoint=null,this.hoveringLayer=null;for(let i=this.layers.length-1;i>=0;i--){let o=this.layers[i];if(o.visible){for(let n=0;n<o.targetPoints.length;n++){let h=o.targetPoints[n];if(Ee(h[0],h[1],this.mousePosition[0],this.mousePosition[1])<this.selectionRadius){this.hoveringPoint=h,this.hoveringLayer=o,this.canvas.style.cursor="pointer";break}}if(this.hoveringPoint)break}}if(!this.hoveringPoint)for(let i=this.layers.length-1;i>=0;i--){let o=this.layers[i];if(o.visible&&this.pointInLayer(this.mousePosition,o)){this.hoveringLayer=o,this.canvas.style.cursor="pointer";break}}this.draw()}mouseDown(e){if(!this.configActive||e.button===2)return;let[t,s]=this.toWorkspace(e.clientX,e.clientY);this.mouseDownPoint=[t,s],this.selectedPoint=null,this.rubberBandActive=!1;let i=null,o=null;for(let n=this.layers.length-1;n>=0;n--){let h=this.layers[n];if(h.visible){for(let c=0;c<h.targetPoints.length;c++){let v=h.targetPoints[c];if(Ee(v[0],v[1],t,s)<this.selectionRadius){o=v,i=h;break}}if(i)break}}if(!i)for(let n=this.layers.length-1;n>=0;n--){let h=this.layers[n];if(h.visible&&this.pointInLayer([t,s],h)){i=h;break}}if(o)this.selectedPoint=o,this.selectedLayer=i,this.selectedLayers=[i],this.dragging=!0;else if(i)if(e.ctrlKey){let n=this.selectedLayers.indexOf(i);n>=0?(this.selectedLayers.splice(n,1),this.selectedLayer=this.selectedLayers[this.selectedLayers.length-1]||null):(this.selectedLayers.push(i),this.selectedLayer=i),this.dragging=this.selectedLayers.length>0}else this.selectedLayers.includes(i)?this.selectedLayer=i:(this.selectedLayers=[i],this.selectedLayer=i),this.dragging=!0;else this.selectedLayer=null,this.rubberBandBaseSelection=e.ctrlKey?[...this.selectedLayers]:[],e.ctrlKey||(this.selectedLayers=[]),this.rubberBandActive=!0,this.rubberBandStart=[t,s],this.rubberBandEnd=[t,s],this.dragging=!1;this.draw()}mouseUp(e){if(this.configActive){if(this.rubberBandActive){this.rubberBandActive=!1,this.draw();return}this.dragging&&(this.pushHistory(),this.autoSave&&this.saveSettings()),this.dragging=!1,this.selectedPoint=null}}keyDown(e){if(!this.configActive)if(e.keyCode==32&&e.shiftKey){this.setConfigEnabled(!0);return}else return;var t=e.keyCode,s=e.shiftKey?10:1,i=!1,o=[0,0];switch(console.log(t),t){case 32:if(e.shiftKey){this.setConfigEnabled(!1);return}break;case 37:o[0]-=s;break;case 38:o[1]-=s;break;case 39:o[0]+=s;break;case 40:o[1]+=s;break;case 67:this.showCrosshairs=!this.showCrosshairs,i=!0;break;case 76:if(!this.configActive)return;this.showLayerNames=!this.showLayerNames,i=!0;break;case 83:if(this.isLayerSoloed){for(var n=0;n<this.layers.length;n++)this.layers[n].visible=!0;this.isLayerSoloed=!1,i=!0}else if(this.selectedLayers.length>0){for(var n=0;n<this.layers.length;n++)this.layers[n].visible=!1;for(let h of this.selectedLayers)h.visible=!0;i=!0,this.isLayerSoloed=!0}break;case 71:this.snapEnabled=!this.snapEnabled,this.onSnapChanged&&this.onSnapChanged(this.snapEnabled);break;case 66:this.showScreenBounds=!this.showScreenBounds,this.draw();break;case 72:this.selectedLayer&&(this.swapLayerPoints(this.selectedLayer.sourcePoints,0,1),this.swapLayerPoints(this.selectedLayer.sourcePoints,3,2),this.updateTransform(),this.draw());break;case 86:this.selectedLayer&&(this.swapLayerPoints(this.selectedLayer.sourcePoints,0,3),this.swapLayerPoints(this.selectedLayer.sourcePoints,1,2),this.updateTransform(),this.draw());break;case 82:this.selectedLayer&&(this.rotateLayer(this.selectedLayer,Math.PI/2),this.updateTransform(),this.draw());break;case 90:if(e.ctrlKey){e.preventDefault(),this.undo();return}break;case 89:if(e.ctrlKey){e.preventDefault(),this.redo();return}break;case 46:case 8:if(this.selectedLayers.length>0){for(let h of[...this.selectedLayers]){h.element.remove(),h.overlay&&h.overlay.remove();let c=this.layers.indexOf(h);c>=0&&this.layers.splice(c,1)}this.selectedLayers=[],this.selectedLayer=null,i=!0,this.updateTransform(),this.draw()}break}if(!this.showScreenBounds){if(this.selectedPoint)this.selectedPoint[0]+=o[0],this.selectedPoint[1]+=o[1],i=!0;else if(this.selectedLayers.length>0){if(e.altKey==!0&&this.selectedLayer)this.rotateLayer(this.selectedLayer,o[0]*.01),this.scaleLayer(this.selectedLayer,o[1]*-.005+1);else for(let h of this.selectedLayers)for(var n=0;n<h.targetPoints.length;n++)h.targetPoints[n][0]+=o[0],h.targetPoints[n][1]+=o[1];i=!0}}i&&(this.updateTransform(),this.draw(),this.autoSave&&this.saveSettings(),this.pushHistory(),this.layoutChangeListener())}};at();var dt=new ue({layers:[]});ct(dt);dt.setConfigEnabled(!0);window.MLMap=ue;})();
