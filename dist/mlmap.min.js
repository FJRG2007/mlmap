"use strict";(()=>{function C(u,e,t=[]){let s=0,i=0,o=0,n=100,y;do{y=!1,s=Math.random()*(window.innerWidth-u),i=Math.random()*(window.innerHeight-e);for(let c of t){let d=[Math.min(...c.targetPoints.map(l=>l[0])),Math.min(...c.targetPoints.map(l=>l[1])),Math.max(...c.targetPoints.map(l=>l[0])),Math.max(...c.targetPoints.map(l=>l[1]))];if(!(s+u<d[0]||s>d[2]||i+e<d[1]||i>d[3])){y=!0;break}}o++}while(y&&o<n);return[s,i]}function k(u){return u.map(e=>e.slice(0,2))}function N(u,e,t,s){return Math.hypot(t-u,s-e)}var X=(()=>{function u(c,d,l,p){if(l===d.length-1)return p(c);let h,g=d[l],L=Array(g);for(h=g-1;h>=0;--h)L[h]=u(c[h],d,l+1,p);return L}function e(c){let d=[];for(;typeof c=="object";)d.push(c.length),c=c[0];return d}function t(c){let d,l;return typeof c=="object"?(d=c[0],typeof d=="object"?(l=d[0],typeof l=="object"?e(c):[c.length,d.length]):[c.length]):[]}function s(c){let d,l=c.length,p=Array(l);for(d=l-1;d>=0;--d)p[d]=c[d];return p}function i(c){return typeof c!="object"?c:u(c,t(c),0,s)}function o(c,d){d=d||!1;let l,p,h,g,L,b,v,m,P,S=c.length,D=S-1,E=new Array(S);for(d||(c=i(c)),h=0;h<S;++h){for(v=h,b=c[h],P=y(b[h]),p=h+1;p<S;++p)g=y(c[p][h]),g>P&&(P=g,v=p);for(E[h]=v,v!=h&&(c[h]=c[v],c[v]=b,b=c[h]),L=b[h],l=h+1;l<S;++l)c[l][h]/=L;for(l=h+1;l<S;++l){for(m=c[l],p=h+1;p<D;++p)m[p]-=m[h]*b[p],++p,m[p]-=m[h]*b[p];p===D&&(m[p]-=m[h]*b[p])}}return{LU:c,P:E}}function n(c,d){let l,p,h,g,L,b=c.LU,v=b.length,m=i(d),P=c.P;for(l=v-1;l>=0;--l)m[l]=d[l];for(l=0;l<v;++l)for(h=P[l],P[l]!==l&&(L=m[l],m[l]=m[h],m[h]=L),g=b[l],p=0;p<l;++p)m[l]-=m[p]*g[p];for(l=v-1;l>=0;--l){for(g=b[l],p=l+1;p<v;++p)m[l]-=m[p]*g[p];m[l]/=g[l]}return m}let y=Math.abs;return function(c,d,l){return n(o(c,l),d)}})();function I(u){localStorage.setItem(`mlmap:workspace<${u.id}>`,JSON.stringify(u))}function R(u){let e=localStorage.getItem("mlmap:currentWorkspaceId");if(!e){e=Date.now().toString(),localStorage.setItem("mlmap:currentWorkspaceId",e);let s={id:e,name:"New Workspace",version:"1.0",layout:{}};return localStorage.setItem(`mlmap:workspace<${e}>`,JSON.stringify(s)),s}let t=localStorage.getItem(`mlmap:workspace<${u||e}>`);return t?JSON.parse(t):null}function $(u){localStorage.removeItem(`mlmap:workspace<${u}>`)}function A(u){let e=`mlmap:workspace<${u}>`,t=JSON.parse(localStorage.getItem(e)||`{id:"${u}",name:"Reset Workspace",version:"1.0",layout:{}`);localStorage.setItem(e,JSON.stringify({id:u,name:t?.name,version:"1.0",layout:{}}))}function Y(){let u=[];for(let e=0;e<localStorage.length;e++){let t=localStorage.key(e);if(t&&t.startsWith("mlmap:workspace<")){let s=localStorage.getItem(t);s&&u.push(JSON.parse(s))}}return u}var z="0.0.2.4",T=[];function K(u){let e=document.createElement("div");e.id="controls",e.innerHTML=`
    <div style="display:flex; justify-content:space-between; align-items:center;">
  <strong>Controls</strong>
  <button id="closeHelp" style="background:#808080;color:white;border:none;padding:2px 6px;cursor:pointer;">X</button>
</div>
<pre style="margin-top:5px;">
SHIFT-Space: Toggle edit mode

In Edit Mode

click / drag:       select and move quads/corner points
SHIFT + drag:       move selected quad/corner point with 10x precision
ALT + drag:         rotate/scale selected quad
Arrow keys:         move selected quad/corner point
SHIFT + Arrow keys: move selected quad/corner point by 10 pixels
ALT + Arrow keys:   rotate/scale selected quad
's':                Solo/unsolo selected quad
'c':                Toggle mouse cursor crosshairs
'r':                Rotate selected layer 90 degrees clock-wise
'h':                Flip selected layer horizontally
'v':                Flip selected layer vertically
'b':                Show/Hide projector bounds
'l':                Show/Hide layer labels
'\u232B'/'Del':         Delete selected layer

MLMap | Version ${z}
</pre>
    `,Object.assign(e.style,{position:"fixed",top:"20px",left:"50%",transform:"translateX(-50%)",width:"600px",background:"#404040",color:"white",fontFamily:"monospace",padding:"10px",border:"2px solid #808080",zIndex:"1000001",cursor:"move",display:"none",userSelect:"none"}),document.body.appendChild(e),document.getElementById("closeHelp")?.addEventListener("click",()=>{e.style.display="none"});let t=document.createElement("div");t.id="shapePanel",Object.assign(t.style,{position:"fixed",top:"10px",right:"10px",width:"200px",background:"#303030",color:"white",fontFamily:"monospace",padding:"10px",border:"2px solid #808080",zIndex:"1000002",cursor:"move",display:"none",userSelect:"none"}),t.innerHTML=`
    <strong>Shapes</strong>
    <div id="shapeList"></div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: 5px;">
        <button id="addSquare">Add Square</button>
        <button id="addCircle">Add Circle</button>
        <button id="addTriangle">Add Triangle</button>
    </div>
    <hr>
    <strong>Workspaces</strong>
    <select id="workspaceSelector" style="width:100%;margin-top:5px;"></select>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: 5px;">
        <button id="addWorkspace" title="Add Workspace" aria-label="Add Workspace">\u{1F195}</button>
        <button id="duplicateWorkspace" title="Duplicate Workspace" aria-label="Duplicate Workspace">\u{1F4CB}</button>
        <button id="renameWorkspace" title="Rename Workspace" aria-label="Rename Workspace">\u270F\uFE0F</button>
        <button id="resetWorkspace" title="Reset Workspace" aria-label="Reset Workspace">\u{1F9F9}</button>
        <button id="deleteWorkspace" title="Delete Workspace" aria-label="Delete Workspace">\u{1F5D1}\uFE0F</button>
    </div>
    `,document.body.appendChild(t);let s=!1,i=!1,o=0,n=0;e.addEventListener("mousedown",function(r){r?.target?.id!=="closeHelp"&&(s=!0,o=r.clientX-e.offsetLeft,n=r.clientY-e.offsetTop)}),t.addEventListener("mousedown",function(r){i=!0,o=r.clientX-t.offsetLeft,n=r.clientY-t.offsetTop}),document.addEventListener("mousemove",function(r){s&&(e.style.left=r.clientX-o+"px",e.style.top=r.clientY-n+"px",e.style.transform=""),i&&(t.style.left=r.clientX-o+"px",t.style.top=r.clientY-n+"px",t.style.transform="")}),document.addEventListener("mouseup",function(){s=!1,i=!1});let y=document.getElementById("shapeList"),c=document.getElementById("addSquare"),d=document.getElementById("addCircle"),l=document.getElementById("addTriangle"),p=new WeakMap,h=[];function g(r){let a=document.createElement("div");a.id=`shape_${Date.now()}`;let[x,W]=C(100,100);a.style.position="fixed",a.style.top=W+"px",a.style.left=x+"px",a.style.width="100px",a.style.height="100px",a.style.background=r==="triangle"?"transparent":"white",a.style.border=r==="triangle"?"2px solid white":"none",r==="circle"&&(a.style.borderRadius="50%"),r==="triangle"&&(a.style.width="0",a.style.height="0",a.style.borderLeft="50px solid transparent",a.style.borderRight="50px solid transparent",a.style.borderBottom="100px solid white",u.addLayer(a,k([[50,0],[100,100],[0,100],[50,100]]))),document.body.appendChild(a),u.addLayer(a),h.push({id:a.id,type:r,x,y:W}),L(),v()}function L(){y.innerHTML="",h.forEach(r=>{let a=document.createElement("div");a.style.display="flex",a.style.justifyContent="space-between",a.style.marginBottom="4px",a.innerHTML=`${r.type} <button data-id="${r.id}">Delete</button>`,y.appendChild(a),a.querySelector("button")?.addEventListener("click",()=>b(r.id))})}function b(r){let a=h.findIndex(x=>x.id===r);if(a!==-1){let x=document.getElementById(r);x&&x.remove(),h.splice(a,1),L(),v()}}function v(){localStorage.setItem("mlmap.dynamicShapes",JSON.stringify(h))}function m(){let r=localStorage.getItem("mlmap.dynamicShapes");r&&(h=JSON.parse(r),h.forEach(a=>P(a)),L())}function P(r){let a=document.createElement("div");a.id=r.id;let x=r.x??Math.random()*(window.innerWidth-100),W=r.y??Math.random()*(window.innerHeight-100);a.style.position="fixed",a.style.top=W+"px",a.style.left=x+"px",a.style.width="100px",a.style.height="100px",a.style.background=r.type==="triangle"?"transparent":"white",a.style.border=r.type==="triangle"?"2px solid white":"none",r.type==="circle"&&(a.style.borderRadius="50%"),r.type==="triangle"&&(a.style.width="0",a.style.height="0",a.style.borderLeft="50px solid transparent",a.style.borderRight="50px solid transparent",a.style.borderBottom="100px solid white"),document.body.appendChild(a),u.addLayer(a)}c.addEventListener("click",()=>g("square")),d.addEventListener("click",()=>g("circle")),l.addEventListener("click",()=>g("triangle")),document.addEventListener("keydown",r=>{r.shiftKey&&r.code==="Space"&&(r.preventDefault(),e.style.display=e.style.display==="none"?"block":"none",t.style.display=t.style.display==="none"?"block":"none")});let S=u.setConfigEnabled;u.setConfigEnabled=function(r){S(r),t.style.display=r?"block":"none"},m(),new MutationObserver(r=>{for(let a of r)a.type==="childList"&&a.removedNodes.length>0&&a.removedNodes.forEach(x=>{if(x instanceof HTMLElement){let W=h.findIndex(J=>J.id===x.id);W!==-1&&(h.splice(W,1),L(),v())}})}).observe(document.body,{childList:!0,subtree:!0});let E=t.querySelector("#workspaceSelector"),w=Y(),f=w.find(r=>r.id===localStorage.getItem("mlmap:currentWorkspaceId"))||null;!f&&w.length&&(f=w[0],localStorage.setItem("mlmap:currentWorkspaceId",f.id)),f&&u.setLayout(f.layout),w.length===1&&(document.getElementById("deleteWorkspace").disabled=!0);function M(){E.innerHTML="",w.forEach(r=>{let a=document.createElement("option");a.value=r.id,a.textContent=r.name,f&&f.id===r.id&&(a.selected=!0),E.appendChild(a)})}function B(r){localStorage.setItem("mlmap:currentWorkspaceId",r.id),window.location.reload()}document.getElementById("addWorkspace")?.addEventListener("click",()=>{let r=prompt("Workspace name:","New Workspace")||"New Workspace",a={id:Date.now().toString(),name:r,version:"1.0",layout:{}};w.push(a),I(a),B(a)}),document.getElementById("duplicateWorkspace")?.addEventListener("click",()=>{if(!f)return;let r=prompt("New name:",f.name+" (Copy)")||f.name+" (Copy)",a={id:Date.now().toString(),name:r,version:"1.0",layout:{}};w.push(a),I(a),B(a),M()}),document.getElementById("renameWorkspace")?.addEventListener("click",()=>{if(!f)return;let r=prompt("New name:",f.name)||f.name;f.name=r,I(f),M()}),document.getElementById("resetWorkspace")?.addEventListener("click",()=>{f&&(A(f.id),window.location.reload(),M())}),document.getElementById("deleteWorkspace")?.addEventListener("click",()=>{!f||w.length===1||(w.length===1&&(document.getElementById("deleteWorkspace").disabled=!0),$(f.id),w=w.filter(r=>r.id!==f?.id),f=w[0]||null,f&&u.setLayout(f.layout),M())}),E.addEventListener("change",()=>{let r=w.find(a=>a.id===E.value);r&&B(r)}),M(),u.layoutChangeListener=()=>{f&&(f.layout=u.getLayout(),I(f))}}var H=class{constructor(e={}){this.layers=[];this.configActive=!1;this.dragging=!1;this.dragOffset=[0,0];this.selectedLayer=null;this.selectedPoint=null;this.selectionRadius=20;this.hoveringPoint=null;this.hoveringLayer=null;this.isLayerSoloed=!1;this.mousePosition=[0,0];this.mouseDelta=[0,0];this.mouseDownPoint=[0,0];this.keyDown=this.keyDown.bind(this),this.setConfigEnabled=this.setConfigEnabled.bind(this),this.showLayerNames=this.getProp(e,"labels",!0),this.showCrosshairs=this.getProp(e,"crosshairs",!1),this.showScreenBounds=this.getProp(e,"screenbounds",!1),this.autoSave=this.getProp(e,"autoSave",!0),this.autoLoad=this.getProp(e,"autoLoad",!0),this.layerList=this.getProp(e,"layers",[]),this.layoutChangeListener=this.getProp(e,"onchange",()=>{}),this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.initCanvas(),this.loadSettings();for(let s of this.layerList)(s instanceof HTMLElement||typeof s=="string")&&this.addLayer(s);this.autoLoad&&this.loadSettings(),this.pushHistory(),new MutationObserver(s=>{s.forEach(i=>{i.removedNodes.forEach(o=>{this.layers.forEach((n,y)=>{n.element===o&&(n.overlay&&n.overlay.remove(),this.layers.splice(y,1))})})})}).observe(document.body,{childList:!0,subtree:!0})}getProp(e,t,s){return e&&e.hasOwnProperty(t)&&e[t]!==null?e[t]:s}initCanvas(){this.canvas.style.display="none",this.canvas.style.position="fixed",this.canvas.style.top="0px",this.canvas.style.left="0px",this.canvas.style.zIndex="1000000",this.context=this.canvas.getContext("2d"),document.body.appendChild(this.canvas),window.addEventListener("resize",this.resize.bind(this)),window.addEventListener("mousemove",this.mouseMove.bind(this)),window.addEventListener("mouseup",this.mouseUp.bind(this)),window.addEventListener("mousedown",this.mouseDown.bind(this)),window.addEventListener("keydown",this.keyDown.bind(this)),this.resize()}pushHistory(){let e=this.getLayout();T.push(JSON.stringify(e)),T.length>50&&T.shift()}saveSettings(){let e=R();I({id:e?.id,name:e?.name,version:e?.version,layout:this.getLayout()})}loadSettings(){try{let e=R();e?.version==="1.0"&&e?.layout?this.setLayout(e.layout):console.warn("MLMap: localStorage version mismatch, skipping load.")}catch(e){console.error("MLMap: Failed to parse layout from localStorage.",e)}}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.draw()}pointInTriangle(e,t,s,i){let o=t[1]*i[0]-t[0]*i[1]+(i[1]-t[1])*e[0]+(t[0]-i[0])*e[1],n=t[0]*s[1]-t[1]*s[0]+(t[1]-s[1])*e[0]+(s[0]-t[0])*e[1];if(o<0!=n<0)return!1;let y=-s[1]*i[0]+t[1]*(i[0]-s[0])+t[0]*(s[1]-i[1])+s[0]*i[1];return y<0&&(o=-o,n=-n,y=-y),o>0&&n>0&&o+n<y}pointInLayer(e,t){let[s,i,o,n]=t.targetPoints;return this.pointInTriangle(e,s,i,o)||this.pointInTriangle(e,n,s,o)}updateTransform(){let e=["","-webkit-","-moz-","-ms-","-o-"],t="transform";for(let s of e){let i=s+"transform";if(i in document.body.style){t=i;break}}for(let s=0;s<this.layers.length;s++){let i=[],o=[];for(let d=0,l=this.layers[s].sourcePoints.length;d<l;++d){let p=this.layers[s].sourcePoints[d],h=this.layers[s].targetPoints[d];i.push([p[0],p[1],1,0,0,0,-p[0]*h[0],-p[1]*h[0]]),o.push(h[0]),i.push([0,0,0,p[0],p[1],1,-p[0]*h[1],-p[1]*h[1]]),o.push(h[1])}let n=X(i,o,!0),y=[n[0],n[3],0,n[6],n[1],n[4],0,n[7],0,0,1,0,n[2],n[5],0,1],c=this.layers[s].element.style;c.setProperty(t,`matrix3d(${y.join(",")})`),c.setProperty(`${t}-origin`,"0px 0px 0px")}}rotateLayer(e,t){for(var s=Math.sin(t),i=Math.cos(t),o=[0,0],n=0;n<e.targetPoints.length;n++)o[0]+=e.targetPoints[n][0],o[1]+=e.targetPoints[n][1];o[0]/=4,o[1]/=4;for(var n=0;n<e.targetPoints.length;n++){var y=e.targetPoints[n][0]-o[0],c=e.targetPoints[n][1]-o[1];e.targetPoints[n][0]=y*i-c*s+o[0],e.targetPoints[n][1]=y*s+c*i+o[1]}}scaleLayer(e,t){for(var s=[0,0],i=0;i<e.targetPoints.length;i++)s[0]+=e.targetPoints[i][0],s[1]+=e.targetPoints[i][1];s[0]/=4,s[1]/=4;for(var i=0;i<e.targetPoints.length;i++){var o=e.targetPoints[i][0]-s[0],n=e.targetPoints[i][1]-s[1];e.targetPoints[i][0]=o*t+s[0],e.targetPoints[i][1]=n*t+s[1]}}undo(){if(T.length>1){T.pop();var e=JSON.parse(T[T.length-1]);this.setLayout(e),this.draw(),this.autoSave&&this.saveSettings()}}swapLayerPoints(e,t,s){var i=e[t][0],o=e[t][1];e[t][0]=e[s][0],e[t][1]=e[s][1],e[s][0]=i,e[s][1]=o}addLayer(e,t){let s=null;if(typeof e=="string"){if(s=document.getElementById(e),!s)throw new Error("MLMap: No element found with id: "+e)}else if(e instanceof HTMLElement)s=e;else throw new Error("MLMap: Invalid target");for(let o=0;o<this.layers.length;o++)if(this.layers[o].element.id===s.id){t&&(this.layers[o].targetPoints=k(t));return}s.style.position="fixed",s.style.display="block",s.style.top="0px",s.style.left="0px",s.style.padding="0px",s.style.margin="0px";let i={visible:!0,element:s,width:s.clientWidth,height:s.clientHeight,sourcePoints:[[0,0],[s.clientWidth,0],[s.clientWidth,s.clientHeight],[0,s.clientHeight]],targetPoints:[]};if(t)i.targetPoints=k(t);else{let[o,n]=C(i.width,i.height,this.layers);i.targetPoints=[[o,n],[o+i.width,n],[o+i.width,n+i.height],[o,n+i.height]]}this.layers.push(i),this.updateTransform()}removeLayer(e){let t=typeof e=="string"?document.getElementById(e):e;if(t){for(let s=this.layers.length-1;s>=0;s--)this.layers[s].element===t&&(this.layers[s].overlay&&this.layers[s].overlay?.remove(),this.layers.splice(s,1));this.updateTransform()}}setLayout(e){for(var t=0;t<e.length;t++){for(var s=!1,i=0;i<this.layers.length;i++)this.layers[i].element.id==e[t].id&&(console.log("Setting points."),this.layers[i].targetPoints=k(e[t].targetPoints),this.layers[i].sourcePoints=k(e[t].sourcePoints),s=!0);if(s)console.log('MLMap: Element "" + layout[i].id + "" is already mapped.');else{var o=document.getElementById(e[t].id);o?this.addLayer(o,e[t].targetPoints):console.log('MLMap: Can"t find element: '+e[t].id)}}this.updateTransform(),this.draw()}getLayout(){for(var e=[],t=0;t<this.layers.length;t++)e.push({id:this.layers[t].element.id,targetPoints:k(this.layers[t].targetPoints),sourcePoints:k(this.layers[t].sourcePoints)});return e}setConfigEnabled(e){this.configActive=e,this.canvas.style.display=e?"block":"none",e?this.draw():(this.selectedPoint=null,this.selectedLayer=null,this.dragging=!1,this.showScreenBounds=!1)}draw(){if(this.configActive){this.context.strokeStyle="red",this.context.lineWidth=2,this.context.clearRect(0,0,this.canvas.width,this.canvas.height);for(let e=0;e<this.layers.length;e++){let t=this.layers[e];if(t.visible){t.element.style.visibility="visible",this.context.beginPath(),t===this.hoveringLayer?this.context.strokeStyle="red":t===this.selectedLayer?this.context.strokeStyle="red":this.context.strokeStyle="white",this.context.moveTo(t.targetPoints[0][0],t.targetPoints[0][1]);for(let i=0;i<t.targetPoints.length;i++)this.context.lineTo(t.targetPoints[i][0],t.targetPoints[i][1]);this.context.lineTo(t.targetPoints[3][0],t.targetPoints[3][1]),this.context.closePath(),this.context.stroke();let s=[0,0];for(let i=0;i<t.targetPoints.length;i++)t.targetPoints[i]===this.hoveringPoint?this.context.strokeStyle="red":t.targetPoints[i]===this.selectedPoint?this.context.strokeStyle="red":this.context.strokeStyle="white",s[0]+=t.targetPoints[i][0],s[1]+=t.targetPoints[i][1],this.context.beginPath(),this.context.arc(t.targetPoints[i][0],t.targetPoints[i][1],this.selectionRadius/2,0,2*Math.PI,!1),this.context.stroke();if(s[0]/=4,s[1]/=4,this.showLayerNames){let i=t.element.id.toUpperCase();this.context.font="16px sans-serif",this.context.textAlign="center";let o=this.context.measureText(i),n=[o.width+8,32];this.context.fillStyle="white";let y=window.innerHeight*.01,c=s[0],d=s[1];(t.width<o.width+10||t.height<20)&&(d=s[1]-t.height/2-10-y,d-n[1]/2<y&&(d=s[1]+t.height/2+20+y)),this.context.fillRect(c-n[0]/2,d-n[1]/2,n[0],n[1]),this.context.fillStyle="black",this.context.font="14px sans-serif",this.context.fillText(i,c,d)}}else t.element.style.visibility="hidden"}if(this.showCrosshairs&&(this.context.strokeStyle="yellow",this.context.lineWidth=1,this.context.beginPath(),this.context.moveTo(this.mousePosition[0],0),this.context.lineTo(this.mousePosition[0],this.canvas.height),this.context.moveTo(0,this.mousePosition[1]),this.context.lineTo(this.canvas.width,this.mousePosition[1]),this.context.stroke()),this.showScreenBounds){this.context.fillStyle="black",this.context.lineWidth=4,this.context.fillRect(0,0,this.canvas.width,this.canvas.height),this.context.strokeStyle="#909090",this.context.beginPath();let e=this.canvas.width/10,t=this.canvas.height/10;for(let i=0;i<10;i++)this.context.moveTo(i*e,0),this.context.lineTo(i*e,this.canvas.height),this.context.moveTo(0,i*t),this.context.lineTo(this.canvas.width,i*t);this.context.stroke(),this.context.strokeStyle="white",this.context.strokeRect(2,2,this.canvas.width-4,this.canvas.height-4);let s=Math.round(t*.6);this.context.font=`${s}px mono, sans-serif`,this.context.fillRect(e*2+2,t*3+2,this.canvas.width-e*4-4,this.canvas.height-t*6-4),this.context.fillStyle="white",this.context.font="20px sans-serif",this.context.fillText(`${this.canvas.width} x ${this.canvas.height}`,this.canvas.width/2,this.canvas.height/2+s*.75),this.context.fillText("Display size",this.canvas.width/2,this.canvas.height/2-s*.75)}}}mouseMove(e){if(this.configActive){if(e.preventDefault(),this.mouseDelta[0]=e.clientX-this.mousePosition[0],this.mouseDelta[1]=e.clientY-this.mousePosition[1],this.mousePosition[0]=e.clientX,this.mousePosition[1]=e.clientY,this.dragging){let t=e.shiftKey?.1:1;if(this.selectedPoint)e.shiftKey?this.scaleLayer(this.selectedLayer,1+this.mouseDelta[0]*.01):(this.selectedPoint[0]+=this.mouseDelta[0]*t,this.selectedPoint[1]+=this.mouseDelta[1]*t);else if(this.selectedLayer)if(e.altKey&&this.rotateLayer(this.selectedLayer,this.mouseDelta[0]*(.01*t)),e.ctrlKey)this.scaleLayer(this.selectedLayer,this.mouseDelta[1]*(-.005*t)+1);else for(let s=0;s<this.selectedLayer.targetPoints.length;s++)this.selectedLayer.targetPoints[s][0]+=this.mouseDelta[0]*t,this.selectedLayer.targetPoints[s][1]+=this.mouseDelta[1]*t;this.updateTransform(),this.autoSave&&this.saveSettings(),this.draw(),this.layoutChangeListener();return}this.canvas.style.cursor="default",this.hoveringPoint=null,this.hoveringLayer=null;for(let t=this.layers.length-1;t>=0;t--){let s=this.layers[t];if(s.visible){for(let i=0;i<s.targetPoints.length;i++){let o=s.targetPoints[i];if(N(o[0],o[1],e.clientX,e.clientY)<this.selectionRadius){this.hoveringPoint=o,this.hoveringLayer=s,this.canvas.style.cursor="pointer";break}}if(this.hoveringPoint)break}}if(!this.hoveringPoint)for(let t=this.layers.length-1;t>=0;t--){let s=this.layers[t];if(s.visible&&this.pointInLayer(this.mousePosition,s)){this.hoveringLayer=s,this.canvas.style.cursor="pointer";break}}this.draw()}}mouseDown(e){if(this.configActive){this.mouseDownPoint=[e.clientX,e.clientY],this.selectedPoint=null,this.selectedLayer=null;for(let t=this.layers.length-1;t>=0;t--){let s=this.layers[t];if(s.visible){for(let i=0;i<s.targetPoints.length;i++){let o=s.targetPoints[i];if(N(o[0],o[1],e.clientX,e.clientY)<this.selectionRadius){this.selectedPoint=o,this.selectedLayer=s;break}}if(this.selectedLayer)break}}if(!this.selectedLayer)for(let t=this.layers.length-1;t>=0;t--){let s=this.layers[t];if(s.visible&&this.pointInLayer([e.clientX,e.clientY],s)){this.selectedLayer=s;break}}this.selectedLayer&&(this.dragging=!0,this.draw())}}mouseUp(e){this.configActive&&(this.dragging&&(this.pushHistory(),this.autoSave&&this.saveSettings()),this.dragging=!1,this.selectedPoint=null)}keyDown(e){if(!this.configActive)if(e.keyCode==32&&e.shiftKey){this.setConfigEnabled(!0);return}else return;var t=e.keyCode,s=e.shiftKey?10:1,i=!1,o=[0,0];switch(console.log(t),t){case 32:if(e.shiftKey){this.setConfigEnabled(!1);return}break;case 37:o[0]-=s;break;case 38:o[1]-=s;break;case 39:o[0]+=s;break;case 40:o[1]+=s;break;case 67:this.showCrosshairs=!this.showCrosshairs,i=!0;break;case 76:if(!this.configActive)return;this.showLayerNames=!this.showLayerNames,i=!0;break;case 83:if(this.isLayerSoloed){for(var n=0;n<this.layers.length;n++)this.layers[n].visible=!0;this.isLayerSoloed=!1,i=!0}else if(this.selectedLayer!=null){for(var n=0;n<this.layers.length;n++)this.layers[n].visible=!1;this.selectedLayer.visible=!0,i=!0,this.isLayerSoloed=!0}break;case 66:this.showScreenBounds=!this.showScreenBounds,this.draw();break;case 72:this.selectedLayer&&(this.swapLayerPoints(this.selectedLayer.sourcePoints,0,1),this.swapLayerPoints(this.selectedLayer.sourcePoints,3,2),this.updateTransform(),this.draw());break;case 86:this.selectedLayer&&(this.swapLayerPoints(this.selectedLayer.sourcePoints,0,3),this.swapLayerPoints(this.selectedLayer.sourcePoints,1,2),this.updateTransform(),this.draw());break;case 82:this.selectedLayer&&(this.rotateLayer(this.selectedLayer,Math.PI/2),this.updateTransform(),this.draw());break;case 90:e.ctrlKey&&this.undo();break;case 46:case 8:if(this.selectedLayer){this.selectedLayer.element.remove(),this.selectedLayer.overlay&&this.selectedLayer.overlay.remove();let y=this.layers.indexOf(this.selectedLayer);y>=0&&this.layers.splice(y,1),this.selectedLayer=null,i=!0,this.updateTransform(),this.draw()}break}if(!this.showScreenBounds){if(this.selectedPoint)this.selectedPoint[0]+=o[0],this.selectedPoint[1]+=o[1],i=!0;else if(this.selectedLayer){if(e.altKey==!0)this.rotateLayer(this.selectedLayer,o[0]*.01),this.scaleLayer(this.selectedLayer,o[1]*-.005+1);else for(var n=0;n<this.selectedLayer.targetPoints.length;n++)this.selectedLayer.targetPoints[n][0]+=o[0],this.selectedLayer.targetPoints[n][1]+=o[1];i=!0}}i&&(this.updateTransform(),this.draw(),this.autoSave&&this.saveSettings(),this.pushHistory(),this.layoutChangeListener())}},U=new H({layers:[]});K(U);window.MLMap=H;})();
