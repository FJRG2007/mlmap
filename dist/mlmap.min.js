"use strict";(()=>{var Pt=Object.create;var Je=Object.defineProperty;var Ct=Object.getOwnPropertyDescriptor;var Mt=Object.getOwnPropertyNames;var Ht=Object.getPrototypeOf,Dt=Object.prototype.hasOwnProperty;var je=(d,e)=>()=>(d&&(e=d(d=0)),e);var qe=(d,e)=>()=>(e||d((e={exports:{}}).exports,e),e.exports);var At=(d,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Mt(e))!Dt.call(d,i)&&i!==t&&Je(d,i,{get:()=>e[i],enumerable:!(s=Ct(e,i))||s.enumerable});return d};var Ge=(d,e,t)=>(t=d!=null?Pt(Ht(d)):{},At(e||!d||!d.__esModule?Je(t,"default",{value:d,enumerable:!0}):t,d));var K,Q,he,Xe,fe=je(()=>{"use strict";K="0.1.0.1",Q=[],he=[],Xe="display.html"});async function ve(){let d="mlmap:cache:checkLatestVersion",t=Date.now(),s=localStorage.getItem(d),i=null;if(s)try{i=JSON.parse(s)}catch{}if(i&&t-i.timestamp<3e5)return{current:K,latest:i.latest,requireUpdate:i.latest!==K};let a=new AbortController,u=setTimeout(()=>a.abort(),5e3);try{let c=await fetch("https://raw.githubusercontent.com/FJRG2007/mlmap/refs/heads/main/package.json",{signal:a.signal});clearTimeout(u);let y=await c.json();return i={latest:y.version,timestamp:t},localStorage.setItem(d,JSON.stringify(i)),{current:K,latest:y.version,requireUpdate:y.version!==K}}catch{return{current:K,latest:i?.latest||K,requireUpdate:!1}}}var Ae=je(()=>{"use strict";fe()});var Ze=qe(()=>{"use strict";Ae();document.addEventListener("DOMContentLoaded",async()=>{let d=await ve();console.log(`Current version: ${d.current}`),console.log(`Latest version: ${d.latest}`),d.requireUpdate&&console.log("A new version is available!")})});var Qe=qe(()=>{"use strict";var jt=Ge(Ze())});var yi=Ge(Qe());function et(d,e,t=[]){let s=0,i=0,a=0,n=100,u;do{u=!1,s=Math.random()*(window.innerWidth-d),i=Math.random()*(window.innerHeight-e);for(let c of t){let y=[Math.min(...c.targetPoints.map(m=>m[0])),Math.min(...c.targetPoints.map(m=>m[1])),Math.max(...c.targetPoints.map(m=>m[0])),Math.max(...c.targetPoints.map(m=>m[1]))];if(!(s+d<y[0]||s>y[2]||i+e<y[1]||i>y[3])){u=!0;break}}a++}while(u&&a<n);return[s,i]}function se(d){return d.map(e=>e.slice(0,2))}function Be(d,e,t,s){return Math.hypot(t-d,s-e)}var tt=(()=>{function d(c,y,m,g){if(m===y.length-1)return g(c);let x,E=y[m],T=Array(E);for(x=E-1;x>=0;--x)T[x]=d(c[x],y,m+1,g);return T}function e(c){let y=[];for(;typeof c=="object";)y.push(c.length),c=c[0];return y}function t(c){let y,m;return typeof c=="object"?(y=c[0],typeof y=="object"?(m=y[0],typeof m=="object"?e(c):[c.length,y.length]):[c.length]):[]}function s(c){let y,m=c.length,g=Array(m);for(y=m-1;y>=0;--y)g[y]=c[y];return g}function i(c){return typeof c!="object"?c:d(c,t(c),0,s)}function a(c,y){y=y||!1;let m,g,x,E,T,L,I,S,R,J=c.length,X=J-1,z=new Array(J);for(y||(c=i(c)),x=0;x<J;++x){for(I=x,L=c[x],R=u(L[x]),g=x+1;g<J;++g)E=u(c[g][x]),E>R&&(R=E,I=g);for(z[x]=I,I!=x&&(c[x]=c[I],c[I]=L,L=c[x]),T=L[x],m=x+1;m<J;++m)c[m][x]/=T;for(m=x+1;m<J;++m){for(S=c[m],g=x+1;g<X;++g)S[g]-=S[x]*L[g],++g,S[g]-=S[x]*L[g];g===X&&(S[g]-=S[x]*L[g])}}return{LU:c,P:z}}function n(c,y){let m,g,x,E,T,L=c.LU,I=L.length,S=i(y),R=c.P;for(m=I-1;m>=0;--m)S[m]=y[m];for(m=0;m<I;++m)for(x=R[m],R[m]!==m&&(T=S[m],S[m]=S[x],S[x]=T),E=L[m],g=0;g<m;++g)S[m]-=S[g]*E[g];for(m=I-1;m>=0;--m){for(E=L[m],g=m+1;g<I;++g)S[m]-=S[g]*E[g];S[m]/=E[m]}return S}let u=Math.abs;return function(c,y,m){return n(a(c,m),y)}})();function ne(d){localStorage.setItem(`mlmap:workspace<${d.id}>`,JSON.stringify(d))}function We(d){let e=localStorage.getItem("mlmap:currentWorkspaceId");if(!e){e=Date.now().toString(),localStorage.setItem("mlmap:currentWorkspaceId",e);let s={id:e,name:"New Workspace",version:"1.0",layout:{}};return localStorage.setItem(`mlmap:workspace<${e}>`,JSON.stringify(s)),s}let t=localStorage.getItem(`mlmap:workspace<${d||e}>`);return t?JSON.parse(t):null}function it(d){localStorage.removeItem(`mlmap:workspace<${d}>`)}function st(d){let e=`mlmap:workspace<${d}>`,t=JSON.parse(localStorage.getItem(e)||`{id:"${d}",name:"Reset Workspace",version:"1.0",layout:{}`);localStorage.setItem(e,JSON.stringify({id:d,name:t?.name,version:"1.0",layout:{}}))}function nt(){let d=[];for(let e=0;e<localStorage.length;e++){let t=localStorage.key(e);if(t&&t.startsWith("mlmap:workspace<")){let s=localStorage.getItem(t);s&&d.push(JSON.parse(s))}}return d}fe();Ae();var at="mlmap-sync",rt=2e3;var lt=6e3;function ct(d,e){return{type:d,payload:e,timestamp:Date.now()}}var be=class{constructor(e){this.listeners=new Map;this.heartbeatTimer=null;this.lastPong=0;this._connected=!1;this.onConnectionChange=null;this.role=e,this.channel=new BroadcastChannel(at),this.channel.onmessage=t=>this.handleMessage(t.data),e==="control"&&this.startHeartbeat(),e==="display"&&(this.on("PING",()=>this.send("PONG")),setTimeout(()=>this.send("DISPLAY_READY"),100))}get connected(){return this._connected}set onConnectionChanged(e){this.onConnectionChange=e}send(e,t){try{this.channel.postMessage(ct(e,t))}catch(s){console.warn("ChannelBridge: Failed to send message",e,s)}}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){let s=this.listeners.get(e);if(s){let i=s.indexOf(t);i>=0&&s.splice(i,1)}}destroy(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.channel.close(),this.listeners.clear()}handleMessage(e){(e.type==="PONG"||e.type==="DISPLAY_READY")&&(this.lastPong=Date.now(),this.setConnected(!0));let t=this.listeners.get(e.type);t&&t.forEach(s=>s(e.payload))}startHeartbeat(){this.heartbeatTimer=window.setInterval(()=>{this.send("PING"),this._connected&&Date.now()-this.lastPong>lt&&this.setConnected(!1)},rt)}setConnected(e){this._connected!==e&&(this._connected=e,this.onConnectionChange&&this.onConnectionChange(e))}};var dt="mlmap:videoSources",xe=class{constructor(){this.sources=[];this.onChange=null;this.liveStreams=new Map;this.load()}set onChanged(e){this.onChange=e}getAll(){return[...this.sources]}getById(e){return this.sources.find(t=>t.id===e)}getStream(e){return this.liveStreams.get(e)}addUrl(e,t){let s=t||e.split("/").pop()||"video",i={id:`src-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,name:s,url:e,type:"url"};return this.sources.push(i),this.save(),this.notify(),i}addFile(e){let t=URL.createObjectURL(e),s={id:`src-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,name:e.name,url:t,type:"file"};return this.sources.push(s),this.notify(),s}addCapture(e,t){let s=`src-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,i={id:s,name:t,url:`capture:${s}`,type:"capture"};this.liveStreams.set(s,e),this.sources.push(i);let a=e.getTracks(),n=()=>{a.every(u=>u.readyState==="ended")&&this.liveStreams.delete(s)};return a.forEach(u=>u.addEventListener("ended",n)),this.notify(),i}remove(e){let t=this.sources.findIndex(s=>s.id===e);if(t>=0){let s=this.sources[t];if(s.type==="file"&&s.url.startsWith("blob:")&&URL.revokeObjectURL(s.url),s.type==="capture"){let i=this.liveStreams.get(e);i&&(i.getTracks().forEach(a=>a.stop()),this.liveStreams.delete(e))}this.sources.splice(t,1),this.save(),this.notify()}}save(){let e=this.sources.filter(t=>t.type==="url");localStorage.setItem(dt,JSON.stringify(e))}load(){try{let e=localStorage.getItem(dt);e&&(this.sources=JSON.parse(e))}catch{this.sources=[]}}notify(){this.onChange&&this.onChange()}};var pt="mlmap:playlists",Re="mlmap:activePlaylist",we=class{constructor(){this.playlists=[];this.activeId=null;this.onChange=null;this.load()}set onChanged(e){this.onChange=e}getAll(){return[...this.playlists]}getActive(){return this.playlists.find(e=>e.id===this.activeId)||this.playlists[0]||null}setActive(e){this.activeId=e,localStorage.setItem(Re,e),this.notify()}create(e){let t={id:`pl-${Date.now()}`,name:e,items:[],loop:!0};return this.playlists.push(t),this.activeId||(this.activeId=t.id),this.save(),this.notify(),t}remove(e){this.playlists=this.playlists.filter(t=>t.id!==e),this.activeId===e&&(this.activeId=this.playlists[0]?.id||null),this.save(),this.notify()}addItem(e,t){let s=this.playlists.find(a=>a.id===e);if(!s)return;let i={id:`item-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,sourceId:t,order:s.items.length};s.items.push(i),this.save(),this.notify()}removeItem(e,t){let s=this.playlists.find(i=>i.id===e);s&&(s.items=s.items.filter(i=>i.id!==t),s.items.forEach((i,a)=>i.order=a),this.save(),this.notify())}moveItem(e,t,s){let i=this.playlists.find(u=>u.id===e);if(!i)return;let a=i.items.findIndex(u=>u.id===t);if(a<0)return;let n=s==="up"?a-1:a+1;n<0||n>=i.items.length||([i.items[a],i.items[n]]=[i.items[n],i.items[a]],i.items.forEach((u,c)=>u.order=c),this.save(),this.notify())}toggleLoop(e){let t=this.playlists.find(s=>s.id===e);t&&(t.loop=!t.loop,this.save(),this.notify())}save(){localStorage.setItem(pt,JSON.stringify(this.playlists)),this.activeId&&localStorage.setItem(Re,this.activeId)}load(){try{let e=localStorage.getItem(pt);e?this.playlists=JSON.parse(e):this.create("Default"),this.activeId=localStorage.getItem(Re)||this.playlists[0]?.id||null}catch{this.create("Default")}}notify(){this.onChange&&this.onChange()}};function ht(d){if(!isFinite(d)||isNaN(d))return"0:00";let e=Math.floor(d/60),t=Math.floor(d%60);return`${e}:${t.toString().padStart(2,"0")}`}function ut(d,e,t,s){let i=new xe,a=new we,n=null,u=0;d.innerHTML=`
        <div class="mlmap-section">
            <div class="mlmap-section-title">Media Library</div>
            <div style="display:flex;gap:4px;margin-bottom:4px;">
                <input id="vp-url" type="text" class="mlmap-input" placeholder="Video URL..." style="flex:1;min-width:0;">
                <button id="vp-addUrl" class="mlmap-btn">Add</button>
            </div>
            <div style="display:flex;gap:4px;margin-bottom:6px;">
                <input id="vp-file" type="file" accept="video/*" style="display:none;">
                <button id="vp-chooseFile" class="mlmap-btn" style="flex:1;">Browse file...</button>
            </div>
            <div style="display:flex;gap:4px;margin-bottom:6px;">
                <button id="vp-capture" class="mlmap-btn" style="flex:1;">Screen capture...</button>
                <button id="vp-webcam" class="mlmap-btn" style="flex:1;">Webcam...</button>
            </div>
            <div id="vp-library"></div>
        </div>
        <div class="mlmap-section">
            <div class="mlmap-section-title">Playlist</div>
            <div style="display:flex;gap:4px;align-items:center;margin-bottom:6px;">
                <select id="vp-plSelect" class="mlmap-select" style="flex:1;min-width:0;"></select>
                <button id="vp-plNew" class="mlmap-btn" title="New playlist">+</button>
                <button id="vp-plDel" class="mlmap-btn" title="Delete playlist">-</button>
            </div>
            <div id="vp-playlist" style="margin-bottom:4px;"></div>
            <button id="vp-loop" class="mlmap-btn" style="width:100%;font-size:10px;">Loop: ON</button>
        </div>
    `,e.innerHTML=`
        <div style="display:flex;align-items:center;gap:3px;">
            <button id="tp-prev" class="transport-btn" title="Previous">|&lt;</button>
            <button id="tp-rw" class="transport-btn" title="-10s">&lt;&lt;</button>
            <button id="tp-play" class="transport-btn" title="Play" style="width:38px;font-size:14px;">&#9654;</button>
            <button id="tp-ff" class="transport-btn" title="+10s">&gt;&gt;</button>
            <button id="tp-next" class="transport-btn" title="Next">&gt;|</button>
            <button id="tp-stop" class="transport-btn" title="Stop">&#9632;</button>
        </div>
        <input id="tp-seek" type="range" min="0" max="1000" value="0" step="1" class="mlmap-range" style="flex:1;min-width:80px;">
        <span id="tp-time" style="font-size:11px;white-space:nowrap;color:#aaa;min-width:85px;text-align:center;">0:00 / 0:00</span>
        <span id="tp-now" style="flex:1;font-size:11px;color:#888;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:center;">No media</span>
        <div style="display:flex;align-items:center;gap:4px;">
            <span style="font-size:10px;color:#666;">Vol</span>
            <input id="tp-vol" type="range" min="0" max="100" value="100" class="mlmap-range" style="width:70px;">
            <button id="tp-mute" class="transport-btn" style="width:28px;font-size:10px;" title="Mute/Unmute">M</button>
        </div>
        <select id="tp-audioOut" class="mlmap-select" style="max-width:120px;font-size:10px;" title="Audio output routing">
            <option value="editor">Audio: Editor</option>
            <option value="output">Audio: Output</option>
            <option value="both">Audio: Both</option>
        </select>
    `;let c=h=>document.getElementById(h);function y(h){n=h,h.addEventListener("timeupdate",$),h.addEventListener("play",()=>{n===h&&R(),$()}),h.addEventListener("pause",$),h.addEventListener("ended",E),h.addEventListener("loadedmetadata",$)}function m(h){let w=a.getActive();if(!w||!w.items[h]||!n)return;u=h;let k=w.items[h],P=i.getById(k.sourceId);P&&(n.src=P.url,n.load())}function g(){let h=a.getActive();if(!(!h||h.items.length===0)){if(u++,u>=h.items.length)if(h.loop)u=0;else{u=h.items.length-1;return}m(u),n&&n.play().catch(()=>{}),t.send("NEXT")}}function x(){let h=a.getActive();if(!(!h||h.items.length===0)){if(u--,u<0)if(h.loop)u=h.items.length-1;else{u=0;return}m(u),n&&n.play().catch(()=>{}),t.send("PREVIOUS")}}function E(){let h=a.getActive();h&&h.items.length>1?g():h&&h.loop&&n&&(n.currentTime=0,n.play().catch(()=>{}),t.send("SEEK",{time:0}),t.send("PLAY"))}function T(){let h=a.getActive();if(h&&h.items[u]){let w=i.getById(h.items[u].sourceId);if(w)return w.name}if(n&&n.src&&n.src!==window.location.href){let w=n.src.split("/");return w[w.length-1]||"Video"}return""}c("vp-addUrl").addEventListener("click",()=>{let h=c("vp-url"),w=h.value.trim();w&&(i.addUrl(w),h.value="",_())}),c("vp-url").addEventListener("keydown",h=>{h.stopPropagation(),h.key==="Enter"&&c("vp-addUrl").click()}),c("vp-chooseFile").addEventListener("click",()=>c("vp-file").click()),c("vp-file").addEventListener("change",h=>{let w=h.target;w.files&&w.files[0]&&(i.addFile(w.files[0]),_(),w.value="")}),c("vp-capture").addEventListener("click",async()=>{try{let h=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!0}),k=h.getVideoTracks()[0]?.label||"Screen Capture",P=i.addCapture(h,k);_(),s(P.url,P.name,h)}catch{}}),c("vp-webcam").addEventListener("click",async()=>{try{let w=(await navigator.mediaDevices.enumerateDevices()).filter(W=>W.kind==="videoinput"),k={video:!0,audio:!0};if(w.length>1){let W=w.map((Y,ye)=>`${ye+1}. ${Y.label||`Camera ${ye+1}`}`).join(`
`),N=prompt(`Select camera:
${W}`,"1");if(!N)return;let U=parseInt(N)-1;U>=0&&U<w.length&&(k={video:{deviceId:{exact:w[U].deviceId}},audio:!0})}let P=await navigator.mediaDevices.getUserMedia(k),D=P.getVideoTracks()[0]?.label||"Webcam",V=i.addCapture(P,D);_(),s(V.url,V.name,P)}catch{}}),c("vp-plSelect").addEventListener("change",h=>{a.setActive(h.target.value),j()}),c("vp-plNew").addEventListener("click",()=>{let h=prompt("Playlist name:","New Playlist");if(h){let w=a.create(h);a.setActive(w.id),te(),j()}}),c("vp-plDel").addEventListener("click",()=>{let h=a.getActive();h&&a.getAll().length>1&&(a.remove(h.id),te(),j())}),c("vp-loop").addEventListener("click",()=>{let h=a.getActive();h&&(a.toggleLoop(h.id),j())});let L="mlmap:audioMode",I=localStorage.getItem(L)||"editor",S=!1;function R(){n&&(n.muted=S||I==="output"),t.send("SET_MUTED",{muted:S||I==="editor"}),$()}function J(){n&&(t.send("SEEK",{time:n.currentTime}),n.paused?t.send("PAUSE"):t.send("PLAY"),t.send("SET_VOLUME",{volume:n.volume}),t.send("SET_MUTED",{muted:S||I==="editor"}))}c("tp-play").addEventListener("click",()=>{if(!n){let h=a.getActive();if(h&&h.items.length>0){let w=h.items[0],k=i.getById(w.sourceId);k&&(s(k.url,k.name),setTimeout(()=>{n&&(S=!1,R(),m(0),setTimeout(()=>{n&&n.play().catch(()=>{}),oe(),t.send("PLAY"),$()},200))},100))}return}if(n.paused){if(S=!1,R(),!n.src||n.src===window.location.href){let h=a.getActive();h&&h.items.length>0&&(m(0),setTimeout(()=>{n&&n.play().catch(()=>{}),$()},200))}else n.play().catch(()=>{});t.send("PLAY"),$()}else n.pause(),t.send("PAUSE")}),c("tp-stop").addEventListener("click",()=>{n&&(n.pause(),n.currentTime=0),t.send("STOP"),$()}),c("tp-prev").addEventListener("click",()=>x()),c("tp-next").addEventListener("click",()=>g()),c("tp-rw").addEventListener("click",()=>{if(n){let h=Math.max(0,n.currentTime-10);n.currentTime=h,t.send("SEEK",{time:h})}}),c("tp-ff").addEventListener("click",()=>{if(n){let h=n.currentTime+10;n.currentTime=h,t.send("SEEK",{time:h})}});let X=c("tp-seek"),z=!1;X.addEventListener("pointerdown",()=>{z=!0}),X.addEventListener("pointerup",()=>{z=!1}),X.addEventListener("input",()=>{if(n&&n.duration>0){let h=parseInt(X.value)/1e3*n.duration;n.currentTime=h,t.send("SEEK",{time:h})}}),c("tp-vol").addEventListener("input",h=>{let w=parseInt(h.target.value)/100;n&&(n.volume=w),t.send("SET_VOLUME",{volume:w})}),c("tp-mute").addEventListener("click",()=>{S=!S,R()}),c("tp-audioOut").value=I,c("tp-audioOut").addEventListener("change",h=>{I=h.target.value,localStorage.setItem(L,I),R()});function ue(h){n&&n!==h&&(n.muted=!0),n=h,h.addEventListener("timeupdate",$),h.addEventListener("play",()=>{n===h&&R(),$()}),h.addEventListener("pause",$),h.addEventListener("ended",E),h.addEventListener("loadedmetadata",$),R()}d.addEventListener("keydown",h=>{let w=h.target.tagName;(w==="INPUT"||w==="SELECT"||w==="TEXTAREA")&&h.stopPropagation()});function $(){let h=n,w=h?!h.paused:!1,k=h?.currentTime||0,P=h?.duration||0;c("tp-play").innerHTML=w?"&#9646;&#9646;":"&#9654;",P>0&&!z&&(X.value=String(Math.round(k/P*1e3))),c("tp-time").textContent=`${ht(k)} / ${ht(P)}`;let M=T();if(c("tp-now").textContent=M||"No media",h){c("tp-vol").value=String(Math.round(h.volume*100));let D=c("tp-mute");D.textContent=S?"M":"\u266A",D.style.color=S?"#f55":"#ccc"}}function _(){let h=c("vp-library");if(!h)return;let w=i.getAll();if(h.innerHTML="",w.length===0){h.innerHTML='<div style="color:#555;font-size:11px;padding:4px;">No media added yet</div>';return}w.forEach(k=>{let P=document.createElement("div");P.className="mlmap-media-item";let M=document.createElement("span");M.className="name",M.textContent=k.type==="capture"?`[LIVE] ${k.name}`:k.name,M.title=k.type==="capture"?"Screen capture":k.url,k.type==="capture"&&(M.style.color="#5f5");let D=document.createElement("span");D.style.cssText="display:flex;gap:2px;flex-shrink:0;";let V=document.createElement("button");V.className="mlmap-btn",V.textContent="Layer",V.title="Create video layer",V.style.cssText="font-size:10px;padding:2px 4px;",V.addEventListener("click",()=>{let U=i.getStream(k.id);s(k.url,k.name,U)});let W=document.createElement("button");k.type!=="capture"&&(W.className="mlmap-btn",W.textContent="+PL",W.title="Add to playlist",W.style.cssText="font-size:10px;padding:2px 4px;",W.addEventListener("click",()=>{let U=a.getActive();U&&(a.addItem(U.id,k.id),j())}));let N=document.createElement("button");N.className="mlmap-btn",N.textContent="x",N.title="Remove",N.style.cssText="font-size:10px;padding:2px 4px;color:#f55;",N.addEventListener("click",()=>{i.remove(k.id),_()}),D.appendChild(V),D.appendChild(W),D.appendChild(N),P.appendChild(M),P.appendChild(D),h.appendChild(P)})}function te(){let h=c("vp-plSelect");if(!h)return;let w=a.getAll(),k=a.getActive();h.innerHTML="",w.forEach(P=>{let M=document.createElement("option");M.value=P.id,M.textContent=P.name,k&&k.id===P.id&&(M.selected=!0),h.appendChild(M)})}function j(){let h=c("vp-playlist");if(!h)return;let w=a.getActive();if(h.innerHTML="",!!w){if(c("vp-loop").textContent=`Loop: ${w.loop?"ON":"OFF"}`,w.items.length===0){h.innerHTML='<div style="color:#555;font-size:11px;padding:4px;">Playlist empty</div>';return}w.items.forEach((k,P)=>{let M=i.getById(k.sourceId),D=document.createElement("div");D.className="mlmap-pl-item";let V=document.createElement("span");V.className="name",V.textContent=`${P+1}. ${M?.name||"Unknown"}`;let W=document.createElement("span");W.style.cssText="display:flex;gap:1px;flex-shrink:0;";let N=document.createElement("button");N.className="mlmap-btn",N.innerHTML="&#9650;",N.style.cssText="font-size:8px;padding:1px 3px;",N.addEventListener("click",()=>{a.moveItem(w.id,k.id,"up"),j()});let U=document.createElement("button");U.className="mlmap-btn",U.innerHTML="&#9660;",U.style.cssText="font-size:8px;padding:1px 3px;",U.addEventListener("click",()=>{a.moveItem(w.id,k.id,"down"),j()});let Y=document.createElement("button");Y.className="mlmap-btn",Y.textContent="x",Y.style.cssText="font-size:9px;padding:1px 3px;color:#f55;",Y.addEventListener("click",()=>{a.removeItem(w.id,k.id),j()}),W.appendChild(N),W.appendChild(U),W.appendChild(Y),D.appendChild(V),D.appendChild(W),h.appendChild(D)})}}function oe(){let h=a.getActive();if(!h)return;let w=h.items.map(k=>{let P=i.getById(k.sourceId);return{url:P?.url||"",name:P?.name||"Unknown"}}).filter(k=>k.url);t.send("LOAD_PLAYLIST",{items:w,loop:h.loop,startIndex:u})}function Te(){c("tp-play").click()}return _(),te(),j(),{sourceManager:i,playlistManager:a,sendPlaylistToDisplay:oe,syncPlaybackToDisplay:J,registerVideoElement:y,setActiveVideo:ue,getActiveVideo:()=>n,togglePlayPause:Te}}fe();var mt="mlmap.managedLayers",Ne="mlmap:videoSources",ft="mlmap:playlists",yt="mlmap:activePlaylist",gt="mlmap:currentWorkspaceId";function Oe(d){let e=localStorage.getItem(gt)||"default",t=localStorage.getItem(`mlmap:workspace<${e}>`),s=t?JSON.parse(t):{id:e,name:"Workspace",version:"1.0",layout:[]},i=[];try{let c=localStorage.getItem(mt);c&&(i=JSON.parse(c))}catch{}let a=[];try{let c=localStorage.getItem(Ne);c&&(a=JSON.parse(c))}catch{}a=a.filter(c=>c.type==="url");let n=[];try{let c=localStorage.getItem(ft);c&&(n=JSON.parse(c))}catch{}let u=localStorage.getItem(yt);return{version:K,name:d||s.name||"Workflow",timestamp:Date.now(),workspace:{id:s.id,name:s.name,layout:s.layout},managedLayers:i,videoSources:a,playlists:n,activePlaylistId:u}}function Ue(d){let e=Date.now().toString(),t={id:e,name:d.name||d.workspace.name||"Imported",version:"1.0",layout:d.workspace.layout||[]};if(localStorage.setItem(`mlmap:workspace<${e}>`,JSON.stringify(t)),localStorage.setItem(gt,e),d.managedLayers&&localStorage.setItem(mt,JSON.stringify(d.managedLayers)),d.videoSources&&d.videoSources.length>0){let s=[];try{let a=localStorage.getItem(Ne);a&&(s=JSON.parse(a))}catch{}let i=new Set(s.map(a=>a.url));for(let a of d.videoSources)i.has(a.url)||(s.push(a),i.add(a.url));localStorage.setItem(Ne,JSON.stringify(s))}d.playlists&&d.playlists.length>0&&localStorage.setItem(ft,JSON.stringify(d.playlists)),d.activePlaylistId&&localStorage.setItem(yt,d.activePlaylistId)}function Wt(d){let e=JSON.stringify(d),t=new TextEncoder().encode(e),s="";for(let i=0;i<t.length;i++)s+=String.fromCharCode(t[i]);return btoa(s).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function Rt(d){try{let e=d.replace(/-/g,"+").replace(/_/g,"/");for(;e.length%4;)e+="=";let t=atob(e),s=new Uint8Array(t.length);for(let n=0;n<t.length;n++)s[n]=t.charCodeAt(n);let i=new TextDecoder().decode(s),a=JSON.parse(i);return!a.workspace||!a.version?null:a}catch{return null}}function vt(d){let e=Wt(d);return`${window.location.origin+window.location.pathname}?workflow=${e}`}function bt(){let e=new URLSearchParams(window.location.search).get("workflow");if(!e)return!1;let t=Rt(e);if(!t)return console.warn("MLMap: Invalid workflow data in URL"),!1;Ue(t);let s=window.location.origin+window.location.pathname;return window.history.replaceState({},document.title,s),!0}function xt(d){let e=JSON.stringify(d,null,2),t=new Blob([e],{type:"application/json"}),s=URL.createObjectURL(t),i=document.createElement("a");i.href=s,i.download=`${d.name.replace(/[^a-zA-Z0-9_-]/g,"_")}.mlmap`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s)}function wt(){return new Promise(d=>{let e=document.createElement("input");e.type="file",e.accept=".mlmap,.json",e.addEventListener("change",()=>{let t=e.files?.[0];if(!t){d(null);return}let s=new FileReader;s.onload=()=>{try{let i=JSON.parse(s.result);if(!i.workspace||!i.version){alert("Invalid workflow file."),d(null);return}d(i)}catch{alert("Failed to parse workflow file."),d(null)}},s.readAsText(t)}),e.click()})}var Le=class{constructor(e){this.running=!1;this.rafId=0;this.zoom=1;this.getClipGroups=e,this.canvas=document.createElement("canvas"),this.canvas.style.position="fixed",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.zIndex="999999",this.canvas.style.pointerEvents="none",this.ctx=this.canvas.getContext("2d"),window.addEventListener("resize",()=>this.resize()),this.resize()}get canvasElement(){return this.canvas}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight}start(){this.running||(this.running=!0,this.render())}stop(){this.running=!1,this.rafId&&cancelAnimationFrame(this.rafId),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}render(){if(!this.running)return;let e=this.canvas.width,t=this.canvas.height;this.ctx.clearRect(0,0,e,t);let s=this.getClipGroups();if(this.zoom!==1){this.ctx.save();let i=e/2,a=t/2;this.ctx.translate(i,a),this.ctx.scale(this.zoom,this.zoom),this.ctx.translate(-i,-a)}for(let i of s){let a=i.video;if(a.readyState<2)continue;let n=i.baseTargetPoints,u=1/0,c=1/0,y=-1/0,m=-1/0;for(let E of n)E[0]<u&&(u=E[0]),E[1]<c&&(c=E[1]),E[0]>y&&(y=E[0]),E[1]>m&&(m=E[1]);let g=y-u,x=m-c;if(!(g<=0||x<=0))for(let E of i.masks){let T=E.targetPoints;if(!(!T||T.length<3)){this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(T[0][0],T[0][1]);for(let L=1;L<T.length;L++)this.ctx.lineTo(T[L][0],T[L][1]);this.ctx.closePath(),this.ctx.clip(),this.ctx.drawImage(a,u,c,g,x),this.ctx.restore()}}}this.zoom!==1&&this.ctx.restore(),this.rafId=requestAnimationFrame(()=>this.render())}};function Lt(d){let e=window.innerWidth<900||window.innerHeight<500,t=window.matchMedia("(pointer: coarse)").matches&&!window.matchMedia("(pointer: fine)").matches;if(e||t){let o=document.createElement("div");o.id="mlmap-device-warning",o.style.cssText="position:fixed;inset:0;z-index:9999999;background:#111;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;font-family:-apple-system,'Segoe UI',Roboto,sans-serif;color:#ccc;padding:32px;",o.innerHTML=`
            <div style="font-size:48px;margin-bottom:16px;">\u{1F5A5}\uFE0F</div>
            <h2 style="color:#fff;margin:0 0 12px;font-size:20px;">Screen too small</h2>
            <p style="max-width:400px;line-height:1.6;margin:0 0 24px;color:#999;">
                MLMap requires a computer or tablet with a keyboard and mouse.<br>
                Minimum screen size: 900 &times; 500 px.
            </p>
            <p style="font-size:12px;color:#555;">Current: ${window.innerWidth} &times; ${window.innerHeight} px</p>
        `,document.body.appendChild(o),window.addEventListener("resize",()=>{window.innerWidth>=900&&window.innerHeight>=500&&o.parentElement&&o.remove()});return}let s=document.createElement("style");s.textContent=`
        #mlmap-app {
            position: fixed;
            inset: 0;
            display: grid;
            grid-template-rows: 38px 1fr 48px;
            grid-template-columns: 210px 1fr 270px;
            grid-template-areas:
                "toolbar toolbar toolbar"
                "left center right"
                "transport transport transport";
            z-index: 1000001;
            pointer-events: none;
            font-family: -apple-system, 'Segoe UI', Roboto, sans-serif;
            font-size: 12px;
            color: #ccc;
            user-select: none;
        }
        #mlmap-toolbar {
            grid-area: toolbar;
            pointer-events: auto;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
        }
        #mlmap-left {
            grid-area: left;
            pointer-events: auto;
            background: #222;
            border-right: 1px solid #333;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        #mlmap-right {
            grid-area: right;
            pointer-events: auto;
            background: #222;
            border-left: 1px solid #333;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        #mlmap-transport {
            grid-area: transport;
            pointer-events: auto;
            background: #1a1a1a;
            border-top: 1px solid #333;
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 8px;
        }
        .mlmap-section {
            padding: 8px;
            border-bottom: 1px solid #333;
        }
        .mlmap-section-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #888;
            margin-bottom: 6px;
        }
        .mlmap-btn {
            background: #383838;
            color: #ccc;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            font-family: inherit;
        }
        .mlmap-btn:hover { background: #484848; color: #fff; }
        .mlmap-btn:active { background: #555; }
        .mlmap-btn-primary { background: #2a6cb5; color: #fff; }
        .mlmap-btn-primary:hover { background: #3580d0; }
        .mlmap-input {
            background: #1a1a1a;
            color: #ccc;
            border: 1px solid #444;
            border-radius: 3px;
            padding: 4px 6px;
            font-size: 11px;
            font-family: inherit;
            outline: none;
        }
        .mlmap-input:focus { border-color: #2a6cb5; }
        .mlmap-select {
            background: #1a1a1a;
            color: #ccc;
            border: 1px solid #444;
            border-radius: 3px;
            padding: 4px 6px;
            font-size: 11px;
            font-family: inherit;
            outline: none;
        }
        .mlmap-layer-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 3px 6px;
            border-radius: 3px;
            cursor: default;
        }
        .mlmap-layer-item:hover { background: #2a2a2a; }
        .mlmap-layer-item .name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 11px;
        }
        .mlmap-layer-item .icon {
            width: 14px;
            text-align: center;
            flex-shrink: 0;
            font-size: 10px;
        }
        .mlmap-layer-item .del-btn {
            opacity: 0;
            cursor: pointer;
            color: #f55;
            background: none;
            border: none;
            font-size: 11px;
            padding: 0 2px;
        }
        .mlmap-layer-item:hover .del-btn { opacity: 1; }
        .mlmap-media-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 3px 6px;
            border-radius: 3px;
        }
        .mlmap-media-item:hover { background: #2a2a2a; }
        .mlmap-media-item .name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 11px;
        }
        .mlmap-pl-item {
            display: flex;
            align-items: center;
            gap: 2px;
            padding: 3px 4px;
            border-radius: 3px;
            font-size: 11px;
        }
        .mlmap-pl-item:hover { background: #2a2a2a; }
        .mlmap-pl-item .name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .transport-btn {
            background: #333;
            color: #ccc;
            border: none;
            width: 30px;
            height: 26px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .transport-btn:hover { background: #444; color: #fff; }
        .mlmap-range {
            -webkit-appearance: none;
            appearance: none;
            background: #333;
            height: 6px;
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }
        .mlmap-range::-webkit-slider-runnable-track {
            height: 6px;
            border-radius: 3px;
        }
        .mlmap-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #aaa;
            cursor: pointer;
            margin-top: -4px;
        }
        .mlmap-range::-webkit-slider-thumb:hover { background: #fff; }
        .mlmap-range::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #aaa;
            cursor: pointer;
            border: none;
        }
        .mlmap-range::-moz-range-track {
            height: 6px;
            border-radius: 3px;
            background: #333;
        }
        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .app-title {
            font-weight: 700;
            font-size: 14px;
            color: #fff;
            letter-spacing: -0.5px;
            margin-right: 8px;
        }
        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-dot.connected { background: #4CAF50; }
        .status-dot.disconnected { background: #555; }
        #mlmap-left::-webkit-scrollbar,
        #mlmap-right::-webkit-scrollbar { width: 5px; }
        #mlmap-left::-webkit-scrollbar-track,
        #mlmap-right::-webkit-scrollbar-track { background: #1a1a1a; }
        #mlmap-left::-webkit-scrollbar-thumb,
        #mlmap-right::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        .add-layer-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3px;
        }
        .ws-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 3px;
            margin-top: 4px;
        }
        /* Context menu */
        #mlmap-context-menu {
            position: fixed;
            background: #2a2a2a;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 4px 0;
            min-width: 180px;
            z-index: 1000010;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            font-family: -apple-system, 'Segoe UI', Roboto, sans-serif;
            font-size: 12px;
            color: #ccc;
            display: none;
            pointer-events: auto;
        }
        .ctx-item {
            padding: 6px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ctx-item:hover { background: #3a3a3a; color: #fff; }
        .ctx-item .shortcut { color: #666; font-size: 10px; margin-left: 16px; }
        .ctx-sep { height: 1px; background: #444; margin: 3px 8px; }
        .ctx-item.disabled { color: #555; pointer-events: none; }
        .ctx-has-sub {
            position: relative;
        }
        .ctx-has-sub > .ctx-item { cursor: default; }
        .ctx-arrow { margin-left: auto; padding-left: 12px; font-size: 10px; color: #666; }
        .ctx-submenu {
            position: absolute;
            left: 100%;
            top: -4px;
            background: #2a2a2a;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 4px 0;
            min-width: 170px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            display: none;
        }
        .ctx-has-sub:hover > .ctx-submenu { display: block; }
    `,document.head.appendChild(s);let i=new be("control"),a=null,n=[],u="mlmap.managedLayers",c="mlmap:outputResolution",y=null,m=null,g=new Le(()=>x());function x(){let o=[],r=d.getLayers(),l=new Map;for(let p of n){if(!p.clipTo)continue;let f=n.find(O=>O.id===p.clipTo);if(!f)continue;let b=r.find(O=>O.element.id===f.id),v=r.find(O=>O.element.id===p.id);if(!b||!v)continue;let C=document.getElementById(f.id);if(!C)continue;let H=C.querySelector("video");H&&(l.has(f.id)||l.set(f.id,{video:H,baseTargetPoints:b.targetPoints.map(O=>[O[0],O[1]]),masks:[]}),l.get(f.id).masks.push({targetPoints:v.targetPoints.map(O=>[O[0],O[1]])}))}for(let p of l.values())o.push(p);return o}function E(){return n.some(o=>!!o.clipTo)}function T(){E()?g.start():g.stop()}let L=document.createElement("div");L.id="mlmap-workspace",L.style.cssText="position:fixed;inset:0;transform-origin:center center;",document.body.appendChild(L);let I=document.createElement("div");I.id="mlmap-app",I.innerHTML=`
        <div id="mlmap-toolbar">
            <div class="toolbar-group">
                <span class="app-title">MLMap</span>
                <span style="font-size:10px;color:#666;">v${K}</span>
                <button id="tb-toggleLeft" class="mlmap-btn" title="Toggle layers panel" style="font-size:10px;padding:4px 5px;">&laquo;</button>
            </div>
            <div class="toolbar-group">
                <span style="font-size:10px;color:#666;">Zoom</span>
                <input id="tb-zoom" type="range" min="25" max="100" value="100" class="mlmap-range" style="width:80px;" title="Workspace zoom">
                <span id="tb-zoomLabel" style="font-size:10px;color:#888;min-width:30px;">100%</span>
            </div>
            <div class="toolbar-group">
                <span style="font-size:10px;color:#666;">Output</span>
                <select id="tb-resolution" class="mlmap-select" title="Output resolution" style="max-width:130px;">
                    <option value="auto">Auto</option>
                    <option value="1920x1080">1920x1080</option>
                    <option value="1280x720">1280x720</option>
                    <option value="3840x2160">3840x2160</option>
                    <option value="1024x768">1024x768</option>
                    <option value="custom">Custom...</option>
                </select>
                <input id="tb-resW" class="mlmap-input" type="number" style="width:50px;display:none;" placeholder="W">
                <input id="tb-resH" class="mlmap-input" type="number" style="width:50px;display:none;" placeholder="H">
            </div>
            <div class="toolbar-group">
                <select id="tb-monitor" class="mlmap-select" title="Select output monitor" style="max-width:140px;">
                    <option value="">Monitor...</option>
                </select>
                <button id="tb-launch" class="mlmap-btn mlmap-btn-primary">Launch Output</button>
                <button id="tb-exportTpl" class="mlmap-btn" title="Export layout template as image">TPL</button>
                <button id="tb-fullscreen" class="mlmap-btn" title="Fullscreen output">FS</button>
                <span class="status-dot disconnected" id="tb-status" title="Display disconnected"></span>
                <button id="tb-toggleRight" class="mlmap-btn" title="Toggle media panel" style="font-size:10px;padding:4px 5px;">&raquo;</button>
            </div>
        </div>
        <div id="mlmap-left"></div>
        <div id="mlmap-right"></div>
        <div id="mlmap-transport"></div>
    `,document.body.appendChild(I),I.addEventListener("mousedown",o=>o.stopPropagation());let S=document.createElement("div");S.id="mlmap-context-menu",document.body.appendChild(S),S.addEventListener("mousedown",o=>o.stopPropagation());let R=document.getElementById("mlmap-left"),J=document.getElementById("mlmap-right"),X=document.getElementById("mlmap-transport");R.innerHTML=`
        <div class="mlmap-section">
            <div class="mlmap-section-title">Layers</div>
            <div id="lp-layerList"></div>
            <div class="mlmap-section-title" style="margin-top:8px;">Add Layer</div>
            <div class="add-layer-grid">
                <button id="lp-addSquare" class="mlmap-btn">&#9633; Square</button>
                <button id="lp-addCircle" class="mlmap-btn">&#9675; Circle</button>
                <button id="lp-addTriangle" class="mlmap-btn">&#9651; Triangle</button>
                <button id="lp-addIframe" class="mlmap-btn">&#8865; iframe</button>
            </div>
            <div class="mlmap-section-title" style="margin-top:8px;">Options</div>
            <label style="display:flex;align-items:center;gap:4px;font-size:11px;cursor:pointer;">
                <input type="checkbox" id="lp-snap" checked> Snap to edges (G)
            </label>
        </div>
        <div class="mlmap-section">
            <div class="mlmap-section-title">Workspaces</div>
            <select id="lp-wsSelect" class="mlmap-select" style="width:100%;"></select>
            <div class="ws-grid">
                <button id="lp-wsAdd" class="mlmap-btn" title="New">+</button>
                <button id="lp-wsDup" class="mlmap-btn" title="Duplicate">&#128203;</button>
                <button id="lp-wsRen" class="mlmap-btn" title="Rename">&#9998;</button>
                <button id="lp-wsReset" class="mlmap-btn" title="Reset">&#8634;</button>
                <button id="lp-wsDel" class="mlmap-btn" title="Delete">&#128465;</button>
            </div>
            <div class="mlmap-section-title" style="margin-top:8px;">Import / Export</div>
            <div style="display:flex;flex-direction:column;gap:3px;">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;">
                    <button id="lp-wfExport" class="mlmap-btn" title="Export workflow to .mlmap file">Export File</button>
                    <button id="lp-wfImport" class="mlmap-btn" title="Import workflow from .mlmap file">Import File</button>
                </div>
                <button id="lp-wfShare" class="mlmap-btn mlmap-btn-primary" title="Copy share URL to clipboard" style="width:100%;">Copy Share URL</button>
            </div>
        </div>
        <div class="mlmap-section" style="border-bottom:none;">
            <div class="mlmap-section-title">Shortcuts</div>
            <pre style="font-size:10px;color:#666;margin:0;white-space:pre-wrap;line-height:1.5;">SHIFT+Space: Toggle edit mode
Space: Play/Pause video
Drag: Move | SHIFT+Drag: Precise
ALT+Drag: Rotate/Scale
Ctrl+Click: Multi-select layers
Drag empty: Rubber band select
Arrows: Move | S: Solo | C: Cross
R: Rotate | H/V: Flip | B: Bounds
DEL: Delete | Ctrl+Z/Y: Undo/Redo
G: Toggle snap | Right-click: Menu</pre>
        </div>
    `;let z=ut(J,X,i,j);function ue(o,r){!r||!r.startsWith("blob:")||fetch(r).then(l=>l.arrayBuffer()).then(l=>{i.send("SEND_VIDEO_DATA",{layerId:o,data:l,mimeType:"video/mp4"})}).catch(()=>{})}function $(){let o=d.getLayout(),r=d.outputFrame;if(!r||r.w<=0||r.h<=0)return o;let l=r.resW/r.w,p=r.resH/r.h;return o.map(f=>({...f,targetPoints:f.targetPoints.map(b=>[(b[0]-r.x)*l,(b[1]-r.y)*p])}))}function _(){i.send("UPDATE_LAYOUT",{layout:$()})}function te(){let o=y||m;return o?{w:o.width,h:o.height}:{w:1920,h:1080}}function j(o,r,l){let p=`vlayer_${Date.now()}`,f=te(),b=document.createElement("div");b.id=p,b.style.position="fixed",b.style.top="0px",b.style.left="0px",b.style.width=f.w+"px",b.style.height=f.h+"px",b.style.overflow="hidden",b.style.background="#000";let v=document.createElement("video");l?(v.srcObject=l,v.autoplay=!0):(v.src=o,v.preload="metadata"),v.style.width="100%",v.style.height="100%",v.style.objectFit="contain",v.muted=!0,v.playsInline=!0,b.appendChild(v),l&&l.getTracks().forEach(ce=>{ce.addEventListener("ended",()=>{if(l.getTracks().every(q=>q.readyState==="ended")){v.srcObject=null,b.innerHTML="";let q=document.createElement("div");q.className="mlmap-video-placeholder",q.style.cssText="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none;",q.innerHTML=`<span style="font-size:18px;color:#555;">&#9632;</span><span style="font-size:10px;color:#555;margin-top:2px;">${r}</span><span style="font-size:9px;color:#444;margin-top:2px;">Capture ended</span>`,b.appendChild(q),M()}})}),L.appendChild(b);let C=window.innerWidth/2,H=window.innerHeight/2;d.addLayer(b,[[C-200,H-150],[C+200,H-150],[C+200,H+150],[C-200,H+150]]),z.registerVideoElement(v);let O={id:p,name:r,type:"video",videoUrl:l?void 0:o,width:f.w,height:f.h};n.push(O),D(),M(),i.send("ADD_LAYER",O),!l&&o&&ue(p,o),setTimeout(()=>_(),100)}function oe(o){let r=`shape_${Date.now()}`,l=document.createElement("div");l.id=r;let p=window.innerWidth/2,f=window.innerHeight/2;l.style.position="fixed",l.style.top="0px",l.style.left="0px",l.style.width="100px",l.style.height="100px",l.style.background=o==="triangle"?"transparent":"white",l.style.border=o==="triangle"?"2px solid white":"none",o==="circle"&&(l.style.borderRadius="50%"),o==="triangle"&&(l.style.width="0",l.style.height="0",l.style.borderLeft="50px solid transparent",l.style.borderRight="50px solid transparent",l.style.borderBottom="100px solid white"),L.appendChild(l);let b=50,v=50,C=o==="triangle"?[[p,f-v],[p+b,f+v],[p-b,f+v],[p,f+v]]:[[p-b,f-v],[p+b,f-v],[p+b,f+v],[p-b,f+v]];d.addLayer(l,C);let H={id:r,name:`${o}`,type:"shape",shapeType:o,width:100,height:100};n.push(H),D(),M(),i.send("ADD_LAYER",H),setTimeout(()=>_(),100)}function Te(o){let r=`iframe_${Date.now()}`,l=document.createElement("div");l.id=r,l.style.position="fixed",l.style.top="0px",l.style.left="0px",l.style.width="400px",l.style.height="300px",l.style.overflow="hidden",l.style.background="#000";let p=document.createElement("iframe");p.src=o,p.style.width="100%",p.style.height="100%",p.style.border="none",p.style.pointerEvents="none",p.setAttribute("allow","autoplay; encrypted-media"),l.appendChild(p),L.appendChild(l);let f=window.innerWidth/2,b=window.innerHeight/2;d.addLayer(l,[[f-200,b-150],[f+200,b-150],[f+200,b+150],[f-200,b+150]]);let v=o.replace(/^https?:\/\//,"").split("/")[0]||"iframe",C={id:r,name:v,type:"iframe",iframeUrl:o,width:400,height:300};n.push(C),D(),M(),i.send("ADD_LAYER",C),setTimeout(()=>_(),100)}function h(o){n.forEach(p=>{p.clipTo===o&&k(p.id)}),n.find(p=>p.id===o)?.clipTo&&k(o);let l=document.getElementById(o);l&&l.remove(),n=n.filter(p=>p.id!==o),D(),M(),i.send("REMOVE_LAYER",{id:o}),T()}function w(o){let r=n.find(v=>v.id===o);if(!r||r.type!=="shape")return;let l=n.indexOf(r),p=null;for(let v=l-1;v>=0;v--)if(n[v].type==="video"){p=n[v].id;break}if(!p){for(let v=l+1;v<n.length;v++)if(n[v].type==="video"){p=n[v].id;break}}if(!p)return;r.clipTo=p;let f=document.getElementById(p);f&&(f.style.opacity="0");let b=document.getElementById(o);if(b&&(b.style.opacity="0"),f){let v=f.querySelector("video");v&&(v.paused&&v.play().catch(()=>{}),z.setActiveVideo(v))}D(),M(),T(),i.send("ADD_LAYER",r)}function k(o){let r=n.find(b=>b.id===o);if(!r||!r.clipTo)return;let l=r.clipTo;r.clipTo=void 0;let p=document.getElementById(o);if(p&&(p.style.opacity="1",r.shapeType==="triangle"?p.style.borderBottomColor="white":(r.shapeType,p.style.background="white")),!n.some(b=>b.clipTo===l)){let b=document.getElementById(l);b&&(b.style.opacity="1")}D(),M(),T(),i.send("ADD_LAYER",r)}function P(){let r=d.getLayers().map(l=>l.element.id);n.sort((l,p)=>{let f=r.indexOf(l.id),b=r.indexOf(p.id);return f-b}),D(),M()}function M(){let o=document.getElementById("lp-layerList");if(o.innerHTML="",n.length===0){o.innerHTML='<div style="color:#555;font-size:11px;padding:4px;">No layers</div>';return}n.forEach(r=>{let l=document.createElement("div");l.className="mlmap-layer-item",r.clipTo&&(l.style.paddingLeft="18px");let p=document.createElement("span");p.className="icon",r.type==="video"?p.textContent="\u25B6":r.type==="iframe"?p.textContent="\u29C9":r.shapeType==="circle"?p.textContent="\u25CF":r.shapeType==="triangle"?p.textContent="\u25B2":p.textContent="\u25A0";let f=r.type==="video"&&!document.getElementById(r.id)?.querySelector("video"),b=document.createElement("span");b.className="name",r.clipTo?b.textContent=`${r.name} (clip)`:f?(b.textContent=`${r.name}`,b.style.color="#f80"):b.textContent=r.name;let v=document.createElement("button");v.className="del-btn",v.textContent="\u2715",v.addEventListener("click",()=>h(r.id)),l.appendChild(p),l.appendChild(b),l.appendChild(v),o.appendChild(l)})}function D(){let o=n.map(r=>r.type==="video"?{...r,videoUrl:void 0}:r);localStorage.setItem(u,JSON.stringify(o))}function V(){try{let o=localStorage.getItem(u);o&&JSON.parse(o).forEach(p=>W(p));let r=localStorage.getItem("mlmap.dynamicShapes");r&&!o&&JSON.parse(r).forEach(p=>{let f={id:p.id,name:p.type,type:"shape",shapeType:p.type,width:100,height:100};W(f)})}catch{}M()}function W(o){let r=document.createElement("div");if(r.id=o.id,r.style.position="fixed",r.style.top="0px",r.style.left="0px",r.style.width=o.width+"px",r.style.height=o.height+"px",o.type==="video"){r.style.overflow="hidden",r.style.background="#111";let l=document.createElement("div");l.className="mlmap-video-placeholder",l.style.cssText="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none;",l.innerHTML=`<span style="font-size:18px;color:#555;">\u25B6</span><span style="font-size:10px;color:#555;margin-top:2px;">${o.name}</span><span style="font-size:9px;color:#444;margin-top:2px;">Re-import video</span>`,r.appendChild(l)}else if(o.type==="iframe"&&o.iframeUrl){r.style.overflow="hidden",r.style.background="#000";let l=document.createElement("iframe");l.src=o.iframeUrl,l.style.width="100%",l.style.height="100%",l.style.border="none",l.style.pointerEvents="none",l.setAttribute("allow","autoplay; encrypted-media"),r.appendChild(l)}else o.shapeType==="circle"?(r.style.background="white",r.style.borderRadius="50%"):o.shapeType==="triangle"?(r.style.width="0",r.style.height="0",r.style.borderLeft="50px solid transparent",r.style.borderRight="50px solid transparent",r.style.borderBottom="100px solid white",r.style.background="transparent"):r.style.background="white";L.appendChild(r),d.addLayer(r),n.push(o)}function N(o,r,l){let p=n.find(C=>C.id===o);if(!p||p.type!=="video")return;let f=document.getElementById(o);if(!f)return;let b=te();f.style.width=b.w+"px",f.style.height=b.h+"px",p.width=b.w,p.height=b.h,f.innerHTML="",f.style.background="#000";let v=document.createElement("video");v.src=r,v.style.width="100%",v.style.height="100%",v.style.objectFit="contain",v.muted=!0,v.playsInline=!0,v.preload="metadata",f.appendChild(v),z.registerVideoElement(v),p.name=l,p.videoUrl=r,D(),M(),n.some(C=>C.clipTo===o)&&(v.play().catch(()=>{}),T()),i.send("ADD_LAYER",p),ue(o,r),setTimeout(()=>_(),100)}function U(o,r,l){let p=n.find(C=>C.id===o);if(!p||p.type!=="video")return;let f=document.getElementById(o);if(!f)return;let b=te();f.style.width=b.w+"px",f.style.height=b.h+"px",p.width=b.w,p.height=b.h,f.innerHTML="",f.style.background="#000";let v=document.createElement("video");v.srcObject=r,v.autoplay=!0,v.style.width="100%",v.style.height="100%",v.style.objectFit="contain",v.muted=!0,v.playsInline=!0,f.appendChild(v),r.getTracks().forEach(C=>{C.addEventListener("ended",()=>{if(r.getTracks().every(H=>H.readyState==="ended")){v.srcObject=null,f.innerHTML="";let H=document.createElement("div");H.className="mlmap-video-placeholder",H.style.cssText="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none;",H.innerHTML=`<span style="font-size:18px;color:#555;">&#9632;</span><span style="font-size:10px;color:#555;margin-top:2px;">${l}</span><span style="font-size:9px;color:#444;margin-top:2px;">Capture ended</span>`,f.appendChild(H),M()}})}),z.registerVideoElement(v),p.name=l,p.videoUrl=void 0,D(),M(),n.some(C=>C.clipTo===o)&&T(),i.send("ADD_LAYER",p),setTimeout(()=>_(),100)}document.getElementById("lp-addSquare").addEventListener("click",()=>oe("square")),document.getElementById("lp-addCircle").addEventListener("click",()=>oe("circle")),document.getElementById("lp-addTriangle").addEventListener("click",()=>oe("triangle")),document.getElementById("lp-addIframe").addEventListener("click",()=>{let o=prompt("Enter URL for iframe:","https://");o&&o!=="https://"&&Te(o)});let Y=document.getElementById("lp-snap");Y.checked=d.snapEnabled,Y.addEventListener("change",()=>{d.snapEnabled=Y.checked}),d.onSnapChanged=o=>{Y.checked=o};function ye(o,r,l){d.selectLayer(l);let p=l.element.id,f=n.find(ee=>ee.id===p),b=f?.type==="shape",v=f?.type==="video",C=!!f?.clipTo,H="",O=n.some(ee=>ee.type==="video");b&&!C&&O?H="Create Clip Mask":C&&(H="Release Clip Mask"),S.innerHTML=`
            <div class="ctx-item" data-action="center">Center on screen</div>
            <div class="ctx-sep"></div>
            ${v?`
            <div class="ctx-has-sub">
                <div class="ctx-item" style="color:#5af;">Assign Video<span class="ctx-arrow">\u25B6</span></div>
                <div class="ctx-submenu">
                    <div class="ctx-item" data-action="assignFile">Browse file...</div>
                    <div class="ctx-item" data-action="assignUrl">Enter URL...</div>
                    <div class="ctx-sep"></div>
                    <div class="ctx-item" data-action="assignCapture">Screen capture...</div>
                    <div class="ctx-item" data-action="assignWebcam">Webcam...</div>
                </div>
            </div>
            <div class="ctx-sep"></div>`:""}
            <div class="ctx-has-sub">
                <div class="ctx-item">Layer Order<span class="ctx-arrow">\u25B6</span></div>
                <div class="ctx-submenu">
                    <div class="ctx-item" data-action="moveUp">Move Up</div>
                    <div class="ctx-item" data-action="moveDown">Move Down</div>
                    <div class="ctx-sep"></div>
                    <div class="ctx-item" data-action="sendToTop">Send to Top</div>
                    <div class="ctx-item" data-action="sendToBottom">Send to Bottom</div>
                </div>
            </div>
            <div class="ctx-has-sub">
                <div class="ctx-item">Transform<span class="ctx-arrow">\u25B6</span></div>
                <div class="ctx-submenu">
                    <div class="ctx-item" data-action="rotate90">Rotate 90\xB0</div>
                    <div class="ctx-item" data-action="rotate180">Rotate 180\xB0</div>
                    <div class="ctx-item" data-action="rotate270">Rotate 270\xB0</div>
                    <div class="ctx-sep"></div>
                    <div class="ctx-item" data-action="flipH">Flip Horizontal</div>
                    <div class="ctx-item" data-action="flipV">Flip Vertical</div>
                    <div class="ctx-sep"></div>
                    <div class="ctx-item" data-action="scaleUp">Scale +10%</div>
                    <div class="ctx-item" data-action="scaleDown">Scale -10%</div>
                    <div class="ctx-sep"></div>
                    <div class="ctx-item" data-action="resetTransform">Reset Transform</div>
                </div>
            </div>
            <div class="ctx-has-sub">
                <div class="ctx-item">Fit to Output<span class="ctx-arrow">\u25B6</span></div>
                <div class="ctx-submenu">
                    <div class="ctx-item" data-action="fitOutput">Fit to Output</div>
                    <div class="ctx-item" data-action="stretchOutput">Stretch to Output</div>
                </div>
            </div>
            <div class="ctx-sep"></div>
            ${H?`<div class="ctx-item" data-action="toggleClip">${H}</div><div class="ctx-sep"></div>`:""}
            <div class="ctx-item" data-action="solo">Solo / Unsolo<span class="shortcut">S</span></div>
            <div class="ctx-item" data-action="delete" style="color:#f55;">Delete layer<span class="shortcut">DEL</span></div>
        `;let ce=200,q=300,Ce=o+ce>window.innerWidth?o-ce:o,Me=r+q>window.innerHeight?r-q:r;S.style.left=Math.max(0,Ce)+"px",S.style.top=Math.max(0,Me)+"px",S.style.display="block",S.querySelectorAll(".ctx-item[data-action]").forEach(ee=>{ee.addEventListener("click",Z=>{switch(Z.stopPropagation(),ee.dataset.action){case"center":d.centerLayer(l);break;case"moveUp":d.moveLayerUp(l),P();break;case"moveDown":d.moveLayerDown(l),P();break;case"sendToTop":d.moveLayerToTop(l),P();break;case"sendToBottom":d.moveLayerToBottom(l),P();break;case"rotate90":d.rotateLayerPublic(l,90);break;case"rotate180":d.rotateLayerPublic(l,180);break;case"rotate270":d.rotateLayerPublic(l,270);break;case"flipH":d.flipLayerH(l);break;case"flipV":d.flipLayerV(l);break;case"scaleUp":d.scaleLayerPublic(l,1.1);break;case"scaleDown":d.scaleLayerPublic(l,.9);break;case"resetTransform":d.resetLayerTransform(l);break;case"fitOutput":{let B=d.outputFrame||{x:0,y:0,w:window.innerWidth,h:window.innerHeight};d.fitToFrame(l,B);break}case"stretchOutput":{let B=d.outputFrame||{x:0,y:0,w:window.innerWidth,h:window.innerHeight};d.stretchToFrame(l,B);break}case"toggleClip":C?k(p):w(p);break;case"assignFile":{let B=document.createElement("input");B.type="file",B.accept="video/*",B.onchange=()=>{let G=B.files?.[0];if(G){let pe=URL.createObjectURL(G);N(p,pe,G.name)}},B.click();break}case"assignUrl":{let B=prompt("Enter video URL:","https://");if(B&&B!=="https://"){let G=B.split("/").pop()||"Video URL";N(p,B,G)}break}case"assignCapture":{(async()=>{try{let B=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!0}),pe=B.getVideoTracks()[0]?.label||"Screen Capture";U(p,B,pe)}catch{}})();break}case"assignWebcam":{(async()=>{try{let G=(await navigator.mediaDevices.enumerateDevices()).filter(He=>He.kind==="videoinput"),pe={video:!0,audio:!0};if(G.length>1){let He=G.map((It,Ke)=>`${Ke+1}. ${It.label||`Camera ${Ke+1}`}`).join(`
`),Fe=prompt(`Select camera:
${He}`,"1");if(!Fe)return;let De=parseInt(Fe)-1;De>=0&&De<G.length&&(pe={video:{deviceId:{exact:G[De].deviceId}},audio:!0})}let Ye=await navigator.mediaDevices.getUserMedia(pe),St=Ye.getVideoTracks()[0]?.label||"Webcam";U(p,Ye,St)}catch{}})();break}case"solo":let de=d.getLayers();de.some(B=>!B.visible)?de.forEach(B=>B.visible=!0):(de.forEach(B=>B.visible=!1),l.visible=!0);break;case"delete":h(p);break}ke()})})}function ke(){S.style.display="none"}document.addEventListener("contextmenu",o=>{let r=o.target;if(r.closest("#mlmap-app")||r.closest("#mlmap-context-menu"))return;let l=d.getLayerAtPoint(o.clientX,o.clientY);l&&(o.preventDefault(),ye(o.clientX,o.clientY,l))}),document.addEventListener("mousedown",o=>{o.target.closest("#mlmap-context-menu")||ke()}),document.addEventListener("keydown",o=>{o.key==="Escape"&&ke()});let F=nt(),A=F.find(o=>o.id===localStorage.getItem("mlmap:currentWorkspaceId"))||null;!A&&F.length&&(A=F[0],localStorage.setItem("mlmap:currentWorkspaceId",A.id));function ze(){let o=document.getElementById("lp-wsSelect");o.innerHTML="",F.forEach(r=>{let l=document.createElement("option");l.value=r.id,l.textContent=r.name,A&&A.id===r.id&&(l.selected=!0),o.appendChild(l)})}function ge(o){localStorage.setItem("mlmap:currentWorkspaceId",o.id),window.location.reload()}document.getElementById("lp-wsAdd").addEventListener("click",()=>{let o=prompt("Workspace name:","New Workspace")||"New Workspace",r={id:Date.now().toString(),name:o,version:"1.0",layout:{}};F.push(r),ne(r),ge(r)}),document.getElementById("lp-wsDup").addEventListener("click",()=>{if(!A)return;let o=prompt("New name:",A.name+" (Copy)")||A.name+" (Copy)",r={id:Date.now().toString(),name:o,version:"1.0",layout:A.layout};F.push(r),ne(r),ge(r)}),document.getElementById("lp-wsRen").addEventListener("click",()=>{if(!A)return;let o=prompt("New name:",A.name);o&&(A.name=o,ne(A),ze())}),document.getElementById("lp-wsReset").addEventListener("click",()=>{A&&confirm("Reset workspace? This will clear all layer positions.")&&(st(A.id),window.location.reload())}),document.getElementById("lp-wsDel").addEventListener("click",()=>{!A||F.length<=1||confirm("Delete workspace '"+A.name+"'?")&&(it(A.id),F=F.filter(o=>o.id!==A?.id),F.length&&ge(F[0]))}),document.getElementById("lp-wsSelect").addEventListener("change",o=>{let r=F.find(l=>l.id===o.target.value);r&&ge(r)}),ze(),document.getElementById("lp-wfExport").addEventListener("click",()=>{let o=Oe(A?.name);xt(o)}),document.getElementById("lp-wfImport").addEventListener("click",async()=>{let o=await wt();o&&(Ue(o),window.location.reload())}),document.getElementById("lp-wfShare").addEventListener("click",()=>{let o=Oe(A?.name),r=vt(o);navigator.clipboard.writeText(r).then(()=>{let l=document.getElementById("lp-wfShare"),p=l.textContent;l.textContent="Copied!",l.style.background="#4CAF50",setTimeout(()=>{l.textContent=p,l.style.background=""},2e3)}).catch(()=>{prompt("Share URL (copy manually):",r)})});let ie=document.getElementById("tb-launch");function Se(){a&&!a.closed?(ie.textContent="Stop Output",ie.classList.remove("mlmap-btn-primary"),ie.style.background="#a33"):(ie.textContent="Launch Output",ie.classList.add("mlmap-btn-primary"),ie.style.background="",a=null)}ie.addEventListener("click",()=>{if(a&&!a.closed){a.close(),a=null,Se();return}let o=document.getElementById("tb-monitor"),r=parseInt(o.value),l="width=1280,height=720";if(!isNaN(r)&&window._mlmapScreens&&window._mlmapScreens[r]){let f=window._mlmapScreens[r];l=`left=${f.availLeft},top=${f.availTop},width=${f.availWidth},height=${f.availHeight}`}a=window.open(Xe,"mlmap-display",l),Se();let p=setInterval(()=>{(!a||a.closed)&&(clearInterval(p),a=null,Se())},1e3)}),document.getElementById("tb-fullscreen").addEventListener("click",()=>{i.send("FULLSCREEN_ENTER")}),document.getElementById("tb-exportTpl").addEventListener("click",()=>{let o=y||m||{width:window.innerWidth,height:window.innerHeight};d.exportTemplate(o.width,o.height).toBlob(l=>{if(!l)return;let p=URL.createObjectURL(l),f=document.createElement("a");f.href=p,f.download=`mlmap-template-${o.width}x${o.height}.png`,f.click(),URL.revokeObjectURL(p)},"image/png")}),i.onConnectionChanged=o=>{let r=document.getElementById("tb-status");r.className=o?"status-dot connected":"status-dot disconnected",r.title=o?"Display connected":"Display disconnected"},i.on("DISPLAY_READY",()=>{n.forEach(o=>i.send("ADD_LAYER",o)),setTimeout(()=>{_(),z.sendPlaylistToDisplay(),n.forEach(o=>{if(o.type==="video"){let l=document.getElementById(o.id)?.querySelector("video");l&&l.src&&l.src.startsWith("blob:")&&ue(o.id,l.src)}}),setTimeout(()=>z.syncPlaybackToDisplay(),500)},200)});async function Tt(){let o=document.getElementById("tb-monitor");try{if("getScreenDetails"in window){let r=await window.getScreenDetails();window._mlmapScreens=r.screens,o.innerHTML='<option value="">Select monitor...</option>',r.screens.forEach((l,p)=>{let f=document.createElement("option");f.value=String(p);let b=l.label||`Monitor ${p+1}`;f.textContent=`${b} (${l.width}x${l.height})`,l.isPrimary||(f.textContent+=" *"),o.appendChild(f)})}else o.innerHTML=`<option value="">Default (${screen.width}x${screen.height})</option>`}catch{o.innerHTML=`<option value="">Default (${screen.width}x${screen.height})</option>`}}Tt();let ae=!0,re=!0;function $e(){let o=ae?"210px":"0px",r=re?"270px":"0px";I.style.gridTemplateColumns=`${o} 1fr ${r}`,R.style.display=ae?"flex":"none",J.style.display=re?"flex":"none",document.getElementById("tb-toggleLeft").innerHTML=ae?"&laquo;":"&raquo;",document.getElementById("tb-toggleRight").innerHTML=re?"&raquo;":"&laquo;"}document.getElementById("tb-toggleLeft").addEventListener("click",()=>{ae=!ae,$e(),le()}),document.getElementById("tb-toggleRight").addEventListener("click",()=>{re=!re,$e(),le()});let me=document.getElementById("tb-zoom"),Ve=document.getElementById("tb-zoomLabel");me.addEventListener("input",()=>{let o=parseInt(me.value)/100;L.style.transform=o<1?`scale(${o})`:"",Ve.textContent=`${me.value}%`,d.setWorkspaceZoom(o),g.zoom=o}),document.body.appendChild(g.canvasElement);let kt=d.setConfigEnabled;d.setConfigEnabled=function(o){kt.call(d,o),I.style.display=o?"grid":"none",o||Ie()};function Ie(){let o=new Set;for(let r of n){if(!r.clipTo)continue;let l=document.getElementById(r.id);l&&(l.style.opacity="0"),o.add(r.clipTo)}for(let r of o){let l=document.getElementById(r);l&&(l.style.opacity="0")}}d.onAfterDraw=Ie,d.onSpaceBar=()=>z.togglePlayPause(),d.layoutChangeListener=()=>{A&&(A.layout=d.getLayout(),ne(A)),_()},document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&z.syncPlaybackToDisplay()}),new MutationObserver(o=>{for(let r of o)r.type==="childList"&&r.removedNodes.length>0&&r.removedNodes.forEach(l=>{if(l instanceof HTMLElement&&!l.isConnected){let p=n.findIndex(f=>f.id===l.id);p!==-1&&(n.splice(p,1),D(),M(),i.send("REMOVE_LAYER",{id:l.id}))}})}).observe(document.body,{childList:!0,subtree:!0}),V(),A?.layout&&d.setLayout(A.layout),d.resetHistory(),Ie(),T(),R.addEventListener("keydown",o=>{let r=o.target.tagName;(r==="INPUT"||r==="SELECT"||r==="TEXTAREA")&&o.stopPropagation()});try{let o=localStorage.getItem(c);if(o){let r=JSON.parse(o);if(r.mode){if(document.getElementById("tb-resolution").value=r.mode,r.mode==="custom"&&r.width&&r.height){y={width:r.width,height:r.height};let l=document.getElementById("tb-resW"),p=document.getElementById("tb-resH");l.value=String(r.width),p.value=String(r.height),l.style.display="",p.style.display=""}else if(r.mode!=="auto"&&r.mode!=="custom"){let[l,p]=r.mode.split("x").map(Number);l&&p&&(y={width:l,height:p})}}}}catch{}function le(){let o=y;if(!o&&m&&(o=m),!o){d.outputFrame=null;return}let r=ae?210:0,l=re?270:0,p=window.innerWidth-r-l,f=window.innerHeight-38-48,b=o.width/o.height,v=p/f,C,H;b>v?(C=p*.9,H=C/b):(H=f*.9,C=H*b);let O=r+(p-C)/2,ce=38+(f-H)/2;d.outputFrame={x:O,y:ce,w:C,h:H,resW:o.width,resH:o.height};let q=o.width,Ce=o.height,Me=p/q,ee=f/Ce,Z=Math.min(Me,ee)*.9;Z=Math.max(.1,Math.min(1,Z));let _e=parseInt(me.value)/100;if(Z<_e){let de=Math.round(Z*100);me.value=String(de),Ve.textContent=`${de}%`,L.style.transform=Z<1?`scale(${Z})`:"",d.setWorkspaceZoom(Z),g.zoom=Z}}function Pe(){let o=document.getElementById("tb-resolution").value,r=document.getElementById("tb-resW"),l=document.getElementById("tb-resH");if(o==="auto")y=null,r.style.display="none",l.style.display="none";else if(o==="custom"){r.style.display="",l.style.display="";let p=parseInt(r.value)||0,f=parseInt(l.value)||0;y=p>0&&f>0?{width:p,height:f}:null}else{r.style.display="none",l.style.display="none";let[p,f]=o.split("x").map(Number);y=p&&f?{width:p,height:f}:null}localStorage.setItem(c,JSON.stringify({mode:o,width:y?.width,height:y?.height})),le()}document.getElementById("tb-resolution").addEventListener("change",Pe),document.getElementById("tb-resW").addEventListener("input",Pe),document.getElementById("tb-resH").addEventListener("input",Pe),document.getElementById("tb-resW").addEventListener("keydown",o=>o.stopPropagation()),document.getElementById("tb-resH").addEventListener("keydown",o=>o.stopPropagation()),window.addEventListener("resize",()=>le()),i.on("DISPLAY_RESIZE",o=>{m={width:o.width,height:o.height},document.getElementById("tb-resolution").value==="auto"&&le()}),le(),ve().then(o=>{if(o.latest!==K){let r=I.querySelector(".app-title");r&&r.setAttribute("title",`Update available: v${o.latest}`)}})}fe();var Ee=class{constructor(e={}){this.onAfterDraw=null;this.layers=[];this.configActive=!1;this.dragging=!1;this.dragOffset=[0,0];this.selectedLayer=null;this.selectedLayers=[];this.selectedPoint=null;this.selectionRadius=20;this.hoveringPoint=null;this.hoveringLayer=null;this.isLayerSoloed=!1;this.snapEnabled=!0;this.onSnapChanged=null;this.outputFrame=null;this.onSpaceBar=null;this.SNAP_THRESHOLD=12;this.workspaceZoom=1;this.rubberBandActive=!1;this.rubberBandStart=[0,0];this.rubberBandEnd=[0,0];this.rubberBandBaseSelection=[];this.mousePosition=[0,0];this.mouseDelta=[0,0];this.mouseDownPoint=[0,0];this.keyDown=this.keyDown.bind(this),this.setConfigEnabled=this.setConfigEnabled.bind(this),this.showLayerNames=this.getProp(e,"labels",!0),this.showCrosshairs=this.getProp(e,"crosshairs",!1),this.showScreenBounds=this.getProp(e,"screenbounds",!1),this.autoSave=this.getProp(e,"autoSave",!0),this.autoLoad=this.getProp(e,"autoLoad",!0),this.layerList=this.getProp(e,"layers",[]),this.layoutChangeListener=this.getProp(e,"onchange",()=>{}),this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.initCanvas(),this.loadSettings();for(let s of this.layerList)(s instanceof HTMLElement||typeof s=="string")&&this.addLayer(s);this.autoLoad&&this.loadSettings(),this.pushHistory(),new MutationObserver(s=>{s.forEach(i=>{i.removedNodes.forEach(a=>{a.isConnected||this.layers.forEach((n,u)=>{n.element===a&&(n.overlay&&n.overlay.remove(),this.layers.splice(u,1))})})})}).observe(document.body,{childList:!0,subtree:!0})}getProp(e,t,s){return e&&e.hasOwnProperty(t)&&e[t]!==null?e[t]:s}initCanvas(){this.canvas.style.display="none",this.canvas.style.position="fixed",this.canvas.style.top="0px",this.canvas.style.left="0px",this.canvas.style.zIndex="1000000",this.context=this.canvas.getContext("2d"),document.body.appendChild(this.canvas),window.addEventListener("resize",this.resize.bind(this)),window.addEventListener("mousemove",this.mouseMove.bind(this)),window.addEventListener("mouseup",this.mouseUp.bind(this)),window.addEventListener("mousedown",this.mouseDown.bind(this)),window.addEventListener("keydown",this.keyDown.bind(this)),this.resize()}pushHistory(){let e=this.getLayout();Q.push(JSON.stringify(e)),Q.length>50&&Q.shift(),he.length=0}saveSettings(){let e=We();ne({id:e?.id,name:e?.name,version:e?.version,layout:this.getLayout()})}loadSettings(){try{let e=We();e?.version==="1.0"&&e?.layout?this.setLayout(e.layout):console.warn("MLMap: localStorage version mismatch, skipping load.")}catch(e){console.error("MLMap: Failed to parse layout from localStorage.",e)}}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.draw()}pointInTriangle(e,t,s,i){let a=t[1]*i[0]-t[0]*i[1]+(i[1]-t[1])*e[0]+(t[0]-i[0])*e[1],n=t[0]*s[1]-t[1]*s[0]+(t[1]-s[1])*e[0]+(s[0]-t[0])*e[1];if(a<0!=n<0)return!1;let u=-s[1]*i[0]+t[1]*(i[0]-s[0])+t[0]*(s[1]-i[1])+s[0]*i[1];return u<0&&(a=-a,n=-n,u=-u),a>0&&n>0&&a+n<u}pointInLayer(e,t){let[s,i,a,n]=t.targetPoints;return this.pointInTriangle(e,s,i,a)||this.pointInTriangle(e,n,s,a)}updateTransform(){let e=["","-webkit-","-moz-","-ms-","-o-"],t="transform";for(let s of e){let i=s+"transform";if(i in document.body.style){t=i;break}}for(let s=0;s<this.layers.length;s++){let i=[],a=[];for(let y=0,m=this.layers[s].sourcePoints.length;y<m;++y){let g=this.layers[s].sourcePoints[y],x=this.layers[s].targetPoints[y];i.push([g[0],g[1],1,0,0,0,-g[0]*x[0],-g[1]*x[0]]),a.push(x[0]),i.push([0,0,0,g[0],g[1],1,-g[0]*x[1],-g[1]*x[1]]),a.push(x[1])}let n=tt(i,a,!0),u=[n[0],n[3],0,n[6],n[1],n[4],0,n[7],0,0,1,0,n[2],n[5],0,1],c=this.layers[s].element.style;c.setProperty(t,`matrix3d(${u.join(",")})`),c.setProperty(`${t}-origin`,"0px 0px 0px")}}rotateLayer(e,t){for(var s=Math.sin(t),i=Math.cos(t),a=[0,0],n=0;n<e.targetPoints.length;n++)a[0]+=e.targetPoints[n][0],a[1]+=e.targetPoints[n][1];a[0]/=4,a[1]/=4;for(var n=0;n<e.targetPoints.length;n++){var u=e.targetPoints[n][0]-a[0],c=e.targetPoints[n][1]-a[1];e.targetPoints[n][0]=u*i-c*s+a[0],e.targetPoints[n][1]=u*s+c*i+a[1]}}scaleLayer(e,t){for(var s=[0,0],i=0;i<e.targetPoints.length;i++)s[0]+=e.targetPoints[i][0],s[1]+=e.targetPoints[i][1];s[0]/=4,s[1]/=4;for(var i=0;i<e.targetPoints.length;i++){var a=e.targetPoints[i][0]-s[0],n=e.targetPoints[i][1]-s[1];e.targetPoints[i][0]=a*t+s[0],e.targetPoints[i][1]=n*t+s[1]}}undo(){if(Q.length>1){he.push(Q.pop());var e=JSON.parse(Q[Q.length-1]);this.setLayout(e),this.draw(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}}redo(){if(he.length>0){let e=he.pop();Q.push(e),this.setLayout(JSON.parse(e)),this.draw(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}}swapLayerPoints(e,t,s){var i=e[t][0],a=e[t][1];e[t][0]=e[s][0],e[t][1]=e[s][1],e[s][0]=i,e[s][1]=a}addLayer(e,t){let s=null;if(typeof e=="string"){if(s=document.getElementById(e),!s)throw new Error("MLMap: No element found with id: "+e)}else if(e instanceof HTMLElement)s=e;else throw new Error("MLMap: Invalid target");for(let a=0;a<this.layers.length;a++)if(this.layers[a].element.id===s.id){t&&(this.layers[a].targetPoints=se(t));return}s.style.position="fixed",s.style.display="block",s.style.top="0px",s.style.left="0px",s.style.padding="0px",s.style.margin="0px";let i={visible:!0,element:s,width:s.clientWidth,height:s.clientHeight,sourcePoints:[[0,0],[s.clientWidth,0],[s.clientWidth,s.clientHeight],[0,s.clientHeight]],targetPoints:[]};if(t)i.targetPoints=se(t);else{let[a,n]=et(i.width,i.height,this.layers);i.targetPoints=[[a,n],[a+i.width,n],[a+i.width,n+i.height],[a,n+i.height]]}this.layers.push(i),s.parentElement?.appendChild(s),this.updateTransform()}removeLayer(e){let t=typeof e=="string"?document.getElementById(e):e;if(t){for(let s=this.layers.length-1;s>=0;s--)this.layers[s].element===t&&(this.layers[s].overlay&&this.layers[s].overlay?.remove(),this.layers.splice(s,1));this.updateTransform()}}setLayout(e){for(var t=0;t<e.length;t++){for(var s=!1,i=0;i<this.layers.length;i++)this.layers[i].element.id==e[t].id&&(console.log("Setting points."),this.layers[i].targetPoints=se(e[t].targetPoints),this.layers[i].sourcePoints=se(e[t].sourcePoints),s=!0);if(s)console.log('MLMap: Element "" + layout[i].id + "" is already mapped.');else{var a=document.getElementById(e[t].id);a?this.addLayer(a,e[t].targetPoints):console.log('MLMap: Can"t find element: '+e[t].id)}}this.updateTransform(),this.draw()}getLayout(){for(var e=[],t=0;t<this.layers.length;t++)e.push({id:this.layers[t].element.id,targetPoints:se(this.layers[t].targetPoints),sourcePoints:se(this.layers[t].sourcePoints)});return e}setConfigEnabled(e){this.configActive=e,this.canvas.style.display=e?"block":"none",e?this.draw():(this.selectedPoint=null,this.selectedLayer=null,this.selectedLayers=[],this.dragging=!1,this.rubberBandActive=!1,this.showScreenBounds=!1)}getSelectedLayer(){return this.selectedLayer}getLayers(){return this.layers}getLayerAtPoint(e,t){let[s,i]=this.toWorkspace(e,t);for(let a=this.layers.length-1;a>=0;a--){let n=this.layers[a];if(n.visible&&this.pointInLayer([s,i],n))return n}return null}selectLayer(e){this.selectedLayer=e,this.selectedLayers=e?[e]:[],this.selectedPoint=null,this.draw()}getSelectedLayers(){return[...this.selectedLayers]}centerLayer(e){let t=window.innerWidth/2,s=window.innerHeight/2,i=0,a=0;for(let c of e.targetPoints)i+=c[0],a+=c[1];i/=4,a/=4;let n=t-i,u=s-a;for(let c of e.targetPoints)c[0]+=n,c[1]+=u;this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}rotateLayerPublic(e,t){this.rotateLayer(e,t*Math.PI/180),this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}flipLayerH(e){this.swapLayerPoints(e.sourcePoints,0,1),this.swapLayerPoints(e.sourcePoints,3,2),this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}flipLayerV(e){this.swapLayerPoints(e.sourcePoints,0,3),this.swapLayerPoints(e.sourcePoints,1,2),this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}deleteSelectedLayer(e){e.element.remove(),e.overlay&&e.overlay.remove();let t=this.layers.indexOf(e);t>=0&&this.layers.splice(t,1),this.selectedLayer===e&&(this.selectedLayer=null);let s=this.selectedLayers.indexOf(e);s>=0&&this.selectedLayers.splice(s,1),this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}scaleLayerPublic(e,t){this.scaleLayer(e,t),this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}moveLayerUp(e){let t=this.layers.indexOf(e);t<0||t>=this.layers.length-1||(this.layers[t]=this.layers[t+1],this.layers[t+1]=e,this.reorderLayerDOM(),this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener())}moveLayerDown(e){let t=this.layers.indexOf(e);t<=0||(this.layers[t]=this.layers[t-1],this.layers[t-1]=e,this.reorderLayerDOM(),this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener())}moveLayerToTop(e){let t=this.layers.indexOf(e);t<0||t===this.layers.length-1||(this.layers.splice(t,1),this.layers.push(e),this.reorderLayerDOM(),this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener())}moveLayerToBottom(e){let t=this.layers.indexOf(e);t<=0||(this.layers.splice(t,1),this.layers.unshift(e),this.reorderLayerDOM(),this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener())}reorderLayerDOM(){for(let e of this.layers)e.element.parentElement?.appendChild(e.element)}stretchToFrame(e,t){e.targetPoints=[[t.x,t.y],[t.x+t.w,t.y],[t.x+t.w,t.y+t.h],[t.x,t.y+t.h]],e.sourcePoints=[[0,0],[e.width,0],[e.width,e.height],[0,e.height]],this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}fitToFrame(e,t){let s=e.width/e.height,i=t.w/t.h,a,n;s>i?(a=t.w,n=t.w/s):(n=t.h,a=t.h*s);let u=t.x+(t.w-a)/2,c=t.y+(t.h-n)/2;e.targetPoints=[[u,c],[u+a,c],[u+a,c+n],[u,c+n]],e.sourcePoints=[[0,0],[e.width,0],[e.width,e.height],[0,e.height]],this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}exportTemplate(e,t){let s=document.createElement("canvas");s.width=e,s.height=t;let i=s.getContext("2d");i.fillStyle="#000",i.fillRect(0,0,e,t);let a=this.outputFrame,n,u,c,y;a&&a.w>0&&a.h>0?(n=e/a.w,u=t/a.h,c=a.x,y=a.y):(n=e/window.innerWidth,u=t/window.innerHeight,c=0,y=0),i.lineWidth=2;for(let m of this.layers){if(!m.visible)continue;i.strokeStyle="white",i.beginPath();let g=m.targetPoints;i.moveTo((g[0][0]-c)*n,(g[0][1]-y)*u);for(let L=1;L<g.length;L++)i.lineTo((g[L][0]-c)*n,(g[L][1]-y)*u);i.closePath(),i.stroke();let x=0,E=0;for(let L of g)x+=(L[0]-c)*n,E+=(L[1]-y)*u;x/=4,E/=4;let T=m.element.id.toUpperCase();i.font=`${Math.max(12,Math.round(16*n))}px sans-serif`,i.textAlign="center",i.fillStyle="rgba(255,255,255,0.7)",i.fillText(T,x,E+5)}return i.strokeStyle="#b44dff",i.lineWidth=3,i.strokeRect(1,1,e-2,t-2),i.font="14px sans-serif",i.fillStyle="#b44dff",i.textAlign="left",i.fillText(`${e}x${t}`,8,20),s}resetHistory(){Q.length=0,he.length=0,this.pushHistory()}resetLayerTransform(e){let t=window.innerWidth/2,s=window.innerHeight/2,i=e.width/2,a=e.height/2;e.targetPoints=[[t-i,s-a],[t+i,s-a],[t+i,s+a],[t-i,s+a]],e.sourcePoints=[[0,0],[e.width,0],[e.width,e.height],[0,e.height]],this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}layerIntersectsRect(e,t,s,i,a){let n=Math.min(t,i),u=Math.min(s,a),c=Math.max(t,i),y=Math.max(s,a),m=1/0,g=1/0,x=-1/0,E=-1/0;for(let T of e.targetPoints)T[0]<m&&(m=T[0]),T[1]<g&&(g=T[1]),T[0]>x&&(x=T[0]),T[1]>E&&(E=T[1]);return!(x<n||m>c||E<u||g>y)}draw(){if(this.configActive){if(this.context.strokeStyle="red",this.context.lineWidth=2,this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.workspaceZoom!==1){this.context.save();let e=this.canvas.width/2,t=this.canvas.height/2;this.context.translate(e,t),this.context.scale(this.workspaceZoom,this.workspaceZoom),this.context.translate(-e,-t)}for(let e=0;e<this.layers.length;e++){let t=this.layers[e];if(t.visible){t.element.style.visibility="visible",this.context.beginPath(),this.selectedLayers.includes(t)?this.context.strokeStyle="red":t===this.hoveringLayer?this.context.strokeStyle="red":this.context.strokeStyle="white",this.context.moveTo(t.targetPoints[0][0],t.targetPoints[0][1]);for(let i=0;i<t.targetPoints.length;i++)this.context.lineTo(t.targetPoints[i][0],t.targetPoints[i][1]);this.context.lineTo(t.targetPoints[3][0],t.targetPoints[3][1]),this.context.closePath(),this.context.stroke();let s=[0,0];for(let i=0;i<t.targetPoints.length;i++)t.targetPoints[i]===this.hoveringPoint?this.context.strokeStyle="red":t.targetPoints[i]===this.selectedPoint?this.context.strokeStyle="red":this.context.strokeStyle="white",s[0]+=t.targetPoints[i][0],s[1]+=t.targetPoints[i][1],this.context.beginPath(),this.context.arc(t.targetPoints[i][0],t.targetPoints[i][1],this.selectionRadius/2,0,2*Math.PI,!1),this.context.stroke();if(s[0]/=4,s[1]/=4,this.showLayerNames){let i=t.element.id.toUpperCase();this.context.font="16px sans-serif",this.context.textAlign="center";let a=this.context.measureText(i),n=[a.width+8,32];this.context.fillStyle="white";let u=window.innerHeight*.01,c=s[0],y=s[1];(t.width<a.width+10||t.height<20)&&(y=s[1]-t.height/2-10-u,y-n[1]/2<u&&(y=s[1]+t.height/2+20+u)),this.context.fillRect(c-n[0]/2,y-n[1]/2,n[0],n[1]),this.context.fillStyle="black",this.context.font="14px sans-serif",this.context.fillText(i,c,y)}}else t.element.style.visibility="hidden"}if(this.showCrosshairs&&(this.context.strokeStyle="yellow",this.context.lineWidth=1,this.context.beginPath(),this.context.moveTo(this.mousePosition[0],0),this.context.lineTo(this.mousePosition[0],this.canvas.height),this.context.moveTo(0,this.mousePosition[1]),this.context.lineTo(this.canvas.width,this.mousePosition[1]),this.context.stroke()),this.showScreenBounds){this.context.fillStyle="black",this.context.lineWidth=4,this.context.fillRect(0,0,this.canvas.width,this.canvas.height),this.context.strokeStyle="#909090",this.context.beginPath();let e=this.canvas.width/10,t=this.canvas.height/10;for(let i=0;i<10;i++)this.context.moveTo(i*e,0),this.context.lineTo(i*e,this.canvas.height),this.context.moveTo(0,i*t),this.context.lineTo(this.canvas.width,i*t);this.context.stroke(),this.context.strokeStyle="white",this.context.strokeRect(2,2,this.canvas.width-4,this.canvas.height-4);let s=Math.round(t*.6);this.context.font=`${s}px mono, sans-serif`,this.context.fillRect(e*2+2,t*3+2,this.canvas.width-e*4-4,this.canvas.height-t*6-4),this.context.fillStyle="white",this.context.font="20px sans-serif",this.context.fillText(`${this.canvas.width} x ${this.canvas.height}`,this.canvas.width/2,this.canvas.height/2+s*.75),this.context.fillText("Display size",this.canvas.width/2,this.canvas.height/2-s*.75)}if(this.outputFrame){let e=this.outputFrame;this.context.save(),this.context.strokeStyle="#b44dff",this.context.lineWidth=2,this.context.setLineDash([8,6]),this.context.strokeRect(e.x,e.y,e.w,e.h),this.context.setLineDash([]),this.context.font="11px sans-serif",this.context.fillStyle="#b44dff",this.context.textAlign="left",this.context.fillText(`${e.resW}x${e.resH}`,e.x+4,e.y-4),this.context.restore()}if(this.rubberBandActive){let e=Math.min(this.rubberBandStart[0],this.rubberBandEnd[0]),t=Math.min(this.rubberBandStart[1],this.rubberBandEnd[1]),s=Math.abs(this.rubberBandEnd[0]-this.rubberBandStart[0]),i=Math.abs(this.rubberBandEnd[1]-this.rubberBandStart[1]);this.context.strokeStyle="rgba(51, 153, 255, 0.8)",this.context.fillStyle="rgba(51, 153, 255, 0.1)",this.context.lineWidth=1,this.context.fillRect(e,t,s,i),this.context.strokeRect(e,t,s,i)}this.workspaceZoom!==1&&this.context.restore(),this.onAfterDraw&&this.onAfterDraw()}}snapLayerToEdges(e){if(!this.snapEnabled)return;let t=this.SNAP_THRESHOLD,s=1/0,i=1/0,a=-1/0,n=-1/0;for(let g of e.targetPoints)g[0]<s&&(s=g[0]),g[1]<i&&(i=g[1]),g[0]>a&&(a=g[0]),g[1]>n&&(n=g[1]);let u=0,c=0,y=!1,m=!1;Math.abs(s)<t?(u=-s,y=!0):Math.abs(a-window.innerWidth)<t&&(u=window.innerWidth-a,y=!0),Math.abs(i)<t?(c=-i,m=!0):Math.abs(n-window.innerHeight)<t&&(c=window.innerHeight-n,m=!0);for(let g of this.layers){if(g===e||!g.visible)continue;let x=1/0,E=1/0,T=-1/0,L=-1/0;for(let I of g.targetPoints)I[0]<x&&(x=I[0]),I[1]<E&&(E=I[1]),I[0]>T&&(T=I[0]),I[1]>L&&(L=I[1]);if(y||(Math.abs(a-x)<t?(u=x-a,y=!0):Math.abs(s-T)<t?(u=T-s,y=!0):Math.abs(s-x)<t?(u=x-s,y=!0):Math.abs(a-T)<t&&(u=T-a,y=!0)),m||(Math.abs(n-E)<t?(c=E-n,m=!0):Math.abs(i-L)<t?(c=L-i,m=!0):Math.abs(i-E)<t?(c=E-i,m=!0):Math.abs(n-L)<t&&(c=L-n,m=!0)),y&&m)break}if(u!==0||c!==0)for(let g of e.targetPoints)g[0]+=u,g[1]+=c}toWorkspace(e,t){if(this.workspaceZoom===1)return[e,t];let s=window.innerWidth/2,i=window.innerHeight/2;return[(e-s)/this.workspaceZoom+s,(t-i)/this.workspaceZoom+i]}setWorkspaceZoom(e){this.workspaceZoom=Math.max(.1,Math.min(1,e)),this.draw()}mouseMove(e){if(!this.configActive)return;(this.dragging||this.rubberBandActive)&&e.preventDefault();let[t,s]=this.toWorkspace(e.clientX,e.clientY);if(this.mouseDelta[0]=t-this.mousePosition[0],this.mouseDelta[1]=s-this.mousePosition[1],this.mousePosition[0]=t,this.mousePosition[1]=s,this.rubberBandActive){this.rubberBandEnd=[t,s];let i=[];for(let n of this.layers)n.visible&&this.layerIntersectsRect(n,this.rubberBandStart[0],this.rubberBandStart[1],this.rubberBandEnd[0],this.rubberBandEnd[1])&&i.push(n);let a=[...this.rubberBandBaseSelection];for(let n of i)a.includes(n)||a.push(n);this.selectedLayers=a,this.selectedLayer=this.selectedLayers[this.selectedLayers.length-1]||null,this.draw();return}if(this.dragging){let i=e.shiftKey?.1:1;if(this.selectedPoint)e.shiftKey?this.scaleLayer(this.selectedLayer,1+this.mouseDelta[0]*.01):(this.selectedPoint[0]+=this.mouseDelta[0]*i,this.selectedPoint[1]+=this.mouseDelta[1]*i);else if(this.selectedLayers.length>0)if(e.altKey&&this.selectedLayer)this.rotateLayer(this.selectedLayer,this.mouseDelta[0]*(.01*i));else{for(let a of this.selectedLayers)for(let n=0;n<a.targetPoints.length;n++)a.targetPoints[n][0]+=this.mouseDelta[0]*i,a.targetPoints[n][1]+=this.mouseDelta[1]*i;this.selectedLayer&&this.snapLayerToEdges(this.selectedLayer)}this.updateTransform(),this.autoSave&&this.saveSettings(),this.draw(),this.layoutChangeListener();return}this.canvas.style.cursor="default",this.hoveringPoint=null,this.hoveringLayer=null;for(let i=this.layers.length-1;i>=0;i--){let a=this.layers[i];if(a.visible){for(let n=0;n<a.targetPoints.length;n++){let u=a.targetPoints[n];if(Be(u[0],u[1],this.mousePosition[0],this.mousePosition[1])<this.selectionRadius){this.hoveringPoint=u,this.hoveringLayer=a,this.canvas.style.cursor="pointer";break}}if(this.hoveringPoint)break}}if(!this.hoveringPoint)for(let i=this.layers.length-1;i>=0;i--){let a=this.layers[i];if(a.visible&&this.pointInLayer(this.mousePosition,a)){this.hoveringLayer=a,this.canvas.style.cursor="pointer";break}}this.draw()}mouseDown(e){if(!this.configActive||e.button===2)return;let[t,s]=this.toWorkspace(e.clientX,e.clientY);this.mouseDownPoint=[t,s],this.selectedPoint=null,this.rubberBandActive=!1;let i=null,a=null;for(let n=this.layers.length-1;n>=0;n--){let u=this.layers[n];if(u.visible){for(let c=0;c<u.targetPoints.length;c++){let y=u.targetPoints[c];if(Be(y[0],y[1],t,s)<this.selectionRadius){a=y,i=u;break}}if(i)break}}if(!i)for(let n=this.layers.length-1;n>=0;n--){let u=this.layers[n];if(u.visible&&this.pointInLayer([t,s],u)){i=u;break}}if(a)this.selectedPoint=a,this.selectedLayer=i,this.selectedLayers=[i],this.dragging=!0;else if(i)if(e.ctrlKey){let n=this.selectedLayers.indexOf(i);n>=0?(this.selectedLayers.splice(n,1),this.selectedLayer=this.selectedLayers[this.selectedLayers.length-1]||null):(this.selectedLayers.push(i),this.selectedLayer=i),this.dragging=this.selectedLayers.length>0}else this.selectedLayers.includes(i)?this.selectedLayer=i:(this.selectedLayers=[i],this.selectedLayer=i),this.dragging=!0;else this.selectedLayer=null,this.rubberBandBaseSelection=e.ctrlKey?[...this.selectedLayers]:[],e.ctrlKey||(this.selectedLayers=[]),this.rubberBandActive=!0,this.rubberBandStart=[t,s],this.rubberBandEnd=[t,s],this.dragging=!1;this.draw()}mouseUp(e){if(this.configActive){if(this.rubberBandActive){this.rubberBandActive=!1,this.draw();return}this.dragging&&(this.pushHistory(),this.autoSave&&this.saveSettings()),this.dragging=!1,this.selectedPoint=null}}keyDown(e){if(!this.configActive)if(e.keyCode==32&&e.shiftKey){this.setConfigEnabled(!0);return}else return;var t=e.keyCode,s=e.shiftKey?10:1,i=!1,a=[0,0];switch(console.log(t),t){case 32:if(e.shiftKey){this.setConfigEnabled(!1);return}e.preventDefault(),this.onSpaceBar&&this.onSpaceBar();return;case 37:a[0]-=s;break;case 38:a[1]-=s;break;case 39:a[0]+=s;break;case 40:a[1]+=s;break;case 67:this.showCrosshairs=!this.showCrosshairs,i=!0;break;case 76:if(!this.configActive)return;this.showLayerNames=!this.showLayerNames,i=!0;break;case 83:if(this.isLayerSoloed){for(var n=0;n<this.layers.length;n++)this.layers[n].visible=!0;this.isLayerSoloed=!1,i=!0}else if(this.selectedLayers.length>0){for(var n=0;n<this.layers.length;n++)this.layers[n].visible=!1;for(let u of this.selectedLayers)u.visible=!0;i=!0,this.isLayerSoloed=!0}break;case 71:this.snapEnabled=!this.snapEnabled,this.onSnapChanged&&this.onSnapChanged(this.snapEnabled);break;case 66:this.showScreenBounds=!this.showScreenBounds,this.draw();break;case 72:this.selectedLayer&&(this.swapLayerPoints(this.selectedLayer.sourcePoints,0,1),this.swapLayerPoints(this.selectedLayer.sourcePoints,3,2),this.updateTransform(),this.draw());break;case 86:this.selectedLayer&&(this.swapLayerPoints(this.selectedLayer.sourcePoints,0,3),this.swapLayerPoints(this.selectedLayer.sourcePoints,1,2),this.updateTransform(),this.draw());break;case 82:this.selectedLayer&&(this.rotateLayer(this.selectedLayer,Math.PI/2),this.updateTransform(),this.draw());break;case 90:if(e.ctrlKey){e.preventDefault(),this.undo();return}break;case 89:if(e.ctrlKey){e.preventDefault(),this.redo();return}break;case 46:case 8:if(this.selectedLayers.length>0){for(let u of[...this.selectedLayers]){u.element.remove(),u.overlay&&u.overlay.remove();let c=this.layers.indexOf(u);c>=0&&this.layers.splice(c,1)}this.selectedLayers=[],this.selectedLayer=null,i=!0,this.updateTransform(),this.draw()}break}if(!this.showScreenBounds){if(this.selectedPoint)this.selectedPoint[0]+=a[0],this.selectedPoint[1]+=a[1],i=!0;else if(this.selectedLayers.length>0){if(e.altKey==!0&&this.selectedLayer)this.rotateLayer(this.selectedLayer,a[0]*.01),this.scaleLayer(this.selectedLayer,a[1]*-.005+1);else for(let u of this.selectedLayers)for(var n=0;n<u.targetPoints.length;n++)u.targetPoints[n][0]+=a[0],u.targetPoints[n][1]+=a[1];i=!0}}i&&(this.updateTransform(),this.draw(),this.autoSave&&this.saveSettings(),this.pushHistory(),this.layoutChangeListener())}};bt();var Et=new Ee({layers:[]});Lt(Et);Et.setConfigEnabled(!0);window.MLMap=Ee;})();
