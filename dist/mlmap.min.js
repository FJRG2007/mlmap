"use strict";(()=>{function M(p,e,t=[]){let s=0,i=0,n=0,o=100,y;do{y=!1,s=Math.random()*(window.innerWidth-p),i=Math.random()*(window.innerHeight-e);for(let c of t){let d=[Math.min(...c.targetPoints.map(r=>r[0])),Math.min(...c.targetPoints.map(r=>r[1])),Math.max(...c.targetPoints.map(r=>r[0])),Math.max(...c.targetPoints.map(r=>r[1]))];if(!(s+p<d[0]||s>d[2]||i+e<d[1]||i>d[3])){y=!0;break}}n++}while(y&&n<o);return[s,i]}function P(p){return p.map(e=>e.slice(0,2))}function B(p,e,t,s){return Math.hypot(t-p,s-e)}function I(p){let e=`mlmap:workspace<${p.id}>`;localStorage.setItem(e,JSON.stringify(p))}function D(p){let e=localStorage.getItem("mlmap:currentWorkspaceId");if(!e){e=Date.now().toString(),localStorage.setItem("mlmap:currentWorkspaceId",e);let i={id:e,name:"New Workspace",version:"1.0",layout:{}};return localStorage.setItem(`mlmap:workspace<${e}>`,JSON.stringify(i)),i}let t=`mlmap:workspace<${p||e}>`,s=localStorage.getItem(t);return s?JSON.parse(s):null}function q(p){let e=`mlmap:workspace<${p}>`;localStorage.removeItem(e)}function K(){let p=[];for(let e=0;e<localStorage.length;e++){let t=localStorage.key(e);if(t&&t.startsWith("mlmap:workspace<")){let s=localStorage.getItem(t);s&&p.push(JSON.parse(s))}}return p}var $="0.0.2.0";function z(p){let e=document.createElement("div");e.id="controls",e.innerHTML=`
    <div style="display:flex; justify-content:space-between; align-items:center;">
  <strong>Controls</strong>
  <button id="closeHelp" style="background:#808080;color:white;border:none;padding:2px 6px;cursor:pointer;">X</button>
</div>
<pre style="margin-top:5px;">
SHIFT-Space: Toggle edit mode

In Edit Mode

click / drag:       select and move quads/corner points
SHIFT + drag:       move selected quad/corner point with 10x precision
ALT + drag:         rotate/scale selected quad
Arrow keys:         move selected quad/corner point
SHIFT + Arrow keys: move selected quad/corner point by 10 pixels
ALT + Arrow keys:   rotate/scale selected quad
's':                Solo/unsolo selected quad
'c':                Toggle mouse cursor crosshairs
'r':                Rotate selected layer 90 degrees clock-wise
'h':                Flip selected layer horizontally
'v':                Flip selected layer vertically
'b':                Show/Hide projector bounds
'l':                Show/Hide layer labels
'\u232B'/'Del':         Delete selected layer

MLMap | Version ${$}
</pre>
    `,Object.assign(e.style,{position:"fixed",top:"20px",left:"50%",transform:"translateX(-50%)",width:"600px",background:"#404040",color:"white",fontFamily:"monospace",padding:"10px",border:"2px solid #808080",zIndex:"1000001",cursor:"move",display:"none",userSelect:"none"}),document.body.appendChild(e),document.getElementById("closeHelp")?.addEventListener("click",()=>{e.style.display="none"});let t=document.createElement("div");t.id="shapePanel",Object.assign(t.style,{position:"fixed",top:"10px",right:"10px",width:"200px",background:"#303030",color:"white",fontFamily:"monospace",padding:"10px",border:"2px solid #808080",zIndex:"1000002",display:"none"}),t.innerHTML=`
    <strong>Shapes</strong>
    <div id="shapeList"></div>
    <button id="addSquare">Add Square</button>
    <button id="addCircle">Add Circle</button>
    <button id="addTriangle">Add Triangle</button>
    <hr>
    <strong>Workspaces</strong>
    <select id="workspaceSelector" style="width:100%;margin-top:5px;"></select>
    <div style="display:flex;gap:4px;margin-top:5px;">
      <button id="addWorkspace">New</button>
      <button id="renameWorkspace">Rename</button>
      <button id="deleteWorkspace">Delete</button>
    </div>`,document.body.appendChild(t);let s=!1,i=0,n=0;e.addEventListener("mousedown",function(l){l?.target?.id!=="closeHelp"&&(s=!0,i=l.clientX-e.offsetLeft,n=l.clientY-e.offsetTop)}),document.addEventListener("mousemove",function(l){s&&(e.style.left=l.clientX-i+"px",e.style.top=l.clientY-n+"px",e.style.transform="")}),document.addEventListener("mouseup",function(){s=!1});let o=document.getElementById("shapeList"),y=document.getElementById("addSquare"),c=document.getElementById("addCircle"),d=document.getElementById("addTriangle"),r=new WeakMap,h=[];function u(l){let a=document.createElement("div");a.id=`shape_${Date.now()}`;let[L,E]=M(100,100);a.style.position="fixed",a.style.top=E+"px",a.style.left=L+"px",a.style.width="100px",a.style.height="100px",a.style.background=l==="triangle"?"transparent":"white",a.style.border=l==="triangle"?"2px solid white":"none",l==="circle"&&(a.style.borderRadius="50%"),l==="triangle"&&(a.style.width="0",a.style.height="0",a.style.borderLeft="50px solid transparent",a.style.borderRight="50px solid transparent",a.style.borderBottom="100px solid white",p.addLayer(a,P([[50,0],[100,100],[0,100],[50,100]]))),document.body.appendChild(a),p.addLayer(a),h.push({id:a.id,type:l,x:L,y:E}),m(),v()}function m(){o.innerHTML="",h.forEach(l=>{let a=document.createElement("div");a.style.display="flex",a.style.justifyContent="space-between",a.style.marginBottom="4px",a.innerHTML=`${l.type} <button data-id="${l.id}">Delete</button>`,o.appendChild(a),a.querySelector("button")?.addEventListener("click",()=>x(l.id))})}function x(l){let a=h.findIndex(L=>L.id===l);if(a!==-1){let L=document.getElementById(l);L&&L.remove(),h.splice(a,1),m(),v()}}function v(){localStorage.setItem("mlmap.dynamicShapes",JSON.stringify(h))}function w(){let l=localStorage.getItem("mlmap.dynamicShapes");l&&(h=JSON.parse(l),h.forEach(a=>f(a)),m())}function f(l){let a=document.createElement("div");a.id=l.id;let L=l.x??Math.random()*(window.innerWidth-100),E=l.y??Math.random()*(window.innerHeight-100);a.style.position="fixed",a.style.top=E+"px",a.style.left=L+"px",a.style.width="100px",a.style.height="100px",a.style.background=l.type==="triangle"?"transparent":"white",a.style.border=l.type==="triangle"?"2px solid white":"none",l.type==="circle"&&(a.style.borderRadius="50%"),l.type==="triangle"&&(a.style.width="0",a.style.height="0",a.style.borderLeft="50px solid transparent",a.style.borderRight="50px solid transparent",a.style.borderBottom="100px solid white"),document.body.appendChild(a),p.addLayer(a)}y.addEventListener("click",()=>u("square")),c.addEventListener("click",()=>u("circle")),d.addEventListener("click",()=>u("triangle")),document.addEventListener("keydown",l=>{l.shiftKey&&l.code==="Space"&&(l.preventDefault(),e.style.display=e.style.display==="none"?"block":"none",t.style.display=t.style.display==="none"?"block":"none")});let k=p.setConfigEnabled;p.setConfigEnabled=function(l){k(l),t.style.display=l?"block":"none"},w(),new MutationObserver(l=>{for(let a of l)a.type==="childList"&&a.removedNodes.length>0&&a.removedNodes.forEach(L=>{if(L instanceof HTMLElement){let E=h.findIndex(A=>A.id===L.id);E!==-1&&(h.splice(E,1),m(),v())}})}).observe(document.body,{childList:!0,subtree:!0});let T=t.querySelector("#workspaceSelector"),b=K(),g=b.find(l=>l.id===localStorage.getItem("mlmap:currentWorkspaceId"))||null;!g&&b.length&&(g=b[0],localStorage.setItem("mlmap:currentWorkspaceId",g.id)),g&&p.setLayout(g.layout),b.length===1&&(document.getElementById("deleteWorkspace").disabled=!0);function H(){T.innerHTML="",b.forEach(l=>{let a=document.createElement("option");a.value=l.id,a.textContent=l.name,g&&g.id===l.id&&(a.selected=!0),T.appendChild(a)})}function N(l){localStorage.setItem("mlmap:currentWorkspaceId",l.id),window.location.reload()}document.getElementById("addWorkspace")?.addEventListener("click",()=>{let l=prompt("Workspace name:","New Workspace")||"New Workspace",a={id:Date.now().toString(),name:l,version:"1.0",layout:{}};b.push(a),I(a),N(a)}),document.getElementById("renameWorkspace")?.addEventListener("click",()=>{if(!g)return;let l=prompt("New name:",g.name)||g.name;g.name=l,I(g),H()}),document.getElementById("deleteWorkspace")?.addEventListener("click",()=>{!g||b.length===1||(b.length===1&&(document.getElementById("deleteWorkspace").disabled=!0),q(g.id),b=b.filter(l=>l.id!==g?.id),g=b[0]||null,g&&p.setLayout(g.layout),H())}),T.addEventListener("change",()=>{let l=b.find(a=>a.id===T.value);l&&N(l)}),H(),p.layoutChangeListener=()=>{g&&(g.layout=p.getLayout(),I(g))}}var Y=(()=>{function p(c,d,r,h){if(r===d.length-1)return h(c);let u,m=d[r],x=Array(m);for(u=m-1;u>=0;--u)x[u]=p(c[u],d,r+1,h);return x}function e(c){let d=[];for(;typeof c=="object";)d.push(c.length),c=c[0];return d}function t(c){let d,r;return typeof c=="object"?(d=c[0],typeof d=="object"?(r=d[0],typeof r=="object"?e(c):[c.length,d.length]):[c.length]):[]}function s(c){let d,r=c.length,h=Array(r);for(d=r-1;d>=0;--d)h[d]=c[d];return h}function i(c){return typeof c!="object"?c:p(c,t(c),0,s)}function n(c,d){d=d||!1;let r,h,u,m,x,v,w,f,k,S=c.length,T=S-1,b=new Array(S);for(d||(c=i(c)),u=0;u<S;++u){for(w=u,v=c[u],k=y(v[u]),h=u+1;h<S;++h)m=y(c[h][u]),m>k&&(k=m,w=h);for(b[u]=w,w!=u&&(c[u]=c[w],c[w]=v,v=c[u]),x=v[u],r=u+1;r<S;++r)c[r][u]/=x;for(r=u+1;r<S;++r){for(f=c[r],h=u+1;h<T;++h)f[h]-=f[u]*v[h],++h,f[h]-=f[u]*v[h];h===T&&(f[h]-=f[u]*v[h])}}return{LU:c,P:b}}function o(c,d){let r,h,u,m,x,v=c.LU,w=v.length,f=i(d),k=c.P;for(r=w-1;r>=0;--r)f[r]=d[r];for(r=0;r<w;++r)for(u=k[r],k[r]!==r&&(x=f[r],f[r]=f[u],f[u]=x),m=v[r],h=0;h<r;++h)f[r]-=f[h]*m[h];for(r=w-1;r>=0;--r){for(m=v[r],h=r+1;h<w;++h)f[r]-=f[h]*m[h];f[r]/=m[r]}return f}let y=Math.abs;return function(c,d,r){return o(n(c,r),d)}})(),W=[],O=50,C=class{constructor(e={}){this.layers=[];this.configActive=!1;this.dragging=!1;this.dragOffset=[0,0];this.selectedLayer=null;this.selectedPoint=null;this.selectionRadius=20;this.hoveringPoint=null;this.hoveringLayer=null;this.isLayerSoloed=!1;this.mousePosition=[0,0];this.mouseDelta=[0,0];this.mouseDownPoint=[0,0];this.keyDown=this.keyDown.bind(this),this.setConfigEnabled=this.setConfigEnabled.bind(this),this.showLayerNames=this.getProp(e,"labels",!0),this.showCrosshairs=this.getProp(e,"crosshairs",!1),this.showScreenBounds=this.getProp(e,"screenbounds",!1),this.autoSave=this.getProp(e,"autoSave",!0),this.autoLoad=this.getProp(e,"autoLoad",!0),this.layerList=this.getProp(e,"layers",[]),this.layoutChangeListener=this.getProp(e,"onchange",()=>{}),this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.initCanvas(),this.loadSettings();for(let s of this.layerList)(s instanceof HTMLElement||typeof s=="string")&&this.addLayer(s);this.autoLoad&&this.loadSettings(),this.pushHistory(),new MutationObserver(s=>{s.forEach(i=>{i.removedNodes.forEach(n=>{this.layers.forEach((o,y)=>{o.element===n&&(o.overlay&&o.overlay.remove(),this.layers.splice(y,1))})})})}).observe(document.body,{childList:!0,subtree:!0})}getProp(e,t,s){return e&&e.hasOwnProperty(t)&&e[t]!==null?e[t]:s}initCanvas(){this.canvas.style.display="none",this.canvas.style.position="fixed",this.canvas.style.top="0px",this.canvas.style.left="0px",this.canvas.style.zIndex="1000000",this.context=this.canvas.getContext("2d"),document.body.appendChild(this.canvas),window.addEventListener("resize",this.resize.bind(this)),window.addEventListener("mousemove",this.mouseMove.bind(this)),window.addEventListener("mouseup",this.mouseUp.bind(this)),window.addEventListener("mousedown",this.mouseDown.bind(this)),window.addEventListener("keydown",this.keyDown.bind(this)),this.resize()}pushHistory(){let e=this.getLayout();W.push(JSON.stringify(e)),W.length>O&&W.shift()}saveSettings(){let e=D();I({id:e?.id,name:e?.name,version:e?.version,layout:this.getLayout()})}loadSettings(){try{let e=D();e?.version==="1.0"&&e?.layout?this.setLayout(e.layout):console.warn("MLMap: localStorage version mismatch, skipping load.")}catch(e){console.error("MLMap: Failed to parse layout from localStorage.",e)}}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.draw()}pointInTriangle(e,t,s,i){let n=t[1]*i[0]-t[0]*i[1]+(i[1]-t[1])*e[0]+(t[0]-i[0])*e[1],o=t[0]*s[1]-t[1]*s[0]+(t[1]-s[1])*e[0]+(s[0]-t[0])*e[1];if(n<0!=o<0)return!1;let y=-s[1]*i[0]+t[1]*(i[0]-s[0])+t[0]*(s[1]-i[1])+s[0]*i[1];return y<0&&(n=-n,o=-o,y=-y),n>0&&o>0&&n+o<y}pointInLayer(e,t){let[s,i,n,o]=t.targetPoints;return this.pointInTriangle(e,s,i,n)||this.pointInTriangle(e,o,s,n)}updateTransform(){let e=["","-webkit-","-moz-","-ms-","-o-"],t="transform";for(let s of e){let i=s+"transform";if(i in document.body.style){t=i;break}}for(let s=0;s<this.layers.length;s++){let i=[],n=[];for(let d=0,r=this.layers[s].sourcePoints.length;d<r;++d){let h=this.layers[s].sourcePoints[d],u=this.layers[s].targetPoints[d];i.push([h[0],h[1],1,0,0,0,-h[0]*u[0],-h[1]*u[0]]),n.push(u[0]),i.push([0,0,0,h[0],h[1],1,-h[0]*u[1],-h[1]*u[1]]),n.push(u[1])}let o=Y(i,n,!0),y=[o[0],o[3],0,o[6],o[1],o[4],0,o[7],0,0,1,0,o[2],o[5],0,1],c=this.layers[s].element.style;c.setProperty(t,`matrix3d(${y.join(",")})`),c.setProperty(`${t}-origin`,"0px 0px 0px")}}rotateLayer(e,t){for(var s=Math.sin(t),i=Math.cos(t),n=[0,0],o=0;o<e.targetPoints.length;o++)n[0]+=e.targetPoints[o][0],n[1]+=e.targetPoints[o][1];n[0]/=4,n[1]/=4;for(var o=0;o<e.targetPoints.length;o++){var y=e.targetPoints[o][0]-n[0],c=e.targetPoints[o][1]-n[1];e.targetPoints[o][0]=y*i-c*s+n[0],e.targetPoints[o][1]=y*s+c*i+n[1]}}scaleLayer(e,t){for(var s=[0,0],i=0;i<e.targetPoints.length;i++)s[0]+=e.targetPoints[i][0],s[1]+=e.targetPoints[i][1];s[0]/=4,s[1]/=4;for(var i=0;i<e.targetPoints.length;i++){var n=e.targetPoints[i][0]-s[0],o=e.targetPoints[i][1]-s[1];e.targetPoints[i][0]=n*t+s[0],e.targetPoints[i][1]=o*t+s[1]}}undo(){if(W.length>1){W.pop();var e=JSON.parse(W[W.length-1]);this.setLayout(e),this.draw(),this.autoSave&&this.saveSettings()}}swapLayerPoints(e,t,s){var i=e[t][0],n=e[t][1];e[t][0]=e[s][0],e[t][1]=e[s][1],e[s][0]=i,e[s][1]=n}addLayer(e,t){let s=null;if(typeof e=="string"){if(s=document.getElementById(e),!s)throw new Error("MLMap: No element found with id: "+e)}else if(e instanceof HTMLElement)s=e;else throw new Error("MLMap: Invalid target");for(let n=0;n<this.layers.length;n++)if(this.layers[n].element.id===s.id){t&&(this.layers[n].targetPoints=P(t));return}s.style.position="fixed",s.style.display="block",s.style.top="0px",s.style.left="0px",s.style.padding="0px",s.style.margin="0px";let i={visible:!0,element:s,width:s.clientWidth,height:s.clientHeight,sourcePoints:[[0,0],[s.clientWidth,0],[s.clientWidth,s.clientHeight],[0,s.clientHeight]],targetPoints:[]};if(t)i.targetPoints=P(t);else{let[n,o]=M(i.width,i.height,this.layers);i.targetPoints=[[n,o],[n+i.width,o],[n+i.width,o+i.height],[n,o+i.height]]}this.layers.push(i),this.updateTransform()}removeLayer(e){let t=typeof e=="string"?document.getElementById(e):e;if(t){for(let s=this.layers.length-1;s>=0;s--)this.layers[s].element===t&&(this.layers[s].overlay&&this.layers[s].overlay?.remove(),this.layers.splice(s,1));this.updateTransform()}}setLayout(e){for(var t=0;t<e.length;t++){for(var s=!1,i=0;i<this.layers.length;i++)this.layers[i].element.id==e[t].id&&(console.log("Setting points."),this.layers[i].targetPoints=P(e[t].targetPoints),this.layers[i].sourcePoints=P(e[t].sourcePoints),s=!0);if(s)console.log('Maptastic: Element "" + layout[i].id + "" is already mapped.');else{var n=document.getElementById(e[t].id);n?this.addLayer(n,e[t].targetPoints):console.log('Maptastic: Can"t find element: '+e[t].id)}}this.updateTransform(),this.draw()}getLayout(){for(var e=[],t=0;t<this.layers.length;t++)e.push({id:this.layers[t].element.id,targetPoints:P(this.layers[t].targetPoints),sourcePoints:P(this.layers[t].sourcePoints)});return e}setConfigEnabled(e){this.configActive=e,this.canvas.style.display=e?"block":"none",e?this.draw():(this.selectedPoint=null,this.selectedLayer=null,this.dragging=!1,this.showScreenBounds=!1)}draw(){if(this.configActive){this.context.strokeStyle="red",this.context.lineWidth=2,this.context.clearRect(0,0,this.canvas.width,this.canvas.height);for(let e=0;e<this.layers.length;e++){let t=this.layers[e];if(t.visible){t.element.style.visibility="visible",this.context.beginPath(),t===this.hoveringLayer?this.context.strokeStyle="red":t===this.selectedLayer?this.context.strokeStyle="red":this.context.strokeStyle="white",this.context.moveTo(t.targetPoints[0][0],t.targetPoints[0][1]);for(let i=0;i<t.targetPoints.length;i++)this.context.lineTo(t.targetPoints[i][0],t.targetPoints[i][1]);this.context.lineTo(t.targetPoints[3][0],t.targetPoints[3][1]),this.context.closePath(),this.context.stroke();let s=[0,0];for(let i=0;i<t.targetPoints.length;i++)t.targetPoints[i]===this.hoveringPoint?this.context.strokeStyle="red":t.targetPoints[i]===this.selectedPoint?this.context.strokeStyle="red":this.context.strokeStyle="white",s[0]+=t.targetPoints[i][0],s[1]+=t.targetPoints[i][1],this.context.beginPath(),this.context.arc(t.targetPoints[i][0],t.targetPoints[i][1],this.selectionRadius/2,0,2*Math.PI,!1),this.context.stroke();if(s[0]/=4,s[1]/=4,this.showLayerNames){let i=t.element.id.toUpperCase();this.context.font="16px sans-serif",this.context.textAlign="center";let n=this.context.measureText(i),o=[n.width+8,32];this.context.fillStyle="white";let y=window.innerHeight*.01,c=s[0],d=s[1];(t.width<n.width+10||t.height<20)&&(d=s[1]-t.height/2-10-y,d-o[1]/2<y&&(d=s[1]+t.height/2+20+y)),this.context.fillRect(c-o[0]/2,d-o[1]/2,o[0],o[1]),this.context.fillStyle="black",this.context.font="14px sans-serif",this.context.fillText(i,c,d)}}else t.element.style.visibility="hidden"}if(this.showCrosshairs&&(this.context.strokeStyle="yellow",this.context.lineWidth=1,this.context.beginPath(),this.context.moveTo(this.mousePosition[0],0),this.context.lineTo(this.mousePosition[0],this.canvas.height),this.context.moveTo(0,this.mousePosition[1]),this.context.lineTo(this.canvas.width,this.mousePosition[1]),this.context.stroke()),this.showScreenBounds){this.context.fillStyle="black",this.context.lineWidth=4,this.context.fillRect(0,0,this.canvas.width,this.canvas.height),this.context.strokeStyle="#909090",this.context.beginPath();let e=this.canvas.width/10,t=this.canvas.height/10;for(let i=0;i<10;i++)this.context.moveTo(i*e,0),this.context.lineTo(i*e,this.canvas.height),this.context.moveTo(0,i*t),this.context.lineTo(this.canvas.width,i*t);this.context.stroke(),this.context.strokeStyle="white",this.context.strokeRect(2,2,this.canvas.width-4,this.canvas.height-4);let s=Math.round(t*.6);this.context.font=`${s}px mono, sans-serif`,this.context.fillRect(e*2+2,t*3+2,this.canvas.width-e*4-4,this.canvas.height-t*6-4),this.context.fillStyle="white",this.context.font="20px sans-serif",this.context.fillText(`${this.canvas.width} x ${this.canvas.height}`,this.canvas.width/2,this.canvas.height/2+s*.75),this.context.fillText("display size",this.canvas.width/2,this.canvas.height/2-s*.75)}}}mouseMove(e){if(this.configActive){if(e.preventDefault(),this.mouseDelta[0]=e.clientX-this.mousePosition[0],this.mouseDelta[1]=e.clientY-this.mousePosition[1],this.mousePosition[0]=e.clientX,this.mousePosition[1]=e.clientY,this.dragging){let t=e.shiftKey?.1:1;if(this.selectedPoint)e.shiftKey?this.scaleLayer(this.selectedLayer,1+this.mouseDelta[0]*.01):(this.selectedPoint[0]+=this.mouseDelta[0]*t,this.selectedPoint[1]+=this.mouseDelta[1]*t);else if(this.selectedLayer)if(e.altKey&&this.rotateLayer(this.selectedLayer,this.mouseDelta[0]*(.01*t)),e.ctrlKey)this.scaleLayer(this.selectedLayer,this.mouseDelta[1]*(-.005*t)+1);else for(let s=0;s<this.selectedLayer.targetPoints.length;s++)this.selectedLayer.targetPoints[s][0]+=this.mouseDelta[0]*t,this.selectedLayer.targetPoints[s][1]+=this.mouseDelta[1]*t;this.updateTransform(),this.autoSave&&this.saveSettings(),this.draw(),this.layoutChangeListener();return}this.canvas.style.cursor="default",this.hoveringPoint=null,this.hoveringLayer=null;for(let t=this.layers.length-1;t>=0;t--){let s=this.layers[t];if(s.visible){for(let i=0;i<s.targetPoints.length;i++){let n=s.targetPoints[i];if(B(n[0],n[1],e.clientX,e.clientY)<this.selectionRadius){this.hoveringPoint=n,this.hoveringLayer=s,this.canvas.style.cursor="pointer";break}}if(this.hoveringPoint)break}}if(!this.hoveringPoint)for(let t=this.layers.length-1;t>=0;t--){let s=this.layers[t];if(s.visible&&this.pointInLayer(this.mousePosition,s)){this.hoveringLayer=s,this.canvas.style.cursor="pointer";break}}this.draw()}}mouseDown(e){if(this.configActive){this.mouseDownPoint=[e.clientX,e.clientY],this.selectedPoint=null,this.selectedLayer=null;for(let t=this.layers.length-1;t>=0;t--){let s=this.layers[t];if(s.visible){for(let i=0;i<s.targetPoints.length;i++){let n=s.targetPoints[i];if(B(n[0],n[1],e.clientX,e.clientY)<this.selectionRadius){this.selectedPoint=n,this.selectedLayer=s;break}}if(this.selectedLayer)break}}if(!this.selectedLayer)for(let t=this.layers.length-1;t>=0;t--){let s=this.layers[t];if(s.visible&&this.pointInLayer([e.clientX,e.clientY],s)){this.selectedLayer=s;break}}this.selectedLayer&&(this.dragging=!0,this.draw())}}mouseUp(e){this.configActive&&(this.dragging&&(this.pushHistory(),this.autoSave&&this.saveSettings()),this.dragging=!1,this.selectedPoint=null)}keyDown(e){if(!this.configActive)if(e.keyCode==32&&e.shiftKey){this.setConfigEnabled(!0);return}else return;var t=e.keyCode,s=e.shiftKey?10:1,i=!1,n=[0,0];switch(console.log(t),t){case 32:if(e.shiftKey){this.setConfigEnabled(!1);return}break;case 37:n[0]-=s;break;case 38:n[1]-=s;break;case 39:n[0]+=s;break;case 40:n[1]+=s;break;case 67:this.showCrosshairs=!this.showCrosshairs,i=!0;break;case 76:if(!this.configActive)return;this.showLayerNames=!this.showLayerNames,i=!0;break;case 83:if(this.isLayerSoloed){for(var o=0;o<this.layers.length;o++)this.layers[o].visible=!0;this.isLayerSoloed=!1,i=!0}else if(this.selectedLayer!=null){for(var o=0;o<this.layers.length;o++)this.layers[o].visible=!1;this.selectedLayer.visible=!0,i=!0,this.isLayerSoloed=!0}break;case 66:this.showScreenBounds=!this.showScreenBounds,this.draw();break;case 72:this.selectedLayer&&(this.swapLayerPoints(this.selectedLayer.sourcePoints,0,1),this.swapLayerPoints(this.selectedLayer.sourcePoints,3,2),this.updateTransform(),this.draw());break;case 86:this.selectedLayer&&(this.swapLayerPoints(this.selectedLayer.sourcePoints,0,3),this.swapLayerPoints(this.selectedLayer.sourcePoints,1,2),this.updateTransform(),this.draw());break;case 82:this.selectedLayer&&(this.rotateLayer(this.selectedLayer,Math.PI/2),this.updateTransform(),this.draw());break;case 90:e.ctrlKey&&this.undo();break;case 46:case 8:if(this.selectedLayer){this.selectedLayer.element.remove(),this.selectedLayer.overlay&&this.selectedLayer.overlay.remove();let y=this.layers.indexOf(this.selectedLayer);y>=0&&this.layers.splice(y,1),this.selectedLayer=null,i=!0,this.updateTransform(),this.draw()}break}if(!this.showScreenBounds){if(this.selectedPoint)this.selectedPoint[0]+=n[0],this.selectedPoint[1]+=n[1],i=!0;else if(this.selectedLayer){if(e.altKey==!0)this.rotateLayer(this.selectedLayer,n[0]*.01),this.scaleLayer(this.selectedLayer,n[1]*-.005+1);else for(var o=0;o<this.selectedLayer.targetPoints.length;o++)this.selectedLayer.targetPoints[o][0]+=n[0],this.selectedLayer.targetPoints[o][1]+=n[1];i=!0}}i&&(this.updateTransform(),this.draw(),this.autoSave&&this.saveSettings(),this.pushHistory(),this.layoutChangeListener())}},F=new C({layers:[]});z(F);window.MLMap=C;})();
