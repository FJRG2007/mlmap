"use strict";(()=>{var gt=Object.create;var Ae=Object.defineProperty;var vt=Object.getOwnPropertyDescriptor;var bt=Object.getOwnPropertyNames;var xt=Object.getPrototypeOf,wt=Object.prototype.hasOwnProperty;var Be=(c,e)=>()=>(c&&(e=c(c=0)),e);var He=(c,e)=>()=>(e||c((e={exports:{}}).exports,e),e.exports);var Lt=(c,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of bt(e))!wt.call(c,i)&&i!==t&&Ae(c,i,{get:()=>e[i],enumerable:!(s=vt(e,i))||s.enumerable});return c};var Re=(c,e,t)=>(t=c!=null?gt(xt(c)):{},Lt(e||!c||!c.__esModule?Ae(t,"default",{value:c,enumerable:!0}):t,c));var F,X,ae,Ne,oe=Be(()=>{"use strict";F="0.1.0.0",X=[],ae=[],Ne="display.html"});async function le(){let c="mlmap:cache:checkLatestVersion",t=Date.now(),s=localStorage.getItem(c),i=null;if(s)try{i=JSON.parse(s)}catch{}if(i&&t-i.timestamp<3e5)return{current:F,latest:i.latest,requireUpdate:i.latest!==F};let a=new AbortController,h=setTimeout(()=>a.abort(),5e3);try{let d=await fetch("https://raw.githubusercontent.com/FJRG2007/mlmap/refs/heads/main/package.json",{signal:a.signal});clearTimeout(h);let y=await d.json();return i={latest:y.version,timestamp:t},localStorage.setItem(c,JSON.stringify(i)),{current:F,latest:y.version,requireUpdate:y.version!==F}}catch{return{current:F,latest:i?.latest||F,requireUpdate:!1}}}var xe=Be(()=>{"use strict";oe()});var We=He(()=>{"use strict";xe();document.addEventListener("DOMContentLoaded",async()=>{let c=await le();console.log(`Current version: ${c.current}`),console.log(`Latest version: ${c.latest}`),c.requireUpdate&&console.log("A new version is available!")})});var Ue=He(()=>{"use strict";var Ut=Re(We())});var oi=Re(Ue());function Oe(c,e,t=[]){let s=0,i=0,a=0,n=100,h;do{h=!1,s=Math.random()*(window.innerWidth-c),i=Math.random()*(window.innerHeight-e);for(let d of t){let y=[Math.min(...d.targetPoints.map(m=>m[0])),Math.min(...d.targetPoints.map(m=>m[1])),Math.max(...d.targetPoints.map(m=>m[0])),Math.max(...d.targetPoints.map(m=>m[1]))];if(!(s+c<y[0]||s>y[2]||i+e<y[1]||i>y[3])){h=!0;break}}a++}while(h&&a<n);return[s,i]}function Z(c){return c.map(e=>e.slice(0,2))}function we(c,e,t,s){return Math.hypot(t-c,s-e)}var ze=(()=>{function c(d,y,m,f){if(m===y.length-1)return f(d);let b,E=y[m],T=Array(E);for(b=E-1;b>=0;--b)T[b]=c(d[b],y,m+1,f);return T}function e(d){let y=[];for(;typeof d=="object";)y.push(d.length),d=d[0];return y}function t(d){let y,m;return typeof d=="object"?(y=d[0],typeof y=="object"?(m=y[0],typeof m=="object"?e(d):[d.length,y.length]):[d.length]):[]}function s(d){let y,m=d.length,f=Array(m);for(y=m-1;y>=0;--y)f[y]=d[y];return f}function i(d){return typeof d!="object"?d:c(d,t(d),0,s)}function a(d,y){y=y||!1;let m,f,b,E,T,I,S,P,z,Y=d.length,j=Y-1,q=new Array(Y);for(y||(d=i(d)),b=0;b<Y;++b){for(S=b,I=d[b],z=h(I[b]),f=b+1;f<Y;++f)E=h(d[f][b]),E>z&&(z=E,S=f);for(q[b]=S,S!=b&&(d[b]=d[S],d[S]=I,I=d[b]),T=I[b],m=b+1;m<Y;++m)d[m][b]/=T;for(m=b+1;m<Y;++m){for(P=d[m],f=b+1;f<j;++f)P[f]-=P[b]*I[f],++f,P[f]-=P[b]*I[f];f===j&&(P[f]-=P[b]*I[f])}}return{LU:d,P:q}}function n(d,y){let m,f,b,E,T,I=d.LU,S=I.length,P=i(y),z=d.P;for(m=S-1;m>=0;--m)P[m]=y[m];for(m=0;m<S;++m)for(b=z[m],z[m]!==m&&(T=P[m],P[m]=P[b],P[b]=T),E=I[m],f=0;f<m;++f)P[m]-=P[f]*E[f];for(m=S-1;m>=0;--m){for(E=I[m],f=m+1;f<S;++f)P[m]-=P[f]*E[f];P[m]/=E[m]}return P}let h=Math.abs;return function(d,y,m){return n(a(d,m),y)}})();function Q(c){localStorage.setItem(`mlmap:workspace<${c.id}>`,JSON.stringify(c))}function Le(c){let e=localStorage.getItem("mlmap:currentWorkspaceId");if(!e){e=Date.now().toString(),localStorage.setItem("mlmap:currentWorkspaceId",e);let s={id:e,name:"New Workspace",version:"1.0",layout:{}};return localStorage.setItem(`mlmap:workspace<${e}>`,JSON.stringify(s)),s}let t=localStorage.getItem(`mlmap:workspace<${c||e}>`);return t?JSON.parse(t):null}function Ve(c){localStorage.removeItem(`mlmap:workspace<${c}>`)}function $e(c){let e=`mlmap:workspace<${c}>`,t=JSON.parse(localStorage.getItem(e)||`{id:"${c}",name:"Reset Workspace",version:"1.0",layout:{}`);localStorage.setItem(e,JSON.stringify({id:c,name:t?.name,version:"1.0",layout:{}}))}function _e(){let c=[];for(let e=0;e<localStorage.length;e++){let t=localStorage.key(e);if(t&&t.startsWith("mlmap:workspace<")){let s=localStorage.getItem(t);s&&c.push(JSON.parse(s))}}return c}oe();xe();var Fe="mlmap-sync",Ke=2e3;var Je=6e3;function je(c,e){return{type:c,payload:e,timestamp:Date.now()}}var ce=class{constructor(e){this.listeners=new Map;this.heartbeatTimer=null;this.lastPong=0;this._connected=!1;this.onConnectionChange=null;this.role=e,this.channel=new BroadcastChannel(Fe),this.channel.onmessage=t=>this.handleMessage(t.data),e==="control"&&this.startHeartbeat(),e==="display"&&(this.on("PING",()=>this.send("PONG")),setTimeout(()=>this.send("DISPLAY_READY"),100))}get connected(){return this._connected}set onConnectionChanged(e){this.onConnectionChange=e}send(e,t){try{this.channel.postMessage(je(e,t))}catch(s){console.warn("ChannelBridge: Failed to send message",e,s)}}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){let s=this.listeners.get(e);if(s){let i=s.indexOf(t);i>=0&&s.splice(i,1)}}destroy(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.channel.close(),this.listeners.clear()}handleMessage(e){(e.type==="PONG"||e.type==="DISPLAY_READY")&&(this.lastPong=Date.now(),this.setConnected(!0));let t=this.listeners.get(e.type);t&&t.forEach(s=>s(e.payload))}startHeartbeat(){this.heartbeatTimer=window.setInterval(()=>{this.send("PING"),this._connected&&Date.now()-this.lastPong>Je&&this.setConnected(!1)},Ke)}setConnected(e){this._connected!==e&&(this._connected=e,this.onConnectionChange&&this.onConnectionChange(e))}};var qe="mlmap:videoSources",de=class{constructor(){this.sources=[];this.onChange=null;this.liveStreams=new Map;this.load()}set onChanged(e){this.onChange=e}getAll(){return[...this.sources]}getById(e){return this.sources.find(t=>t.id===e)}getStream(e){return this.liveStreams.get(e)}addUrl(e,t){let s=t||e.split("/").pop()||"video",i={id:`src-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,name:s,url:e,type:"url"};return this.sources.push(i),this.save(),this.notify(),i}addFile(e){let t=URL.createObjectURL(e),s={id:`src-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,name:e.name,url:t,type:"file"};return this.sources.push(s),this.notify(),s}addCapture(e,t){let s=`src-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,i={id:s,name:t,url:`capture:${s}`,type:"capture"};this.liveStreams.set(s,e),this.sources.push(i);let a=e.getTracks(),n=()=>{a.every(h=>h.readyState==="ended")&&this.liveStreams.delete(s)};return a.forEach(h=>h.addEventListener("ended",n)),this.notify(),i}remove(e){let t=this.sources.findIndex(s=>s.id===e);if(t>=0){let s=this.sources[t];if(s.type==="file"&&s.url.startsWith("blob:")&&URL.revokeObjectURL(s.url),s.type==="capture"){let i=this.liveStreams.get(e);i&&(i.getTracks().forEach(a=>a.stop()),this.liveStreams.delete(e))}this.sources.splice(t,1),this.save(),this.notify()}}save(){let e=this.sources.filter(t=>t.type==="url");localStorage.setItem(qe,JSON.stringify(e))}load(){try{let e=localStorage.getItem(qe);e&&(this.sources=JSON.parse(e))}catch{this.sources=[]}}notify(){this.onChange&&this.onChange()}};var Ge="mlmap:playlists",Ee="mlmap:activePlaylist",pe=class{constructor(){this.playlists=[];this.activeId=null;this.onChange=null;this.load()}set onChanged(e){this.onChange=e}getAll(){return[...this.playlists]}getActive(){return this.playlists.find(e=>e.id===this.activeId)||this.playlists[0]||null}setActive(e){this.activeId=e,localStorage.setItem(Ee,e),this.notify()}create(e){let t={id:`pl-${Date.now()}`,name:e,items:[],loop:!0};return this.playlists.push(t),this.activeId||(this.activeId=t.id),this.save(),this.notify(),t}remove(e){this.playlists=this.playlists.filter(t=>t.id!==e),this.activeId===e&&(this.activeId=this.playlists[0]?.id||null),this.save(),this.notify()}addItem(e,t){let s=this.playlists.find(a=>a.id===e);if(!s)return;let i={id:`item-${Date.now()}-${Math.random().toString(36).slice(2,6)}`,sourceId:t,order:s.items.length};s.items.push(i),this.save(),this.notify()}removeItem(e,t){let s=this.playlists.find(i=>i.id===e);s&&(s.items=s.items.filter(i=>i.id!==t),s.items.forEach((i,a)=>i.order=a),this.save(),this.notify())}moveItem(e,t,s){let i=this.playlists.find(h=>h.id===e);if(!i)return;let a=i.items.findIndex(h=>h.id===t);if(a<0)return;let n=s==="up"?a-1:a+1;n<0||n>=i.items.length||([i.items[a],i.items[n]]=[i.items[n],i.items[a]],i.items.forEach((h,d)=>h.order=d),this.save(),this.notify())}toggleLoop(e){let t=this.playlists.find(s=>s.id===e);t&&(t.loop=!t.loop,this.save(),this.notify())}save(){localStorage.setItem(Ge,JSON.stringify(this.playlists)),this.activeId&&localStorage.setItem(Ee,this.activeId)}load(){try{let e=localStorage.getItem(Ge);e?this.playlists=JSON.parse(e):this.create("Default"),this.activeId=localStorage.getItem(Ee)||this.playlists[0]?.id||null}catch{this.create("Default")}}notify(){this.onChange&&this.onChange()}};function Xe(c){if(!isFinite(c)||isNaN(c))return"0:00";let e=Math.floor(c/60),t=Math.floor(c%60);return`${e}:${t.toString().padStart(2,"0")}`}function Ze(c,e,t,s){let i=new de,a=new pe,n=null,h=0;c.innerHTML=`
        <div class="mlmap-section">
            <div class="mlmap-section-title">Media Library</div>
            <div style="display:flex;gap:4px;margin-bottom:4px;">
                <input id="vp-url" type="text" class="mlmap-input" placeholder="Video URL..." style="flex:1;min-width:0;">
                <button id="vp-addUrl" class="mlmap-btn">Add</button>
            </div>
            <div style="display:flex;gap:4px;margin-bottom:6px;">
                <input id="vp-file" type="file" accept="video/*" style="display:none;">
                <button id="vp-chooseFile" class="mlmap-btn" style="flex:1;">Browse file...</button>
            </div>
            <div style="display:flex;gap:4px;margin-bottom:6px;">
                <button id="vp-capture" class="mlmap-btn" style="flex:1;">Screen capture...</button>
                <button id="vp-webcam" class="mlmap-btn" style="flex:1;">Webcam...</button>
            </div>
            <div id="vp-library"></div>
        </div>
        <div class="mlmap-section">
            <div class="mlmap-section-title">Playlist</div>
            <div style="display:flex;gap:4px;align-items:center;margin-bottom:6px;">
                <select id="vp-plSelect" class="mlmap-select" style="flex:1;min-width:0;"></select>
                <button id="vp-plNew" class="mlmap-btn" title="New playlist">+</button>
                <button id="vp-plDel" class="mlmap-btn" title="Delete playlist">-</button>
            </div>
            <div id="vp-playlist" style="margin-bottom:4px;"></div>
            <button id="vp-loop" class="mlmap-btn" style="width:100%;font-size:10px;">Loop: ON</button>
        </div>
    `,e.innerHTML=`
        <div style="display:flex;align-items:center;gap:3px;">
            <button id="tp-prev" class="transport-btn" title="Previous">|&lt;</button>
            <button id="tp-rw" class="transport-btn" title="-10s">&lt;&lt;</button>
            <button id="tp-play" class="transport-btn" title="Play" style="width:38px;font-size:14px;">&#9654;</button>
            <button id="tp-ff" class="transport-btn" title="+10s">&gt;&gt;</button>
            <button id="tp-next" class="transport-btn" title="Next">&gt;|</button>
            <button id="tp-stop" class="transport-btn" title="Stop">&#9632;</button>
        </div>
        <input id="tp-seek" type="range" min="0" max="1000" value="0" step="1" class="mlmap-range" style="flex:1;min-width:80px;">
        <span id="tp-time" style="font-size:11px;white-space:nowrap;color:#aaa;min-width:85px;text-align:center;">0:00 / 0:00</span>
        <span id="tp-now" style="flex:1;font-size:11px;color:#888;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:center;">No media</span>
        <div style="display:flex;align-items:center;gap:4px;">
            <span style="font-size:10px;color:#666;">Vol</span>
            <input id="tp-vol" type="range" min="0" max="100" value="100" class="mlmap-range" style="width:70px;">
            <button id="tp-mute" class="transport-btn" style="width:28px;font-size:10px;" title="Mute/Unmute">M</button>
        </div>
        <select id="tp-audioOut" class="mlmap-select" style="max-width:120px;font-size:10px;" title="Audio output routing">
            <option value="editor">Audio: Editor</option>
            <option value="output">Audio: Output</option>
            <option value="both">Audio: Both</option>
        </select>
    `;let d=p=>document.getElementById(p);function y(p){n=p,p.addEventListener("timeupdate",W),p.addEventListener("play",()=>{n===p&&z(),W()}),p.addEventListener("pause",W),p.addEventListener("ended",E),p.addEventListener("loadedmetadata",W)}function m(p){let x=a.getActive();if(!x||!x.items[p]||!n)return;h=p;let k=x.items[p],C=i.getById(k.sourceId);C&&(n.src=C.url,n.load())}function f(){let p=a.getActive();if(!(!p||p.items.length===0)){if(h++,h>=p.items.length)if(p.loop)h=0;else{h=p.items.length-1;return}m(h),n&&n.play().catch(()=>{}),t.send("NEXT")}}function b(){let p=a.getActive();if(!(!p||p.items.length===0)){if(h--,h<0)if(p.loop)h=p.items.length-1;else{h=0;return}m(h),n&&n.play().catch(()=>{}),t.send("PREVIOUS")}}function E(){let p=a.getActive();p&&p.items.length>1?f():p&&p.loop&&n&&(n.currentTime=0,n.play().catch(()=>{}))}function T(){let p=a.getActive();if(p&&p.items[h]){let x=i.getById(p.items[h].sourceId);if(x)return x.name}if(n&&n.src&&n.src!==window.location.href){let x=n.src.split("/");return x[x.length-1]||"Video"}return""}d("vp-addUrl").addEventListener("click",()=>{let p=d("vp-url"),x=p.value.trim();x&&(i.addUrl(x),p.value="",K())}),d("vp-url").addEventListener("keydown",p=>{p.stopPropagation(),p.key==="Enter"&&d("vp-addUrl").click()}),d("vp-chooseFile").addEventListener("click",()=>d("vp-file").click()),d("vp-file").addEventListener("change",p=>{let x=p.target;x.files&&x.files[0]&&(i.addFile(x.files[0]),K(),x.value="")}),d("vp-capture").addEventListener("click",async()=>{try{let p=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!0}),k=p.getVideoTracks()[0]?.label||"Screen Capture",C=i.addCapture(p,k);K(),s(C.url,C.name,p)}catch{}}),d("vp-webcam").addEventListener("click",async()=>{try{let x=(await navigator.mediaDevices.enumerateDevices()).filter(L=>L.kind==="videoinput"),k={video:!0,audio:!0};if(x.length>1){let L=x.map((V,ee)=>`${ee+1}. ${V.label||`Camera ${ee+1}`}`).join(`
`),N=prompt(`Select camera:
${L}`,"1");if(!N)return;let R=parseInt(N)-1;R>=0&&R<x.length&&(k={video:{deviceId:{exact:x[R].deviceId}},audio:!0})}let C=await navigator.mediaDevices.getUserMedia(k),H=C.getVideoTracks()[0]?.label||"Webcam",M=i.addCapture(C,H);K(),s(M.url,M.name,C)}catch{}}),d("vp-plSelect").addEventListener("change",p=>{a.setActive(p.target.value),A()}),d("vp-plNew").addEventListener("click",()=>{let p=prompt("Playlist name:","New Playlist");if(p){let x=a.create(p);a.setActive(x.id),U(),A()}}),d("vp-plDel").addEventListener("click",()=>{let p=a.getActive();p&&a.getAll().length>1&&(a.remove(p.id),U(),A())}),d("vp-loop").addEventListener("click",()=>{let p=a.getActive();p&&(a.toggleLoop(p.id),A())});let I="mlmap:audioMode",S=localStorage.getItem(I)||"editor",P=!1;function z(){n&&(n.muted=P||S==="output"),t.send("SET_MUTED",{muted:P||S==="editor"}),W()}function Y(){n&&(t.send("SEEK",{time:n.currentTime}),n.paused?t.send("PAUSE"):t.send("PLAY"),t.send("SET_VOLUME",{volume:n.volume}),t.send("SET_MUTED",{muted:P||S==="editor"}))}d("tp-play").addEventListener("click",()=>{if(!n){let p=a.getActive();if(p&&p.items.length>0){let x=p.items[0],k=i.getById(x.sourceId);k&&(s(k.url,k.name),setTimeout(()=>{n&&(P=!1,z(),m(0),setTimeout(()=>{n&&n.play().catch(()=>{}),re(),t.send("PLAY"),W()},200))},100))}return}if(n.paused){if(P=!1,z(),!n.src||n.src===window.location.href){let p=a.getActive();p&&p.items.length>0&&(m(0),setTimeout(()=>{n&&n.play().catch(()=>{}),W()},200))}else n.play().catch(()=>{});t.send("PLAY"),W()}else n.pause(),t.send("PAUSE")}),d("tp-stop").addEventListener("click",()=>{n&&(n.pause(),n.currentTime=0),t.send("STOP"),W()}),d("tp-prev").addEventListener("click",()=>b()),d("tp-next").addEventListener("click",()=>f()),d("tp-rw").addEventListener("click",()=>{if(n){let p=Math.max(0,n.currentTime-10);n.currentTime=p,t.send("SEEK",{time:p})}}),d("tp-ff").addEventListener("click",()=>{if(n){let p=n.currentTime+10;n.currentTime=p,t.send("SEEK",{time:p})}});let j=d("tp-seek"),q=!1;j.addEventListener("pointerdown",()=>{q=!0}),j.addEventListener("pointerup",()=>{q=!1}),j.addEventListener("input",()=>{if(n&&n.duration>0){let p=parseInt(j.value)/1e3*n.duration;n.currentTime=p,t.send("SEEK",{time:p})}}),d("tp-vol").addEventListener("input",p=>{let x=parseInt(p.target.value)/100;n&&(n.volume=x),t.send("SET_VOLUME",{volume:x})}),d("tp-mute").addEventListener("click",()=>{P=!P,z()}),d("tp-audioOut").value=S,d("tp-audioOut").addEventListener("change",p=>{S=p.target.value,localStorage.setItem(I,S),z()});function me(p){n&&n!==p&&(n.muted=!0),n=p,p.addEventListener("timeupdate",W),p.addEventListener("play",()=>{n===p&&z(),W()}),p.addEventListener("pause",W),p.addEventListener("ended",E),p.addEventListener("loadedmetadata",W),z()}c.addEventListener("keydown",p=>{let x=p.target.tagName;(x==="INPUT"||x==="SELECT"||x==="TEXTAREA")&&p.stopPropagation()});function W(){let p=n,x=p?!p.paused:!1,k=p?.currentTime||0,C=p?.duration||0;d("tp-play").innerHTML=x?"&#9646;&#9646;":"&#9654;",C>0&&!q&&(j.value=String(Math.round(k/C*1e3))),d("tp-time").textContent=`${Xe(k)} / ${Xe(C)}`;let O=T();if(d("tp-now").textContent=O||"No media",p){d("tp-vol").value=String(Math.round(p.volume*100));let H=d("tp-mute");H.textContent=P?"M":"\u266A",H.style.color=P?"#f55":"#ccc"}}function K(){let p=d("vp-library");if(!p)return;let x=i.getAll();if(p.innerHTML="",x.length===0){p.innerHTML='<div style="color:#555;font-size:11px;padding:4px;">No media added yet</div>';return}x.forEach(k=>{let C=document.createElement("div");C.className="mlmap-media-item";let O=document.createElement("span");O.className="name",O.textContent=k.type==="capture"?`[LIVE] ${k.name}`:k.name,O.title=k.type==="capture"?"Screen capture":k.url,k.type==="capture"&&(O.style.color="#5f5");let H=document.createElement("span");H.style.cssText="display:flex;gap:2px;flex-shrink:0;";let M=document.createElement("button");M.className="mlmap-btn",M.textContent="Layer",M.title="Create video layer",M.style.cssText="font-size:10px;padding:2px 4px;",M.addEventListener("click",()=>{let R=i.getStream(k.id);s(k.url,k.name,R)});let L=document.createElement("button");k.type!=="capture"&&(L.className="mlmap-btn",L.textContent="+PL",L.title="Add to playlist",L.style.cssText="font-size:10px;padding:2px 4px;",L.addEventListener("click",()=>{let R=a.getActive();R&&(a.addItem(R.id,k.id),A())}));let N=document.createElement("button");N.className="mlmap-btn",N.textContent="x",N.title="Remove",N.style.cssText="font-size:10px;padding:2px 4px;color:#f55;",N.addEventListener("click",()=>{i.remove(k.id),K()}),H.appendChild(M),H.appendChild(L),H.appendChild(N),C.appendChild(O),C.appendChild(H),p.appendChild(C)})}function U(){let p=d("vp-plSelect");if(!p)return;let x=a.getAll(),k=a.getActive();p.innerHTML="",x.forEach(C=>{let O=document.createElement("option");O.value=C.id,O.textContent=C.name,k&&k.id===C.id&&(O.selected=!0),p.appendChild(O)})}function A(){let p=d("vp-playlist");if(!p)return;let x=a.getActive();if(p.innerHTML="",!!x){if(d("vp-loop").textContent=`Loop: ${x.loop?"ON":"OFF"}`,x.items.length===0){p.innerHTML='<div style="color:#555;font-size:11px;padding:4px;">Playlist empty</div>';return}x.items.forEach((k,C)=>{let O=i.getById(k.sourceId),H=document.createElement("div");H.className="mlmap-pl-item";let M=document.createElement("span");M.className="name",M.textContent=`${C+1}. ${O?.name||"Unknown"}`;let L=document.createElement("span");L.style.cssText="display:flex;gap:1px;flex-shrink:0;";let N=document.createElement("button");N.className="mlmap-btn",N.innerHTML="&#9650;",N.style.cssText="font-size:8px;padding:1px 3px;",N.addEventListener("click",()=>{a.moveItem(x.id,k.id,"up"),A()});let R=document.createElement("button");R.className="mlmap-btn",R.innerHTML="&#9660;",R.style.cssText="font-size:8px;padding:1px 3px;",R.addEventListener("click",()=>{a.moveItem(x.id,k.id,"down"),A()});let V=document.createElement("button");V.className="mlmap-btn",V.textContent="x",V.style.cssText="font-size:9px;padding:1px 3px;color:#f55;",V.addEventListener("click",()=>{a.removeItem(x.id,k.id),A()}),L.appendChild(N),L.appendChild(R),L.appendChild(V),H.appendChild(M),H.appendChild(L),p.appendChild(H)})}}function re(){let p=a.getActive();if(!p)return;let x=p.items.map(k=>{let C=i.getById(k.sourceId);return{url:C?.url||"",name:C?.name||"Unknown"}}).filter(k=>k.url);t.send("LOAD_PLAYLIST",{items:x,loop:p.loop,startIndex:h})}return K(),U(),A(),{sourceManager:i,playlistManager:a,sendPlaylistToDisplay:re,syncPlaybackToDisplay:Y,registerVideoElement:y,setActiveVideo:me,getActiveVideo:()=>n}}oe();var Qe="mlmap.managedLayers",ke="mlmap:videoSources",et="mlmap:playlists",tt="mlmap:activePlaylist",it="mlmap:currentWorkspaceId";function Te(c){let e=localStorage.getItem(it)||"default",t=localStorage.getItem(`mlmap:workspace<${e}>`),s=t?JSON.parse(t):{id:e,name:"Workspace",version:"1.0",layout:[]},i=[];try{let d=localStorage.getItem(Qe);d&&(i=JSON.parse(d))}catch{}let a=[];try{let d=localStorage.getItem(ke);d&&(a=JSON.parse(d))}catch{}a=a.filter(d=>d.type==="url");let n=[];try{let d=localStorage.getItem(et);d&&(n=JSON.parse(d))}catch{}let h=localStorage.getItem(tt);return{version:F,name:c||s.name||"Workflow",timestamp:Date.now(),workspace:{id:s.id,name:s.name,layout:s.layout},managedLayers:i,videoSources:a,playlists:n,activePlaylistId:h}}function Se(c){let e=Date.now().toString(),t={id:e,name:c.name||c.workspace.name||"Imported",version:"1.0",layout:c.workspace.layout||[]};if(localStorage.setItem(`mlmap:workspace<${e}>`,JSON.stringify(t)),localStorage.setItem(it,e),c.managedLayers&&localStorage.setItem(Qe,JSON.stringify(c.managedLayers)),c.videoSources&&c.videoSources.length>0){let s=[];try{let a=localStorage.getItem(ke);a&&(s=JSON.parse(a))}catch{}let i=new Set(s.map(a=>a.url));for(let a of c.videoSources)i.has(a.url)||(s.push(a),i.add(a.url));localStorage.setItem(ke,JSON.stringify(s))}c.playlists&&c.playlists.length>0&&localStorage.setItem(et,JSON.stringify(c.playlists)),c.activePlaylistId&&localStorage.setItem(tt,c.activePlaylistId)}function kt(c){let e=JSON.stringify(c),t=new TextEncoder().encode(e),s="";for(let i=0;i<t.length;i++)s+=String.fromCharCode(t[i]);return btoa(s).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function Tt(c){try{let e=c.replace(/-/g,"+").replace(/_/g,"/");for(;e.length%4;)e+="=";let t=atob(e),s=new Uint8Array(t.length);for(let n=0;n<t.length;n++)s[n]=t.charCodeAt(n);let i=new TextDecoder().decode(s),a=JSON.parse(i);return!a.workspace||!a.version?null:a}catch{return null}}function st(c){let e=kt(c);return`${window.location.origin+window.location.pathname}?workflow=${e}`}function nt(){let e=new URLSearchParams(window.location.search).get("workflow");if(!e)return!1;let t=Tt(e);if(!t)return console.warn("MLMap: Invalid workflow data in URL"),!1;Se(t);let s=window.location.origin+window.location.pathname;return window.history.replaceState({},document.title,s),!0}function at(c){let e=JSON.stringify(c,null,2),t=new Blob([e],{type:"application/json"}),s=URL.createObjectURL(t),i=document.createElement("a");i.href=s,i.download=`${c.name.replace(/[^a-zA-Z0-9_-]/g,"_")}.mlmap`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s)}function ot(){return new Promise(c=>{let e=document.createElement("input");e.type="file",e.accept=".mlmap,.json",e.addEventListener("change",()=>{let t=e.files?.[0];if(!t){c(null);return}let s=new FileReader;s.onload=()=>{try{let i=JSON.parse(s.result);if(!i.workspace||!i.version){alert("Invalid workflow file."),c(null);return}c(i)}catch{alert("Failed to parse workflow file."),c(null)}},s.readAsText(t)}),e.click()})}var he=class{constructor(e){this.running=!1;this.rafId=0;this.zoom=1;this.getClipGroups=e,this.canvas=document.createElement("canvas"),this.canvas.style.position="fixed",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.zIndex="999999",this.canvas.style.pointerEvents="none",this.ctx=this.canvas.getContext("2d"),window.addEventListener("resize",()=>this.resize()),this.resize()}get canvasElement(){return this.canvas}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight}start(){this.running||(this.running=!0,this.render())}stop(){this.running=!1,this.rafId&&cancelAnimationFrame(this.rafId),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}render(){if(!this.running)return;let e=this.canvas.width,t=this.canvas.height;this.ctx.clearRect(0,0,e,t);let s=this.getClipGroups();if(this.zoom!==1){this.ctx.save();let i=e/2,a=t/2;this.ctx.translate(i,a),this.ctx.scale(this.zoom,this.zoom),this.ctx.translate(-i,-a)}for(let i of s){let a=i.video;if(a.readyState<2)continue;let n=i.baseTargetPoints,h=1/0,d=1/0,y=-1/0,m=-1/0;for(let E of n)E[0]<h&&(h=E[0]),E[1]<d&&(d=E[1]),E[0]>y&&(y=E[0]),E[1]>m&&(m=E[1]);let f=y-h,b=m-d;if(!(f<=0||b<=0))for(let E of i.masks){let T=E.targetPoints;if(!(!T||T.length<3)){this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(T[0][0],T[0][1]);for(let I=1;I<T.length;I++)this.ctx.lineTo(T[I][0],T[I][1]);this.ctx.closePath(),this.ctx.clip(),this.ctx.drawImage(a,h,d,f,b),this.ctx.restore()}}}this.zoom!==1&&this.ctx.restore(),this.rafId=requestAnimationFrame(()=>this.render())}};function rt(c){let e=document.createElement("style");e.textContent=`
        #mlmap-app {
            position: fixed;
            inset: 0;
            display: grid;
            grid-template-rows: 38px 1fr 48px;
            grid-template-columns: 210px 1fr 270px;
            grid-template-areas:
                "toolbar toolbar toolbar"
                "left center right"
                "transport transport transport";
            z-index: 1000001;
            pointer-events: none;
            font-family: -apple-system, 'Segoe UI', Roboto, sans-serif;
            font-size: 12px;
            color: #ccc;
            user-select: none;
        }
        #mlmap-toolbar {
            grid-area: toolbar;
            pointer-events: auto;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
        }
        #mlmap-left {
            grid-area: left;
            pointer-events: auto;
            background: #222;
            border-right: 1px solid #333;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        #mlmap-right {
            grid-area: right;
            pointer-events: auto;
            background: #222;
            border-left: 1px solid #333;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        #mlmap-transport {
            grid-area: transport;
            pointer-events: auto;
            background: #1a1a1a;
            border-top: 1px solid #333;
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 8px;
        }
        .mlmap-section {
            padding: 8px;
            border-bottom: 1px solid #333;
        }
        .mlmap-section-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #888;
            margin-bottom: 6px;
        }
        .mlmap-btn {
            background: #383838;
            color: #ccc;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            font-family: inherit;
        }
        .mlmap-btn:hover { background: #484848; color: #fff; }
        .mlmap-btn:active { background: #555; }
        .mlmap-btn-primary { background: #2a6cb5; color: #fff; }
        .mlmap-btn-primary:hover { background: #3580d0; }
        .mlmap-input {
            background: #1a1a1a;
            color: #ccc;
            border: 1px solid #444;
            border-radius: 3px;
            padding: 4px 6px;
            font-size: 11px;
            font-family: inherit;
            outline: none;
        }
        .mlmap-input:focus { border-color: #2a6cb5; }
        .mlmap-select {
            background: #1a1a1a;
            color: #ccc;
            border: 1px solid #444;
            border-radius: 3px;
            padding: 4px 6px;
            font-size: 11px;
            font-family: inherit;
            outline: none;
        }
        .mlmap-layer-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 3px 6px;
            border-radius: 3px;
            cursor: default;
        }
        .mlmap-layer-item:hover { background: #2a2a2a; }
        .mlmap-layer-item .name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 11px;
        }
        .mlmap-layer-item .icon {
            width: 14px;
            text-align: center;
            flex-shrink: 0;
            font-size: 10px;
        }
        .mlmap-layer-item .del-btn {
            opacity: 0;
            cursor: pointer;
            color: #f55;
            background: none;
            border: none;
            font-size: 11px;
            padding: 0 2px;
        }
        .mlmap-layer-item:hover .del-btn { opacity: 1; }
        .mlmap-media-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 3px 6px;
            border-radius: 3px;
        }
        .mlmap-media-item:hover { background: #2a2a2a; }
        .mlmap-media-item .name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 11px;
        }
        .mlmap-pl-item {
            display: flex;
            align-items: center;
            gap: 2px;
            padding: 3px 4px;
            border-radius: 3px;
            font-size: 11px;
        }
        .mlmap-pl-item:hover { background: #2a2a2a; }
        .mlmap-pl-item .name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .transport-btn {
            background: #333;
            color: #ccc;
            border: none;
            width: 30px;
            height: 26px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .transport-btn:hover { background: #444; color: #fff; }
        .mlmap-range {
            -webkit-appearance: none;
            appearance: none;
            background: #333;
            height: 6px;
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }
        .mlmap-range::-webkit-slider-runnable-track {
            height: 6px;
            border-radius: 3px;
        }
        .mlmap-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #aaa;
            cursor: pointer;
            margin-top: -4px;
        }
        .mlmap-range::-webkit-slider-thumb:hover { background: #fff; }
        .mlmap-range::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #aaa;
            cursor: pointer;
            border: none;
        }
        .mlmap-range::-moz-range-track {
            height: 6px;
            border-radius: 3px;
            background: #333;
        }
        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .app-title {
            font-weight: 700;
            font-size: 14px;
            color: #fff;
            letter-spacing: -0.5px;
            margin-right: 8px;
        }
        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-dot.connected { background: #4CAF50; }
        .status-dot.disconnected { background: #555; }
        #mlmap-left::-webkit-scrollbar,
        #mlmap-right::-webkit-scrollbar { width: 5px; }
        #mlmap-left::-webkit-scrollbar-track,
        #mlmap-right::-webkit-scrollbar-track { background: #1a1a1a; }
        #mlmap-left::-webkit-scrollbar-thumb,
        #mlmap-right::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        .add-layer-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3px;
        }
        .ws-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 3px;
            margin-top: 4px;
        }
        /* Context menu */
        #mlmap-context-menu {
            position: fixed;
            background: #2a2a2a;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 4px 0;
            min-width: 180px;
            z-index: 1000010;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            font-family: -apple-system, 'Segoe UI', Roboto, sans-serif;
            font-size: 12px;
            color: #ccc;
            display: none;
            pointer-events: auto;
        }
        .ctx-item {
            padding: 6px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ctx-item:hover { background: #3a3a3a; color: #fff; }
        .ctx-item .shortcut { color: #666; font-size: 10px; margin-left: 16px; }
        .ctx-sep { height: 1px; background: #444; margin: 3px 8px; }
        .ctx-item.disabled { color: #555; pointer-events: none; }
        .ctx-has-sub {
            position: relative;
        }
        .ctx-has-sub > .ctx-item { cursor: default; }
        .ctx-arrow { margin-left: auto; padding-left: 12px; font-size: 10px; color: #666; }
        .ctx-submenu {
            position: absolute;
            left: 100%;
            top: -4px;
            background: #2a2a2a;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 4px 0;
            min-width: 170px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            display: none;
        }
        .ctx-has-sub:hover > .ctx-submenu { display: block; }
    `,document.head.appendChild(e);let t=new ce("control"),s=null,i=[],a="mlmap.managedLayers",n=new he(()=>h());function h(){let o=[],l=c.getLayers(),r=new Map;for(let u of i){if(!u.clipTo)continue;let g=i.find($=>$.id===u.clipTo);if(!g)continue;let v=l.find($=>$.element.id===g.id),w=l.find($=>$.element.id===u.id);if(!v||!w)continue;let D=document.getElementById(g.id);if(!D)continue;let _=D.querySelector("video");_&&(r.has(g.id)||r.set(g.id,{video:_,baseTargetPoints:v.targetPoints.map($=>[$[0],$[1]]),masks:[]}),r.get(g.id).masks.push({targetPoints:w.targetPoints.map($=>[$[0],$[1]])}))}for(let u of r.values())o.push(u);return o}function d(){return i.some(o=>!!o.clipTo)}function y(){d()?n.start():n.stop()}let m=document.createElement("div");m.id="mlmap-workspace",m.style.cssText="position:fixed;inset:0;transform-origin:center center;",document.body.appendChild(m);let f=document.createElement("div");f.id="mlmap-app",f.innerHTML=`
        <div id="mlmap-toolbar">
            <div class="toolbar-group">
                <span class="app-title">MLMap</span>
                <span style="font-size:10px;color:#666;">v${F}</span>
                <button id="tb-toggleLeft" class="mlmap-btn" title="Toggle layers panel" style="font-size:10px;padding:4px 5px;">&laquo;</button>
            </div>
            <div class="toolbar-group">
                <span style="font-size:10px;color:#666;">Zoom</span>
                <input id="tb-zoom" type="range" min="25" max="100" value="100" class="mlmap-range" style="width:80px;" title="Workspace zoom">
                <span id="tb-zoomLabel" style="font-size:10px;color:#888;min-width:30px;">100%</span>
            </div>
            <div class="toolbar-group">
                <select id="tb-monitor" class="mlmap-select" title="Select output monitor" style="max-width:140px;">
                    <option value="">Monitor...</option>
                </select>
                <button id="tb-launch" class="mlmap-btn mlmap-btn-primary">Launch Output</button>
                <button id="tb-fullscreen" class="mlmap-btn" title="Fullscreen output">FS</button>
                <span class="status-dot disconnected" id="tb-status" title="Display disconnected"></span>
                <button id="tb-toggleRight" class="mlmap-btn" title="Toggle media panel" style="font-size:10px;padding:4px 5px;">&raquo;</button>
            </div>
        </div>
        <div id="mlmap-left"></div>
        <div id="mlmap-right"></div>
        <div id="mlmap-transport"></div>
    `,document.body.appendChild(f),f.addEventListener("mousedown",o=>o.stopPropagation());let b=document.createElement("div");b.id="mlmap-context-menu",document.body.appendChild(b),b.addEventListener("mousedown",o=>o.stopPropagation());let E=document.getElementById("mlmap-left"),T=document.getElementById("mlmap-right"),I=document.getElementById("mlmap-transport");E.innerHTML=`
        <div class="mlmap-section">
            <div class="mlmap-section-title">Layers</div>
            <div id="lp-layerList"></div>
            <div class="mlmap-section-title" style="margin-top:8px;">Add Layer</div>
            <div class="add-layer-grid">
                <button id="lp-addSquare" class="mlmap-btn">&#9633; Square</button>
                <button id="lp-addCircle" class="mlmap-btn">&#9675; Circle</button>
                <button id="lp-addTriangle" class="mlmap-btn">&#9651; Triangle</button>
                <button id="lp-addIframe" class="mlmap-btn">&#8865; iframe</button>
            </div>
            <div class="mlmap-section-title" style="margin-top:8px;">Options</div>
            <label style="display:flex;align-items:center;gap:4px;font-size:11px;cursor:pointer;">
                <input type="checkbox" id="lp-snap" checked> Snap to edges (G)
            </label>
        </div>
        <div class="mlmap-section">
            <div class="mlmap-section-title">Workspaces</div>
            <select id="lp-wsSelect" class="mlmap-select" style="width:100%;"></select>
            <div class="ws-grid">
                <button id="lp-wsAdd" class="mlmap-btn" title="New">+</button>
                <button id="lp-wsDup" class="mlmap-btn" title="Duplicate">&#128203;</button>
                <button id="lp-wsRen" class="mlmap-btn" title="Rename">&#9998;</button>
                <button id="lp-wsReset" class="mlmap-btn" title="Reset">&#8634;</button>
                <button id="lp-wsDel" class="mlmap-btn" title="Delete">&#128465;</button>
            </div>
            <div class="mlmap-section-title" style="margin-top:8px;">Import / Export</div>
            <div style="display:flex;flex-direction:column;gap:3px;">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;">
                    <button id="lp-wfExport" class="mlmap-btn" title="Export workflow to .mlmap file">Export File</button>
                    <button id="lp-wfImport" class="mlmap-btn" title="Import workflow from .mlmap file">Import File</button>
                </div>
                <button id="lp-wfShare" class="mlmap-btn mlmap-btn-primary" title="Copy share URL to clipboard" style="width:100%;">Copy Share URL</button>
            </div>
        </div>
        <div class="mlmap-section" style="border-bottom:none;">
            <div class="mlmap-section-title">Shortcuts</div>
            <pre style="font-size:10px;color:#666;margin:0;white-space:pre-wrap;line-height:1.5;">SHIFT+Space: Toggle edit mode
Drag: Move | SHIFT+Drag: Precise
ALT+Drag: Rotate/Scale
Ctrl+Click: Multi-select layers
Drag empty: Rubber band select
Arrows: Move | S: Solo | C: Cross
R: Rotate | H/V: Flip | B: Bounds
DEL: Delete | Ctrl+Z/Y: Undo/Redo
G: Toggle snap | Right-click: Menu</pre>
        </div>
    `;let S=Ze(T,I,t,z);function P(o,l){!l||!l.startsWith("blob:")||fetch(l).then(r=>r.arrayBuffer()).then(r=>{t.send("SEND_VIDEO_DATA",{layerId:o,data:r,mimeType:"video/mp4"})}).catch(()=>{})}function z(o,l,r){let u=`vlayer_${Date.now()}`,g=document.createElement("div");g.id=u,g.style.position="fixed",g.style.top="0px",g.style.left="0px",g.style.width="400px",g.style.height="300px",g.style.overflow="hidden",g.style.background="#000";let v=document.createElement("video");r?(v.srcObject=r,v.autoplay=!0):(v.src=o,v.preload="metadata"),v.style.width="100%",v.style.height="100%",v.style.objectFit="contain",v.muted=!0,v.playsInline=!0,g.appendChild(v),r&&r.getTracks().forEach($=>{$.addEventListener("ended",()=>{if(r.getTracks().every(G=>G.readyState==="ended")){v.srcObject=null,g.innerHTML="";let G=document.createElement("div");G.className="mlmap-video-placeholder",G.style.cssText="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none;",G.innerHTML=`<span style="font-size:18px;color:#555;">&#9632;</span><span style="font-size:10px;color:#555;margin-top:2px;">${l}</span><span style="font-size:9px;color:#444;margin-top:2px;">Capture ended</span>`,g.appendChild(G),U()}})}),m.appendChild(g);let w=window.innerWidth/2,D=window.innerHeight/2;c.addLayer(g,[[w-200,D-150],[w+200,D-150],[w+200,D+150],[w-200,D+150]]),S.registerVideoElement(v);let _={id:u,name:l,type:"video",videoUrl:r?void 0:o,width:400,height:300};i.push(_),A(),U(),t.send("ADD_LAYER",_),!r&&o&&P(u,o),setTimeout(()=>t.send("UPDATE_LAYOUT",{layout:c.getLayout()}),100)}function Y(o){let l=`shape_${Date.now()}`,r=document.createElement("div");r.id=l;let u=window.innerWidth/2,g=window.innerHeight/2;r.style.position="fixed",r.style.top="0px",r.style.left="0px",r.style.width="100px",r.style.height="100px",r.style.background=o==="triangle"?"transparent":"white",r.style.border=o==="triangle"?"2px solid white":"none",o==="circle"&&(r.style.borderRadius="50%"),o==="triangle"&&(r.style.width="0",r.style.height="0",r.style.borderLeft="50px solid transparent",r.style.borderRight="50px solid transparent",r.style.borderBottom="100px solid white"),m.appendChild(r);let v=50,w=50,D=o==="triangle"?[[u,g-w],[u+v,g+w],[u-v,g+w],[u,g+w]]:[[u-v,g-w],[u+v,g-w],[u+v,g+w],[u-v,g+w]];c.addLayer(r,D);let _={id:l,name:`${o}`,type:"shape",shapeType:o,width:100,height:100};i.push(_),A(),U(),t.send("ADD_LAYER",_),setTimeout(()=>t.send("UPDATE_LAYOUT",{layout:c.getLayout()}),100)}function j(o){let l=`iframe_${Date.now()}`,r=document.createElement("div");r.id=l,r.style.position="fixed",r.style.top="0px",r.style.left="0px",r.style.width="400px",r.style.height="300px",r.style.overflow="hidden",r.style.background="#000";let u=document.createElement("iframe");u.src=o,u.style.width="100%",u.style.height="100%",u.style.border="none",u.style.pointerEvents="none",u.setAttribute("allow","autoplay; encrypted-media"),r.appendChild(u),m.appendChild(r);let g=window.innerWidth/2,v=window.innerHeight/2;c.addLayer(r,[[g-200,v-150],[g+200,v-150],[g+200,v+150],[g-200,v+150]]);let w=o.replace(/^https?:\/\//,"").split("/")[0]||"iframe",D={id:l,name:w,type:"iframe",iframeUrl:o,width:400,height:300};i.push(D),A(),U(),t.send("ADD_LAYER",D),setTimeout(()=>t.send("UPDATE_LAYOUT",{layout:c.getLayout()}),100)}function q(o){i.forEach(u=>{u.clipTo===o&&W(u.id)}),i.find(u=>u.id===o)?.clipTo&&W(o);let r=document.getElementById(o);r&&r.remove(),i=i.filter(u=>u.id!==o),A(),U(),t.send("REMOVE_LAYER",{id:o}),y()}function me(o){let l=i.find(w=>w.id===o);if(!l||l.type!=="shape")return;let r=i.indexOf(l),u=null;for(let w=r-1;w>=0;w--)if(i[w].type==="video"){u=i[w].id;break}if(!u){for(let w=r+1;w<i.length;w++)if(i[w].type==="video"){u=i[w].id;break}}if(!u)return;l.clipTo=u;let g=document.getElementById(u);g&&(g.style.opacity="0");let v=document.getElementById(o);if(v&&(v.style.opacity="0"),g){let w=g.querySelector("video");w&&(w.paused&&w.play().catch(()=>{}),S.setActiveVideo(w))}A(),U(),y(),t.send("ADD_LAYER",l)}function W(o){let l=i.find(v=>v.id===o);if(!l||!l.clipTo)return;let r=l.clipTo;l.clipTo=void 0;let u=document.getElementById(o);if(u&&(u.style.opacity="1",l.shapeType==="triangle"?u.style.borderBottomColor="white":(l.shapeType,u.style.background="white")),!i.some(v=>v.clipTo===r)){let v=document.getElementById(r);v&&(v.style.opacity="1")}A(),U(),y(),t.send("ADD_LAYER",l)}function K(){let l=c.getLayers().map(r=>r.element.id);i.sort((r,u)=>{let g=l.indexOf(r.id),v=l.indexOf(u.id);return g-v}),A(),U()}function U(){let o=document.getElementById("lp-layerList");if(o.innerHTML="",i.length===0){o.innerHTML='<div style="color:#555;font-size:11px;padding:4px;">No layers</div>';return}i.forEach(l=>{let r=document.createElement("div");r.className="mlmap-layer-item",l.clipTo&&(r.style.paddingLeft="18px");let u=document.createElement("span");u.className="icon",l.type==="video"?u.textContent="\u25B6":l.type==="iframe"?u.textContent="\u29C9":l.shapeType==="circle"?u.textContent="\u25CF":l.shapeType==="triangle"?u.textContent="\u25B2":u.textContent="\u25A0";let g=l.type==="video"&&!document.getElementById(l.id)?.querySelector("video"),v=document.createElement("span");v.className="name",l.clipTo?v.textContent=`${l.name} (clip)`:g?(v.textContent=`${l.name}`,v.style.color="#f80"):v.textContent=l.name;let w=document.createElement("button");w.className="del-btn",w.textContent="\u2715",w.addEventListener("click",()=>q(l.id)),r.appendChild(u),r.appendChild(v),r.appendChild(w),o.appendChild(r)})}function A(){let o=i.map(l=>l.type==="video"?{...l,videoUrl:void 0}:l);localStorage.setItem(a,JSON.stringify(o))}function re(){try{let o=localStorage.getItem(a);o&&JSON.parse(o).forEach(u=>p(u));let l=localStorage.getItem("mlmap.dynamicShapes");l&&!o&&JSON.parse(l).forEach(u=>{let g={id:u.id,name:u.type,type:"shape",shapeType:u.type,width:100,height:100};p(g)})}catch{}U()}function p(o){let l=document.createElement("div");if(l.id=o.id,l.style.position="fixed",l.style.top="0px",l.style.left="0px",l.style.width=o.width+"px",l.style.height=o.height+"px",o.type==="video"){l.style.overflow="hidden",l.style.background="#111";let r=document.createElement("div");r.className="mlmap-video-placeholder",r.style.cssText="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none;",r.innerHTML=`<span style="font-size:18px;color:#555;">\u25B6</span><span style="font-size:10px;color:#555;margin-top:2px;">${o.name}</span><span style="font-size:9px;color:#444;margin-top:2px;">Re-import video</span>`,l.appendChild(r)}else if(o.type==="iframe"&&o.iframeUrl){l.style.overflow="hidden",l.style.background="#000";let r=document.createElement("iframe");r.src=o.iframeUrl,r.style.width="100%",r.style.height="100%",r.style.border="none",r.style.pointerEvents="none",r.setAttribute("allow","autoplay; encrypted-media"),l.appendChild(r)}else o.shapeType==="circle"?(l.style.background="white",l.style.borderRadius="50%"):o.shapeType==="triangle"?(l.style.width="0",l.style.height="0",l.style.borderLeft="50px solid transparent",l.style.borderRight="50px solid transparent",l.style.borderBottom="100px solid white",l.style.background="transparent"):l.style.background="white";m.appendChild(l),c.addLayer(l),i.push(o)}function x(o,l,r){let u=i.find(w=>w.id===o);if(!u||u.type!=="video")return;let g=document.getElementById(o);if(!g)return;g.innerHTML="",g.style.background="#000";let v=document.createElement("video");v.src=l,v.style.width="100%",v.style.height="100%",v.style.objectFit="contain",v.muted=!0,v.playsInline=!0,v.preload="metadata",g.appendChild(v),S.registerVideoElement(v),u.name=r,u.videoUrl=l,A(),U(),i.some(w=>w.clipTo===o)&&(v.play().catch(()=>{}),y()),t.send("ADD_LAYER",u),P(o,l),setTimeout(()=>t.send("UPDATE_LAYOUT",{layout:c.getLayout()}),100)}function k(o,l,r){let u=i.find(w=>w.id===o);if(!u||u.type!=="video")return;let g=document.getElementById(o);if(!g)return;g.innerHTML="",g.style.background="#000";let v=document.createElement("video");v.srcObject=l,v.autoplay=!0,v.style.width="100%",v.style.height="100%",v.style.objectFit="contain",v.muted=!0,v.playsInline=!0,g.appendChild(v),l.getTracks().forEach(w=>{w.addEventListener("ended",()=>{if(l.getTracks().every(D=>D.readyState==="ended")){v.srcObject=null,g.innerHTML="";let D=document.createElement("div");D.className="mlmap-video-placeholder",D.style.cssText="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none;",D.innerHTML=`<span style="font-size:18px;color:#555;">&#9632;</span><span style="font-size:10px;color:#555;margin-top:2px;">${r}</span><span style="font-size:9px;color:#444;margin-top:2px;">Capture ended</span>`,g.appendChild(D),U()}})}),S.registerVideoElement(v),u.name=r,u.videoUrl=void 0,A(),U(),i.some(w=>w.clipTo===o)&&y(),t.send("ADD_LAYER",u),setTimeout(()=>t.send("UPDATE_LAYOUT",{layout:c.getLayout()}),100)}document.getElementById("lp-addSquare").addEventListener("click",()=>Y("square")),document.getElementById("lp-addCircle").addEventListener("click",()=>Y("circle")),document.getElementById("lp-addTriangle").addEventListener("click",()=>Y("triangle")),document.getElementById("lp-addIframe").addEventListener("click",()=>{let o=prompt("Enter URL for iframe:","https://");o&&o!=="https://"&&j(o)});let C=document.getElementById("lp-snap");C.checked=c.snapEnabled,C.addEventListener("change",()=>{c.snapEnabled=C.checked}),c.onSnapChanged=o=>{C.checked=o};function O(o,l,r){c.selectLayer(r);let u=r.element.id,g=i.find(te=>te.id===u),v=g?.type==="shape",w=g?.type==="video",D=!!g?.clipTo,_="",$=i.some(te=>te.type==="video");v&&!D&&$?_="Create Clip Mask":D&&(_="Release Clip Mask"),b.innerHTML=`
            <div class="ctx-item" data-action="center">Center on screen</div>
            <div class="ctx-sep"></div>
            ${w?`
            <div class="ctx-has-sub">
                <div class="ctx-item" style="color:#5af;">Assign Video<span class="ctx-arrow">\u25B6</span></div>
                <div class="ctx-submenu">
                    <div class="ctx-item" data-action="assignFile">Browse file...</div>
                    <div class="ctx-item" data-action="assignUrl">Enter URL...</div>
                    <div class="ctx-sep"></div>
                    <div class="ctx-item" data-action="assignCapture">Screen capture...</div>
                    <div class="ctx-item" data-action="assignWebcam">Webcam...</div>
                </div>
            </div>
            <div class="ctx-sep"></div>`:""}
            <div class="ctx-has-sub">
                <div class="ctx-item">Layer Order<span class="ctx-arrow">\u25B6</span></div>
                <div class="ctx-submenu">
                    <div class="ctx-item" data-action="moveUp">Move Up</div>
                    <div class="ctx-item" data-action="moveDown">Move Down</div>
                    <div class="ctx-sep"></div>
                    <div class="ctx-item" data-action="sendToTop">Send to Top</div>
                    <div class="ctx-item" data-action="sendToBottom">Send to Bottom</div>
                </div>
            </div>
            <div class="ctx-has-sub">
                <div class="ctx-item">Transform<span class="ctx-arrow">\u25B6</span></div>
                <div class="ctx-submenu">
                    <div class="ctx-item" data-action="rotate90">Rotate 90\xB0</div>
                    <div class="ctx-item" data-action="rotate180">Rotate 180\xB0</div>
                    <div class="ctx-item" data-action="rotate270">Rotate 270\xB0</div>
                    <div class="ctx-sep"></div>
                    <div class="ctx-item" data-action="flipH">Flip Horizontal</div>
                    <div class="ctx-item" data-action="flipV">Flip Vertical</div>
                    <div class="ctx-sep"></div>
                    <div class="ctx-item" data-action="scaleUp">Scale +10%</div>
                    <div class="ctx-item" data-action="scaleDown">Scale -10%</div>
                    <div class="ctx-sep"></div>
                    <div class="ctx-item" data-action="resetTransform">Reset Transform</div>
                </div>
            </div>
            <div class="ctx-sep"></div>
            ${_?`<div class="ctx-item" data-action="toggleClip">${_}</div><div class="ctx-sep"></div>`:""}
            <div class="ctx-item" data-action="solo">Solo / Unsolo<span class="shortcut">S</span></div>
            <div class="ctx-item" data-action="delete" style="color:#f55;">Delete layer<span class="shortcut">DEL</span></div>
        `;let G=200,Ce=300,ht=o+G>window.innerWidth?o-G:o,ut=l+Ce>window.innerHeight?l-Ce:l;b.style.left=Math.max(0,ht)+"px",b.style.top=Math.max(0,ut)+"px",b.style.display="block",b.querySelectorAll(".ctx-item[data-action]").forEach(te=>{te.addEventListener("click",mt=>{switch(mt.stopPropagation(),te.dataset.action){case"center":c.centerLayer(r);break;case"moveUp":c.moveLayerUp(r),K();break;case"moveDown":c.moveLayerDown(r),K();break;case"sendToTop":c.moveLayerToTop(r),K();break;case"sendToBottom":c.moveLayerToBottom(r),K();break;case"rotate90":c.rotateLayerPublic(r,90);break;case"rotate180":c.rotateLayerPublic(r,180);break;case"rotate270":c.rotateLayerPublic(r,270);break;case"flipH":c.flipLayerH(r);break;case"flipV":c.flipLayerV(r);break;case"scaleUp":c.scaleLayerPublic(r,1.1);break;case"scaleDown":c.scaleLayerPublic(r,.9);break;case"resetTransform":c.resetLayerTransform(r);break;case"toggleClip":D?W(u):me(u);break;case"assignFile":{let B=document.createElement("input");B.type="file",B.accept="video/*",B.onchange=()=>{let J=B.files?.[0];if(J){let ie=URL.createObjectURL(J);x(u,ie,J.name)}},B.click();break}case"assignUrl":{let B=prompt("Enter video URL:","https://");if(B&&B!=="https://"){let J=B.split("/").pop()||"Video URL";x(u,B,J)}break}case"assignCapture":{(async()=>{try{let B=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!0}),ie=B.getVideoTracks()[0]?.label||"Screen Capture";k(u,B,ie)}catch{}})();break}case"assignWebcam":{(async()=>{try{let J=(await navigator.mediaDevices.enumerateDevices()).filter(ve=>ve.kind==="videoinput"),ie={video:!0,audio:!0};if(J.length>1){let ve=J.map((yt,De)=>`${De+1}. ${yt.label||`Camera ${De+1}`}`).join(`
`),Me=prompt(`Select camera:
${ve}`,"1");if(!Me)return;let be=parseInt(Me)-1;be>=0&&be<J.length&&(ie={video:{deviceId:{exact:J[be].deviceId}},audio:!0})}let Ie=await navigator.mediaDevices.getUserMedia(ie),ft=Ie.getVideoTracks()[0]?.label||"Webcam";k(u,Ie,ft)}catch{}})();break}case"solo":let ge=c.getLayers();ge.some(B=>!B.visible)?ge.forEach(B=>B.visible=!0):(ge.forEach(B=>B.visible=!1),r.visible=!0);break;case"delete":q(u);break}H()})})}function H(){b.style.display="none"}document.addEventListener("contextmenu",o=>{let l=o.target;if(l.closest("#mlmap-app")||l.closest("#mlmap-context-menu"))return;let r=c.getLayerAtPoint(o.clientX,o.clientY);r&&(o.preventDefault(),O(o.clientX,o.clientY,r))}),document.addEventListener("mousedown",o=>{o.target.closest("#mlmap-context-menu")||H()}),document.addEventListener("keydown",o=>{o.key==="Escape"&&H()});let M=_e(),L=M.find(o=>o.id===localStorage.getItem("mlmap:currentWorkspaceId"))||null;!L&&M.length&&(L=M[0],localStorage.setItem("mlmap:currentWorkspaceId",L.id));function N(){let o=document.getElementById("lp-wsSelect");o.innerHTML="",M.forEach(l=>{let r=document.createElement("option");r.value=l.id,r.textContent=l.name,L&&L.id===l.id&&(r.selected=!0),o.appendChild(r)})}function R(o){localStorage.setItem("mlmap:currentWorkspaceId",o.id),window.location.reload()}document.getElementById("lp-wsAdd").addEventListener("click",()=>{let o=prompt("Workspace name:","New Workspace")||"New Workspace",l={id:Date.now().toString(),name:o,version:"1.0",layout:{}};M.push(l),Q(l),R(l)}),document.getElementById("lp-wsDup").addEventListener("click",()=>{if(!L)return;let o=prompt("New name:",L.name+" (Copy)")||L.name+" (Copy)",l={id:Date.now().toString(),name:o,version:"1.0",layout:L.layout};M.push(l),Q(l),R(l)}),document.getElementById("lp-wsRen").addEventListener("click",()=>{if(!L)return;let o=prompt("New name:",L.name);o&&(L.name=o,Q(L),N())}),document.getElementById("lp-wsReset").addEventListener("click",()=>{L&&confirm("Reset workspace? This will clear all layer positions.")&&($e(L.id),window.location.reload())}),document.getElementById("lp-wsDel").addEventListener("click",()=>{!L||M.length<=1||confirm("Delete workspace '"+L.name+"'?")&&(Ve(L.id),M=M.filter(o=>o.id!==L?.id),M.length&&R(M[0]))}),document.getElementById("lp-wsSelect").addEventListener("change",o=>{let l=M.find(r=>r.id===o.target.value);l&&R(l)}),N(),document.getElementById("lp-wfExport").addEventListener("click",()=>{let o=Te(L?.name);at(o)}),document.getElementById("lp-wfImport").addEventListener("click",async()=>{let o=await ot();o&&(Se(o),window.location.reload())}),document.getElementById("lp-wfShare").addEventListener("click",()=>{let o=Te(L?.name),l=st(o);navigator.clipboard.writeText(l).then(()=>{let r=document.getElementById("lp-wfShare"),u=r.textContent;r.textContent="Copied!",r.style.background="#4CAF50",setTimeout(()=>{r.textContent=u,r.style.background=""},2e3)}).catch(()=>{prompt("Share URL (copy manually):",l)})});let V=document.getElementById("tb-launch");function ee(){s&&!s.closed?(V.textContent="Stop Output",V.classList.remove("mlmap-btn-primary"),V.style.background="#a33"):(V.textContent="Launch Output",V.classList.add("mlmap-btn-primary"),V.style.background="",s=null)}V.addEventListener("click",()=>{if(s&&!s.closed){s.close(),s=null,ee();return}let o=document.getElementById("tb-monitor"),l=parseInt(o.value),r="width=1280,height=720";if(!isNaN(l)&&window._mlmapScreens&&window._mlmapScreens[l]){let g=window._mlmapScreens[l];r=`left=${g.availLeft},top=${g.availTop},width=${g.availWidth},height=${g.availHeight}`}s=window.open(Ne,"mlmap-display",r),ee();let u=setInterval(()=>{(!s||s.closed)&&(clearInterval(u),s=null,ee())},1e3)}),document.getElementById("tb-fullscreen").addEventListener("click",()=>{t.send("FULLSCREEN_ENTER")}),t.onConnectionChanged=o=>{let l=document.getElementById("tb-status");l.className=o?"status-dot connected":"status-dot disconnected",l.title=o?"Display connected":"Display disconnected"},t.on("DISPLAY_READY",()=>{i.forEach(o=>t.send("ADD_LAYER",o)),setTimeout(()=>{t.send("UPDATE_LAYOUT",{layout:c.getLayout()}),S.sendPlaylistToDisplay(),i.forEach(o=>{if(o.type==="video"){let r=document.getElementById(o.id)?.querySelector("video");r&&r.src&&r.src.startsWith("blob:")&&P(o.id,r.src)}}),setTimeout(()=>S.syncPlaybackToDisplay(),500)},200)});async function ct(){let o=document.getElementById("tb-monitor");try{if("getScreenDetails"in window){let l=await window.getScreenDetails();window._mlmapScreens=l.screens,o.innerHTML='<option value="">Select monitor...</option>',l.screens.forEach((r,u)=>{let g=document.createElement("option");g.value=String(u);let v=r.label||`Monitor ${u+1}`;g.textContent=`${v} (${r.width}x${r.height})`,r.isPrimary||(g.textContent+=" *"),o.appendChild(g)})}else o.innerHTML=`<option value="">Default (${screen.width}x${screen.height})</option>`}catch{o.innerHTML=`<option value="">Default (${screen.width}x${screen.height})</option>`}}ct();let se=!0,ne=!0;function Pe(){let o=se?"210px":"0px",l=ne?"270px":"0px";f.style.gridTemplateColumns=`${o} 1fr ${l}`,E.style.display=se?"flex":"none",T.style.display=ne?"flex":"none",document.getElementById("tb-toggleLeft").innerHTML=se?"&laquo;":"&raquo;",document.getElementById("tb-toggleRight").innerHTML=ne?"&raquo;":"&laquo;"}document.getElementById("tb-toggleLeft").addEventListener("click",()=>{se=!se,Pe()}),document.getElementById("tb-toggleRight").addEventListener("click",()=>{ne=!ne,Pe()});let fe=document.getElementById("tb-zoom"),dt=document.getElementById("tb-zoomLabel");fe.addEventListener("input",()=>{let o=parseInt(fe.value)/100;m.style.transform=o<1?`scale(${o})`:"",dt.textContent=`${fe.value}%`,c.setWorkspaceZoom(o),n.zoom=o}),document.body.appendChild(n.canvasElement);let pt=c.setConfigEnabled;c.setConfigEnabled=function(o){pt.call(c,o),f.style.display=o?"grid":"none",o||ye()};function ye(){let o=new Set;for(let l of i){if(!l.clipTo)continue;let r=document.getElementById(l.id);r&&(r.style.opacity="0"),o.add(l.clipTo)}for(let l of o){let r=document.getElementById(l);r&&(r.style.opacity="0")}}c.onAfterDraw=ye,c.layoutChangeListener=()=>{L&&(L.layout=c.getLayout(),Q(L)),t.send("UPDATE_LAYOUT",{layout:c.getLayout()})},document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&S.syncPlaybackToDisplay()}),new MutationObserver(o=>{for(let l of o)l.type==="childList"&&l.removedNodes.length>0&&l.removedNodes.forEach(r=>{if(r instanceof HTMLElement&&!r.isConnected){let u=i.findIndex(g=>g.id===r.id);u!==-1&&(i.splice(u,1),A(),U(),t.send("REMOVE_LAYER",{id:r.id}))}})}).observe(document.body,{childList:!0,subtree:!0}),re(),L?.layout&&c.setLayout(L.layout),ye(),y(),E.addEventListener("keydown",o=>{let l=o.target.tagName;(l==="INPUT"||l==="SELECT"||l==="TEXTAREA")&&o.stopPropagation()}),le().then(o=>{if(o.latest!==F){let l=f.querySelector(".app-title");l&&l.setAttribute("title",`Update available: v${o.latest}`)}})}oe();var ue=class{constructor(e={}){this.onAfterDraw=null;this.layers=[];this.configActive=!1;this.dragging=!1;this.dragOffset=[0,0];this.selectedLayer=null;this.selectedLayers=[];this.selectedPoint=null;this.selectionRadius=20;this.hoveringPoint=null;this.hoveringLayer=null;this.isLayerSoloed=!1;this.snapEnabled=!0;this.onSnapChanged=null;this.SNAP_THRESHOLD=12;this.workspaceZoom=1;this.rubberBandActive=!1;this.rubberBandStart=[0,0];this.rubberBandEnd=[0,0];this.rubberBandBaseSelection=[];this.mousePosition=[0,0];this.mouseDelta=[0,0];this.mouseDownPoint=[0,0];this.keyDown=this.keyDown.bind(this),this.setConfigEnabled=this.setConfigEnabled.bind(this),this.showLayerNames=this.getProp(e,"labels",!0),this.showCrosshairs=this.getProp(e,"crosshairs",!1),this.showScreenBounds=this.getProp(e,"screenbounds",!1),this.autoSave=this.getProp(e,"autoSave",!0),this.autoLoad=this.getProp(e,"autoLoad",!0),this.layerList=this.getProp(e,"layers",[]),this.layoutChangeListener=this.getProp(e,"onchange",()=>{}),this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.initCanvas(),this.loadSettings();for(let s of this.layerList)(s instanceof HTMLElement||typeof s=="string")&&this.addLayer(s);this.autoLoad&&this.loadSettings(),this.pushHistory(),new MutationObserver(s=>{s.forEach(i=>{i.removedNodes.forEach(a=>{a.isConnected||this.layers.forEach((n,h)=>{n.element===a&&(n.overlay&&n.overlay.remove(),this.layers.splice(h,1))})})})}).observe(document.body,{childList:!0,subtree:!0})}getProp(e,t,s){return e&&e.hasOwnProperty(t)&&e[t]!==null?e[t]:s}initCanvas(){this.canvas.style.display="none",this.canvas.style.position="fixed",this.canvas.style.top="0px",this.canvas.style.left="0px",this.canvas.style.zIndex="1000000",this.context=this.canvas.getContext("2d"),document.body.appendChild(this.canvas),window.addEventListener("resize",this.resize.bind(this)),window.addEventListener("mousemove",this.mouseMove.bind(this)),window.addEventListener("mouseup",this.mouseUp.bind(this)),window.addEventListener("mousedown",this.mouseDown.bind(this)),window.addEventListener("keydown",this.keyDown.bind(this)),this.resize()}pushHistory(){let e=this.getLayout();X.push(JSON.stringify(e)),X.length>50&&X.shift(),ae.length=0}saveSettings(){let e=Le();Q({id:e?.id,name:e?.name,version:e?.version,layout:this.getLayout()})}loadSettings(){try{let e=Le();e?.version==="1.0"&&e?.layout?this.setLayout(e.layout):console.warn("MLMap: localStorage version mismatch, skipping load.")}catch(e){console.error("MLMap: Failed to parse layout from localStorage.",e)}}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.draw()}pointInTriangle(e,t,s,i){let a=t[1]*i[0]-t[0]*i[1]+(i[1]-t[1])*e[0]+(t[0]-i[0])*e[1],n=t[0]*s[1]-t[1]*s[0]+(t[1]-s[1])*e[0]+(s[0]-t[0])*e[1];if(a<0!=n<0)return!1;let h=-s[1]*i[0]+t[1]*(i[0]-s[0])+t[0]*(s[1]-i[1])+s[0]*i[1];return h<0&&(a=-a,n=-n,h=-h),a>0&&n>0&&a+n<h}pointInLayer(e,t){let[s,i,a,n]=t.targetPoints;return this.pointInTriangle(e,s,i,a)||this.pointInTriangle(e,n,s,a)}updateTransform(){let e=["","-webkit-","-moz-","-ms-","-o-"],t="transform";for(let s of e){let i=s+"transform";if(i in document.body.style){t=i;break}}for(let s=0;s<this.layers.length;s++){let i=[],a=[];for(let y=0,m=this.layers[s].sourcePoints.length;y<m;++y){let f=this.layers[s].sourcePoints[y],b=this.layers[s].targetPoints[y];i.push([f[0],f[1],1,0,0,0,-f[0]*b[0],-f[1]*b[0]]),a.push(b[0]),i.push([0,0,0,f[0],f[1],1,-f[0]*b[1],-f[1]*b[1]]),a.push(b[1])}let n=ze(i,a,!0),h=[n[0],n[3],0,n[6],n[1],n[4],0,n[7],0,0,1,0,n[2],n[5],0,1],d=this.layers[s].element.style;d.setProperty(t,`matrix3d(${h.join(",")})`),d.setProperty(`${t}-origin`,"0px 0px 0px")}}rotateLayer(e,t){for(var s=Math.sin(t),i=Math.cos(t),a=[0,0],n=0;n<e.targetPoints.length;n++)a[0]+=e.targetPoints[n][0],a[1]+=e.targetPoints[n][1];a[0]/=4,a[1]/=4;for(var n=0;n<e.targetPoints.length;n++){var h=e.targetPoints[n][0]-a[0],d=e.targetPoints[n][1]-a[1];e.targetPoints[n][0]=h*i-d*s+a[0],e.targetPoints[n][1]=h*s+d*i+a[1]}}scaleLayer(e,t){for(var s=[0,0],i=0;i<e.targetPoints.length;i++)s[0]+=e.targetPoints[i][0],s[1]+=e.targetPoints[i][1];s[0]/=4,s[1]/=4;for(var i=0;i<e.targetPoints.length;i++){var a=e.targetPoints[i][0]-s[0],n=e.targetPoints[i][1]-s[1];e.targetPoints[i][0]=a*t+s[0],e.targetPoints[i][1]=n*t+s[1]}}undo(){if(X.length>1){ae.push(X.pop());var e=JSON.parse(X[X.length-1]);this.setLayout(e),this.draw(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}}redo(){if(ae.length>0){let e=ae.pop();X.push(e),this.setLayout(JSON.parse(e)),this.draw(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}}swapLayerPoints(e,t,s){var i=e[t][0],a=e[t][1];e[t][0]=e[s][0],e[t][1]=e[s][1],e[s][0]=i,e[s][1]=a}addLayer(e,t){let s=null;if(typeof e=="string"){if(s=document.getElementById(e),!s)throw new Error("MLMap: No element found with id: "+e)}else if(e instanceof HTMLElement)s=e;else throw new Error("MLMap: Invalid target");for(let a=0;a<this.layers.length;a++)if(this.layers[a].element.id===s.id){t&&(this.layers[a].targetPoints=Z(t));return}s.style.position="fixed",s.style.display="block",s.style.top="0px",s.style.left="0px",s.style.padding="0px",s.style.margin="0px";let i={visible:!0,element:s,width:s.clientWidth,height:s.clientHeight,sourcePoints:[[0,0],[s.clientWidth,0],[s.clientWidth,s.clientHeight],[0,s.clientHeight]],targetPoints:[]};if(t)i.targetPoints=Z(t);else{let[a,n]=Oe(i.width,i.height,this.layers);i.targetPoints=[[a,n],[a+i.width,n],[a+i.width,n+i.height],[a,n+i.height]]}this.layers.push(i),s.parentElement?.appendChild(s),this.updateTransform()}removeLayer(e){let t=typeof e=="string"?document.getElementById(e):e;if(t){for(let s=this.layers.length-1;s>=0;s--)this.layers[s].element===t&&(this.layers[s].overlay&&this.layers[s].overlay?.remove(),this.layers.splice(s,1));this.updateTransform()}}setLayout(e){for(var t=0;t<e.length;t++){for(var s=!1,i=0;i<this.layers.length;i++)this.layers[i].element.id==e[t].id&&(console.log("Setting points."),this.layers[i].targetPoints=Z(e[t].targetPoints),this.layers[i].sourcePoints=Z(e[t].sourcePoints),s=!0);if(s)console.log('MLMap: Element "" + layout[i].id + "" is already mapped.');else{var a=document.getElementById(e[t].id);a?this.addLayer(a,e[t].targetPoints):console.log('MLMap: Can"t find element: '+e[t].id)}}this.updateTransform(),this.draw()}getLayout(){for(var e=[],t=0;t<this.layers.length;t++)e.push({id:this.layers[t].element.id,targetPoints:Z(this.layers[t].targetPoints),sourcePoints:Z(this.layers[t].sourcePoints)});return e}setConfigEnabled(e){this.configActive=e,this.canvas.style.display=e?"block":"none",e?this.draw():(this.selectedPoint=null,this.selectedLayer=null,this.selectedLayers=[],this.dragging=!1,this.rubberBandActive=!1,this.showScreenBounds=!1)}getSelectedLayer(){return this.selectedLayer}getLayers(){return this.layers}getLayerAtPoint(e,t){let[s,i]=this.toWorkspace(e,t);for(let a=this.layers.length-1;a>=0;a--){let n=this.layers[a];if(n.visible&&this.pointInLayer([s,i],n))return n}return null}selectLayer(e){this.selectedLayer=e,this.selectedLayers=e?[e]:[],this.selectedPoint=null,this.draw()}getSelectedLayers(){return[...this.selectedLayers]}centerLayer(e){let t=window.innerWidth/2,s=window.innerHeight/2,i=0,a=0;for(let d of e.targetPoints)i+=d[0],a+=d[1];i/=4,a/=4;let n=t-i,h=s-a;for(let d of e.targetPoints)d[0]+=n,d[1]+=h;this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}rotateLayerPublic(e,t){this.rotateLayer(e,t*Math.PI/180),this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}flipLayerH(e){this.swapLayerPoints(e.sourcePoints,0,1),this.swapLayerPoints(e.sourcePoints,3,2),this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}flipLayerV(e){this.swapLayerPoints(e.sourcePoints,0,3),this.swapLayerPoints(e.sourcePoints,1,2),this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}deleteSelectedLayer(e){e.element.remove(),e.overlay&&e.overlay.remove();let t=this.layers.indexOf(e);t>=0&&this.layers.splice(t,1),this.selectedLayer===e&&(this.selectedLayer=null);let s=this.selectedLayers.indexOf(e);s>=0&&this.selectedLayers.splice(s,1),this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}scaleLayerPublic(e,t){this.scaleLayer(e,t),this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}moveLayerUp(e){let t=this.layers.indexOf(e);t<0||t>=this.layers.length-1||(this.layers[t]=this.layers[t+1],this.layers[t+1]=e,this.reorderLayerDOM(),this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener())}moveLayerDown(e){let t=this.layers.indexOf(e);t<=0||(this.layers[t]=this.layers[t-1],this.layers[t-1]=e,this.reorderLayerDOM(),this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener())}moveLayerToTop(e){let t=this.layers.indexOf(e);t<0||t===this.layers.length-1||(this.layers.splice(t,1),this.layers.push(e),this.reorderLayerDOM(),this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener())}moveLayerToBottom(e){let t=this.layers.indexOf(e);t<=0||(this.layers.splice(t,1),this.layers.unshift(e),this.reorderLayerDOM(),this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener())}reorderLayerDOM(){for(let e of this.layers)e.element.parentElement?.appendChild(e.element)}resetLayerTransform(e){let t=window.innerWidth/2,s=window.innerHeight/2,i=e.width/2,a=e.height/2;e.targetPoints=[[t-i,s-a],[t+i,s-a],[t+i,s+a],[t-i,s+a]],e.sourcePoints=[[0,0],[e.width,0],[e.width,e.height],[0,e.height]],this.updateTransform(),this.draw(),this.pushHistory(),this.autoSave&&this.saveSettings(),this.layoutChangeListener()}layerIntersectsRect(e,t,s,i,a){let n=Math.min(t,i),h=Math.min(s,a),d=Math.max(t,i),y=Math.max(s,a),m=1/0,f=1/0,b=-1/0,E=-1/0;for(let T of e.targetPoints)T[0]<m&&(m=T[0]),T[1]<f&&(f=T[1]),T[0]>b&&(b=T[0]),T[1]>E&&(E=T[1]);return!(b<n||m>d||E<h||f>y)}draw(){if(this.configActive){if(this.context.strokeStyle="red",this.context.lineWidth=2,this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.workspaceZoom!==1){this.context.save();let e=this.canvas.width/2,t=this.canvas.height/2;this.context.translate(e,t),this.context.scale(this.workspaceZoom,this.workspaceZoom),this.context.translate(-e,-t)}for(let e=0;e<this.layers.length;e++){let t=this.layers[e];if(t.visible){t.element.style.visibility="visible",this.context.beginPath(),this.selectedLayers.includes(t)?this.context.strokeStyle="red":t===this.hoveringLayer?this.context.strokeStyle="red":this.context.strokeStyle="white",this.context.moveTo(t.targetPoints[0][0],t.targetPoints[0][1]);for(let i=0;i<t.targetPoints.length;i++)this.context.lineTo(t.targetPoints[i][0],t.targetPoints[i][1]);this.context.lineTo(t.targetPoints[3][0],t.targetPoints[3][1]),this.context.closePath(),this.context.stroke();let s=[0,0];for(let i=0;i<t.targetPoints.length;i++)t.targetPoints[i]===this.hoveringPoint?this.context.strokeStyle="red":t.targetPoints[i]===this.selectedPoint?this.context.strokeStyle="red":this.context.strokeStyle="white",s[0]+=t.targetPoints[i][0],s[1]+=t.targetPoints[i][1],this.context.beginPath(),this.context.arc(t.targetPoints[i][0],t.targetPoints[i][1],this.selectionRadius/2,0,2*Math.PI,!1),this.context.stroke();if(s[0]/=4,s[1]/=4,this.showLayerNames){let i=t.element.id.toUpperCase();this.context.font="16px sans-serif",this.context.textAlign="center";let a=this.context.measureText(i),n=[a.width+8,32];this.context.fillStyle="white";let h=window.innerHeight*.01,d=s[0],y=s[1];(t.width<a.width+10||t.height<20)&&(y=s[1]-t.height/2-10-h,y-n[1]/2<h&&(y=s[1]+t.height/2+20+h)),this.context.fillRect(d-n[0]/2,y-n[1]/2,n[0],n[1]),this.context.fillStyle="black",this.context.font="14px sans-serif",this.context.fillText(i,d,y)}}else t.element.style.visibility="hidden"}if(this.showCrosshairs&&(this.context.strokeStyle="yellow",this.context.lineWidth=1,this.context.beginPath(),this.context.moveTo(this.mousePosition[0],0),this.context.lineTo(this.mousePosition[0],this.canvas.height),this.context.moveTo(0,this.mousePosition[1]),this.context.lineTo(this.canvas.width,this.mousePosition[1]),this.context.stroke()),this.showScreenBounds){this.context.fillStyle="black",this.context.lineWidth=4,this.context.fillRect(0,0,this.canvas.width,this.canvas.height),this.context.strokeStyle="#909090",this.context.beginPath();let e=this.canvas.width/10,t=this.canvas.height/10;for(let i=0;i<10;i++)this.context.moveTo(i*e,0),this.context.lineTo(i*e,this.canvas.height),this.context.moveTo(0,i*t),this.context.lineTo(this.canvas.width,i*t);this.context.stroke(),this.context.strokeStyle="white",this.context.strokeRect(2,2,this.canvas.width-4,this.canvas.height-4);let s=Math.round(t*.6);this.context.font=`${s}px mono, sans-serif`,this.context.fillRect(e*2+2,t*3+2,this.canvas.width-e*4-4,this.canvas.height-t*6-4),this.context.fillStyle="white",this.context.font="20px sans-serif",this.context.fillText(`${this.canvas.width} x ${this.canvas.height}`,this.canvas.width/2,this.canvas.height/2+s*.75),this.context.fillText("Display size",this.canvas.width/2,this.canvas.height/2-s*.75)}if(this.rubberBandActive){let e=Math.min(this.rubberBandStart[0],this.rubberBandEnd[0]),t=Math.min(this.rubberBandStart[1],this.rubberBandEnd[1]),s=Math.abs(this.rubberBandEnd[0]-this.rubberBandStart[0]),i=Math.abs(this.rubberBandEnd[1]-this.rubberBandStart[1]);this.context.strokeStyle="rgba(51, 153, 255, 0.8)",this.context.fillStyle="rgba(51, 153, 255, 0.1)",this.context.lineWidth=1,this.context.fillRect(e,t,s,i),this.context.strokeRect(e,t,s,i)}this.workspaceZoom!==1&&this.context.restore(),this.onAfterDraw&&this.onAfterDraw()}}snapLayerToEdges(e){if(!this.snapEnabled)return;let t=this.SNAP_THRESHOLD,s=1/0,i=1/0,a=-1/0,n=-1/0;for(let f of e.targetPoints)f[0]<s&&(s=f[0]),f[1]<i&&(i=f[1]),f[0]>a&&(a=f[0]),f[1]>n&&(n=f[1]);let h=0,d=0,y=!1,m=!1;Math.abs(s)<t?(h=-s,y=!0):Math.abs(a-window.innerWidth)<t&&(h=window.innerWidth-a,y=!0),Math.abs(i)<t?(d=-i,m=!0):Math.abs(n-window.innerHeight)<t&&(d=window.innerHeight-n,m=!0);for(let f of this.layers){if(f===e||!f.visible)continue;let b=1/0,E=1/0,T=-1/0,I=-1/0;for(let S of f.targetPoints)S[0]<b&&(b=S[0]),S[1]<E&&(E=S[1]),S[0]>T&&(T=S[0]),S[1]>I&&(I=S[1]);if(y||(Math.abs(a-b)<t?(h=b-a,y=!0):Math.abs(s-T)<t?(h=T-s,y=!0):Math.abs(s-b)<t?(h=b-s,y=!0):Math.abs(a-T)<t&&(h=T-a,y=!0)),m||(Math.abs(n-E)<t?(d=E-n,m=!0):Math.abs(i-I)<t?(d=I-i,m=!0):Math.abs(i-E)<t?(d=E-i,m=!0):Math.abs(n-I)<t&&(d=I-n,m=!0)),y&&m)break}if(h!==0||d!==0)for(let f of e.targetPoints)f[0]+=h,f[1]+=d}toWorkspace(e,t){if(this.workspaceZoom===1)return[e,t];let s=window.innerWidth/2,i=window.innerHeight/2;return[(e-s)/this.workspaceZoom+s,(t-i)/this.workspaceZoom+i]}setWorkspaceZoom(e){this.workspaceZoom=Math.max(.1,Math.min(1,e)),this.draw()}mouseMove(e){if(!this.configActive)return;(this.dragging||this.rubberBandActive)&&e.preventDefault();let[t,s]=this.toWorkspace(e.clientX,e.clientY);if(this.mouseDelta[0]=t-this.mousePosition[0],this.mouseDelta[1]=s-this.mousePosition[1],this.mousePosition[0]=t,this.mousePosition[1]=s,this.rubberBandActive){this.rubberBandEnd=[t,s];let i=[];for(let n of this.layers)n.visible&&this.layerIntersectsRect(n,this.rubberBandStart[0],this.rubberBandStart[1],this.rubberBandEnd[0],this.rubberBandEnd[1])&&i.push(n);let a=[...this.rubberBandBaseSelection];for(let n of i)a.includes(n)||a.push(n);this.selectedLayers=a,this.selectedLayer=this.selectedLayers[this.selectedLayers.length-1]||null,this.draw();return}if(this.dragging){let i=e.shiftKey?.1:1;if(this.selectedPoint)e.shiftKey?this.scaleLayer(this.selectedLayer,1+this.mouseDelta[0]*.01):(this.selectedPoint[0]+=this.mouseDelta[0]*i,this.selectedPoint[1]+=this.mouseDelta[1]*i);else if(this.selectedLayers.length>0)if(e.altKey&&this.selectedLayer)this.rotateLayer(this.selectedLayer,this.mouseDelta[0]*(.01*i));else{for(let a of this.selectedLayers)for(let n=0;n<a.targetPoints.length;n++)a.targetPoints[n][0]+=this.mouseDelta[0]*i,a.targetPoints[n][1]+=this.mouseDelta[1]*i;this.selectedLayer&&this.snapLayerToEdges(this.selectedLayer)}this.updateTransform(),this.autoSave&&this.saveSettings(),this.draw(),this.layoutChangeListener();return}this.canvas.style.cursor="default",this.hoveringPoint=null,this.hoveringLayer=null;for(let i=this.layers.length-1;i>=0;i--){let a=this.layers[i];if(a.visible){for(let n=0;n<a.targetPoints.length;n++){let h=a.targetPoints[n];if(we(h[0],h[1],this.mousePosition[0],this.mousePosition[1])<this.selectionRadius){this.hoveringPoint=h,this.hoveringLayer=a,this.canvas.style.cursor="pointer";break}}if(this.hoveringPoint)break}}if(!this.hoveringPoint)for(let i=this.layers.length-1;i>=0;i--){let a=this.layers[i];if(a.visible&&this.pointInLayer(this.mousePosition,a)){this.hoveringLayer=a,this.canvas.style.cursor="pointer";break}}this.draw()}mouseDown(e){if(!this.configActive||e.button===2)return;let[t,s]=this.toWorkspace(e.clientX,e.clientY);this.mouseDownPoint=[t,s],this.selectedPoint=null,this.rubberBandActive=!1;let i=null,a=null;for(let n=this.layers.length-1;n>=0;n--){let h=this.layers[n];if(h.visible){for(let d=0;d<h.targetPoints.length;d++){let y=h.targetPoints[d];if(we(y[0],y[1],t,s)<this.selectionRadius){a=y,i=h;break}}if(i)break}}if(!i)for(let n=this.layers.length-1;n>=0;n--){let h=this.layers[n];if(h.visible&&this.pointInLayer([t,s],h)){i=h;break}}if(a)this.selectedPoint=a,this.selectedLayer=i,this.selectedLayers=[i],this.dragging=!0;else if(i)if(e.ctrlKey){let n=this.selectedLayers.indexOf(i);n>=0?(this.selectedLayers.splice(n,1),this.selectedLayer=this.selectedLayers[this.selectedLayers.length-1]||null):(this.selectedLayers.push(i),this.selectedLayer=i),this.dragging=this.selectedLayers.length>0}else this.selectedLayers.includes(i)?this.selectedLayer=i:(this.selectedLayers=[i],this.selectedLayer=i),this.dragging=!0;else this.selectedLayer=null,this.rubberBandBaseSelection=e.ctrlKey?[...this.selectedLayers]:[],e.ctrlKey||(this.selectedLayers=[]),this.rubberBandActive=!0,this.rubberBandStart=[t,s],this.rubberBandEnd=[t,s],this.dragging=!1;this.draw()}mouseUp(e){if(this.configActive){if(this.rubberBandActive){this.rubberBandActive=!1,this.draw();return}this.dragging&&(this.pushHistory(),this.autoSave&&this.saveSettings()),this.dragging=!1,this.selectedPoint=null}}keyDown(e){if(!this.configActive)if(e.keyCode==32&&e.shiftKey){this.setConfigEnabled(!0);return}else return;var t=e.keyCode,s=e.shiftKey?10:1,i=!1,a=[0,0];switch(console.log(t),t){case 32:if(e.shiftKey){this.setConfigEnabled(!1);return}break;case 37:a[0]-=s;break;case 38:a[1]-=s;break;case 39:a[0]+=s;break;case 40:a[1]+=s;break;case 67:this.showCrosshairs=!this.showCrosshairs,i=!0;break;case 76:if(!this.configActive)return;this.showLayerNames=!this.showLayerNames,i=!0;break;case 83:if(this.isLayerSoloed){for(var n=0;n<this.layers.length;n++)this.layers[n].visible=!0;this.isLayerSoloed=!1,i=!0}else if(this.selectedLayers.length>0){for(var n=0;n<this.layers.length;n++)this.layers[n].visible=!1;for(let h of this.selectedLayers)h.visible=!0;i=!0,this.isLayerSoloed=!0}break;case 71:this.snapEnabled=!this.snapEnabled,this.onSnapChanged&&this.onSnapChanged(this.snapEnabled);break;case 66:this.showScreenBounds=!this.showScreenBounds,this.draw();break;case 72:this.selectedLayer&&(this.swapLayerPoints(this.selectedLayer.sourcePoints,0,1),this.swapLayerPoints(this.selectedLayer.sourcePoints,3,2),this.updateTransform(),this.draw());break;case 86:this.selectedLayer&&(this.swapLayerPoints(this.selectedLayer.sourcePoints,0,3),this.swapLayerPoints(this.selectedLayer.sourcePoints,1,2),this.updateTransform(),this.draw());break;case 82:this.selectedLayer&&(this.rotateLayer(this.selectedLayer,Math.PI/2),this.updateTransform(),this.draw());break;case 90:if(e.ctrlKey){e.preventDefault(),this.undo();return}break;case 89:if(e.ctrlKey){e.preventDefault(),this.redo();return}break;case 46:case 8:if(this.selectedLayers.length>0){for(let h of[...this.selectedLayers]){h.element.remove(),h.overlay&&h.overlay.remove();let d=this.layers.indexOf(h);d>=0&&this.layers.splice(d,1)}this.selectedLayers=[],this.selectedLayer=null,i=!0,this.updateTransform(),this.draw()}break}if(!this.showScreenBounds){if(this.selectedPoint)this.selectedPoint[0]+=a[0],this.selectedPoint[1]+=a[1],i=!0;else if(this.selectedLayers.length>0){if(e.altKey==!0&&this.selectedLayer)this.rotateLayer(this.selectedLayer,a[0]*.01),this.scaleLayer(this.selectedLayer,a[1]*-.005+1);else for(let h of this.selectedLayers)for(var n=0;n<h.targetPoints.length;n++)h.targetPoints[n][0]+=a[0],h.targetPoints[n][1]+=a[1];i=!0}}i&&(this.updateTransform(),this.draw(),this.autoSave&&this.saveSettings(),this.pushHistory(),this.layoutChangeListener())}};nt();var lt=new ue({layers:[]});rt(lt);lt.setConfigEnabled(!0);window.MLMap=ue;})();
