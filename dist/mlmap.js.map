{
  "version": 3,
  "sources": ["../src/lib/data.ts", "../src/utils/remote.ts", "../src/events/listeners.ts", "../src/events/index.ts", "../src/main.ts", "../src/utils/basics.ts", "../src/utils/storage.ts", "../src/uiControls/index.ts", "../src/channel/protocol.ts", "../src/channel/index.ts", "../src/video/sources.ts", "../src/video/playlist.ts", "../src/uiControls/videoPanel.ts", "../src/utils/workflow.ts", "../src/video/clipMaskRenderer.ts"],
  "sourcesContent": ["// ------------------- Global variables -------------------\r\nexport const VERSION = \"0.1.0.1\";\r\nexport let historyStack: string[] = [];\r\nexport let redoStack: string[] = [];\r\nexport const historyLimit = 50;\r\nexport const DISPLAY_URL = \"display.html\";", "import { VERSION } from \"../lib/data\";\r\n\r\nexport async function checkLatestVersion(): Promise<{ current: string; latest: string; requireUpdate: boolean; }> {\r\n    const CACHE_KEY = \"mlmap:cache:checkLatestVersion\";\r\n    const CACHE_DURATION = 5 * 60 * 1000;\r\n    const now = Date.now();\r\n    const cachedString = localStorage.getItem(CACHE_KEY);\r\n    let cachedData: { latest: string; timestamp: number; } | null = null;\r\n    if (cachedString) try { cachedData = JSON.parse(cachedString); } catch { };\r\n    \r\n    if (cachedData && (now - cachedData.timestamp < CACHE_DURATION)) return { current: VERSION, latest: cachedData.latest, requireUpdate: cachedData.latest !== VERSION };\r\n\r\n    const controller = new AbortController();\r\n    const timeout = 5000;\r\n    const timeoutId = setTimeout(() => controller.abort(), timeout);\r\n\r\n    try {\r\n        const response = await fetch(\"https://raw.githubusercontent.com/FJRG2007/mlmap/refs/heads/main/package.json\", { signal: controller.signal });\r\n        clearTimeout(timeoutId);\r\n        const data = await response.json();\r\n\r\n        cachedData = { latest: data.version, timestamp: now };\r\n        localStorage.setItem(CACHE_KEY, JSON.stringify(cachedData));\r\n\r\n        return { current: VERSION, latest: data.version, requireUpdate: data.version !== VERSION };\r\n    } catch {\r\n        return { current: VERSION, latest: cachedData?.latest || VERSION, requireUpdate: false };\r\n    };\r\n};", "import { checkLatestVersion } from \"../utils/remote\";\r\n\r\ndocument.addEventListener(\"DOMContentLoaded\", async () => {\r\n    const versionInfo = await checkLatestVersion();\r\n    console.log(`Current version: ${versionInfo.current}`);\r\n    console.log(`Latest version: ${versionInfo.latest}`);\r\n    if (versionInfo.requireUpdate) console.log(\"A new version is available!\");\r\n});", "import \"./listeners\";", "import \"./events\";\r\nimport * as Types from \"./types\";\r\nimport * as utils from \"./utils/basics\";\r\nimport * as storage from \"./utils/storage\";\r\nimport { initUIControls } from \"./uiControls\";\r\nimport { historyStack, historyLimit, redoStack } from \"./lib/data\";\r\nimport { checkUrlForWorkflow } from \"./utils/workflow\";\r\n\r\nexport class MLMap {\r\n    private showLayerNames: boolean;\r\n    private showCrosshairs: boolean;\r\n    private showScreenBounds: boolean;\r\n    private autoSave: boolean;\r\n    private autoLoad: boolean;\r\n    private layerList: (HTMLElement | string)[];\r\n    public layoutChangeListener: () => void;\r\n    public onAfterDraw: (() => void) | null = null;\r\n\r\n    private canvas: HTMLCanvasElement;\r\n    private context: CanvasRenderingContext2D;\r\n\r\n    private layers: Types.Layer[] = [];\r\n    private configActive = false;\r\n\r\n    private dragging = false;\r\n    private dragOffset: [number, number] = [0, 0];\r\n\r\n    private selectedLayer: Types.Layer | null = null;\r\n    private selectedLayers: Types.Layer[] = [];\r\n    private selectedPoint: number[] | null = null;\r\n    private selectionRadius = 20;\r\n    private hoveringPoint: number[] | null = null;\r\n    private hoveringLayer: Types.Layer | null = null;\r\n    private isLayerSoloed = false;\r\n    public snapEnabled = true;\r\n    public onSnapChanged: ((enabled: boolean) => void) | null = null;\r\n    public outputFrame: { x: number; y: number; w: number; h: number; resW: number; resH: number } | null = null;\r\n    public onSpaceBar: (() => void) | null = null;\r\n    private readonly SNAP_THRESHOLD = 12;\r\n    public workspaceZoom = 1;\r\n\r\n    // Rubber band selection state\r\n    private rubberBandActive = false;\r\n    private rubberBandStart: [number, number] = [0, 0];\r\n    private rubberBandEnd: [number, number] = [0, 0];\r\n    private rubberBandBaseSelection: Types.Layer[] = [];\r\n\r\n    private mousePosition: [number, number] = [0, 0];\r\n    private mouseDelta: [number, number] = [0, 0];\r\n    private mouseDownPoint: [number, number] = [0, 0];\r\n\r\n    constructor(config: Types.MLMapConfig = {}) {\r\n        this.keyDown = this.keyDown.bind(this);\r\n        this.setConfigEnabled = this.setConfigEnabled.bind(this);\r\n        this.showLayerNames = this.getProp(config, \"labels\", true);\r\n        this.showCrosshairs = this.getProp(config, \"crosshairs\", false);\r\n        this.showScreenBounds = this.getProp(config, \"screenbounds\", false);\r\n        this.autoSave = this.getProp(config, \"autoSave\", true);\r\n        this.autoLoad = this.getProp(config, \"autoLoad\", true);\r\n        this.layerList = this.getProp(config, \"layers\", []);\r\n        this.layoutChangeListener = this.getProp(config, \"onchange\", () => { });\r\n\r\n        this.canvas = document.createElement(\"canvas\");\r\n        this.context = this.canvas.getContext(\"2d\")!;\r\n\r\n        this.initCanvas();\r\n        this.loadSettings();\r\n\r\n        for (let item of this.layerList) {\r\n            if (item instanceof HTMLElement || typeof item === \"string\") this.addLayer(item);\r\n        }\r\n\r\n        if (this.autoLoad) this.loadSettings();\r\n        this.pushHistory();\r\n\r\n        const observer = new MutationObserver((mutationsList) => {\r\n            mutationsList.forEach((mutation) => {\r\n                mutation.removedNodes.forEach((node) => {\r\n                    // Skip nodes that were just moved (appendChild re-appends)\r\n                    if ((node as Element).isConnected) return;\r\n                    this.layers.forEach((layer, i) => {\r\n                        if (layer.element === node) {\r\n                            if (layer.overlay) layer.overlay.remove();\r\n                            this.layers.splice(i, 1);\r\n                        }\r\n                    });\r\n                });\r\n            });\r\n        });\r\n        observer.observe(document.body, { childList: true, subtree: true });\r\n    };\r\n\r\n    // ---------------- Internal Methods ----------------\r\n    private getProp(cfg: any, key: string, defaultVal: any) {\r\n        return cfg && cfg.hasOwnProperty(key) && cfg[key] !== null ? cfg[key] : defaultVal;\r\n    };\r\n\r\n    private initCanvas() {\r\n        this.canvas.style.display = \"none\";\r\n        this.canvas.style.position = \"fixed\";\r\n        this.canvas.style.top = \"0px\";\r\n        this.canvas.style.left = \"0px\";\r\n        this.canvas.style.zIndex = \"1000000\";\r\n\r\n        this.context = this.canvas.getContext(\"2d\")!;\r\n        document.body.appendChild(this.canvas);\r\n\r\n        window.addEventListener(\"resize\", this.resize.bind(this));\r\n        window.addEventListener(\"mousemove\", this.mouseMove.bind(this));\r\n        window.addEventListener(\"mouseup\", this.mouseUp.bind(this));\r\n        window.addEventListener(\"mousedown\", this.mouseDown.bind(this));\r\n        window.addEventListener(\"keydown\", this.keyDown.bind(this));\r\n\r\n        this.resize();\r\n    };\r\n\r\n    private pushHistory() {\r\n        const snapshot = this.getLayout();\r\n        historyStack.push(JSON.stringify(snapshot));\r\n        if (historyStack.length > historyLimit) historyStack.shift();\r\n        redoStack.length = 0;\r\n    };\r\n\r\n    private saveSettings() {\r\n        const data = storage.loadWorkspace()!;\r\n        storage.saveWorkspace({\r\n            id: data?.id,\r\n            name: data?.name,\r\n            version: data?.version,\r\n            layout: this.getLayout()\r\n        });\r\n    };\r\n\r\n    private loadSettings() {\r\n        try {\r\n            const data = storage.loadWorkspace();\r\n            if (data?.version === \"1.0\" && data?.layout) this.setLayout(data.layout);\r\n            else console.warn(\"MLMap: localStorage version mismatch, skipping load.\");\r\n        } catch (e) {\r\n            console.error(\"MLMap: Failed to parse layout from localStorage.\", e);\r\n        }\r\n    };\r\n\r\n    private resize() {\r\n        this.canvas.width = window.innerWidth;\r\n        this.canvas.height = window.innerHeight;\r\n        this.draw();\r\n    };\r\n\r\n    private pointInTriangle(p: Types.Point, a: Types.Point, b: Types.Point, c: Types.Point) {\r\n        let s = a[1] * c[0] - a[0] * c[1] + (c[1] - a[1]) * p[0] + (a[0] - c[0]) * p[1];\r\n        let t = a[0] * b[1] - a[1] * b[0] + (a[1] - b[1]) * p[0] + (b[0] - a[0]) * p[1];\r\n        if ((s < 0) !== (t < 0)) return false;\r\n        let A = -b[1] * c[0] + a[1] * (c[0] - b[0]) + a[0] * (b[1] - c[1]) + b[0] * c[1];\r\n        if (A < 0) { s = -s; t = -t; A = -A; }\r\n        return s > 0 && t > 0 && (s + t) < A;\r\n    };\r\n\r\n    private pointInLayer(point: Types.Point, layer: Types.Layer) {\r\n        const [a, b, c, d] = layer.targetPoints;\r\n        return this.pointInTriangle(point, a, b, c) || this.pointInTriangle(point, d, a, c);\r\n    };\r\n\r\n    private updateTransform() {\r\n        const prefixes = [\"\", \"-webkit-\", \"-moz-\", \"-ms-\", \"-o-\"];\r\n        let transformProp = \"transform\";\r\n        for (const pre of prefixes) {\r\n            const candidate = pre + \"transform\";\r\n            if (candidate in (document.body.style as any)) { transformProp = candidate; break; }\r\n        }\r\n\r\n        for (let l = 0; l < this.layers.length; l++) {\r\n            const a: number[][] = [];\r\n            const b: number[] = [];\r\n            for (let i = 0, n = this.layers[l].sourcePoints.length; i < n; ++i) {\r\n                const s = this.layers[l].sourcePoints[i];\r\n                const t = this.layers[l].targetPoints[i];\r\n                a.push([s[0], s[1], 1, 0, 0, 0, -s[0] * t[0], -s[1] * t[0]]);\r\n                b.push(t[0]);\r\n                a.push([0, 0, 0, s[0], s[1], 1, -s[0] * t[1], -s[1] * t[1]]);\r\n                b.push(t[1]);\r\n            }\r\n\r\n            const X = utils.solve(a, b, true);\r\n            const matrix = [\r\n                X[0], X[3], 0, X[6],\r\n                X[1], X[4], 0, X[7],\r\n                0, 0, 1, 0,\r\n                X[2], X[5], 0, 1\r\n            ];\r\n\r\n            const style = this.layers[l].element.style;\r\n            style.setProperty(transformProp, `matrix3d(${matrix.join(\",\")})`);\r\n            style.setProperty(`${transformProp}-origin`, \"0px 0px 0px\");\r\n        }\r\n    };\r\n\r\n    private rotateLayer(layer: Types.Layer, angle: number) {\r\n        var s = Math.sin(angle);\r\n        var c = Math.cos(angle);\r\n\r\n        var centerPoint = [0, 0];\r\n        for (var p = 0; p < layer.targetPoints.length; p++) {\r\n            centerPoint[0] += layer.targetPoints[p][0];\r\n            centerPoint[1] += layer.targetPoints[p][1];\r\n        }\r\n\r\n        centerPoint[0] /= 4;\r\n        centerPoint[1] /= 4;\r\n\r\n        for (var p = 0; p < layer.targetPoints.length; p++) {\r\n            var px = layer.targetPoints[p][0] - centerPoint[0];\r\n            var py = layer.targetPoints[p][1] - centerPoint[1];\r\n\r\n            layer.targetPoints[p][0] = (px * c) - (py * s) + centerPoint[0];\r\n            layer.targetPoints[p][1] = (px * s) + (py * c) + centerPoint[1];\r\n        }\r\n    };\r\n\r\n    private scaleLayer(layer: Types.Layer, scale: number) {\r\n        var centerPoint = [0, 0];\r\n        for (var p = 0; p < layer.targetPoints.length; p++) {\r\n            centerPoint[0] += layer.targetPoints[p][0];\r\n            centerPoint[1] += layer.targetPoints[p][1];\r\n        }\r\n\r\n        centerPoint[0] /= 4;\r\n        centerPoint[1] /= 4;\r\n\r\n        for (var p = 0; p < layer.targetPoints.length; p++) {\r\n            var px = layer.targetPoints[p][0] - centerPoint[0];\r\n            var py = layer.targetPoints[p][1] - centerPoint[1];\r\n\r\n            layer.targetPoints[p][0] = (px * scale) + centerPoint[0];\r\n            layer.targetPoints[p][1] = (py * scale) + centerPoint[1];\r\n        }\r\n    };\r\n\r\n    private undo() {\r\n        if (historyStack.length > 1) {\r\n            redoStack.push(historyStack.pop()!);\r\n            var last = JSON.parse(historyStack[historyStack.length - 1]);\r\n            this.setLayout(last);\r\n            this.draw();\r\n            if (this.autoSave) this.saveSettings();\r\n            this.layoutChangeListener();\r\n        }\r\n    };\r\n\r\n    private redo() {\r\n        if (redoStack.length > 0) {\r\n            const state = redoStack.pop()!;\r\n            historyStack.push(state);\r\n            this.setLayout(JSON.parse(state));\r\n            this.draw();\r\n            if (this.autoSave) this.saveSettings();\r\n            this.layoutChangeListener();\r\n        }\r\n    };\r\n\r\n    private swapLayerPoints(layerPoints: Types.Point[], index1: number, index2: number) {\r\n        var tx = layerPoints[index1][0];\r\n        var ty = layerPoints[index1][1];\r\n        layerPoints[index1][0] = layerPoints[index2][0];\r\n        layerPoints[index1][1] = layerPoints[index2][1];\r\n        layerPoints[index2][0] = tx;\r\n        layerPoints[index2][1] = ty;\r\n    };\r\n\r\n    // ---------------- Public API ----------------\r\n    public addLayer(target: HTMLElement | string, targetPoints?: number[][]) {\r\n        let element: HTMLElement | null = null;\r\n\r\n        if (typeof target === \"string\") {\r\n            element = document.getElementById(target);\r\n            if (!element) throw new Error(\"MLMap: No element found with id: \" + target);\r\n        } else if (target instanceof HTMLElement) element = target;\r\n        else throw new Error(\"MLMap: Invalid target\");\r\n\r\n        // Check if layer exists.\r\n        for (let n = 0; n < this.layers.length; n++) {\r\n            if (this.layers[n].element.id === element.id) {\r\n                if (targetPoints) this.layers[n].targetPoints = utils.clonePoints(targetPoints);\r\n                return;\r\n            }\r\n        }\r\n\r\n        element.style.position = \"fixed\";\r\n        element.style.display = \"block\";\r\n        element.style.top = \"0px\";\r\n        element.style.left = \"0px\";\r\n        element.style.padding = \"0px\";\r\n        element.style.margin = \"0px\";\r\n\r\n        const layer: Types.Layer = {\r\n            visible: true,\r\n            element,\r\n            width: element.clientWidth,\r\n            height: element.clientHeight,\r\n            sourcePoints: [\r\n                [0, 0],\r\n                [element.clientWidth, 0],\r\n                [element.clientWidth, element.clientHeight],\r\n                [0, element.clientHeight]\r\n            ],\r\n            targetPoints: []\r\n        };\r\n\r\n        if (targetPoints) layer.targetPoints = utils.clonePoints(targetPoints);\r\n        else {\r\n            const [x, y] = utils.getFreePosition(layer.width, layer.height, this.layers);\r\n            layer.targetPoints = [\r\n                [x, y],\r\n                [x + layer.width, y],\r\n                [x + layer.width, y + layer.height],\r\n                [x, y + layer.height]\r\n            ];\r\n        }\r\n\r\n        this.layers.push(layer);\r\n        // Ensure new layer is visually on top (DOM z-stacking follows DOM order)\r\n        element.parentElement?.appendChild(element);\r\n        this.updateTransform();\r\n    };\r\n\r\n    public removeLayer(target: HTMLElement | string) {\r\n        const element = typeof target === \"string\" ? document.getElementById(target) : target;\r\n        if (!element) return;\r\n\r\n        for (let i = this.layers.length - 1; i >= 0; i--) {\r\n            if (this.layers[i].element === element) {\r\n                if (this.layers[i].overlay) this.layers[i].overlay?.remove();\r\n                this.layers.splice(i, 1);\r\n            }\r\n        }\r\n        this.updateTransform();\r\n    };\r\n\r\n    public setLayout(layout: any) {\r\n        for (var i = 0; i < layout.length; i++) {\r\n            var exists = false;\r\n            for (var n = 0; n < this.layers.length; n++) {\r\n                if (this.layers[n].element.id == layout[i].id) {\r\n                    console.log(\"Setting points.\");\r\n                    this.layers[n].targetPoints = utils.clonePoints(layout[i].targetPoints);\r\n                    this.layers[n].sourcePoints = utils.clonePoints(layout[i].sourcePoints);\r\n                    exists = true;\r\n                }\r\n            }\r\n\r\n            if (!exists) {\r\n                var element = document.getElementById(layout[i].id);\r\n                if (element) this.addLayer(element, layout[i].targetPoints);\r\n                else console.log(`MLMap: Can\"t find element: ` + layout[i].id);\r\n            } else console.log(`MLMap: Element \"\" + layout[i].id + \"\" is already mapped.`);\r\n        }\r\n        this.updateTransform();\r\n        this.draw();\r\n    };\r\n\r\n    public getLayout() {\r\n        var layout = [];\r\n        for (var i = 0; i < this.layers.length; i++) {\r\n            layout.push({\r\n                \"id\": this.layers[i].element.id,\r\n                \"targetPoints\": utils.clonePoints(this.layers[i].targetPoints),\r\n                \"sourcePoints\": utils.clonePoints(this.layers[i].sourcePoints)\r\n            });\r\n        }\r\n        return layout;\r\n    };\r\n\r\n    public setConfigEnabled(enabled: boolean) {\r\n        this.configActive = enabled;\r\n        this.canvas.style.display = enabled ? \"block\" : \"none\";\r\n\r\n        if (!enabled) {\r\n            this.selectedPoint = null;\r\n            this.selectedLayer = null;\r\n            this.selectedLayers = [];\r\n            this.dragging = false;\r\n            this.rubberBandActive = false;\r\n            this.showScreenBounds = false;\r\n        } else this.draw();\r\n    };\r\n\r\n    // ---- Context menu helpers ----\r\n    public getSelectedLayer(): Types.Layer | null { return this.selectedLayer; }\r\n    public getLayers(): Types.Layer[] { return this.layers; }\r\n\r\n    public getLayerAtPoint(x: number, y: number): Types.Layer | null {\r\n        const [wx, wy] = this.toWorkspace(x, y);\r\n        for (let i = this.layers.length - 1; i >= 0; i--) {\r\n            const layer = this.layers[i];\r\n            if (!layer.visible) continue;\r\n            if (this.pointInLayer([wx, wy], layer)) return layer;\r\n        }\r\n        return null;\r\n    }\r\n\r\n    public selectLayer(layer: Types.Layer | null): void {\r\n        this.selectedLayer = layer;\r\n        this.selectedLayers = layer ? [layer] : [];\r\n        this.selectedPoint = null;\r\n        this.draw();\r\n    }\r\n\r\n    public getSelectedLayers(): Types.Layer[] { return [...this.selectedLayers]; }\r\n\r\n    public centerLayer(layer: Types.Layer): void {\r\n        const cx = window.innerWidth / 2;\r\n        const cy = window.innerHeight / 2;\r\n        let lcx = 0, lcy = 0;\r\n        for (const p of layer.targetPoints) { lcx += p[0]; lcy += p[1]; }\r\n        lcx /= 4; lcy /= 4;\r\n        const dx = cx - lcx, dy = cy - lcy;\r\n        for (const p of layer.targetPoints) { p[0] += dx; p[1] += dy; }\r\n        this.updateTransform();\r\n        this.draw();\r\n        this.pushHistory();\r\n        if (this.autoSave) this.saveSettings();\r\n        this.layoutChangeListener();\r\n    }\r\n\r\n    public rotateLayerPublic(layer: Types.Layer, angleDeg: number): void {\r\n        this.rotateLayer(layer, (angleDeg * Math.PI) / 180);\r\n        this.updateTransform();\r\n        this.draw();\r\n        this.pushHistory();\r\n        if (this.autoSave) this.saveSettings();\r\n        this.layoutChangeListener();\r\n    }\r\n\r\n    public flipLayerH(layer: Types.Layer): void {\r\n        this.swapLayerPoints(layer.sourcePoints, 0, 1);\r\n        this.swapLayerPoints(layer.sourcePoints, 3, 2);\r\n        this.updateTransform();\r\n        this.draw();\r\n        this.pushHistory();\r\n        if (this.autoSave) this.saveSettings();\r\n        this.layoutChangeListener();\r\n    }\r\n\r\n    public flipLayerV(layer: Types.Layer): void {\r\n        this.swapLayerPoints(layer.sourcePoints, 0, 3);\r\n        this.swapLayerPoints(layer.sourcePoints, 1, 2);\r\n        this.updateTransform();\r\n        this.draw();\r\n        this.pushHistory();\r\n        if (this.autoSave) this.saveSettings();\r\n        this.layoutChangeListener();\r\n    }\r\n\r\n    public deleteSelectedLayer(layer: Types.Layer): void {\r\n        layer.element.remove();\r\n        if (layer.overlay) layer.overlay.remove();\r\n        const index = this.layers.indexOf(layer);\r\n        if (index >= 0) this.layers.splice(index, 1);\r\n        if (this.selectedLayer === layer) this.selectedLayer = null;\r\n        const selIdx = this.selectedLayers.indexOf(layer);\r\n        if (selIdx >= 0) this.selectedLayers.splice(selIdx, 1);\r\n        this.updateTransform();\r\n        this.draw();\r\n        this.pushHistory();\r\n        if (this.autoSave) this.saveSettings();\r\n        this.layoutChangeListener();\r\n    }\r\n\r\n    public scaleLayerPublic(layer: Types.Layer, scale: number): void {\r\n        this.scaleLayer(layer, scale);\r\n        this.updateTransform();\r\n        this.draw();\r\n        this.pushHistory();\r\n        if (this.autoSave) this.saveSettings();\r\n        this.layoutChangeListener();\r\n    }\r\n\r\n    // ---- Layer ordering ----\r\n    public moveLayerUp(layer: Types.Layer): void {\r\n        const idx = this.layers.indexOf(layer);\r\n        if (idx < 0 || idx >= this.layers.length - 1) return;\r\n        this.layers[idx] = this.layers[idx + 1];\r\n        this.layers[idx + 1] = layer;\r\n        this.reorderLayerDOM();\r\n        this.updateTransform();\r\n        this.draw();\r\n        this.pushHistory();\r\n        if (this.autoSave) this.saveSettings();\r\n        this.layoutChangeListener();\r\n    }\r\n\r\n    public moveLayerDown(layer: Types.Layer): void {\r\n        const idx = this.layers.indexOf(layer);\r\n        if (idx <= 0) return;\r\n        this.layers[idx] = this.layers[idx - 1];\r\n        this.layers[idx - 1] = layer;\r\n        this.reorderLayerDOM();\r\n        this.updateTransform();\r\n        this.draw();\r\n        this.pushHistory();\r\n        if (this.autoSave) this.saveSettings();\r\n        this.layoutChangeListener();\r\n    }\r\n\r\n    public moveLayerToTop(layer: Types.Layer): void {\r\n        const idx = this.layers.indexOf(layer);\r\n        if (idx < 0 || idx === this.layers.length - 1) return;\r\n        this.layers.splice(idx, 1);\r\n        this.layers.push(layer);\r\n        this.reorderLayerDOM();\r\n        this.updateTransform();\r\n        this.draw();\r\n        this.pushHistory();\r\n        if (this.autoSave) this.saveSettings();\r\n        this.layoutChangeListener();\r\n    }\r\n\r\n    public moveLayerToBottom(layer: Types.Layer): void {\r\n        const idx = this.layers.indexOf(layer);\r\n        if (idx <= 0) return;\r\n        this.layers.splice(idx, 1);\r\n        this.layers.unshift(layer);\r\n        this.reorderLayerDOM();\r\n        this.updateTransform();\r\n        this.draw();\r\n        this.pushHistory();\r\n        if (this.autoSave) this.saveSettings();\r\n        this.layoutChangeListener();\r\n    }\r\n\r\n    private reorderLayerDOM(): void {\r\n        for (const layer of this.layers) {\r\n            layer.element.parentElement?.appendChild(layer.element);\r\n        }\r\n    }\r\n\r\n    public stretchToFrame(layer: Types.Layer, frame: { x: number; y: number; w: number; h: number }): void {\r\n        layer.targetPoints = [\r\n            [frame.x, frame.y],\r\n            [frame.x + frame.w, frame.y],\r\n            [frame.x + frame.w, frame.y + frame.h],\r\n            [frame.x, frame.y + frame.h],\r\n        ];\r\n        layer.sourcePoints = [\r\n            [0, 0], [layer.width, 0],\r\n            [layer.width, layer.height], [0, layer.height],\r\n        ];\r\n        this.updateTransform();\r\n        this.draw();\r\n        this.pushHistory();\r\n        if (this.autoSave) this.saveSettings();\r\n        this.layoutChangeListener();\r\n    }\r\n\r\n    public fitToFrame(layer: Types.Layer, frame: { x: number; y: number; w: number; h: number }): void {\r\n        const layerAspect = layer.width / layer.height;\r\n        const frameAspect = frame.w / frame.h;\r\n        let fw: number, fh: number;\r\n        if (layerAspect > frameAspect) {\r\n            fw = frame.w;\r\n            fh = frame.w / layerAspect;\r\n        } else {\r\n            fh = frame.h;\r\n            fw = frame.h * layerAspect;\r\n        }\r\n        const fx = frame.x + (frame.w - fw) / 2;\r\n        const fy = frame.y + (frame.h - fh) / 2;\r\n        layer.targetPoints = [\r\n            [fx, fy], [fx + fw, fy],\r\n            [fx + fw, fy + fh], [fx, fy + fh],\r\n        ];\r\n        layer.sourcePoints = [\r\n            [0, 0], [layer.width, 0],\r\n            [layer.width, layer.height], [0, layer.height],\r\n        ];\r\n        this.updateTransform();\r\n        this.draw();\r\n        this.pushHistory();\r\n        if (this.autoSave) this.saveSettings();\r\n        this.layoutChangeListener();\r\n    }\r\n\r\n    public exportTemplate(width: number, height: number): HTMLCanvasElement {\r\n        const c = document.createElement(\"canvas\");\r\n        c.width = width;\r\n        c.height = height;\r\n        const ctx = c.getContext(\"2d\")!;\r\n\r\n        // Black background\r\n        ctx.fillStyle = \"#000\";\r\n        ctx.fillRect(0, 0, width, height);\r\n\r\n        // Scale from editor coordinates to output resolution\r\n        const frame = this.outputFrame;\r\n        let sx: number, sy: number, ox: number, oy: number;\r\n        if (frame && frame.w > 0 && frame.h > 0) {\r\n            sx = width / frame.w;\r\n            sy = height / frame.h;\r\n            ox = frame.x;\r\n            oy = frame.y;\r\n        } else {\r\n            sx = width / window.innerWidth;\r\n            sy = height / window.innerHeight;\r\n            ox = 0;\r\n            oy = 0;\r\n        }\r\n\r\n        ctx.lineWidth = 2;\r\n        for (const layer of this.layers) {\r\n            if (!layer.visible) continue;\r\n\r\n            // Draw layer outline\r\n            ctx.strokeStyle = \"white\";\r\n            ctx.beginPath();\r\n            const tp = layer.targetPoints;\r\n            ctx.moveTo((tp[0][0] - ox) * sx, (tp[0][1] - oy) * sy);\r\n            for (let p = 1; p < tp.length; p++) {\r\n                ctx.lineTo((tp[p][0] - ox) * sx, (tp[p][1] - oy) * sy);\r\n            }\r\n            ctx.closePath();\r\n            ctx.stroke();\r\n\r\n            // Draw label\r\n            let cx = 0, cy = 0;\r\n            for (const p of tp) { cx += (p[0] - ox) * sx; cy += (p[1] - oy) * sy; }\r\n            cx /= 4; cy /= 4;\r\n            const label = layer.element.id.toUpperCase();\r\n            ctx.font = `${Math.max(12, Math.round(16 * sx))}px sans-serif`;\r\n            ctx.textAlign = \"center\";\r\n            ctx.fillStyle = \"rgba(255,255,255,0.7)\";\r\n            ctx.fillText(label, cx, cy + 5);\r\n        }\r\n\r\n        // Draw border\r\n        ctx.strokeStyle = \"#b44dff\";\r\n        ctx.lineWidth = 3;\r\n        ctx.strokeRect(1, 1, width - 2, height - 2);\r\n\r\n        // Draw resolution label\r\n        ctx.font = \"14px sans-serif\";\r\n        ctx.fillStyle = \"#b44dff\";\r\n        ctx.textAlign = \"left\";\r\n        ctx.fillText(`${width}x${height}`, 8, 20);\r\n\r\n        return c;\r\n    }\r\n\r\n    public resetHistory(): void {\r\n        historyStack.length = 0;\r\n        redoStack.length = 0;\r\n        this.pushHistory();\r\n    }\r\n\r\n    public resetLayerTransform(layer: Types.Layer): void {\r\n        const cx = window.innerWidth / 2;\r\n        const cy = window.innerHeight / 2;\r\n        const hw = layer.width / 2, hh = layer.height / 2;\r\n        layer.targetPoints = [\r\n            [cx - hw, cy - hh], [cx + hw, cy - hh],\r\n            [cx + hw, cy + hh], [cx - hw, cy + hh]\r\n        ];\r\n        layer.sourcePoints = [\r\n            [0, 0], [layer.width, 0],\r\n            [layer.width, layer.height], [0, layer.height]\r\n        ];\r\n        this.updateTransform();\r\n        this.draw();\r\n        this.pushHistory();\r\n        if (this.autoSave) this.saveSettings();\r\n        this.layoutChangeListener();\r\n    }\r\n\r\n    // ---------------- Utils ----------------\r\n    private layerIntersectsRect(layer: Types.Layer, x1: number, y1: number, x2: number, y2: number): boolean {\r\n        const rx = Math.min(x1, x2), ry = Math.min(y1, y2);\r\n        const rx2 = Math.max(x1, x2), ry2 = Math.max(y1, y2);\r\n        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;\r\n        for (const p of layer.targetPoints) {\r\n            if (p[0] < minX) minX = p[0];\r\n            if (p[1] < minY) minY = p[1];\r\n            if (p[0] > maxX) maxX = p[0];\r\n            if (p[1] > maxY) maxY = p[1];\r\n        }\r\n        return !(maxX < rx || minX > rx2 || maxY < ry || minY > ry2);\r\n    }\r\n\r\n    private draw() {\r\n        if (!this.configActive) return;\r\n\r\n        this.context.strokeStyle = \"red\";\r\n        this.context.lineWidth = 2;\r\n        this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);\r\n\r\n        if (this.workspaceZoom !== 1) {\r\n            this.context.save();\r\n            const zCx = this.canvas.width / 2;\r\n            const zCy = this.canvas.height / 2;\r\n            this.context.translate(zCx, zCy);\r\n            this.context.scale(this.workspaceZoom, this.workspaceZoom);\r\n            this.context.translate(-zCx, -zCy);\r\n        }\r\n\r\n        for (let i = 0; i < this.layers.length; i++) {\r\n            const layer = this.layers[i];\r\n\r\n            if (layer.visible) {\r\n                layer.element.style.visibility = \"visible\";\r\n\r\n                // Draw layer rectangles.\r\n                this.context.beginPath();\r\n                if (this.selectedLayers.includes(layer)) this.context.strokeStyle = \"red\";\r\n                else if (layer === this.hoveringLayer) this.context.strokeStyle = \"red\";\r\n                else this.context.strokeStyle = \"white\";\r\n\r\n                this.context.moveTo(layer.targetPoints[0][0], layer.targetPoints[0][1]);\r\n                for (let p = 0; p < layer.targetPoints.length; p++) {\r\n                    this.context.lineTo(layer.targetPoints[p][0], layer.targetPoints[p][1]);\r\n                }\r\n                this.context.lineTo(layer.targetPoints[3][0], layer.targetPoints[3][1]);\r\n                this.context.closePath();\r\n                this.context.stroke();\r\n\r\n                // Draw corner points.\r\n                const centerPoint: [number, number] = [0, 0];\r\n                for (let p = 0; p < layer.targetPoints.length; p++) {\r\n                    if (layer.targetPoints[p] === this.hoveringPoint) this.context.strokeStyle = \"red\";\r\n                    else if (layer.targetPoints[p] === this.selectedPoint) this.context.strokeStyle = \"red\";\r\n                    else this.context.strokeStyle = \"white\";\r\n\r\n                    centerPoint[0] += layer.targetPoints[p][0];\r\n                    centerPoint[1] += layer.targetPoints[p][1];\r\n\r\n                    this.context.beginPath();\r\n                    this.context.arc(layer.targetPoints[p][0], layer.targetPoints[p][1], this.selectionRadius / 2, 0, 2 * Math.PI, false);\r\n                    this.context.stroke();\r\n                }\r\n\r\n                // Average corners.\r\n                centerPoint[0] /= 4;\r\n                centerPoint[1] /= 4;\r\n\r\n                if (this.showLayerNames) {\r\n                    const label = layer.element.id.toUpperCase();\r\n                    this.context.font = \"16px sans-serif\";\r\n                    this.context.textAlign = \"center\";\r\n                    const metrics = this.context.measureText(label);\r\n                    const size: [number, number] = [metrics.width + 8, 16 + 16];\r\n\r\n                    this.context.fillStyle = \"white\";\r\n\r\n                    const marginY = window.innerHeight * 0.01; // 1vh.\r\n                    let textX = centerPoint[0];\r\n                    let textY = centerPoint[1];\r\n\r\n                    if (layer.width < metrics.width + 10 || layer.height < 20) {\r\n                        textY = centerPoint[1] - layer.height / 2 - 10 - marginY;\r\n                        if (textY - size[1] / 2 < marginY) {\r\n                            textY = centerPoint[1] + layer.height / 2 + 20 + marginY;\r\n                        }\r\n                    }\r\n\r\n                    this.context.fillRect(textX - size[0] / 2, textY - size[1] / 2, size[0], size[1]);\r\n                    this.context.fillStyle = \"black\";\r\n                    this.context.font = \"14px sans-serif\";\r\n                    this.context.fillText(label, textX, textY);\r\n                }\r\n            } else layer.element.style.visibility = \"hidden\";\r\n        }\r\n\r\n        // Draw mouse crosshairs.\r\n        if (this.showCrosshairs) {\r\n            this.context.strokeStyle = \"yellow\";\r\n            this.context.lineWidth = 1;\r\n            this.context.beginPath();\r\n            this.context.moveTo(this.mousePosition[0], 0);\r\n            this.context.lineTo(this.mousePosition[0], this.canvas.height);\r\n            this.context.moveTo(0, this.mousePosition[1]);\r\n            this.context.lineTo(this.canvas.width, this.mousePosition[1]);\r\n            this.context.stroke();\r\n        }\r\n\r\n        if (this.showScreenBounds) {\r\n            this.context.fillStyle = \"black\";\r\n            this.context.lineWidth = 4;\r\n            this.context.fillRect(0, 0, this.canvas.width, this.canvas.height);\r\n\r\n            this.context.strokeStyle = \"#909090\";\r\n            this.context.beginPath();\r\n            const stepX = this.canvas.width / 10;\r\n            const stepY = this.canvas.height / 10;\r\n\r\n            for (let i = 0; i < 10; i++) {\r\n                this.context.moveTo(i * stepX, 0);\r\n                this.context.lineTo(i * stepX, this.canvas.height);\r\n                this.context.moveTo(0, i * stepY);\r\n                this.context.lineTo(this.canvas.width, i * stepY);\r\n            }\r\n            this.context.stroke();\r\n\r\n            this.context.strokeStyle = \"white\";\r\n            this.context.strokeRect(2, 2, this.canvas.width - 4, this.canvas.height - 4);\r\n\r\n            const fontSize = Math.round(stepY * 0.6);\r\n            this.context.font = `${fontSize}px mono, sans-serif`;\r\n            this.context.fillRect(stepX * 2 + 2, stepY * 3 + 2, this.canvas.width - stepX * 4 - 4, this.canvas.height - stepY * 6 - 4);\r\n            this.context.fillStyle = \"white\";\r\n            this.context.font = \"20px sans-serif\";\r\n            this.context.fillText(`${this.canvas.width} x ${this.canvas.height}`, this.canvas.width / 2, this.canvas.height / 2 + (fontSize * 0.75));\r\n            this.context.fillText(\"Display size\", this.canvas.width / 2, this.canvas.height / 2 - (fontSize * 0.75));\r\n        }\r\n\r\n        // Draw output resolution frame\r\n        if (this.outputFrame) {\r\n            const f = this.outputFrame;\r\n            this.context.save();\r\n            this.context.strokeStyle = \"#b44dff\";\r\n            this.context.lineWidth = 2;\r\n            this.context.setLineDash([8, 6]);\r\n            this.context.strokeRect(f.x, f.y, f.w, f.h);\r\n            this.context.setLineDash([]);\r\n            this.context.font = \"11px sans-serif\";\r\n            this.context.fillStyle = \"#b44dff\";\r\n            this.context.textAlign = \"left\";\r\n            this.context.fillText(`${f.resW}x${f.resH}`, f.x + 4, f.y - 4);\r\n            this.context.restore();\r\n        }\r\n\r\n        // Draw rubber band selection rectangle\r\n        if (this.rubberBandActive) {\r\n            const rx = Math.min(this.rubberBandStart[0], this.rubberBandEnd[0]);\r\n            const ry = Math.min(this.rubberBandStart[1], this.rubberBandEnd[1]);\r\n            const rw = Math.abs(this.rubberBandEnd[0] - this.rubberBandStart[0]);\r\n            const rh = Math.abs(this.rubberBandEnd[1] - this.rubberBandStart[1]);\r\n            this.context.strokeStyle = \"rgba(51, 153, 255, 0.8)\";\r\n            this.context.fillStyle = \"rgba(51, 153, 255, 0.1)\";\r\n            this.context.lineWidth = 1;\r\n            this.context.fillRect(rx, ry, rw, rh);\r\n            this.context.strokeRect(rx, ry, rw, rh);\r\n        }\r\n\r\n        if (this.workspaceZoom !== 1) {\r\n            this.context.restore();\r\n        }\r\n\r\n        if (this.onAfterDraw) this.onAfterDraw();\r\n    };\r\n\r\n    private snapLayerToEdges(layer: Types.Layer): void {\r\n        if (!this.snapEnabled) return;\r\n        const t = this.SNAP_THRESHOLD;\r\n\r\n        // Get bounding box of the moving layer\r\n        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;\r\n        for (const p of layer.targetPoints) {\r\n            if (p[0] < minX) minX = p[0];\r\n            if (p[1] < minY) minY = p[1];\r\n            if (p[0] > maxX) maxX = p[0];\r\n            if (p[1] > maxY) maxY = p[1];\r\n        }\r\n\r\n        let snapDx = 0, snapDy = 0;\r\n        let snappedX = false, snappedY = false;\r\n\r\n        // Snap to screen edges\r\n        if (Math.abs(minX) < t) { snapDx = -minX; snappedX = true; }\r\n        else if (Math.abs(maxX - window.innerWidth) < t) { snapDx = window.innerWidth - maxX; snappedX = true; }\r\n        if (Math.abs(minY) < t) { snapDy = -minY; snappedY = true; }\r\n        else if (Math.abs(maxY - window.innerHeight) < t) { snapDy = window.innerHeight - maxY; snappedY = true; }\r\n\r\n        // Snap to other layers' edges\r\n        for (const other of this.layers) {\r\n            if (other === layer || !other.visible) continue;\r\n            let oMinX = Infinity, oMinY = Infinity, oMaxX = -Infinity, oMaxY = -Infinity;\r\n            for (const p of other.targetPoints) {\r\n                if (p[0] < oMinX) oMinX = p[0];\r\n                if (p[1] < oMinY) oMinY = p[1];\r\n                if (p[0] > oMaxX) oMaxX = p[0];\r\n                if (p[1] > oMaxY) oMaxY = p[1];\r\n            }\r\n            // Snap right edge to left edge, left to right, etc\r\n            if (!snappedX) {\r\n                if (Math.abs(maxX - oMinX) < t) { snapDx = oMinX - maxX; snappedX = true; }\r\n                else if (Math.abs(minX - oMaxX) < t) { snapDx = oMaxX - minX; snappedX = true; }\r\n                else if (Math.abs(minX - oMinX) < t) { snapDx = oMinX - minX; snappedX = true; }\r\n                else if (Math.abs(maxX - oMaxX) < t) { snapDx = oMaxX - maxX; snappedX = true; }\r\n            }\r\n            if (!snappedY) {\r\n                if (Math.abs(maxY - oMinY) < t) { snapDy = oMinY - maxY; snappedY = true; }\r\n                else if (Math.abs(minY - oMaxY) < t) { snapDy = oMaxY - minY; snappedY = true; }\r\n                else if (Math.abs(minY - oMinY) < t) { snapDy = oMinY - minY; snappedY = true; }\r\n                else if (Math.abs(maxY - oMaxY) < t) { snapDy = oMaxY - maxY; snappedY = true; }\r\n            }\r\n            if (snappedX && snappedY) break;\r\n        }\r\n\r\n        if (snapDx !== 0 || snapDy !== 0) {\r\n            for (const p of layer.targetPoints) {\r\n                p[0] += snapDx;\r\n                p[1] += snapDy;\r\n            }\r\n        }\r\n    }\r\n\r\n    private toWorkspace(vx: number, vy: number): [number, number] {\r\n        if (this.workspaceZoom === 1) return [vx, vy];\r\n        const cx = window.innerWidth / 2;\r\n        const cy = window.innerHeight / 2;\r\n        return [\r\n            (vx - cx) / this.workspaceZoom + cx,\r\n            (vy - cy) / this.workspaceZoom + cy,\r\n        ];\r\n    }\r\n\r\n    public setWorkspaceZoom(zoom: number): void {\r\n        this.workspaceZoom = Math.max(0.1, Math.min(1, zoom));\r\n        this.draw();\r\n    }\r\n\r\n    private mouseMove(event: MouseEvent) {\r\n        if (!this.configActive) return;\r\n\r\n        if (this.dragging || this.rubberBandActive) event.preventDefault();\r\n\r\n        const [wx, wy] = this.toWorkspace(event.clientX, event.clientY);\r\n        this.mouseDelta[0] = wx - this.mousePosition[0];\r\n        this.mouseDelta[1] = wy - this.mousePosition[1];\r\n\r\n        this.mousePosition[0] = wx;\r\n        this.mousePosition[1] = wy;\r\n\r\n        // Rubber band selection\r\n        if (this.rubberBandActive) {\r\n            this.rubberBandEnd = [wx, wy];\r\n            const rbLayers: Types.Layer[] = [];\r\n            for (const layer of this.layers) {\r\n                if (!layer.visible) continue;\r\n                if (this.layerIntersectsRect(layer,\r\n                    this.rubberBandStart[0], this.rubberBandStart[1],\r\n                    this.rubberBandEnd[0], this.rubberBandEnd[1])) {\r\n                    rbLayers.push(layer);\r\n                }\r\n            }\r\n            // Merge with base selection (Ctrl held at start)\r\n            const merged = [...this.rubberBandBaseSelection];\r\n            for (const l of rbLayers) {\r\n                if (!merged.includes(l)) merged.push(l);\r\n            }\r\n            this.selectedLayers = merged;\r\n            this.selectedLayer = this.selectedLayers[this.selectedLayers.length - 1] || null;\r\n            this.draw();\r\n            return;\r\n        }\r\n\r\n        if (this.dragging) {\r\n            const scale = event.shiftKey ? 0.1 : 1;\r\n\r\n            if (this.selectedPoint) {\r\n                if (event.shiftKey) this.scaleLayer(this.selectedLayer!, 1 + this.mouseDelta[0] * 0.01);\r\n                else {\r\n                    this.selectedPoint[0] += this.mouseDelta[0] * scale;\r\n                    this.selectedPoint[1] += this.mouseDelta[1] * scale;\r\n                }\r\n            } else if (this.selectedLayers.length > 0) {\r\n                if (event.altKey && this.selectedLayer) {\r\n                    this.rotateLayer(this.selectedLayer, this.mouseDelta[0] * (0.01 * scale));\r\n                } else {\r\n                    // Move all selected layers\r\n                    for (const layer of this.selectedLayers) {\r\n                        for (let i = 0; i < layer.targetPoints.length; i++) {\r\n                            layer.targetPoints[i][0] += this.mouseDelta[0] * scale;\r\n                            layer.targetPoints[i][1] += this.mouseDelta[1] * scale;\r\n                        }\r\n                    }\r\n                    if (this.selectedLayer) this.snapLayerToEdges(this.selectedLayer);\r\n                }\r\n            }\r\n\r\n            this.updateTransform();\r\n            if (this.autoSave) this.saveSettings();\r\n            this.draw();\r\n            this.layoutChangeListener();\r\n            return;\r\n        }\r\n\r\n        this.canvas.style.cursor = \"default\";\r\n        this.hoveringPoint = null;\r\n        this.hoveringLayer = null;\r\n\r\n        // Priority: first check of points.\r\n        for (let i = this.layers.length - 1; i >= 0; i--) {\r\n            const layer = this.layers[i];\r\n            if (!layer.visible) continue;\r\n\r\n            for (let p = 0; p < layer.targetPoints.length; p++) {\r\n                const point = layer.targetPoints[p];\r\n                if (utils.distanceTo(point[0], point[1], this.mousePosition[0], this.mousePosition[1]) < this.selectionRadius) {\r\n                    this.hoveringPoint = point;\r\n                    this.hoveringLayer = layer;\r\n                    this.canvas.style.cursor = \"pointer\";\r\n                    break;\r\n                }\r\n            }\r\n            if (this.hoveringPoint) break;\r\n        }\r\n\r\n        // If there is no point to hover over, check entire layer.\r\n        if (!this.hoveringPoint) {\r\n            for (let i = this.layers.length - 1; i >= 0; i--) {\r\n                const layer = this.layers[i];\r\n                if (!layer.visible) continue;\r\n                if (this.pointInLayer(this.mousePosition, layer)) {\r\n                    this.hoveringLayer = layer;\r\n                    this.canvas.style.cursor = \"pointer\";\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n\r\n        this.draw();\r\n    }\r\n\r\n    private mouseDown(event: MouseEvent) {\r\n        if (!this.configActive) return;\r\n        if (event.button === 2) return; // Right click handled by context menu\r\n\r\n        const [mdx, mdy] = this.toWorkspace(event.clientX, event.clientY);\r\n        this.mouseDownPoint = [mdx, mdy];\r\n        this.selectedPoint = null;\r\n        this.rubberBandActive = false;\r\n\r\n        // First: check for point click\r\n        let clickedLayer: Types.Layer | null = null;\r\n        let clickedPoint: number[] | null = null;\r\n\r\n        for (let i = this.layers.length - 1; i >= 0; i--) {\r\n            const layer = this.layers[i];\r\n            if (!layer.visible) continue;\r\n            for (let p = 0; p < layer.targetPoints.length; p++) {\r\n                const point = layer.targetPoints[p];\r\n                if (utils.distanceTo(point[0], point[1], mdx, mdy) < this.selectionRadius) {\r\n                    clickedPoint = point;\r\n                    clickedLayer = layer;\r\n                    break;\r\n                }\r\n            }\r\n            if (clickedLayer) break;\r\n        }\r\n\r\n        // Then: check for layer click\r\n        if (!clickedLayer) {\r\n            for (let i = this.layers.length - 1; i >= 0; i--) {\r\n                const layer = this.layers[i];\r\n                if (!layer.visible) continue;\r\n                if (this.pointInLayer([mdx, mdy], layer)) {\r\n                    clickedLayer = layer;\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n\r\n        if (clickedPoint) {\r\n            // Point editing: single layer mode\r\n            this.selectedPoint = clickedPoint;\r\n            this.selectedLayer = clickedLayer;\r\n            this.selectedLayers = [clickedLayer!];\r\n            this.dragging = true;\r\n        } else if (clickedLayer) {\r\n            if (event.ctrlKey) {\r\n                // Ctrl+click: toggle layer in multi-selection\r\n                const idx = this.selectedLayers.indexOf(clickedLayer);\r\n                if (idx >= 0) {\r\n                    this.selectedLayers.splice(idx, 1);\r\n                    this.selectedLayer = this.selectedLayers[this.selectedLayers.length - 1] || null;\r\n                } else {\r\n                    this.selectedLayers.push(clickedLayer);\r\n                    this.selectedLayer = clickedLayer;\r\n                }\r\n                this.dragging = this.selectedLayers.length > 0;\r\n            } else {\r\n                // Normal click\r\n                if (this.selectedLayers.includes(clickedLayer)) {\r\n                    // Already in selection: keep multi-selection for dragging\r\n                    this.selectedLayer = clickedLayer;\r\n                } else {\r\n                    // Not selected: single select\r\n                    this.selectedLayers = [clickedLayer];\r\n                    this.selectedLayer = clickedLayer;\r\n                }\r\n                this.dragging = true;\r\n            }\r\n        } else {\r\n            // Empty space: start rubber band\r\n            this.selectedLayer = null;\r\n            this.rubberBandBaseSelection = event.ctrlKey ? [...this.selectedLayers] : [];\r\n            if (!event.ctrlKey) this.selectedLayers = [];\r\n            this.rubberBandActive = true;\r\n            this.rubberBandStart = [mdx, mdy];\r\n            this.rubberBandEnd = [mdx, mdy];\r\n            this.dragging = false;\r\n        }\r\n\r\n        this.draw();\r\n    }\r\n\r\n\r\n    private mouseUp(_event: MouseEvent) {\r\n        if (!this.configActive) return;\r\n\r\n        if (this.rubberBandActive) {\r\n            this.rubberBandActive = false;\r\n            this.draw();\r\n            return;\r\n        }\r\n\r\n        if (this.dragging) {\r\n            this.pushHistory();\r\n            if (this.autoSave) this.saveSettings();\r\n        }\r\n\r\n        this.dragging = false;\r\n        this.selectedPoint = null;\r\n    }\r\n\r\n    private keyDown(event: KeyboardEvent) {\r\n        if (!this.configActive) {\r\n            if (event.keyCode == 32 && event.shiftKey) {\r\n                this.setConfigEnabled(true);\r\n                return;\r\n            } else return;\r\n        }\r\n\r\n        var key = event.keyCode;\r\n\r\n        var increment = event.shiftKey ? 10 : 1;\r\n        var dirty = false;\r\n        var delta = [0, 0];\r\n\r\n        console.log(key);\r\n        switch (key) {\r\n\r\n            case 32: // spacebar.\r\n                if (event.shiftKey) {\r\n                    this.setConfigEnabled(false);\r\n                    return;\r\n                }\r\n                event.preventDefault();\r\n                if (this.onSpaceBar) this.onSpaceBar();\r\n                return;\r\n\r\n            case 37: // left arrow.\r\n                delta[0] -= increment;\r\n                break;\r\n\r\n            case 38: // up arrow.\r\n                delta[1] -= increment;\r\n                break;\r\n\r\n            case 39: // right arrow.\r\n                delta[0] += increment;\r\n                break;\r\n\r\n            case 40: // down arrow.\r\n                delta[1] += increment;\r\n                break;\r\n\r\n            case 67: // c key, toggle crosshairs.\r\n                this.showCrosshairs = !this.showCrosshairs;\r\n                dirty = true;\r\n                break;\r\n\r\n            case 76: // l key, toggle layer names.\r\n                if (!this.configActive) return;\r\n                this.showLayerNames = !this.showLayerNames;\r\n                dirty = true;\r\n                break;\r\n\r\n            case 83: // s key, solo/unsolo quads.\r\n                if (!this.isLayerSoloed) {\r\n                    if (this.selectedLayers.length > 0) {\r\n                        for (var i = 0; i < this.layers.length; i++) {\r\n                            this.layers[i].visible = false;\r\n                        }\r\n                        for (const sl of this.selectedLayers) sl.visible = true;\r\n                        dirty = true;\r\n                        this.isLayerSoloed = true;\r\n                    }\r\n                } else {\r\n                    for (var i = 0; i < this.layers.length; i++) {\r\n                        this.layers[i].visible = true;\r\n                    }\r\n                    this.isLayerSoloed = false;\r\n                    dirty = true;\r\n                }\r\n                break;\r\n\r\n            case 71: // g key, toggle snap\r\n                this.snapEnabled = !this.snapEnabled;\r\n                if (this.onSnapChanged) this.onSnapChanged(this.snapEnabled);\r\n                break;\r\n\r\n            case 66: // b key, toggle projector bounds rectangle.\r\n                this.showScreenBounds = !this.showScreenBounds;\r\n                this.draw();\r\n                break;\r\n\r\n            case 72: // h key, flip horizontal.\r\n                if (this.selectedLayer) {\r\n                    this.swapLayerPoints(this.selectedLayer.sourcePoints, 0, 1);\r\n                    this.swapLayerPoints(this.selectedLayer.sourcePoints, 3, 2);\r\n                    this.updateTransform();\r\n                    this.draw();\r\n                }\r\n                break;\r\n\r\n            case 86: // v key, flip vertical.\r\n                if (this.selectedLayer) {\r\n                    this.swapLayerPoints(this.selectedLayer.sourcePoints, 0, 3);\r\n                    this.swapLayerPoints(this.selectedLayer.sourcePoints, 1, 2);\r\n                    this.updateTransform();\r\n                    this.draw();\r\n                }\r\n                break;\r\n\r\n            case 82: // r key, rotate 90 degrees.\r\n                if (this.selectedLayer) {\r\n                    this.rotateLayer(this.selectedLayer, Math.PI / 2);\r\n                    //rotateLayer(selectedLayer, 0.002);\r\n                    this.updateTransform();\r\n                    this.draw();\r\n                }\r\n                break;\r\n            case 90: // z key\r\n                if (event.ctrlKey) {\r\n                    event.preventDefault();\r\n                    this.undo();\r\n                    return;\r\n                }\r\n                break;\r\n\r\n            case 89: // y key\r\n                if (event.ctrlKey) {\r\n                    event.preventDefault();\r\n                    this.redo();\r\n                    return;\r\n                }\r\n                break;\r\n\r\n            case 46: // Delete key\r\n            case 8:  // Backspace key\r\n                if (this.selectedLayers.length > 0) {\r\n                    for (const layer of [...this.selectedLayers]) {\r\n                        layer.element.remove();\r\n                        if (layer.overlay) layer.overlay.remove();\r\n                        const index = this.layers.indexOf(layer);\r\n                        if (index >= 0) this.layers.splice(index, 1);\r\n                    }\r\n                    this.selectedLayers = [];\r\n                    this.selectedLayer = null;\r\n                    dirty = true;\r\n                    this.updateTransform();\r\n                    this.draw();\r\n                }\r\n                break;\r\n        }\r\n\r\n        // If a layer or point is selected, add the delta amounts (set above via arrow keys).\r\n        if (!this.showScreenBounds) {\r\n            if (this.selectedPoint) {\r\n                this.selectedPoint[0] += delta[0];\r\n                this.selectedPoint[1] += delta[1];\r\n                dirty = true;\r\n            } else if (this.selectedLayers.length > 0) {\r\n                if (event.altKey == true && this.selectedLayer) {\r\n                    this.rotateLayer(this.selectedLayer, delta[0] * 0.01);\r\n                    this.scaleLayer(this.selectedLayer, (delta[1] * -0.005) + 1.0);\r\n                } else {\r\n                    for (const layer of this.selectedLayers) {\r\n                        for (var i = 0; i < layer.targetPoints.length; i++) {\r\n                            layer.targetPoints[i][0] += delta[0];\r\n                            layer.targetPoints[i][1] += delta[1];\r\n                        }\r\n                    }\r\n                }\r\n                dirty = true;\r\n            }\r\n        }\r\n\r\n        // Update the transform and redraw if needed.\r\n        if (dirty) {\r\n            this.updateTransform();\r\n            this.draw();\r\n            if (this.autoSave) this.saveSettings();\r\n            this.pushHistory();\r\n            this.layoutChangeListener();\r\n        }\r\n    };\r\n};\r\n\r\n// Check URL for shared workflow before initializing\r\ncheckUrlForWorkflow();\r\n\r\nconst baseMLMap = new MLMap({ layers: [] });\r\n\r\ninitUIControls(baseMLMap);\r\n\r\n// Start with edit mode and UI visible\r\nbaseMLMap.setConfigEnabled(true);\r\n\r\n(window as any).MLMap = MLMap;", "import { Layer, Point } from \"../types\";\r\n\r\nexport function getFreePosition(width: number, height: number, layers: Layer[] = []): [number, number] {\r\n    let x = 0, y = 0, tries = 0, maxTries = 100;\r\n    let overlap: boolean;\r\n\r\n    do {\r\n        overlap = false;\r\n        x = Math.random() * (window.innerWidth - width);\r\n        y = Math.random() * (window.innerHeight - height);\r\n\r\n        for (let l of layers) {\r\n            const rect = [\r\n                Math.min(...l.targetPoints.map(p => p[0])),\r\n                Math.min(...l.targetPoints.map(p => p[1])),\r\n                Math.max(...l.targetPoints.map(p => p[0])),\r\n                Math.max(...l.targetPoints.map(p => p[1]))\r\n            ];\r\n            if (!(x + width < rect[0] || x > rect[2] || y + height < rect[1] || y > rect[3])) {\r\n                overlap = true;\r\n                break;\r\n            }\r\n        }\r\n        tries++;\r\n    } while (overlap && tries < maxTries);\r\n\r\n    return [x, y];\r\n};\r\n\r\nexport function clonePoints(points: number[][]): Point[] {\r\n    return points.map(p => p.slice(0, 2) as Point);\r\n};\r\n\r\nexport function distanceTo(x1: number, y1: number, x2: number, y2: number): number {\r\n    return Math.hypot(x2 - x1, y2 - y1);\r\n};\r\n\r\nexport const solve = (() => {\r\n    function r(t: any, nArr: any, o: number, eFunc: any) {\r\n        if (o === nArr.length - 1) return eFunc(t);\r\n        let f: any;\r\n        const u = nArr[o];\r\n        const cArr = Array(u);\r\n        for (f = u - 1; f >= 0; --f) cArr[f] = r(t[f], nArr, o + 1, eFunc);\r\n        return cArr;\r\n    };\r\n    function tfn(rObj: any) {\r\n        const res: number[] = [];\r\n        while (typeof rObj === \"object\") {\r\n            res.push(rObj.length);\r\n            rObj = rObj[0];\r\n        }\r\n        return res;\r\n    };\r\n    function nfn(rObj: any) {\r\n        let n: any, o: any;\r\n        if (typeof rObj === \"object\") {\r\n            n = rObj[0];\r\n            if (typeof n === \"object\") {\r\n                o = n[0];\r\n                return (typeof o === \"object\") ? tfn(rObj) : [rObj.length, n.length];\r\n            }\r\n            return [rObj.length];\r\n        }\r\n        return [];\r\n    };\r\n    function ofn(rArr: any[]) {\r\n        let i: number;\r\n        const n = rArr.length;\r\n        const out = Array(n);\r\n        for (i = n - 1; i >= 0; --i) out[i] = rArr[i];\r\n        return out;\r\n    };\r\n    function efn(tVal: any) {\r\n        return typeof tVal !== \"object\" ? tVal : r(tVal, nfn(tVal), 0, ofn);\r\n    };\r\n    function ffn(rArr: any, tFlag?: boolean) {\r\n        tFlag = tFlag || false;\r\n        let n: any, o: any, fVar: any, uVar: any, a: any, h: any, i: any, l: any, g: any;\r\n        let v = rArr.length;\r\n        const y = v - 1;\r\n        const b = new Array(v);\r\n        if (!tFlag) rArr = efn(rArr);\r\n        for (fVar = 0; fVar < v; ++fVar) {\r\n            i = fVar;\r\n            h = rArr[fVar];\r\n            g = c(h[fVar]);\r\n            for (o = fVar + 1; o < v; ++o) {\r\n                uVar = c(rArr[o][fVar]);\r\n                if (uVar > g) { g = uVar; i = o; }\r\n            }\r\n            b[fVar] = i;\r\n            if (i != fVar) { rArr[fVar] = rArr[i]; rArr[i] = h; h = rArr[fVar]; }\r\n            a = h[fVar];\r\n            for (n = fVar + 1; n < v; ++n) rArr[n][fVar] /= a;\r\n            for (n = fVar + 1; n < v; ++n) {\r\n                l = rArr[n];\r\n                for (o = fVar + 1; o < y; ++o) { l[o] -= l[fVar] * h[o]; ++o; l[o] -= l[fVar] * h[o]; }\r\n                if (o === y) l[o] -= l[fVar] * h[o];\r\n            }\r\n        }\r\n        return { LU: rArr, P: b };\r\n    };\r\n    function ufn(rObj: any, tArr: any) {\r\n        let n: any, o: any, fVar: any, uVar: any, cVar: any;\r\n        const a = rObj.LU;\r\n        const h = a.length;\r\n        const iArr = efn(tArr);\r\n        const lArr = rObj.P;\r\n        for (n = h - 1; n >= 0; --n) iArr[n] = tArr[n];\r\n        for (n = 0; n < h; ++n) {\r\n            fVar = lArr[n];\r\n            if (lArr[n] !== n) { cVar = iArr[n]; iArr[n] = iArr[fVar]; iArr[fVar] = cVar; }\r\n            uVar = a[n];\r\n            for (o = 0; o < n; ++o) iArr[n] -= iArr[o] * uVar[o];\r\n        }\r\n        for (n = h - 1; n >= 0; --n) {\r\n            uVar = a[n];\r\n            for (o = n + 1; o < h; ++o) iArr[n] -= iArr[o] * uVar[o];\r\n            iArr[n] /= uVar[n];\r\n        }\r\n        return iArr;\r\n    };\r\n    const c = Math.abs;\r\n    return function (rMat: any, bVec: any, nOpt?: any) {\r\n        return ufn(ffn(rMat, nOpt), bVec);\r\n    };\r\n})();", "import { Workspace } from \"../types\";\r\n\r\nexport function saveWorkspace(workspace: Workspace) {\r\n    localStorage.setItem(`mlmap:workspace<${workspace.id}>`, JSON.stringify(workspace));\r\n};\r\n\r\nexport function loadWorkspace(workspaceId?: string): Workspace | null {\r\n    let currentWorkspaceId = localStorage.getItem(\"mlmap:currentWorkspaceId\");\r\n\r\n    if (!currentWorkspaceId) {\r\n        currentWorkspaceId = Date.now().toString();\r\n        localStorage.setItem(\"mlmap:currentWorkspaceId\", currentWorkspaceId);\r\n\r\n        const defaultWorkspace = {\r\n            id: currentWorkspaceId,\r\n            name: \"New Workspace\",\r\n            version: \"1.0\",\r\n            layout: {}\r\n        };\r\n\r\n        localStorage.setItem(`mlmap:workspace<${currentWorkspaceId}>`, JSON.stringify(defaultWorkspace));\r\n\r\n        return defaultWorkspace;\r\n    }\r\n\r\n    const raw = localStorage.getItem(`mlmap:workspace<${workspaceId || currentWorkspaceId}>`);\r\n    return raw ? JSON.parse(raw) as Workspace : null;\r\n};\r\n\r\nexport function deleteWorkspace(workspaceId: string) {\r\n    localStorage.removeItem(`mlmap:workspace<${workspaceId}>`);\r\n};\r\n\r\nexport function resetWorkspace(workspaceId: string) {\r\n    const cacheKey = `mlmap:workspace<${workspaceId}>`;\r\n    const currentData = JSON.parse(localStorage.getItem(cacheKey) || `{id:\"${workspaceId}\",name:\"Reset Workspace\",version:\"1.0\",layout:{}`);\r\n    localStorage.setItem(cacheKey, JSON.stringify({\r\n        id: workspaceId,\r\n        name: currentData?.name,\r\n        version: \"1.0\",\r\n        layout: {}\r\n    }));\r\n};\r\n\r\nexport function loadAllWorkspaces(): Workspace[] {\r\n    const workspaces: Workspace[] = [];\r\n    for (let i = 0; i < localStorage.length; i++) {\r\n        const key = localStorage.key(i)\r\n        if (key && key.startsWith(\"mlmap:workspace<\")) {\r\n            const raw = localStorage.getItem(key);\r\n            if (raw) workspaces.push(JSON.parse(raw) as Workspace);\r\n        }\r\n    }\r\n    return workspaces;\r\n};", "import { MLMap } from \"../main\";\r\nimport * as Types from \"../types\";\r\nimport { VERSION, DISPLAY_URL } from \"../lib/data\";\r\nimport * as utils from \"../utils/basics\";\r\nimport * as storage from \"../utils/storage\";\r\nimport { checkLatestVersion } from \"../utils/remote\";\r\nimport { ChannelBridge } from \"../channel\";\r\nimport { initVideoUI } from \"./videoPanel\";\r\nimport { exportWorkflow, importWorkflow, downloadWorkflow, uploadWorkflow, generateShareUrl } from \"../utils/workflow\";\r\nimport { ClipMaskRenderer, ClipGroup } from \"../video/clipMaskRenderer\";\r\n\r\nexport function initUIControls(baseMLMap: MLMap) {\r\n    // ---- DEVICE / SCREEN CHECK ----\r\n    const tooSmall = window.innerWidth < 900 || window.innerHeight < 500;\r\n    const touchOnly = window.matchMedia(\"(pointer: coarse)\").matches\r\n        && !window.matchMedia(\"(pointer: fine)\").matches;\r\n\r\n    if (tooSmall || touchOnly) {\r\n        const overlay = document.createElement(\"div\");\r\n        overlay.id = \"mlmap-device-warning\";\r\n        overlay.style.cssText = \"position:fixed;inset:0;z-index:9999999;background:#111;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;font-family:-apple-system,'Segoe UI',Roboto,sans-serif;color:#ccc;padding:32px;\";\r\n        overlay.innerHTML = `\r\n            <div style=\"font-size:48px;margin-bottom:16px;\">\\uD83D\\uDDA5\\uFE0F</div>\r\n            <h2 style=\"color:#fff;margin:0 0 12px;font-size:20px;\">Screen too small</h2>\r\n            <p style=\"max-width:400px;line-height:1.6;margin:0 0 24px;color:#999;\">\r\n                MLMap requires a computer or tablet with a keyboard and mouse.<br>\r\n                Minimum screen size: 900 &times; 500 px.\r\n            </p>\r\n            <p style=\"font-size:12px;color:#555;\">Current: ${window.innerWidth} &times; ${window.innerHeight} px</p>\r\n        `;\r\n        document.body.appendChild(overlay);\r\n\r\n        // Re-check on resize (user might rotate tablet or resize window)\r\n        window.addEventListener(\"resize\", () => {\r\n            const ok = window.innerWidth >= 900 && window.innerHeight >= 500;\r\n            if (ok && overlay.parentElement) {\r\n                overlay.remove();\r\n            }\r\n        });\r\n\r\n        return;\r\n    }\r\n\r\n    // ---- INJECT STYLES ----\r\n    const style = document.createElement(\"style\");\r\n    style.textContent = `\r\n        #mlmap-app {\r\n            position: fixed;\r\n            inset: 0;\r\n            display: grid;\r\n            grid-template-rows: 38px 1fr 48px;\r\n            grid-template-columns: 210px 1fr 270px;\r\n            grid-template-areas:\r\n                \"toolbar toolbar toolbar\"\r\n                \"left center right\"\r\n                \"transport transport transport\";\r\n            z-index: 1000001;\r\n            pointer-events: none;\r\n            font-family: -apple-system, 'Segoe UI', Roboto, sans-serif;\r\n            font-size: 12px;\r\n            color: #ccc;\r\n            user-select: none;\r\n        }\r\n        #mlmap-toolbar {\r\n            grid-area: toolbar;\r\n            pointer-events: auto;\r\n            background: #1a1a1a;\r\n            border-bottom: 1px solid #333;\r\n            display: flex;\r\n            align-items: center;\r\n            justify-content: space-between;\r\n            padding: 0 10px;\r\n        }\r\n        #mlmap-left {\r\n            grid-area: left;\r\n            pointer-events: auto;\r\n            background: #222;\r\n            border-right: 1px solid #333;\r\n            overflow-y: auto;\r\n            display: flex;\r\n            flex-direction: column;\r\n        }\r\n        #mlmap-right {\r\n            grid-area: right;\r\n            pointer-events: auto;\r\n            background: #222;\r\n            border-left: 1px solid #333;\r\n            overflow-y: auto;\r\n            display: flex;\r\n            flex-direction: column;\r\n        }\r\n        #mlmap-transport {\r\n            grid-area: transport;\r\n            pointer-events: auto;\r\n            background: #1a1a1a;\r\n            border-top: 1px solid #333;\r\n            display: flex;\r\n            align-items: center;\r\n            padding: 0 10px;\r\n            gap: 8px;\r\n        }\r\n        .mlmap-section {\r\n            padding: 8px;\r\n            border-bottom: 1px solid #333;\r\n        }\r\n        .mlmap-section-title {\r\n            font-size: 10px;\r\n            font-weight: 600;\r\n            text-transform: uppercase;\r\n            letter-spacing: 0.5px;\r\n            color: #888;\r\n            margin-bottom: 6px;\r\n        }\r\n        .mlmap-btn {\r\n            background: #383838;\r\n            color: #ccc;\r\n            border: none;\r\n            border-radius: 3px;\r\n            padding: 4px 8px;\r\n            font-size: 11px;\r\n            cursor: pointer;\r\n            font-family: inherit;\r\n        }\r\n        .mlmap-btn:hover { background: #484848; color: #fff; }\r\n        .mlmap-btn:active { background: #555; }\r\n        .mlmap-btn-primary { background: #2a6cb5; color: #fff; }\r\n        .mlmap-btn-primary:hover { background: #3580d0; }\r\n        .mlmap-input {\r\n            background: #1a1a1a;\r\n            color: #ccc;\r\n            border: 1px solid #444;\r\n            border-radius: 3px;\r\n            padding: 4px 6px;\r\n            font-size: 11px;\r\n            font-family: inherit;\r\n            outline: none;\r\n        }\r\n        .mlmap-input:focus { border-color: #2a6cb5; }\r\n        .mlmap-select {\r\n            background: #1a1a1a;\r\n            color: #ccc;\r\n            border: 1px solid #444;\r\n            border-radius: 3px;\r\n            padding: 4px 6px;\r\n            font-size: 11px;\r\n            font-family: inherit;\r\n            outline: none;\r\n        }\r\n        .mlmap-layer-item {\r\n            display: flex;\r\n            align-items: center;\r\n            gap: 4px;\r\n            padding: 3px 6px;\r\n            border-radius: 3px;\r\n            cursor: default;\r\n        }\r\n        .mlmap-layer-item:hover { background: #2a2a2a; }\r\n        .mlmap-layer-item .name {\r\n            flex: 1;\r\n            overflow: hidden;\r\n            text-overflow: ellipsis;\r\n            white-space: nowrap;\r\n            font-size: 11px;\r\n        }\r\n        .mlmap-layer-item .icon {\r\n            width: 14px;\r\n            text-align: center;\r\n            flex-shrink: 0;\r\n            font-size: 10px;\r\n        }\r\n        .mlmap-layer-item .del-btn {\r\n            opacity: 0;\r\n            cursor: pointer;\r\n            color: #f55;\r\n            background: none;\r\n            border: none;\r\n            font-size: 11px;\r\n            padding: 0 2px;\r\n        }\r\n        .mlmap-layer-item:hover .del-btn { opacity: 1; }\r\n        .mlmap-media-item {\r\n            display: flex;\r\n            align-items: center;\r\n            gap: 4px;\r\n            padding: 3px 6px;\r\n            border-radius: 3px;\r\n        }\r\n        .mlmap-media-item:hover { background: #2a2a2a; }\r\n        .mlmap-media-item .name {\r\n            flex: 1;\r\n            overflow: hidden;\r\n            text-overflow: ellipsis;\r\n            white-space: nowrap;\r\n            font-size: 11px;\r\n        }\r\n        .mlmap-pl-item {\r\n            display: flex;\r\n            align-items: center;\r\n            gap: 2px;\r\n            padding: 3px 4px;\r\n            border-radius: 3px;\r\n            font-size: 11px;\r\n        }\r\n        .mlmap-pl-item:hover { background: #2a2a2a; }\r\n        .mlmap-pl-item .name {\r\n            flex: 1;\r\n            overflow: hidden;\r\n            text-overflow: ellipsis;\r\n            white-space: nowrap;\r\n        }\r\n        .transport-btn {\r\n            background: #333;\r\n            color: #ccc;\r\n            border: none;\r\n            width: 30px;\r\n            height: 26px;\r\n            border-radius: 3px;\r\n            cursor: pointer;\r\n            font-size: 11px;\r\n            display: flex;\r\n            align-items: center;\r\n            justify-content: center;\r\n        }\r\n        .transport-btn:hover { background: #444; color: #fff; }\r\n        .mlmap-range {\r\n            -webkit-appearance: none;\r\n            appearance: none;\r\n            background: #333;\r\n            height: 6px;\r\n            border-radius: 3px;\r\n            outline: none;\r\n            cursor: pointer;\r\n        }\r\n        .mlmap-range::-webkit-slider-runnable-track {\r\n            height: 6px;\r\n            border-radius: 3px;\r\n        }\r\n        .mlmap-range::-webkit-slider-thumb {\r\n            -webkit-appearance: none;\r\n            width: 14px;\r\n            height: 14px;\r\n            border-radius: 50%;\r\n            background: #aaa;\r\n            cursor: pointer;\r\n            margin-top: -4px;\r\n        }\r\n        .mlmap-range::-webkit-slider-thumb:hover { background: #fff; }\r\n        .mlmap-range::-moz-range-thumb {\r\n            width: 14px;\r\n            height: 14px;\r\n            border-radius: 50%;\r\n            background: #aaa;\r\n            cursor: pointer;\r\n            border: none;\r\n        }\r\n        .mlmap-range::-moz-range-track {\r\n            height: 6px;\r\n            border-radius: 3px;\r\n            background: #333;\r\n        }\r\n        .toolbar-group {\r\n            display: flex;\r\n            align-items: center;\r\n            gap: 6px;\r\n        }\r\n        .app-title {\r\n            font-weight: 700;\r\n            font-size: 14px;\r\n            color: #fff;\r\n            letter-spacing: -0.5px;\r\n            margin-right: 8px;\r\n        }\r\n        .status-dot {\r\n            width: 7px;\r\n            height: 7px;\r\n            border-radius: 50%;\r\n            display: inline-block;\r\n        }\r\n        .status-dot.connected { background: #4CAF50; }\r\n        .status-dot.disconnected { background: #555; }\r\n        #mlmap-left::-webkit-scrollbar,\r\n        #mlmap-right::-webkit-scrollbar { width: 5px; }\r\n        #mlmap-left::-webkit-scrollbar-track,\r\n        #mlmap-right::-webkit-scrollbar-track { background: #1a1a1a; }\r\n        #mlmap-left::-webkit-scrollbar-thumb,\r\n        #mlmap-right::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }\r\n        .add-layer-grid {\r\n            display: grid;\r\n            grid-template-columns: 1fr 1fr;\r\n            gap: 3px;\r\n        }\r\n        .ws-grid {\r\n            display: grid;\r\n            grid-template-columns: repeat(5, 1fr);\r\n            gap: 3px;\r\n            margin-top: 4px;\r\n        }\r\n        /* Context menu */\r\n        #mlmap-context-menu {\r\n            position: fixed;\r\n            background: #2a2a2a;\r\n            border: 1px solid #555;\r\n            border-radius: 4px;\r\n            padding: 4px 0;\r\n            min-width: 180px;\r\n            z-index: 1000010;\r\n            box-shadow: 0 4px 12px rgba(0,0,0,0.5);\r\n            font-family: -apple-system, 'Segoe UI', Roboto, sans-serif;\r\n            font-size: 12px;\r\n            color: #ccc;\r\n            display: none;\r\n            pointer-events: auto;\r\n        }\r\n        .ctx-item {\r\n            padding: 6px 16px;\r\n            cursor: pointer;\r\n            display: flex;\r\n            justify-content: space-between;\r\n            align-items: center;\r\n        }\r\n        .ctx-item:hover { background: #3a3a3a; color: #fff; }\r\n        .ctx-item .shortcut { color: #666; font-size: 10px; margin-left: 16px; }\r\n        .ctx-sep { height: 1px; background: #444; margin: 3px 8px; }\r\n        .ctx-item.disabled { color: #555; pointer-events: none; }\r\n        .ctx-has-sub {\r\n            position: relative;\r\n        }\r\n        .ctx-has-sub > .ctx-item { cursor: default; }\r\n        .ctx-arrow { margin-left: auto; padding-left: 12px; font-size: 10px; color: #666; }\r\n        .ctx-submenu {\r\n            position: absolute;\r\n            left: 100%;\r\n            top: -4px;\r\n            background: #2a2a2a;\r\n            border: 1px solid #555;\r\n            border-radius: 4px;\r\n            padding: 4px 0;\r\n            min-width: 170px;\r\n            box-shadow: 0 4px 12px rgba(0,0,0,0.5);\r\n            display: none;\r\n        }\r\n        .ctx-has-sub:hover > .ctx-submenu { display: block; }\r\n    `;\r\n    document.head.appendChild(style);\r\n\r\n    // ---- CHANNEL BRIDGE ----\r\n    const bridge = new ChannelBridge(\"control\");\r\n    let displayWindow: Window | null = null;\r\n\r\n    // ---- LIVE STREAM SHARING (screen capture / webcam \u2192 display window via WebRTC) ----\r\n    // MediaStream objects can't be serialized via BroadcastChannel.\r\n    // We use WebRTC PeerConnection with BroadcastChannel as signaling channel.\r\n    // Non-trickle ICE: we wait for all candidates before sending SDP (fast for local connections).\r\n    const liveStreams = new Map<string, MediaStream>();\r\n    const streamPCs = new Map<string, RTCPeerConnection>();\r\n\r\n    function waitForIceGathering(pc: RTCPeerConnection): Promise<void> {\r\n        if (pc.iceGatheringState === \"complete\") return Promise.resolve();\r\n        return new Promise(r => {\r\n            pc.addEventListener(\"icegatheringstatechange\", () => {\r\n                if (pc.iceGatheringState === \"complete\") r();\r\n            });\r\n        });\r\n    }\r\n\r\n    async function sendStreamViaRTC(layerId: string): Promise<void> {\r\n        const stream = liveStreams.get(layerId);\r\n        if (!stream) return;\r\n        const oldPc = streamPCs.get(layerId);\r\n        if (oldPc) { oldPc.close(); streamPCs.delete(layerId); }\r\n        const pc = new RTCPeerConnection();\r\n        streamPCs.set(layerId, pc);\r\n        stream.getTracks().forEach(t => pc.addTrack(t, stream));\r\n        const offer = await pc.createOffer();\r\n        await pc.setLocalDescription(offer);\r\n        await waitForIceGathering(pc);\r\n        bridge.send(\"RTC_OFFER\", { layerId, sdp: pc.localDescription!.toJSON() });\r\n    }\r\n\r\n    bridge.on(\"RTC_ANSWER\", async (p: { layerId: string; sdp: RTCSessionDescriptionInit }) => {\r\n        const pc = streamPCs.get(p.layerId);\r\n        if (pc) await pc.setRemoteDescription(p.sdp);\r\n    });\r\n\r\n    // ---- STATE ----\r\n    let managedLayers: Types.ManagedLayer[] = [];\r\n    const MANAGED_LAYERS_KEY = \"mlmap.managedLayers\";\r\n    const RES_KEY = \"mlmap:outputResolution\";\r\n    let outputResolution: { width: number; height: number } | null = null;\r\n    let autoDisplaySize: { width: number; height: number } | null = null;\r\n    // ---- CLIP MASK RENDERER ----\r\n    const clipMaskRenderer = new ClipMaskRenderer(() => getClipGroups());\r\n\r\n    function getClipGroups(): ClipGroup[] {\r\n        const groups: ClipGroup[] = [];\r\n        const allLayers = baseMLMap.getLayers();\r\n        const grouped = new Map<string, { video: HTMLVideoElement; baseTargetPoints: number[][]; masks: Array<{ targetPoints: number[][] }> }>();\r\n\r\n        for (const ml of managedLayers) {\r\n            if (!ml.clipTo) continue;\r\n            const baseMl = managedLayers.find(b => b.id === ml.clipTo);\r\n            if (!baseMl) continue;\r\n\r\n            const baseInternalLayer = allLayers.find(l => l.element.id === baseMl.id);\r\n            const maskInternalLayer = allLayers.find(l => l.element.id === ml.id);\r\n            if (!baseInternalLayer || !maskInternalLayer) continue;\r\n\r\n            const baseEl = document.getElementById(baseMl.id);\r\n            if (!baseEl) continue;\r\n            const video = baseEl.querySelector(\"video\");\r\n            if (!video) continue;\r\n\r\n            if (!grouped.has(baseMl.id)) {\r\n                grouped.set(baseMl.id, {\r\n                    video,\r\n                    baseTargetPoints: baseInternalLayer.targetPoints.map(p => [p[0], p[1]]),\r\n                    masks: []\r\n                });\r\n            }\r\n            grouped.get(baseMl.id)!.masks.push({\r\n                targetPoints: maskInternalLayer.targetPoints.map(p => [p[0], p[1]])\r\n            });\r\n        }\r\n\r\n        for (const g of grouped.values()) groups.push(g);\r\n        return groups;\r\n    }\r\n\r\n    function hasAnyClipMasks(): boolean {\r\n        return managedLayers.some(ml => !!ml.clipTo);\r\n    }\r\n\r\n    function updateClipMaskRendererState(): void {\r\n        if (hasAnyClipMasks()) clipMaskRenderer.start();\r\n        else clipMaskRenderer.stop();\r\n    }\r\n\r\n    // ---- WORKSPACE CONTAINER (holds all layer elements, supports zoom) ----\r\n    const workspace = document.createElement(\"div\");\r\n    workspace.id = \"mlmap-workspace\";\r\n    workspace.style.cssText = \"position:fixed;inset:0;transform-origin:center center;\";\r\n    document.body.appendChild(workspace);\r\n\r\n    // ---- CREATE APP LAYOUT ----\r\n    const app = document.createElement(\"div\");\r\n    app.id = \"mlmap-app\";\r\n    app.innerHTML = `\r\n        <div id=\"mlmap-toolbar\">\r\n            <div class=\"toolbar-group\">\r\n                <span class=\"app-title\">MLMap</span>\r\n                <span style=\"font-size:10px;color:#666;\">v${VERSION}</span>\r\n                <button id=\"tb-toggleLeft\" class=\"mlmap-btn\" title=\"Toggle layers panel\" style=\"font-size:10px;padding:4px 5px;\">&laquo;</button>\r\n            </div>\r\n            <div class=\"toolbar-group\">\r\n                <span style=\"font-size:10px;color:#666;\">Zoom</span>\r\n                <input id=\"tb-zoom\" type=\"range\" min=\"25\" max=\"100\" value=\"100\" class=\"mlmap-range\" style=\"width:80px;\" title=\"Workspace zoom\">\r\n                <span id=\"tb-zoomLabel\" style=\"font-size:10px;color:#888;min-width:30px;\">100%</span>\r\n            </div>\r\n            <div class=\"toolbar-group\">\r\n                <span style=\"font-size:10px;color:#666;\">Output</span>\r\n                <select id=\"tb-resolution\" class=\"mlmap-select\" title=\"Output resolution\" style=\"max-width:130px;\">\r\n                    <option value=\"auto\">Auto</option>\r\n                    <option value=\"1920x1080\">1920x1080</option>\r\n                    <option value=\"1280x720\">1280x720</option>\r\n                    <option value=\"3840x2160\">3840x2160</option>\r\n                    <option value=\"1024x768\">1024x768</option>\r\n                    <option value=\"custom\">Custom...</option>\r\n                </select>\r\n                <input id=\"tb-resW\" class=\"mlmap-input\" type=\"number\" style=\"width:50px;display:none;\" placeholder=\"W\">\r\n                <input id=\"tb-resH\" class=\"mlmap-input\" type=\"number\" style=\"width:50px;display:none;\" placeholder=\"H\">\r\n            </div>\r\n            <div class=\"toolbar-group\">\r\n                <select id=\"tb-monitor\" class=\"mlmap-select\" title=\"Select output monitor\" style=\"max-width:140px;\">\r\n                    <option value=\"\">Monitor...</option>\r\n                </select>\r\n                <button id=\"tb-launch\" class=\"mlmap-btn mlmap-btn-primary\">Launch Output</button>\r\n                <button id=\"tb-exportTpl\" class=\"mlmap-btn\" title=\"Export layout template as image\">TPL</button>\r\n                <button id=\"tb-fullscreen\" class=\"mlmap-btn\" title=\"Fullscreen output\">FS</button>\r\n                <span class=\"status-dot disconnected\" id=\"tb-status\" title=\"Display disconnected\"></span>\r\n                <button id=\"tb-toggleRight\" class=\"mlmap-btn\" title=\"Toggle media panel\" style=\"font-size:10px;padding:4px 5px;\">&raquo;</button>\r\n            </div>\r\n        </div>\r\n        <div id=\"mlmap-left\"></div>\r\n        <div id=\"mlmap-right\"></div>\r\n        <div id=\"mlmap-transport\"></div>\r\n    `;\r\n    document.body.appendChild(app);\r\n    // Prevent mouse events on UI from reaching MLMap's window-level handlers\r\n    app.addEventListener(\"mousedown\", (e) => e.stopPropagation());\r\n\r\n    // ---- CONTEXT MENU ----\r\n    const ctxMenu = document.createElement(\"div\");\r\n    ctxMenu.id = \"mlmap-context-menu\";\r\n    document.body.appendChild(ctxMenu);\r\n    ctxMenu.addEventListener(\"mousedown\", (e) => e.stopPropagation());\r\n\r\n    const leftPanel = document.getElementById(\"mlmap-left\")!;\r\n    const rightPanel = document.getElementById(\"mlmap-right\")!;\r\n    const transportBar = document.getElementById(\"mlmap-transport\")!;\r\n\r\n    // ---- LEFT PANEL ----\r\n    leftPanel.innerHTML = `\r\n        <div class=\"mlmap-section\">\r\n            <div class=\"mlmap-section-title\">Layers</div>\r\n            <div id=\"lp-layerList\"></div>\r\n            <div class=\"mlmap-section-title\" style=\"margin-top:8px;\">Add Layer</div>\r\n            <div class=\"add-layer-grid\">\r\n                <button id=\"lp-addSquare\" class=\"mlmap-btn\">&#9633; Square</button>\r\n                <button id=\"lp-addCircle\" class=\"mlmap-btn\">&#9675; Circle</button>\r\n                <button id=\"lp-addTriangle\" class=\"mlmap-btn\">&#9651; Triangle</button>\r\n                <button id=\"lp-addIframe\" class=\"mlmap-btn\">&#8865; iframe</button>\r\n            </div>\r\n            <div class=\"mlmap-section-title\" style=\"margin-top:8px;\">Options</div>\r\n            <label style=\"display:flex;align-items:center;gap:4px;font-size:11px;cursor:pointer;\">\r\n                <input type=\"checkbox\" id=\"lp-snap\" checked> Snap to edges (G)\r\n            </label>\r\n        </div>\r\n        <div class=\"mlmap-section\">\r\n            <div class=\"mlmap-section-title\">Workspaces</div>\r\n            <select id=\"lp-wsSelect\" class=\"mlmap-select\" style=\"width:100%;\"></select>\r\n            <div class=\"ws-grid\">\r\n                <button id=\"lp-wsAdd\" class=\"mlmap-btn\" title=\"New\">+</button>\r\n                <button id=\"lp-wsDup\" class=\"mlmap-btn\" title=\"Duplicate\">&#128203;</button>\r\n                <button id=\"lp-wsRen\" class=\"mlmap-btn\" title=\"Rename\">&#9998;</button>\r\n                <button id=\"lp-wsReset\" class=\"mlmap-btn\" title=\"Reset\">&#8634;</button>\r\n                <button id=\"lp-wsDel\" class=\"mlmap-btn\" title=\"Delete\">&#128465;</button>\r\n            </div>\r\n            <div class=\"mlmap-section-title\" style=\"margin-top:8px;\">Import / Export</div>\r\n            <div style=\"display:flex;flex-direction:column;gap:3px;\">\r\n                <div style=\"display:grid;grid-template-columns:1fr 1fr;gap:3px;\">\r\n                    <button id=\"lp-wfExport\" class=\"mlmap-btn\" title=\"Export workflow to .mlmap file\">Export File</button>\r\n                    <button id=\"lp-wfImport\" class=\"mlmap-btn\" title=\"Import workflow from .mlmap file\">Import File</button>\r\n                </div>\r\n                <button id=\"lp-wfShare\" class=\"mlmap-btn mlmap-btn-primary\" title=\"Copy share URL to clipboard\" style=\"width:100%;\">Copy Share URL</button>\r\n            </div>\r\n        </div>\r\n        <div class=\"mlmap-section\" style=\"border-bottom:none;\">\r\n            <div class=\"mlmap-section-title\">Shortcuts</div>\r\n            <pre style=\"font-size:10px;color:#666;margin:0;white-space:pre-wrap;line-height:1.5;\">SHIFT+Space: Toggle edit mode\r\nSpace: Play/Pause video\r\nDrag: Move | SHIFT+Drag: Precise\r\nALT+Drag: Rotate/Scale\r\nCtrl+Click: Multi-select layers\r\nDrag empty: Rubber band select\r\nArrows: Move | S: Solo | C: Cross\r\nR: Rotate | H/V: Flip | B: Bounds\r\nDEL: Delete | Ctrl+Z/Y: Undo/Redo\r\nG: Toggle snap | Right-click: Menu</pre>\r\n        </div>\r\n    `;\r\n\r\n    // ---- INITIALIZE VIDEO UI ----\r\n    const videoCtrl = initVideoUI(rightPanel, transportBar, bridge, onAddVideoLayer);\r\n\r\n    // ---- VIDEO DATA TRANSFER ----\r\n    // Blob URLs (local files) can't be loaded cross-window when origin is null (file:// protocol).\r\n    // We fetch the blob, send the ArrayBuffer via BroadcastChannel, and the display creates its own blob URL.\r\n    function sendVideoDataToDisplay(layerId: string, url: string): void {\r\n        if (!url || !url.startsWith(\"blob:\")) return;\r\n        fetch(url)\r\n            .then(r => r.arrayBuffer())\r\n            .then(buf => {\r\n                bridge.send(\"SEND_VIDEO_DATA\", { layerId, data: buf, mimeType: \"video/mp4\" });\r\n            })\r\n            .catch(() => {});\r\n    }\r\n\r\n    // ---- LAYOUT REMAPPING (editor coords \u2192 display coords) ----\r\n    function getDisplayLayout(): any[] {\r\n        const layout = baseMLMap.getLayout();\r\n        const frame = baseMLMap.outputFrame;\r\n        if (!frame || frame.w <= 0 || frame.h <= 0) return layout;\r\n        // Remap targetPoints from editor frame space to output resolution space\r\n        const sx = frame.resW / frame.w;\r\n        const sy = frame.resH / frame.h;\r\n        return layout.map((item: any) => ({\r\n            ...item,\r\n            targetPoints: item.targetPoints.map((p: number[]) => [\r\n                (p[0] - frame.x) * sx,\r\n                (p[1] - frame.y) * sy,\r\n            ]),\r\n        }));\r\n    }\r\n\r\n    function sendLayoutToDisplay(): void {\r\n        bridge.send(\"UPDATE_LAYOUT\", { layout: getDisplayLayout() });\r\n    }\r\n\r\n    // ---- LAYER MANAGEMENT ----\r\n    function getVideoLayerSize(): { w: number; h: number } {\r\n        // Use output resolution for native-quality rendering; fallback to 1920x1080\r\n        const res = outputResolution || autoDisplaySize;\r\n        return res ? { w: res.width, h: res.height } : { w: 1920, h: 1080 };\r\n    }\r\n\r\n    function onAddVideoLayer(url: string, name: string, stream?: MediaStream): void {\r\n        const id = `vlayer_${Date.now()}`;\r\n        const vSize = getVideoLayerSize();\r\n        const div = document.createElement(\"div\");\r\n        div.id = id;\r\n        div.style.position = \"fixed\";\r\n        div.style.top = \"0px\";\r\n        div.style.left = \"0px\";\r\n        div.style.width = vSize.w + \"px\";\r\n        div.style.height = vSize.h + \"px\";\r\n        div.style.overflow = \"hidden\";\r\n        div.style.background = \"#000\";\r\n\r\n        const video = document.createElement(\"video\");\r\n        if (stream) {\r\n            video.srcObject = stream;\r\n            video.autoplay = true;\r\n        } else {\r\n            video.src = url;\r\n            video.preload = \"metadata\";\r\n        }\r\n        video.style.width = \"100%\";\r\n        video.style.height = \"100%\";\r\n        video.style.objectFit = \"contain\";\r\n        video.muted = true;\r\n        video.playsInline = true;\r\n        div.appendChild(video);\r\n\r\n        // When capture stream ends, show placeholder and clean up\r\n        if (stream) {\r\n            stream.getTracks().forEach(track => {\r\n                track.addEventListener(\"ended\", () => {\r\n                    if (stream.getTracks().every(t => t.readyState === \"ended\")) {\r\n                        liveStreams.delete(id);\r\n                        video.srcObject = null;\r\n                        div.innerHTML = \"\";\r\n                        const ph = document.createElement(\"div\");\r\n                        ph.className = \"mlmap-video-placeholder\";\r\n                        ph.style.cssText = \"width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none;\";\r\n                        ph.innerHTML = `<span style=\"font-size:18px;color:#555;\">&#9632;</span><span style=\"font-size:10px;color:#555;margin-top:2px;\">${name}</span><span style=\"font-size:9px;color:#444;margin-top:2px;\">Capture ended</span>`;\r\n                        div.appendChild(ph);\r\n                        renderLayerList();\r\n                    }\r\n                });\r\n            });\r\n        }\r\n\r\n        workspace.appendChild(div);\r\n\r\n        // Center on screen - show at a reasonable visual size (400x300 on screen)\r\n        const cx = window.innerWidth / 2, cy = window.innerHeight / 2;\r\n        baseMLMap.addLayer(div, [[cx - 200, cy - 150], [cx + 200, cy - 150], [cx + 200, cy + 150], [cx - 200, cy + 150]]);\r\n\r\n        // Register with transport for local playback control\r\n        videoCtrl.registerVideoElement(video);\r\n\r\n        const layerInfo: Types.ManagedLayer = { id, name, type: \"video\", videoUrl: stream ? undefined : url, width: vSize.w, height: vSize.h };\r\n        managedLayers.push(layerInfo);\r\n        saveManagedLayers();\r\n        renderLayerList();\r\n\r\n        bridge.send(\"ADD_LAYER\", layerInfo);\r\n        if (stream) {\r\n            liveStreams.set(id, stream);\r\n            setTimeout(() => sendStreamViaRTC(id), 200);\r\n        } else if (url) {\r\n            sendVideoDataToDisplay(id, url);\r\n        }\r\n        setTimeout(() => sendLayoutToDisplay(), 100);\r\n    }\r\n\r\n    function createShape(type: \"square\" | \"circle\" | \"triangle\"): void {\r\n        const id = `shape_${Date.now()}`;\r\n        const div = document.createElement(\"div\");\r\n        div.id = id;\r\n\r\n        const cx = window.innerWidth / 2;\r\n        const cy = window.innerHeight / 2;\r\n        div.style.position = \"fixed\";\r\n        div.style.top = \"0px\";\r\n        div.style.left = \"0px\";\r\n        div.style.width = \"100px\";\r\n        div.style.height = \"100px\";\r\n        div.style.background = type === \"triangle\" ? \"transparent\" : \"white\";\r\n        div.style.border = type === \"triangle\" ? \"2px solid white\" : \"none\";\r\n\r\n        if (type === \"circle\") div.style.borderRadius = \"50%\";\r\n        if (type === \"triangle\") {\r\n            div.style.width = \"0\";\r\n            div.style.height = \"0\";\r\n            div.style.borderLeft = \"50px solid transparent\";\r\n            div.style.borderRight = \"50px solid transparent\";\r\n            div.style.borderBottom = \"100px solid white\";\r\n        }\r\n\r\n        workspace.appendChild(div);\r\n\r\n        // Center on screen\r\n        const hw = type === \"triangle\" ? 50 : 50;\r\n        const hh = 50;\r\n        const centerPts: number[][] = type === \"triangle\"\r\n            ? [[cx, cy - hh], [cx + hw, cy + hh], [cx - hw, cy + hh], [cx, cy + hh]]\r\n            : [[cx - hw, cy - hh], [cx + hw, cy - hh], [cx + hw, cy + hh], [cx - hw, cy + hh]];\r\n        baseMLMap.addLayer(div, centerPts);\r\n\r\n        const layerInfo: Types.ManagedLayer = { id, name: `${type}`, type: \"shape\", shapeType: type, width: 100, height: 100 };\r\n        managedLayers.push(layerInfo);\r\n        saveManagedLayers();\r\n        renderLayerList();\r\n\r\n        bridge.send(\"ADD_LAYER\", layerInfo);\r\n        setTimeout(() => sendLayoutToDisplay(), 100);\r\n    }\r\n\r\n    function createIframeLayer(url: string): void {\r\n        const id = `iframe_${Date.now()}`;\r\n        const div = document.createElement(\"div\");\r\n        div.id = id;\r\n        div.style.position = \"fixed\";\r\n        div.style.top = \"0px\";\r\n        div.style.left = \"0px\";\r\n        div.style.width = \"400px\";\r\n        div.style.height = \"300px\";\r\n        div.style.overflow = \"hidden\";\r\n        div.style.background = \"#000\";\r\n\r\n        const iframe = document.createElement(\"iframe\");\r\n        iframe.src = url;\r\n        iframe.style.width = \"100%\";\r\n        iframe.style.height = \"100%\";\r\n        iframe.style.border = \"none\";\r\n        iframe.style.pointerEvents = \"none\";\r\n        iframe.setAttribute(\"allow\", \"autoplay; encrypted-media\");\r\n        div.appendChild(iframe);\r\n\r\n        workspace.appendChild(div);\r\n\r\n        // Center on screen\r\n        const icx = window.innerWidth / 2, icy = window.innerHeight / 2;\r\n        baseMLMap.addLayer(div, [[icx - 200, icy - 150], [icx + 200, icy - 150], [icx + 200, icy + 150], [icx - 200, icy + 150]]);\r\n\r\n        const name = url.replace(/^https?:\\/\\//, \"\").split(\"/\")[0] || \"iframe\";\r\n        const layerInfo: Types.ManagedLayer = { id, name, type: \"iframe\", iframeUrl: url, width: 400, height: 300 };\r\n        managedLayers.push(layerInfo);\r\n        saveManagedLayers();\r\n        renderLayerList();\r\n\r\n        bridge.send(\"ADD_LAYER\", layerInfo);\r\n        setTimeout(() => sendLayoutToDisplay(), 100);\r\n    }\r\n\r\n    function deleteLayer(id: string): void {\r\n        // Release any clip masks pointing to this layer\r\n        managedLayers.forEach(ml => { if (ml.clipTo === id) releaseClipMask(ml.id); });\r\n        // Also release this layer's own clip mask\r\n        const ml = managedLayers.find(l => l.id === id);\r\n        if (ml?.clipTo) releaseClipMask(id);\r\n        liveStreams.delete(id);\r\n        const pc = streamPCs.get(id);\r\n        if (pc) { pc.close(); streamPCs.delete(id); }\r\n        const el = document.getElementById(id);\r\n        if (el) el.remove();\r\n        managedLayers = managedLayers.filter(l => l.id !== id);\r\n        saveManagedLayers();\r\n        renderLayerList();\r\n        bridge.send(\"REMOVE_LAYER\", { id });\r\n        updateClipMaskRendererState();\r\n    }\r\n\r\n    function createClipMask(maskId: string): void {\r\n        const maskMl = managedLayers.find(l => l.id === maskId);\r\n        if (!maskMl || maskMl.type !== \"shape\") return;\r\n\r\n        // Find nearest video layer: search below first, then above\r\n        const idx = managedLayers.indexOf(maskMl);\r\n        let baseId: string | null = null;\r\n        for (let i = idx - 1; i >= 0; i--) {\r\n            if (managedLayers[i].type === \"video\") { baseId = managedLayers[i].id; break; }\r\n        }\r\n        if (!baseId) {\r\n            for (let i = idx + 1; i < managedLayers.length; i++) {\r\n                if (managedLayers[i].type === \"video\") { baseId = managedLayers[i].id; break; }\r\n            }\r\n        }\r\n        if (!baseId) return;\r\n\r\n        maskMl.clipTo = baseId;\r\n\r\n        // Hide the base layer element (video plays hidden, rendered via canvas)\r\n        // Use opacity instead of visibility \u2014 draw() forces visibility:\"visible\"\r\n        // on every frame, but never touches opacity.\r\n        const baseEl = document.getElementById(baseId);\r\n        if (baseEl) baseEl.style.opacity = \"0\";\r\n\r\n        // Hide the mask shape element (ClipMaskRenderer canvas handles rendering)\r\n        const maskEl = document.getElementById(maskId);\r\n        if (maskEl) maskEl.style.opacity = \"0\";\r\n\r\n        // Auto-play the base video so the ClipMaskRenderer can draw frames\r\n        // Also switch the transport to control this video so audio matches visuals\r\n        if (baseEl) {\r\n            const video = baseEl.querySelector(\"video\") as HTMLVideoElement | null;\r\n            if (video) {\r\n                if (video.paused) video.play().catch(() => {});\r\n                videoCtrl.setActiveVideo(video);\r\n            }\r\n        }\r\n\r\n        saveManagedLayers();\r\n        renderLayerList();\r\n        updateClipMaskRendererState();\r\n        // Sync clip state to display\r\n        bridge.send(\"ADD_LAYER\", maskMl);\r\n    }\r\n\r\n    function releaseClipMask(maskId: string): void {\r\n        const maskMl = managedLayers.find(l => l.id === maskId);\r\n        if (!maskMl || !maskMl.clipTo) return;\r\n\r\n        const baseId = maskMl.clipTo;\r\n        maskMl.clipTo = undefined;\r\n\r\n        // Restore mask shape visibility and appearance\r\n        const maskEl = document.getElementById(maskId);\r\n        if (maskEl) {\r\n            maskEl.style.opacity = \"1\";\r\n            if (maskMl.shapeType === \"triangle\") {\r\n                maskEl.style.borderBottomColor = \"white\";\r\n            } else if (maskMl.shapeType === \"circle\") {\r\n                maskEl.style.background = \"white\";\r\n            } else {\r\n                maskEl.style.background = \"white\";\r\n            }\r\n        }\r\n\r\n        // If no other masks point to this base, show it again\r\n        const stillMasked = managedLayers.some(l => l.clipTo === baseId);\r\n        if (!stillMasked) {\r\n            const baseEl = document.getElementById(baseId);\r\n            if (baseEl) baseEl.style.opacity = \"1\";\r\n        }\r\n\r\n        saveManagedLayers();\r\n        renderLayerList();\r\n        updateClipMaskRendererState();\r\n        // Sync clip state to display\r\n        bridge.send(\"ADD_LAYER\", maskMl);\r\n    }\r\n\r\n    function syncManagedLayerOrder(): void {\r\n        const allLayers = baseMLMap.getLayers();\r\n        const idOrder = allLayers.map(l => l.element.id);\r\n        managedLayers.sort((a, b) => {\r\n            const ia = idOrder.indexOf(a.id);\r\n            const ib = idOrder.indexOf(b.id);\r\n            return ia - ib;\r\n        });\r\n        saveManagedLayers();\r\n        renderLayerList();\r\n    }\r\n\r\n    function renderLayerList(): void {\r\n        const list = document.getElementById(\"lp-layerList\")!;\r\n        list.innerHTML = \"\";\r\n        if (managedLayers.length === 0) {\r\n            list.innerHTML = '<div style=\"color:#555;font-size:11px;padding:4px;\">No layers</div>';\r\n            return;\r\n        }\r\n        managedLayers.forEach(layer => {\r\n            const row = document.createElement(\"div\");\r\n            row.className = \"mlmap-layer-item\";\r\n            if (layer.clipTo) row.style.paddingLeft = \"18px\";\r\n\r\n            const icon = document.createElement(\"span\");\r\n            icon.className = \"icon\";\r\n            if (layer.type === \"video\") icon.textContent = \"\\u25B6\";\r\n            else if (layer.type === \"iframe\") icon.textContent = \"\\u29C9\";\r\n\r\n            else if (layer.shapeType === \"circle\") icon.textContent = \"\\u25CF\";\r\n            else if (layer.shapeType === \"triangle\") icon.textContent = \"\\u25B2\";\r\n            else icon.textContent = \"\\u25A0\";\r\n\r\n            const isPlaceholderVideo = layer.type === \"video\" && !document.getElementById(layer.id)?.querySelector(\"video\");\r\n\r\n            const name = document.createElement(\"span\");\r\n            name.className = \"name\";\r\n            if (layer.clipTo) name.textContent = `${layer.name} (clip)`;\r\n            else if (isPlaceholderVideo) { name.textContent = `${layer.name}`; name.style.color = \"#f80\"; }\r\n            else name.textContent = layer.name;\r\n\r\n            const del = document.createElement(\"button\");\r\n            del.className = \"del-btn\";\r\n            del.textContent = \"\\u2715\";\r\n            del.addEventListener(\"click\", () => deleteLayer(layer.id));\r\n\r\n            row.appendChild(icon);\r\n            row.appendChild(name);\r\n            row.appendChild(del);\r\n            list.appendChild(row);\r\n        });\r\n    }\r\n\r\n    function saveManagedLayers(): void {\r\n        // Persist all layers. Video layers save without blob URL (won't be valid after reload).\r\n        const persistable = managedLayers.map(l => {\r\n            if (l.type === \"video\") return { ...l, videoUrl: undefined };\r\n            return l;\r\n        });\r\n        localStorage.setItem(MANAGED_LAYERS_KEY, JSON.stringify(persistable));\r\n    }\r\n\r\n    function loadManagedLayers(): void {\r\n        try {\r\n            const stored = localStorage.getItem(MANAGED_LAYERS_KEY);\r\n            if (stored) {\r\n                const items: Types.ManagedLayer[] = JSON.parse(stored);\r\n                items.forEach(s => restoreLayer(s));\r\n            }\r\n            const legacy = localStorage.getItem(\"mlmap.dynamicShapes\");\r\n            if (legacy && !stored) {\r\n                const oldShapes: Types.Shape[] = JSON.parse(legacy);\r\n                oldShapes.forEach(s => {\r\n                    const info: Types.ManagedLayer = { id: s.id, name: s.type, type: \"shape\", shapeType: s.type, width: 100, height: 100 };\r\n                    restoreLayer(info);\r\n                });\r\n            }\r\n        } catch { /* ignore */ }\r\n        renderLayerList();\r\n    }\r\n\r\n    function restoreLayer(info: Types.ManagedLayer): void {\r\n        const div = document.createElement(\"div\");\r\n        div.id = info.id;\r\n        div.style.position = \"fixed\";\r\n        div.style.top = \"0px\";\r\n        div.style.left = \"0px\";\r\n        div.style.width = info.width + \"px\";\r\n        div.style.height = info.height + \"px\";\r\n\r\n        if (info.type === \"video\") {\r\n            // Restore as placeholder \u2014 blob URL won't survive reload\r\n            div.style.overflow = \"hidden\";\r\n            div.style.background = \"#111\";\r\n            const ph = document.createElement(\"div\");\r\n            ph.className = \"mlmap-video-placeholder\";\r\n            ph.style.cssText = \"width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none;\";\r\n            ph.innerHTML = `<span style=\"font-size:18px;color:#555;\">\\u25B6</span><span style=\"font-size:10px;color:#555;margin-top:2px;\">${info.name}</span><span style=\"font-size:9px;color:#444;margin-top:2px;\">Re-import video</span>`;\r\n            div.appendChild(ph);\r\n        } else if (info.type === \"iframe\" && info.iframeUrl) {\r\n            div.style.overflow = \"hidden\";\r\n            div.style.background = \"#000\";\r\n            const iframe = document.createElement(\"iframe\");\r\n            iframe.src = info.iframeUrl;\r\n            iframe.style.width = \"100%\";\r\n            iframe.style.height = \"100%\";\r\n            iframe.style.border = \"none\";\r\n            iframe.style.pointerEvents = \"none\";\r\n            iframe.setAttribute(\"allow\", \"autoplay; encrypted-media\");\r\n            div.appendChild(iframe);\r\n        } else if (info.shapeType === \"circle\") {\r\n            div.style.background = \"white\";\r\n            div.style.borderRadius = \"50%\";\r\n        } else if (info.shapeType === \"triangle\") {\r\n            div.style.width = \"0\";\r\n            div.style.height = \"0\";\r\n            div.style.borderLeft = \"50px solid transparent\";\r\n            div.style.borderRight = \"50px solid transparent\";\r\n            div.style.borderBottom = \"100px solid white\";\r\n            div.style.background = \"transparent\";\r\n        } else {\r\n            div.style.background = \"white\";\r\n        }\r\n\r\n        workspace.appendChild(div);\r\n        baseMLMap.addLayer(div);\r\n        managedLayers.push(info);\r\n    }\r\n\r\n    function assignVideoToLayer(layerId: string, url: string, name: string): void {\r\n        const ml = managedLayers.find(l => l.id === layerId);\r\n        if (!ml || ml.type !== \"video\") return;\r\n\r\n        const div = document.getElementById(layerId);\r\n        if (!div) return;\r\n\r\n        // Upgrade to high-res native size\r\n        const vSize = getVideoLayerSize();\r\n        div.style.width = vSize.w + \"px\";\r\n        div.style.height = vSize.h + \"px\";\r\n        ml.width = vSize.w;\r\n        ml.height = vSize.h;\r\n\r\n        // Clear placeholder\r\n        div.innerHTML = \"\";\r\n        div.style.background = \"#000\";\r\n\r\n        // Create video element\r\n        const video = document.createElement(\"video\");\r\n        video.src = url;\r\n        video.style.width = \"100%\";\r\n        video.style.height = \"100%\";\r\n        video.style.objectFit = \"contain\";\r\n        video.muted = true;\r\n        video.playsInline = true;\r\n        video.preload = \"metadata\";\r\n        div.appendChild(video);\r\n\r\n        // Register with transport\r\n        videoCtrl.registerVideoElement(video);\r\n\r\n        // Update managed layer info\r\n        ml.name = name;\r\n        ml.videoUrl = url;\r\n        saveManagedLayers();\r\n        renderLayerList();\r\n\r\n        // If this video has clip masks, auto-play so the renderer works\r\n        if (managedLayers.some(l => l.clipTo === layerId)) {\r\n            video.play().catch(() => {});\r\n            updateClipMaskRendererState();\r\n        }\r\n\r\n        bridge.send(\"ADD_LAYER\", ml);\r\n        sendVideoDataToDisplay(layerId, url);\r\n        setTimeout(() => sendLayoutToDisplay(), 100);\r\n    }\r\n\r\n    function assignCaptureToLayer(layerId: string, stream: MediaStream, name: string): void {\r\n        const ml = managedLayers.find(l => l.id === layerId);\r\n        if (!ml || ml.type !== \"video\") return;\r\n\r\n        const div = document.getElementById(layerId);\r\n        if (!div) return;\r\n\r\n        // Upgrade to high-res native size\r\n        const vSize = getVideoLayerSize();\r\n        div.style.width = vSize.w + \"px\";\r\n        div.style.height = vSize.h + \"px\";\r\n        ml.width = vSize.w;\r\n        ml.height = vSize.h;\r\n\r\n        div.innerHTML = \"\";\r\n        div.style.background = \"#000\";\r\n\r\n        const video = document.createElement(\"video\");\r\n        video.srcObject = stream;\r\n        video.autoplay = true;\r\n        video.style.width = \"100%\";\r\n        video.style.height = \"100%\";\r\n        video.style.objectFit = \"contain\";\r\n        video.muted = true;\r\n        video.playsInline = true;\r\n        div.appendChild(video);\r\n\r\n        // When capture ends, show placeholder and clean up\r\n        stream.getTracks().forEach(track => {\r\n            track.addEventListener(\"ended\", () => {\r\n                if (stream.getTracks().every(t => t.readyState === \"ended\")) {\r\n                    liveStreams.delete(layerId);\r\n                    video.srcObject = null;\r\n                    div.innerHTML = \"\";\r\n                    const ph = document.createElement(\"div\");\r\n                    ph.className = \"mlmap-video-placeholder\";\r\n                    ph.style.cssText = \"width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none;\";\r\n                    ph.innerHTML = `<span style=\"font-size:18px;color:#555;\">&#9632;</span><span style=\"font-size:10px;color:#555;margin-top:2px;\">${name}</span><span style=\"font-size:9px;color:#444;margin-top:2px;\">Capture ended</span>`;\r\n                    div.appendChild(ph);\r\n                    renderLayerList();\r\n                }\r\n            });\r\n        });\r\n\r\n        videoCtrl.registerVideoElement(video);\r\n\r\n        ml.name = name;\r\n        ml.videoUrl = undefined; // Captures don't have persistent URLs\r\n        saveManagedLayers();\r\n        renderLayerList();\r\n\r\n        if (managedLayers.some(l => l.clipTo === layerId)) {\r\n            updateClipMaskRendererState();\r\n        }\r\n\r\n        liveStreams.set(layerId, stream);\r\n        bridge.send(\"ADD_LAYER\", ml);\r\n        setTimeout(() => sendStreamViaRTC(layerId), 200);\r\n        setTimeout(() => sendLayoutToDisplay(), 100);\r\n    }\r\n\r\n    // ---- SHAPE BUTTONS ----\r\n    document.getElementById(\"lp-addSquare\")!.addEventListener(\"click\", () => createShape(\"square\"));\r\n    document.getElementById(\"lp-addCircle\")!.addEventListener(\"click\", () => createShape(\"circle\"));\r\n    document.getElementById(\"lp-addTriangle\")!.addEventListener(\"click\", () => createShape(\"triangle\"));\r\n\r\n    // ---- IFRAME BUTTON ----\r\n    document.getElementById(\"lp-addIframe\")!.addEventListener(\"click\", () => {\r\n        const url = prompt(\"Enter URL for iframe:\", \"https://\");\r\n        if (url && url !== \"https://\") createIframeLayer(url);\r\n    });\r\n\r\n    // ---- SNAP TOGGLE ----\r\n    const snapCheckbox = document.getElementById(\"lp-snap\") as HTMLInputElement;\r\n    snapCheckbox.checked = baseMLMap.snapEnabled;\r\n    snapCheckbox.addEventListener(\"change\", () => { baseMLMap.snapEnabled = snapCheckbox.checked; });\r\n    baseMLMap.onSnapChanged = (enabled: boolean) => { snapCheckbox.checked = enabled; };\r\n\r\n    // ---- CONTEXT MENU ----\r\n    function showContextMenu(x: number, y: number, layer: Types.Layer): void {\r\n        baseMLMap.selectLayer(layer);\r\n        const layerId = layer.element.id;\r\n        const ml = managedLayers.find(l => l.id === layerId);\r\n        const isShape = ml?.type === \"shape\";\r\n        const isVideo = ml?.type === \"video\";\r\n        const isClipped = !!ml?.clipTo;\r\n        // Clip mask label (only show if there's a video layer to clip to)\r\n        let clipLabel = \"\";\r\n        const hasVideoLayer = managedLayers.some(l => l.type === \"video\");\r\n        if (isShape && !isClipped && hasVideoLayer) clipLabel = \"Create Clip Mask\";\r\n        else if (isClipped) clipLabel = \"Release Clip Mask\";\r\n\r\n        ctxMenu.innerHTML = `\r\n            <div class=\"ctx-item\" data-action=\"center\">Center on screen</div>\r\n            <div class=\"ctx-sep\"></div>\r\n            ${isVideo ? `\r\n            <div class=\"ctx-has-sub\">\r\n                <div class=\"ctx-item\" style=\"color:#5af;\">Assign Video<span class=\"ctx-arrow\">\\u25B6</span></div>\r\n                <div class=\"ctx-submenu\">\r\n                    <div class=\"ctx-item\" data-action=\"assignFile\">Browse file...</div>\r\n                    <div class=\"ctx-item\" data-action=\"assignUrl\">Enter URL...</div>\r\n                    <div class=\"ctx-sep\"></div>\r\n                    <div class=\"ctx-item\" data-action=\"assignCapture\">Screen capture...</div>\r\n                    <div class=\"ctx-item\" data-action=\"assignWebcam\">Webcam...</div>\r\n                </div>\r\n            </div>\r\n            <div class=\"ctx-sep\"></div>` : \"\"}\r\n            <div class=\"ctx-has-sub\">\r\n                <div class=\"ctx-item\">Layer Order<span class=\"ctx-arrow\">\\u25B6</span></div>\r\n                <div class=\"ctx-submenu\">\r\n                    <div class=\"ctx-item\" data-action=\"moveUp\">Move Up</div>\r\n                    <div class=\"ctx-item\" data-action=\"moveDown\">Move Down</div>\r\n                    <div class=\"ctx-sep\"></div>\r\n                    <div class=\"ctx-item\" data-action=\"sendToTop\">Send to Top</div>\r\n                    <div class=\"ctx-item\" data-action=\"sendToBottom\">Send to Bottom</div>\r\n                </div>\r\n            </div>\r\n            <div class=\"ctx-has-sub\">\r\n                <div class=\"ctx-item\">Transform<span class=\"ctx-arrow\">\\u25B6</span></div>\r\n                <div class=\"ctx-submenu\">\r\n                    <div class=\"ctx-item\" data-action=\"rotate90\">Rotate 90\\u00B0</div>\r\n                    <div class=\"ctx-item\" data-action=\"rotate180\">Rotate 180\\u00B0</div>\r\n                    <div class=\"ctx-item\" data-action=\"rotate270\">Rotate 270\\u00B0</div>\r\n                    <div class=\"ctx-sep\"></div>\r\n                    <div class=\"ctx-item\" data-action=\"flipH\">Flip Horizontal</div>\r\n                    <div class=\"ctx-item\" data-action=\"flipV\">Flip Vertical</div>\r\n                    <div class=\"ctx-sep\"></div>\r\n                    <div class=\"ctx-item\" data-action=\"scaleUp\">Scale +10%</div>\r\n                    <div class=\"ctx-item\" data-action=\"scaleDown\">Scale -10%</div>\r\n                    <div class=\"ctx-sep\"></div>\r\n                    <div class=\"ctx-item\" data-action=\"resetTransform\">Reset Transform</div>\r\n                </div>\r\n            </div>\r\n            <div class=\"ctx-has-sub\">\r\n                <div class=\"ctx-item\">Fit to Output<span class=\"ctx-arrow\">\\u25B6</span></div>\r\n                <div class=\"ctx-submenu\">\r\n                    <div class=\"ctx-item\" data-action=\"fitOutput\">Fit to Output</div>\r\n                    <div class=\"ctx-item\" data-action=\"stretchOutput\">Stretch to Output</div>\r\n                </div>\r\n            </div>\r\n            <div class=\"ctx-sep\"></div>\r\n            ${clipLabel ? `<div class=\"ctx-item\" data-action=\"toggleClip\">${clipLabel}</div><div class=\"ctx-sep\"></div>` : \"\"}\r\n            <div class=\"ctx-item\" data-action=\"solo\">Solo / Unsolo<span class=\"shortcut\">S</span></div>\r\n            <div class=\"ctx-item\" data-action=\"delete\" style=\"color:#f55;\">Delete layer<span class=\"shortcut\">DEL</span></div>\r\n        `;\r\n\r\n        // Position: keep menu within viewport\r\n        const menuW = 200, menuH = 300;\r\n        const posX = x + menuW > window.innerWidth ? x - menuW : x;\r\n        const posY = y + menuH > window.innerHeight ? y - menuH : y;\r\n        ctxMenu.style.left = Math.max(0, posX) + \"px\";\r\n        ctxMenu.style.top = Math.max(0, posY) + \"px\";\r\n        ctxMenu.style.display = \"block\";\r\n\r\n        // Handle clicks only on items with data-action\r\n        ctxMenu.querySelectorAll(\".ctx-item[data-action]\").forEach(item => {\r\n            item.addEventListener(\"click\", (e) => {\r\n                e.stopPropagation();\r\n                const action = (item as HTMLElement).dataset.action;\r\n                switch (action) {\r\n                    case \"center\": baseMLMap.centerLayer(layer); break;\r\n                    case \"moveUp\":\r\n                        baseMLMap.moveLayerUp(layer);\r\n                        syncManagedLayerOrder();\r\n                        break;\r\n                    case \"moveDown\":\r\n                        baseMLMap.moveLayerDown(layer);\r\n                        syncManagedLayerOrder();\r\n                        break;\r\n                    case \"sendToTop\":\r\n                        baseMLMap.moveLayerToTop(layer);\r\n                        syncManagedLayerOrder();\r\n                        break;\r\n                    case \"sendToBottom\":\r\n                        baseMLMap.moveLayerToBottom(layer);\r\n                        syncManagedLayerOrder();\r\n                        break;\r\n                    case \"rotate90\": baseMLMap.rotateLayerPublic(layer, 90); break;\r\n                    case \"rotate180\": baseMLMap.rotateLayerPublic(layer, 180); break;\r\n                    case \"rotate270\": baseMLMap.rotateLayerPublic(layer, 270); break;\r\n                    case \"flipH\": baseMLMap.flipLayerH(layer); break;\r\n                    case \"flipV\": baseMLMap.flipLayerV(layer); break;\r\n                    case \"scaleUp\": baseMLMap.scaleLayerPublic(layer, 1.1); break;\r\n                    case \"scaleDown\": baseMLMap.scaleLayerPublic(layer, 0.9); break;\r\n                    case \"resetTransform\": baseMLMap.resetLayerTransform(layer); break;\r\n                    case \"fitOutput\": {\r\n                        const frame = baseMLMap.outputFrame || { x: 0, y: 0, w: window.innerWidth, h: window.innerHeight };\r\n                        baseMLMap.fitToFrame(layer, frame);\r\n                        break;\r\n                    }\r\n                    case \"stretchOutput\": {\r\n                        const frame = baseMLMap.outputFrame || { x: 0, y: 0, w: window.innerWidth, h: window.innerHeight };\r\n                        baseMLMap.stretchToFrame(layer, frame);\r\n                        break;\r\n                    }\r\n                    case \"toggleClip\":\r\n                        if (isClipped) releaseClipMask(layerId);\r\n                        else createClipMask(layerId);\r\n                        break;\r\n                    case \"assignFile\": {\r\n                        const input = document.createElement(\"input\");\r\n                        input.type = \"file\";\r\n                        input.accept = \"video/*\";\r\n                        input.onchange = () => {\r\n                            const file = input.files?.[0];\r\n                            if (file) {\r\n                                const url = URL.createObjectURL(file);\r\n                                assignVideoToLayer(layerId, url, file.name);\r\n                            }\r\n                        };\r\n                        input.click();\r\n                        break;\r\n                    }\r\n                    case \"assignUrl\": {\r\n                        const url = prompt(\"Enter video URL:\", \"https://\");\r\n                        if (url && url !== \"https://\") {\r\n                            const urlName = url.split(\"/\").pop() || \"Video URL\";\r\n                            assignVideoToLayer(layerId, url, urlName);\r\n                        }\r\n                        break;\r\n                    }\r\n                    case \"assignCapture\": {\r\n                        (async () => {\r\n                            try {\r\n                                const cursor = localStorage.getItem(\"mlmap:showCursor\") !== \"false\" ? \"always\" : \"never\";\r\n                                const stream = await navigator.mediaDevices.getDisplayMedia({\r\n                                    video: { cursor } as any,\r\n                                    audio: true,\r\n                                });\r\n                                const track = stream.getVideoTracks()[0];\r\n                                const capName = track?.label || \"Screen Capture\";\r\n                                assignCaptureToLayer(layerId, stream, capName);\r\n                            } catch { /* user cancelled */ }\r\n                        })();\r\n                        break;\r\n                    }\r\n                    case \"assignWebcam\": {\r\n                        (async () => {\r\n                            try {\r\n                                const devices = await navigator.mediaDevices.enumerateDevices();\r\n                                const cameras = devices.filter(d => d.kind === \"videoinput\");\r\n                                let constraints: MediaStreamConstraints = { video: true, audio: true };\r\n                                if (cameras.length > 1) {\r\n                                    const options = cameras.map((c, i) => `${i + 1}. ${c.label || `Camera ${i + 1}`}`).join(\"\\n\");\r\n                                    const choice = prompt(`Select camera:\\n${options}`, \"1\");\r\n                                    if (!choice) return;\r\n                                    const idx = parseInt(choice) - 1;\r\n                                    if (idx >= 0 && idx < cameras.length) {\r\n                                        constraints = { video: { deviceId: { exact: cameras[idx].deviceId } }, audio: true };\r\n                                    }\r\n                                }\r\n                                const stream = await navigator.mediaDevices.getUserMedia(constraints);\r\n                                const track = stream.getVideoTracks()[0];\r\n                                const camName = track?.label || \"Webcam\";\r\n                                assignCaptureToLayer(layerId, stream, camName);\r\n                            } catch { /* user denied or cancelled */ }\r\n                        })();\r\n                        break;\r\n                    }\r\n                    case \"solo\":\r\n                        const allLayers = baseMLMap.getLayers();\r\n                        const isSoloed = allLayers.some(l => !l.visible);\r\n                        if (isSoloed) {\r\n                            allLayers.forEach(l => l.visible = true);\r\n                        } else {\r\n                            allLayers.forEach(l => l.visible = false);\r\n                            layer.visible = true;\r\n                        }\r\n                        break;\r\n                    case \"delete\":\r\n                        deleteLayer(layerId);\r\n                        break;\r\n                }\r\n                hideContextMenu();\r\n            });\r\n        });\r\n    }\r\n\r\n    function hideContextMenu(): void {\r\n        ctxMenu.style.display = \"none\";\r\n    }\r\n\r\n    // Right-click handler on the canvas area\r\n    document.addEventListener(\"contextmenu\", (e: MouseEvent) => {\r\n        // Only intercept on the MLMap canvas area (not on UI panels)\r\n        const target = e.target as HTMLElement;\r\n        if (target.closest(\"#mlmap-app\") || target.closest(\"#mlmap-context-menu\")) return;\r\n\r\n        const layer = baseMLMap.getLayerAtPoint(e.clientX, e.clientY);\r\n        if (layer) {\r\n            e.preventDefault();\r\n            showContextMenu(e.clientX, e.clientY, layer);\r\n        }\r\n    });\r\n\r\n    // Hide context menu on click elsewhere or Escape\r\n    document.addEventListener(\"mousedown\", (e: MouseEvent) => {\r\n        if (!(e.target as HTMLElement).closest(\"#mlmap-context-menu\")) {\r\n            hideContextMenu();\r\n        }\r\n    });\r\n    document.addEventListener(\"keydown\", (e: KeyboardEvent) => {\r\n        if (e.key === \"Escape\") hideContextMenu();\r\n    });\r\n\r\n    // ---- WORKSPACE MANAGEMENT ----\r\n    let workspaces = storage.loadAllWorkspaces();\r\n    let activeWorkspace: Types.Workspace | null = workspaces.find(\r\n        ws => ws.id === localStorage.getItem(\"mlmap:currentWorkspaceId\")\r\n    ) || null;\r\n\r\n    if (!activeWorkspace && workspaces.length) {\r\n        activeWorkspace = workspaces[0];\r\n        localStorage.setItem(\"mlmap:currentWorkspaceId\", activeWorkspace.id);\r\n    }\r\n\r\n    // Layout is applied after loadManagedLayers() in the INIT section\r\n\r\n    function updateWorkspaceSelector(): void {\r\n        const sel = document.getElementById(\"lp-wsSelect\") as HTMLSelectElement;\r\n        sel.innerHTML = \"\";\r\n        workspaces.forEach(ws => {\r\n            const opt = document.createElement(\"option\");\r\n            opt.value = ws.id;\r\n            opt.textContent = ws.name;\r\n            if (activeWorkspace && activeWorkspace.id === ws.id) opt.selected = true;\r\n            sel.appendChild(opt);\r\n        });\r\n    }\r\n\r\n    function switchWorkspace(ws: Types.Workspace): void {\r\n        localStorage.setItem(\"mlmap:currentWorkspaceId\", ws.id);\r\n        window.location.reload();\r\n    }\r\n\r\n    document.getElementById(\"lp-wsAdd\")!.addEventListener(\"click\", () => {\r\n        const name = prompt(\"Workspace name:\", \"New Workspace\") || \"New Workspace\";\r\n        const ws: Types.Workspace = { id: Date.now().toString(), name, version: \"1.0\", layout: {} };\r\n        workspaces.push(ws);\r\n        storage.saveWorkspace(ws);\r\n        switchWorkspace(ws);\r\n    });\r\n\r\n    document.getElementById(\"lp-wsDup\")!.addEventListener(\"click\", () => {\r\n        if (!activeWorkspace) return;\r\n        const name = prompt(\"New name:\", activeWorkspace.name + \" (Copy)\") || activeWorkspace.name + \" (Copy)\";\r\n        const ws: Types.Workspace = { id: Date.now().toString(), name, version: \"1.0\", layout: activeWorkspace.layout };\r\n        workspaces.push(ws);\r\n        storage.saveWorkspace(ws);\r\n        switchWorkspace(ws);\r\n    });\r\n\r\n    document.getElementById(\"lp-wsRen\")!.addEventListener(\"click\", () => {\r\n        if (!activeWorkspace) return;\r\n        const name = prompt(\"New name:\", activeWorkspace.name);\r\n        if (name) {\r\n            activeWorkspace.name = name;\r\n            storage.saveWorkspace(activeWorkspace);\r\n            updateWorkspaceSelector();\r\n        }\r\n    });\r\n\r\n    document.getElementById(\"lp-wsReset\")!.addEventListener(\"click\", () => {\r\n        if (!activeWorkspace) return;\r\n        if (confirm(\"Reset workspace? This will clear all layer positions.\")) {\r\n            storage.resetWorkspace(activeWorkspace.id);\r\n            window.location.reload();\r\n        }\r\n    });\r\n\r\n    document.getElementById(\"lp-wsDel\")!.addEventListener(\"click\", () => {\r\n        if (!activeWorkspace || workspaces.length <= 1) return;\r\n        if (confirm(\"Delete workspace '\" + activeWorkspace.name + \"'?\")) {\r\n            storage.deleteWorkspace(activeWorkspace.id);\r\n            workspaces = workspaces.filter(ws => ws.id !== activeWorkspace?.id);\r\n            if (workspaces.length) switchWorkspace(workspaces[0]);\r\n        }\r\n    });\r\n\r\n    (document.getElementById(\"lp-wsSelect\") as HTMLSelectElement).addEventListener(\"change\", (e) => {\r\n        const ws = workspaces.find(w => w.id === (e.target as HTMLSelectElement).value);\r\n        if (ws) switchWorkspace(ws);\r\n    });\r\n\r\n    updateWorkspaceSelector();\r\n\r\n    // ---- WORKFLOW EXPORT / IMPORT / SHARE ----\r\n    document.getElementById(\"lp-wfExport\")!.addEventListener(\"click\", () => {\r\n        const data = exportWorkflow(activeWorkspace?.name);\r\n        downloadWorkflow(data);\r\n    });\r\n\r\n    document.getElementById(\"lp-wfImport\")!.addEventListener(\"click\", async () => {\r\n        const data = await uploadWorkflow();\r\n        if (data) {\r\n            importWorkflow(data);\r\n            window.location.reload();\r\n        }\r\n    });\r\n\r\n    document.getElementById(\"lp-wfShare\")!.addEventListener(\"click\", () => {\r\n        const data = exportWorkflow(activeWorkspace?.name);\r\n        const url = generateShareUrl(data);\r\n        navigator.clipboard.writeText(url).then(() => {\r\n            const btn = document.getElementById(\"lp-wfShare\")!;\r\n            const orig = btn.textContent;\r\n            btn.textContent = \"Copied!\";\r\n            btn.style.background = \"#4CAF50\";\r\n            setTimeout(() => {\r\n                btn.textContent = orig;\r\n                btn.style.background = \"\";\r\n            }, 2000);\r\n        }).catch(() => {\r\n            // Fallback: show URL in prompt for manual copy\r\n            prompt(\"Share URL (copy manually):\", url);\r\n        });\r\n    });\r\n\r\n    // ---- TOOLBAR ----\r\n    const launchBtn = document.getElementById(\"tb-launch\")!;\r\n\r\n    function updateLaunchButton(): void {\r\n        if (displayWindow && !displayWindow.closed) {\r\n            launchBtn.textContent = \"Stop Output\";\r\n            launchBtn.classList.remove(\"mlmap-btn-primary\");\r\n            launchBtn.style.background = \"#a33\";\r\n        } else {\r\n            launchBtn.textContent = \"Launch Output\";\r\n            launchBtn.classList.add(\"mlmap-btn-primary\");\r\n            launchBtn.style.background = \"\";\r\n            displayWindow = null;\r\n        }\r\n    }\r\n\r\n    launchBtn.addEventListener(\"click\", () => {\r\n        if (displayWindow && !displayWindow.closed) {\r\n            displayWindow.close();\r\n            displayWindow = null;\r\n            updateLaunchButton();\r\n            return;\r\n        }\r\n        const monitorSel = document.getElementById(\"tb-monitor\") as HTMLSelectElement;\r\n        const screenIdx = parseInt(monitorSel.value);\r\n        let features = \"width=1280,height=720\";\r\n\r\n        if (!isNaN(screenIdx) && (window as any)._mlmapScreens && (window as any)._mlmapScreens[screenIdx]) {\r\n            const s = (window as any)._mlmapScreens[screenIdx];\r\n            features = `left=${s.availLeft},top=${s.availTop},width=${s.availWidth},height=${s.availHeight}`;\r\n        }\r\n\r\n        displayWindow = window.open(DISPLAY_URL, \"mlmap-display\", features);\r\n        updateLaunchButton();\r\n\r\n        // Monitor if display window is closed externally\r\n        const checkClosed = setInterval(() => {\r\n            if (!displayWindow || displayWindow.closed) {\r\n                clearInterval(checkClosed);\r\n                displayWindow = null;\r\n                updateLaunchButton();\r\n            }\r\n        }, 1000);\r\n    });\r\n\r\n    document.getElementById(\"tb-fullscreen\")!.addEventListener(\"click\", () => {\r\n        bridge.send(\"FULLSCREEN_ENTER\");\r\n    });\r\n\r\n    document.getElementById(\"tb-exportTpl\")!.addEventListener(\"click\", () => {\r\n        const res = outputResolution || autoDisplaySize || { width: window.innerWidth, height: window.innerHeight };\r\n        const canvas = baseMLMap.exportTemplate(res.width, res.height);\r\n        canvas.toBlob((blob) => {\r\n            if (!blob) return;\r\n            const url = URL.createObjectURL(blob);\r\n            const a = document.createElement(\"a\");\r\n            a.href = url;\r\n            a.download = `mlmap-template-${res.width}x${res.height}.png`;\r\n            a.click();\r\n            URL.revokeObjectURL(url);\r\n        }, \"image/png\");\r\n    });\r\n\r\n    bridge.onConnectionChanged = (connected: boolean) => {\r\n        const dot = document.getElementById(\"tb-status\")!;\r\n        dot.className = connected ? \"status-dot connected\" : \"status-dot disconnected\";\r\n        dot.title = connected ? \"Display connected\" : \"Display disconnected\";\r\n    };\r\n\r\n    bridge.on(\"DISPLAY_READY\", () => {\r\n        managedLayers.forEach(layer => bridge.send(\"ADD_LAYER\", layer));\r\n        setTimeout(() => {\r\n            sendLayoutToDisplay();\r\n            videoCtrl.sendPlaylistToDisplay();\r\n            // Send video data / live streams for video layers\r\n            managedLayers.forEach(layer => {\r\n                if (layer.type === \"video\") {\r\n                    if (liveStreams.has(layer.id)) {\r\n                        sendStreamViaRTC(layer.id);\r\n                    } else {\r\n                        const el = document.getElementById(layer.id);\r\n                        const video = el?.querySelector(\"video\") as HTMLVideoElement | null;\r\n                        if (video && video.src && video.src.startsWith(\"blob:\")) {\r\n                            sendVideoDataToDisplay(layer.id, video.src);\r\n                        }\r\n                    }\r\n                }\r\n            });\r\n            // Sync playback state (position, play/pause, volume, mute routing)\r\n            setTimeout(() => videoCtrl.syncPlaybackToDisplay(), 500);\r\n        }, 200);\r\n    });\r\n\r\n    async function detectMonitors(): Promise<void> {\r\n        const sel = document.getElementById(\"tb-monitor\") as HTMLSelectElement;\r\n        try {\r\n            if (\"getScreenDetails\" in window) {\r\n                const screenDetails = await (window as any).getScreenDetails();\r\n                (window as any)._mlmapScreens = screenDetails.screens;\r\n                sel.innerHTML = '<option value=\"\">Select monitor...</option>';\r\n                screenDetails.screens.forEach((screen: any, i: number) => {\r\n                    const opt = document.createElement(\"option\");\r\n                    opt.value = String(i);\r\n                    const label = screen.label || `Monitor ${i + 1}`;\r\n                    opt.textContent = `${label} (${screen.width}x${screen.height})`;\r\n                    if (!screen.isPrimary) opt.textContent += \" *\";\r\n                    sel.appendChild(opt);\r\n                });\r\n            } else {\r\n                sel.innerHTML = `<option value=\"\">Default (${screen.width}x${screen.height})</option>`;\r\n            }\r\n        } catch {\r\n            sel.innerHTML = `<option value=\"\">Default (${screen.width}x${screen.height})</option>`;\r\n        }\r\n    }\r\n    detectMonitors();\r\n\r\n    // ---- PANEL TOGGLES ----\r\n    let leftVisible = true;\r\n    let rightVisible = true;\r\n\r\n    function updatePanelLayout(): void {\r\n        const leftCol = leftVisible ? \"210px\" : \"0px\";\r\n        const rightCol = rightVisible ? \"270px\" : \"0px\";\r\n        app.style.gridTemplateColumns = `${leftCol} 1fr ${rightCol}`;\r\n        leftPanel.style.display = leftVisible ? \"flex\" : \"none\";\r\n        rightPanel.style.display = rightVisible ? \"flex\" : \"none\";\r\n        document.getElementById(\"tb-toggleLeft\")!.innerHTML = leftVisible ? \"&laquo;\" : \"&raquo;\";\r\n        document.getElementById(\"tb-toggleRight\")!.innerHTML = rightVisible ? \"&raquo;\" : \"&laquo;\";\r\n    }\r\n\r\n    document.getElementById(\"tb-toggleLeft\")!.addEventListener(\"click\", () => {\r\n        leftVisible = !leftVisible;\r\n        updatePanelLayout();\r\n        calcOutputFrame();\r\n    });\r\n\r\n    document.getElementById(\"tb-toggleRight\")!.addEventListener(\"click\", () => {\r\n        rightVisible = !rightVisible;\r\n        updatePanelLayout();\r\n        calcOutputFrame();\r\n    });\r\n\r\n    // ---- WORKSPACE ZOOM ----\r\n    const zoomSlider = document.getElementById(\"tb-zoom\") as HTMLInputElement;\r\n    const zoomLabel = document.getElementById(\"tb-zoomLabel\")!;\r\n\r\n    zoomSlider.addEventListener(\"input\", () => {\r\n        const zoom = parseInt(zoomSlider.value) / 100;\r\n        workspace.style.transform = zoom < 1 ? `scale(${zoom})` : \"\";\r\n        zoomLabel.textContent = `${zoomSlider.value}%`;\r\n        baseMLMap.setWorkspaceZoom(zoom);\r\n        clipMaskRenderer.zoom = zoom;\r\n    });\r\n\r\n    // Clip mask canvas goes on body (z-index 999999, below MLMap canvas at 1000000)\r\n    document.body.appendChild(clipMaskRenderer.canvasElement);\r\n\r\n    // ---- KEYBOARD / EDIT MODE ----\r\n    const originalSetConfigEnabled = baseMLMap.setConfigEnabled;\r\n    baseMLMap.setConfigEnabled = function (enabled: boolean) {\r\n        originalSetConfigEnabled.call(baseMLMap, enabled);\r\n        app.style.display = enabled ? \"grid\" : \"none\";\r\n        // When leaving edit mode, re-apply clip mask visibility since draw()\r\n        // won't run (and thus onAfterDraw won't fire) in non-edit mode\r\n        if (!enabled) reapplyClipMaskVisibility();\r\n    };\r\n\r\n    // ---- CLIP MASK VISIBILITY ----\r\n    // draw() sets visibility=\"visible\" for all visible layers, so we must\r\n    // re-hide clip-masked elements after every draw call.\r\n    // Both the base video AND the mask shapes must be hidden \u2014 the\r\n    // ClipMaskRenderer canvas (z-index:2) handles all visual rendering.\r\n    function reapplyClipMaskVisibility(): void {\r\n        const hiddenBases = new Set<string>();\r\n        for (const ml of managedLayers) {\r\n            if (!ml.clipTo) continue;\r\n            // Hide mask shape element via opacity (survives draw()'s visibility override)\r\n            const maskEl = document.getElementById(ml.id);\r\n            if (maskEl) maskEl.style.opacity = \"0\";\r\n            hiddenBases.add(ml.clipTo);\r\n        }\r\n        for (const baseId of hiddenBases) {\r\n            const baseEl = document.getElementById(baseId);\r\n            if (baseEl) baseEl.style.opacity = \"0\";\r\n        }\r\n    }\r\n    baseMLMap.onAfterDraw = reapplyClipMaskVisibility;\r\n    baseMLMap.onSpaceBar = () => videoCtrl.togglePlayPause();\r\n\r\n    // ---- LAYOUT CHANGE LISTENER ----\r\n    baseMLMap.layoutChangeListener = () => {\r\n        if (activeWorkspace) {\r\n            activeWorkspace.layout = baseMLMap.getLayout();\r\n            storage.saveWorkspace(activeWorkspace);\r\n        }\r\n        sendLayoutToDisplay();\r\n    };\r\n\r\n    // ---- VIDEO SYNC ----\r\n    // Re-sync playback when returning to this tab (browser may have throttled timers)\r\n    document.addEventListener(\"visibilitychange\", () => {\r\n        if (document.visibilityState === \"visible\") {\r\n            videoCtrl.syncPlaybackToDisplay();\r\n        }\r\n    });\r\n\r\n    // ---- MUTATION OBSERVER ----\r\n    const observer = new MutationObserver(mutations => {\r\n        for (const mutation of mutations) {\r\n            if (mutation.type === \"childList\" && mutation.removedNodes.length > 0) {\r\n                mutation.removedNodes.forEach(node => {\r\n                    // Skip nodes that were just moved (appendChild re-appends)\r\n                    if (node instanceof HTMLElement && !node.isConnected) {\r\n                        const idx = managedLayers.findIndex(l => l.id === node.id);\r\n                        if (idx !== -1) {\r\n                            managedLayers.splice(idx, 1);\r\n                            saveManagedLayers();\r\n                            renderLayerList();\r\n                            bridge.send(\"REMOVE_LAYER\", { id: node.id });\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n        }\r\n    });\r\n    observer.observe(document.body, { childList: true, subtree: true });\r\n\r\n    // ---- INIT ----\r\n    loadManagedLayers();\r\n\r\n    // Re-apply workspace layout AFTER managed layers are created in the DOM\r\n    if (activeWorkspace?.layout) {\r\n        baseMLMap.setLayout(activeWorkspace.layout);\r\n    }\r\n\r\n    // Reset history so the initial state is the current layout (not an empty snapshot)\r\n    baseMLMap.resetHistory();\r\n\r\n    // Restore clip mask visual state after layers are loaded\r\n    reapplyClipMaskVisibility();\r\n    updateClipMaskRendererState();\r\n\r\n    leftPanel.addEventListener(\"keydown\", (e: KeyboardEvent) => {\r\n        const tag = (e.target as HTMLElement).tagName;\r\n        if (tag === \"INPUT\" || tag === \"SELECT\" || tag === \"TEXTAREA\") e.stopPropagation();\r\n    });\r\n\r\n    // ---- OUTPUT RESOLUTION FRAME ----\r\n    // Load saved resolution\r\n    try {\r\n        const saved = localStorage.getItem(RES_KEY);\r\n        if (saved) {\r\n            const parsed = JSON.parse(saved);\r\n            if (parsed.mode) {\r\n                (document.getElementById(\"tb-resolution\") as HTMLSelectElement).value = parsed.mode;\r\n                if (parsed.mode === \"custom\" && parsed.width && parsed.height) {\r\n                    outputResolution = { width: parsed.width, height: parsed.height };\r\n                    const resW = document.getElementById(\"tb-resW\") as HTMLInputElement;\r\n                    const resH = document.getElementById(\"tb-resH\") as HTMLInputElement;\r\n                    resW.value = String(parsed.width);\r\n                    resH.value = String(parsed.height);\r\n                    resW.style.display = \"\";\r\n                    resH.style.display = \"\";\r\n                } else if (parsed.mode !== \"auto\" && parsed.mode !== \"custom\") {\r\n                    const [w, h] = parsed.mode.split(\"x\").map(Number);\r\n                    if (w && h) outputResolution = { width: w, height: h };\r\n                }\r\n            }\r\n        }\r\n    } catch { /* ignore */ }\r\n\r\n    function calcOutputFrame(): void {\r\n        let res = outputResolution;\r\n        if (!res && autoDisplaySize) res = autoDisplaySize;\r\n        if (!res) {\r\n            baseMLMap.outputFrame = null;\r\n            return;\r\n        }\r\n        // Visible workspace area (subtract panels, toolbar 38px, transport 48px)\r\n        const panelL = leftVisible ? 210 : 0;\r\n        const panelR = rightVisible ? 270 : 0;\r\n        const availW = window.innerWidth - panelL - panelR;\r\n        const availH = window.innerHeight - 38 - 48;\r\n        const oAspect = res.width / res.height;\r\n        const eAspect = availW / availH;\r\n\r\n        // Fit frame within 90% of available workspace\r\n        let fw: number, fh: number;\r\n        if (oAspect > eAspect) {\r\n            fw = availW * 0.9;\r\n            fh = fw / oAspect;\r\n        } else {\r\n            fh = availH * 0.9;\r\n            fw = fh * oAspect;\r\n        }\r\n\r\n        // Center the frame in the visible workspace area (in full window coords)\r\n        const fx = panelL + (availW - fw) / 2;\r\n        const fy = 38 + (availH - fh) / 2;\r\n        baseMLMap.outputFrame = { x: fx, y: fy, w: fw, h: fh, resW: res.width, resH: res.height };\r\n\r\n        // Auto-zoom: if the frame at zoom=1 would overflow, reduce zoom to fit\r\n        // The frame is already sized to fit at zoom=1, but the canvas draws with\r\n        // zoom scaling centered on viewport center, so we need to ensure the frame\r\n        // is fully visible after the zoom transform.\r\n        // Compute the zoom needed for the output resolution to fit in the visible area.\r\n        const needW = res.width;\r\n        const needH = res.height;\r\n        const zoomW = availW / needW;\r\n        const zoomH = availH / needH;\r\n        let autoZoom = Math.min(zoomW, zoomH) * 0.9; // 90% margin\r\n        autoZoom = Math.max(0.1, Math.min(1, autoZoom)); // clamp to [0.1, 1]\r\n\r\n        // Only reduce zoom, never increase above current if user zoomed out more\r\n        const currentZoom = parseInt(zoomSlider.value) / 100;\r\n        if (autoZoom < currentZoom) {\r\n            const pct = Math.round(autoZoom * 100);\r\n            zoomSlider.value = String(pct);\r\n            zoomLabel.textContent = `${pct}%`;\r\n            workspace.style.transform = autoZoom < 1 ? `scale(${autoZoom})` : \"\";\r\n            baseMLMap.setWorkspaceZoom(autoZoom);\r\n            clipMaskRenderer.zoom = autoZoom;\r\n        }\r\n    }\r\n\r\n    function applyResolution(): void {\r\n        const sel = (document.getElementById(\"tb-resolution\") as HTMLSelectElement).value;\r\n        const resW = document.getElementById(\"tb-resW\") as HTMLInputElement;\r\n        const resH = document.getElementById(\"tb-resH\") as HTMLInputElement;\r\n\r\n        if (sel === \"auto\") {\r\n            outputResolution = null;\r\n            resW.style.display = \"none\";\r\n            resH.style.display = \"none\";\r\n        } else if (sel === \"custom\") {\r\n            resW.style.display = \"\";\r\n            resH.style.display = \"\";\r\n            const w = parseInt(resW.value) || 0;\r\n            const h = parseInt(resH.value) || 0;\r\n            outputResolution = (w > 0 && h > 0) ? { width: w, height: h } : null;\r\n        } else {\r\n            resW.style.display = \"none\";\r\n            resH.style.display = \"none\";\r\n            const [w, h] = sel.split(\"x\").map(Number);\r\n            outputResolution = (w && h) ? { width: w, height: h } : null;\r\n        }\r\n\r\n        localStorage.setItem(RES_KEY, JSON.stringify({\r\n            mode: sel,\r\n            width: outputResolution?.width,\r\n            height: outputResolution?.height,\r\n        }));\r\n        calcOutputFrame();\r\n    }\r\n\r\n    (document.getElementById(\"tb-resolution\") as HTMLSelectElement).addEventListener(\"change\", applyResolution);\r\n    (document.getElementById(\"tb-resW\") as HTMLInputElement).addEventListener(\"input\", applyResolution);\r\n    (document.getElementById(\"tb-resH\") as HTMLInputElement).addEventListener(\"input\", applyResolution);\r\n    // Stop key propagation from resolution inputs\r\n    (document.getElementById(\"tb-resW\") as HTMLInputElement).addEventListener(\"keydown\", (e) => e.stopPropagation());\r\n    (document.getElementById(\"tb-resH\") as HTMLInputElement).addEventListener(\"keydown\", (e) => e.stopPropagation());\r\n\r\n    // Recalc frame on window resize\r\n    window.addEventListener(\"resize\", () => calcOutputFrame());\r\n\r\n    // Handle DISPLAY_RESIZE from output window\r\n    bridge.on(\"DISPLAY_RESIZE\", (p: { width: number; height: number }) => {\r\n        autoDisplaySize = { width: p.width, height: p.height };\r\n        const sel = (document.getElementById(\"tb-resolution\") as HTMLSelectElement).value;\r\n        if (sel === \"auto\") calcOutputFrame();\r\n    });\r\n\r\n    // Initial frame calculation\r\n    calcOutputFrame();\r\n\r\n    checkLatestVersion().then(v => {\r\n        if (v.latest !== VERSION) {\r\n            const titleEl = app.querySelector(\".app-title\");\r\n            if (titleEl) titleEl.setAttribute(\"title\", `Update available: v${v.latest}`);\r\n        }\r\n    });\r\n}\r\n", "import { ChannelMessageType, ChannelMessage } from \"../types\";\r\n\r\nexport const CHANNEL_NAME = \"mlmap-sync\";\r\nexport const HEARTBEAT_INTERVAL = 2000;\r\nexport const SYNC_INTERVAL = 500;\r\nexport const HEARTBEAT_TIMEOUT = 6000;\r\n\r\nexport function createMessage(type: ChannelMessageType, payload?: any): ChannelMessage {\r\n    return { type, payload, timestamp: Date.now() };\r\n}\r\n", "import { ChannelMessage, ChannelMessageType } from \"../types\";\r\nimport { CHANNEL_NAME, HEARTBEAT_INTERVAL, HEARTBEAT_TIMEOUT, createMessage } from \"./protocol\";\r\n\r\nexport type ChannelRole = \"control\" | \"display\";\r\n\r\nexport class ChannelBridge {\r\n    private channel: BroadcastChannel;\r\n    private role: ChannelRole;\r\n    private listeners: Map<ChannelMessageType, ((payload: any) => void)[]> = new Map();\r\n    private heartbeatTimer: number | null = null;\r\n    private lastPong: number = 0;\r\n    private _connected: boolean = false;\r\n    private onConnectionChange: ((connected: boolean) => void) | null = null;\r\n\r\n    constructor(role: ChannelRole) {\r\n        this.role = role;\r\n        this.channel = new BroadcastChannel(CHANNEL_NAME);\r\n        this.channel.onmessage = (e: MessageEvent<ChannelMessage>) => this.handleMessage(e.data);\r\n\r\n        if (role === \"control\") {\r\n            this.startHeartbeat();\r\n        }\r\n        if (role === \"display\") {\r\n            this.on(\"PING\", () => this.send(\"PONG\"));\r\n            // Small delay to ensure control's listener is ready\r\n            setTimeout(() => this.send(\"DISPLAY_READY\"), 100);\r\n        }\r\n    }\r\n\r\n    get connected(): boolean { return this._connected; }\r\n\r\n    set onConnectionChanged(cb: ((connected: boolean) => void) | null) {\r\n        this.onConnectionChange = cb;\r\n    }\r\n\r\n    send(type: ChannelMessageType, payload?: any): void {\r\n        try {\r\n            this.channel.postMessage(createMessage(type, payload));\r\n        } catch (e) {\r\n            console.warn(\"ChannelBridge: Failed to send message\", type, e);\r\n        }\r\n    }\r\n\r\n    on(type: ChannelMessageType, callback: (payload: any) => void): void {\r\n        if (!this.listeners.has(type)) this.listeners.set(type, []);\r\n        this.listeners.get(type)!.push(callback);\r\n    }\r\n\r\n    off(type: ChannelMessageType, callback: (payload: any) => void): void {\r\n        const cbs = this.listeners.get(type);\r\n        if (cbs) {\r\n            const idx = cbs.indexOf(callback);\r\n            if (idx >= 0) cbs.splice(idx, 1);\r\n        }\r\n    }\r\n\r\n    destroy(): void {\r\n        if (this.heartbeatTimer) clearInterval(this.heartbeatTimer);\r\n        this.channel.close();\r\n        this.listeners.clear();\r\n    }\r\n\r\n    private handleMessage(msg: ChannelMessage): void {\r\n        if (msg.type === \"PONG\" || msg.type === \"DISPLAY_READY\") {\r\n            this.lastPong = Date.now();\r\n            this.setConnected(true);\r\n        }\r\n        const cbs = this.listeners.get(msg.type);\r\n        if (cbs) cbs.forEach(cb => cb(msg.payload));\r\n    }\r\n\r\n    private startHeartbeat(): void {\r\n        this.heartbeatTimer = window.setInterval(() => {\r\n            this.send(\"PING\");\r\n            if (this._connected && Date.now() - this.lastPong > HEARTBEAT_TIMEOUT) {\r\n                this.setConnected(false);\r\n            }\r\n        }, HEARTBEAT_INTERVAL);\r\n    }\r\n\r\n    private setConnected(val: boolean): void {\r\n        if (this._connected !== val) {\r\n            this._connected = val;\r\n            if (this.onConnectionChange) this.onConnectionChange(val);\r\n        }\r\n    }\r\n}\r\n", "import { VideoSource } from \"../types\";\r\n\r\nconst STORAGE_KEY = \"mlmap:videoSources\";\r\n\r\nexport class VideoSourceManager {\r\n    private sources: VideoSource[] = [];\r\n    private onChange: (() => void) | null = null;\r\n    private liveStreams: Map<string, MediaStream> = new Map();\r\n\r\n    constructor() {\r\n        this.load();\r\n    }\r\n\r\n    set onChanged(cb: (() => void) | null) { this.onChange = cb; }\r\n\r\n    getAll(): VideoSource[] { return [...this.sources]; }\r\n\r\n    getById(id: string): VideoSource | undefined {\r\n        return this.sources.find(s => s.id === id);\r\n    }\r\n\r\n    getStream(sourceId: string): MediaStream | undefined {\r\n        return this.liveStreams.get(sourceId);\r\n    }\r\n\r\n    addUrl(url: string, name?: string): VideoSource {\r\n        const fileName = name || url.split(\"/\").pop() || \"video\";\r\n        const source: VideoSource = {\r\n            id: `src-${Date.now()}-${Math.random().toString(36).slice(2, 6)}`,\r\n            name: fileName,\r\n            url,\r\n            type: \"url\",\r\n        };\r\n        this.sources.push(source);\r\n        this.save();\r\n        this.notify();\r\n        return source;\r\n    }\r\n\r\n    addFile(file: File): VideoSource {\r\n        const blobUrl = URL.createObjectURL(file);\r\n        const source: VideoSource = {\r\n            id: `src-${Date.now()}-${Math.random().toString(36).slice(2, 6)}`,\r\n            name: file.name,\r\n            url: blobUrl,\r\n            type: \"file\",\r\n        };\r\n        this.sources.push(source);\r\n        this.notify();\r\n        return source;\r\n    }\r\n\r\n    addCapture(stream: MediaStream, name: string): VideoSource {\r\n        const id = `src-${Date.now()}-${Math.random().toString(36).slice(2, 6)}`;\r\n        const source: VideoSource = {\r\n            id,\r\n            name,\r\n            url: `capture:${id}`,\r\n            type: \"capture\",\r\n        };\r\n        this.liveStreams.set(id, stream);\r\n        this.sources.push(source);\r\n\r\n        // Clean up when all tracks end\r\n        const tracks = stream.getTracks();\r\n        const checkEnded = () => {\r\n            if (tracks.every(t => t.readyState === \"ended\")) {\r\n                this.liveStreams.delete(id);\r\n            }\r\n        };\r\n        tracks.forEach(t => t.addEventListener(\"ended\", checkEnded));\r\n\r\n        this.notify();\r\n        return source;\r\n    }\r\n\r\n    remove(id: string): void {\r\n        const idx = this.sources.findIndex(s => s.id === id);\r\n        if (idx >= 0) {\r\n            const src = this.sources[idx];\r\n            if (src.type === \"file\" && src.url.startsWith(\"blob:\")) {\r\n                URL.revokeObjectURL(src.url);\r\n            }\r\n            if (src.type === \"capture\") {\r\n                const stream = this.liveStreams.get(id);\r\n                if (stream) {\r\n                    stream.getTracks().forEach(t => t.stop());\r\n                    this.liveStreams.delete(id);\r\n                }\r\n            }\r\n            this.sources.splice(idx, 1);\r\n            this.save();\r\n            this.notify();\r\n        }\r\n    }\r\n\r\n    private save(): void {\r\n        const persistable = this.sources.filter(s => s.type === \"url\");\r\n        localStorage.setItem(STORAGE_KEY, JSON.stringify(persistable));\r\n    }\r\n\r\n    private load(): void {\r\n        try {\r\n            const stored = localStorage.getItem(STORAGE_KEY);\r\n            if (stored) this.sources = JSON.parse(stored);\r\n        } catch {\r\n            this.sources = [];\r\n        }\r\n    }\r\n\r\n    private notify(): void {\r\n        if (this.onChange) this.onChange();\r\n    }\r\n}\r\n", "import { Playlist, PlaylistItem } from \"../types\";\r\n\r\nconst STORAGE_KEY = \"mlmap:playlists\";\r\nconst ACTIVE_KEY = \"mlmap:activePlaylist\";\r\n\r\nexport class PlaylistManager {\r\n    private playlists: Playlist[] = [];\r\n    private activeId: string | null = null;\r\n    private onChange: (() => void) | null = null;\r\n\r\n    constructor() {\r\n        this.load();\r\n    }\r\n\r\n    set onChanged(cb: (() => void) | null) { this.onChange = cb; }\r\n\r\n    getAll(): Playlist[] { return [...this.playlists]; }\r\n\r\n    getActive(): Playlist | null {\r\n        return this.playlists.find(p => p.id === this.activeId) || this.playlists[0] || null;\r\n    }\r\n\r\n    setActive(id: string): void {\r\n        this.activeId = id;\r\n        localStorage.setItem(ACTIVE_KEY, id);\r\n        this.notify();\r\n    }\r\n\r\n    create(name: string): Playlist {\r\n        const playlist: Playlist = {\r\n            id: `pl-${Date.now()}`,\r\n            name,\r\n            items: [],\r\n            loop: true,\r\n        };\r\n        this.playlists.push(playlist);\r\n        if (!this.activeId) this.activeId = playlist.id;\r\n        this.save();\r\n        this.notify();\r\n        return playlist;\r\n    }\r\n\r\n    remove(id: string): void {\r\n        this.playlists = this.playlists.filter(p => p.id !== id);\r\n        if (this.activeId === id) {\r\n            this.activeId = this.playlists[0]?.id || null;\r\n        }\r\n        this.save();\r\n        this.notify();\r\n    }\r\n\r\n    addItem(playlistId: string, sourceId: string): void {\r\n        const pl = this.playlists.find(p => p.id === playlistId);\r\n        if (!pl) return;\r\n        const item: PlaylistItem = {\r\n            id: `item-${Date.now()}-${Math.random().toString(36).slice(2, 6)}`,\r\n            sourceId,\r\n            order: pl.items.length,\r\n        };\r\n        pl.items.push(item);\r\n        this.save();\r\n        this.notify();\r\n    }\r\n\r\n    removeItem(playlistId: string, itemId: string): void {\r\n        const pl = this.playlists.find(p => p.id === playlistId);\r\n        if (!pl) return;\r\n        pl.items = pl.items.filter(i => i.id !== itemId);\r\n        pl.items.forEach((item, idx) => item.order = idx);\r\n        this.save();\r\n        this.notify();\r\n    }\r\n\r\n    moveItem(playlistId: string, itemId: string, direction: \"up\" | \"down\"): void {\r\n        const pl = this.playlists.find(p => p.id === playlistId);\r\n        if (!pl) return;\r\n        const idx = pl.items.findIndex(i => i.id === itemId);\r\n        if (idx < 0) return;\r\n        const newIdx = direction === \"up\" ? idx - 1 : idx + 1;\r\n        if (newIdx < 0 || newIdx >= pl.items.length) return;\r\n        [pl.items[idx], pl.items[newIdx]] = [pl.items[newIdx], pl.items[idx]];\r\n        pl.items.forEach((item, i) => item.order = i);\r\n        this.save();\r\n        this.notify();\r\n    }\r\n\r\n    toggleLoop(playlistId: string): void {\r\n        const pl = this.playlists.find(p => p.id === playlistId);\r\n        if (!pl) return;\r\n        pl.loop = !pl.loop;\r\n        this.save();\r\n        this.notify();\r\n    }\r\n\r\n    private save(): void {\r\n        localStorage.setItem(STORAGE_KEY, JSON.stringify(this.playlists));\r\n        if (this.activeId) localStorage.setItem(ACTIVE_KEY, this.activeId);\r\n    }\r\n\r\n    private load(): void {\r\n        try {\r\n            const stored = localStorage.getItem(STORAGE_KEY);\r\n            if (stored) {\r\n                this.playlists = JSON.parse(stored);\r\n            } else {\r\n                this.create(\"Default\");\r\n            }\r\n            this.activeId = localStorage.getItem(ACTIVE_KEY) || this.playlists[0]?.id || null;\r\n        } catch {\r\n            this.create(\"Default\");\r\n        }\r\n    }\r\n\r\n    private notify(): void {\r\n        if (this.onChange) this.onChange();\r\n    }\r\n}\r\n", "import { ChannelBridge } from \"../channel\";\r\nimport { VideoSourceManager } from \"../video/sources\";\r\nimport { PlaylistManager } from \"../video/playlist\";\r\n\r\nfunction formatTime(seconds: number): string {\r\n    if (!isFinite(seconds) || isNaN(seconds)) return \"0:00\";\r\n    const m = Math.floor(seconds / 60);\r\n    const s = Math.floor(seconds % 60);\r\n    return `${m}:${s.toString().padStart(2, \"0\")}`;\r\n}\r\n\r\nexport function initVideoUI(\r\n    mediaContainer: HTMLElement,\r\n    transportContainer: HTMLElement,\r\n    bridge: ChannelBridge,\r\n    onAddVideoLayer: (url: string, name: string, stream?: MediaStream) => void,\r\n): {\r\n    sourceManager: VideoSourceManager;\r\n    playlistManager: PlaylistManager;\r\n    sendPlaylistToDisplay: () => void;\r\n    syncPlaybackToDisplay: () => void;\r\n    registerVideoElement: (video: HTMLVideoElement) => void;\r\n    setActiveVideo: (video: HTMLVideoElement) => void;\r\n    getActiveVideo: () => HTMLVideoElement | null;\r\n    togglePlayPause: () => void;\r\n} {\r\n    const sourceManager = new VideoSourceManager();\r\n    const playlistManager = new PlaylistManager();\r\n\r\n    // ---- LOCAL VIDEO STATE ----\r\n    let localVideo: HTMLVideoElement | null = null;\r\n    let localPlaylistIndex = 0;\r\n\r\n    // ---- MEDIA LIBRARY (right panel) ----\r\n    mediaContainer.innerHTML = `\r\n        <div class=\"mlmap-section\">\r\n            <div class=\"mlmap-section-title\">Media Library</div>\r\n            <div style=\"display:flex;gap:4px;margin-bottom:4px;\">\r\n                <input id=\"vp-url\" type=\"text\" class=\"mlmap-input\" placeholder=\"Video URL...\" style=\"flex:1;min-width:0;\">\r\n                <button id=\"vp-addUrl\" class=\"mlmap-btn\">Add</button>\r\n            </div>\r\n            <div style=\"display:flex;gap:4px;margin-bottom:6px;\">\r\n                <input id=\"vp-file\" type=\"file\" accept=\"video/*\" style=\"display:none;\">\r\n                <button id=\"vp-chooseFile\" class=\"mlmap-btn\" style=\"flex:1;\">Browse file...</button>\r\n            </div>\r\n            <div style=\"display:flex;gap:4px;margin-bottom:6px;\">\r\n                <button id=\"vp-capture\" class=\"mlmap-btn\" style=\"flex:1;\">Screen capture...</button>\r\n                <button id=\"vp-webcam\" class=\"mlmap-btn\" style=\"flex:1;\">Webcam...</button>\r\n            </div>\r\n            <div style=\"display:flex;align-items:center;gap:4px;margin-bottom:6px;\">\r\n                <label style=\"font-size:10px;color:#aaa;display:flex;align-items:center;gap:4px;cursor:pointer;\">\r\n                    <input id=\"vp-showCursor\" type=\"checkbox\" style=\"margin:0;\">\r\n                    Show cursor in capture\r\n                </label>\r\n            </div>\r\n            <div id=\"vp-library\"></div>\r\n        </div>\r\n        <div class=\"mlmap-section\">\r\n            <div class=\"mlmap-section-title\">Playlist</div>\r\n            <div style=\"display:flex;gap:4px;align-items:center;margin-bottom:6px;\">\r\n                <select id=\"vp-plSelect\" class=\"mlmap-select\" style=\"flex:1;min-width:0;\"></select>\r\n                <button id=\"vp-plNew\" class=\"mlmap-btn\" title=\"New playlist\">+</button>\r\n                <button id=\"vp-plDel\" class=\"mlmap-btn\" title=\"Delete playlist\">-</button>\r\n            </div>\r\n            <div id=\"vp-playlist\" style=\"margin-bottom:4px;\"></div>\r\n            <button id=\"vp-loop\" class=\"mlmap-btn\" style=\"width:100%;font-size:10px;\">Loop: ON</button>\r\n        </div>\r\n    `;\r\n\r\n    // ---- TRANSPORT BAR (bottom) ----\r\n    transportContainer.innerHTML = `\r\n        <div style=\"display:flex;align-items:center;gap:3px;\">\r\n            <button id=\"tp-prev\" class=\"transport-btn\" title=\"Previous\">|&lt;</button>\r\n            <button id=\"tp-rw\" class=\"transport-btn\" title=\"-10s\">&lt;&lt;</button>\r\n            <button id=\"tp-play\" class=\"transport-btn\" title=\"Play\" style=\"width:38px;font-size:14px;\">&#9654;</button>\r\n            <button id=\"tp-ff\" class=\"transport-btn\" title=\"+10s\">&gt;&gt;</button>\r\n            <button id=\"tp-next\" class=\"transport-btn\" title=\"Next\">&gt;|</button>\r\n            <button id=\"tp-stop\" class=\"transport-btn\" title=\"Stop\">&#9632;</button>\r\n        </div>\r\n        <input id=\"tp-seek\" type=\"range\" min=\"0\" max=\"1000\" value=\"0\" step=\"1\" class=\"mlmap-range\" style=\"flex:1;min-width:80px;\">\r\n        <span id=\"tp-time\" style=\"font-size:11px;white-space:nowrap;color:#aaa;min-width:85px;text-align:center;\">0:00 / 0:00</span>\r\n        <span id=\"tp-now\" style=\"flex:1;font-size:11px;color:#888;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:center;\">No media</span>\r\n        <div style=\"display:flex;align-items:center;gap:4px;\">\r\n            <span style=\"font-size:10px;color:#666;\">Vol</span>\r\n            <input id=\"tp-vol\" type=\"range\" min=\"0\" max=\"100\" value=\"100\" class=\"mlmap-range\" style=\"width:70px;\">\r\n            <button id=\"tp-mute\" class=\"transport-btn\" style=\"width:28px;font-size:10px;\" title=\"Mute/Unmute\">M</button>\r\n        </div>\r\n        <select id=\"tp-audioOut\" class=\"mlmap-select\" style=\"max-width:120px;font-size:10px;\" title=\"Audio output routing\">\r\n            <option value=\"editor\">Audio: Editor</option>\r\n            <option value=\"output\">Audio: Output</option>\r\n            <option value=\"both\">Audio: Both</option>\r\n        </select>\r\n    `;\r\n\r\n    const $ = (id: string) => document.getElementById(id) as HTMLElement;\r\n\r\n    // ---- LOCAL VIDEO MANAGEMENT ----\r\n    function registerVideoElement(video: HTMLVideoElement): void {\r\n        localVideo = video;\r\n        video.addEventListener(\"timeupdate\", updateTransportUI);\r\n        video.addEventListener(\"play\", () => {\r\n            // Apply audio routing when video starts playing so auto-play\r\n            // captures/clip-masks get the correct mute state immediately\r\n            if (localVideo === video) applyAudioRouting();\r\n            updateTransportUI();\r\n        });\r\n        video.addEventListener(\"pause\", updateTransportUI);\r\n        video.addEventListener(\"ended\", onLocalVideoEnded);\r\n        video.addEventListener(\"loadedmetadata\", updateTransportUI);\r\n    }\r\n\r\n    function loadPlaylistItem(index: number): void {\r\n        const active = playlistManager.getActive();\r\n        if (!active || !active.items[index] || !localVideo) return;\r\n        localPlaylistIndex = index;\r\n        const item = active.items[index];\r\n        const src = sourceManager.getById(item.sourceId);\r\n        if (!src) return;\r\n        localVideo.src = src.url;\r\n        localVideo.load();\r\n    }\r\n\r\n    function localNext(): void {\r\n        const active = playlistManager.getActive();\r\n        if (!active || active.items.length === 0) return;\r\n        localPlaylistIndex++;\r\n        if (localPlaylistIndex >= active.items.length) {\r\n            if (active.loop) localPlaylistIndex = 0;\r\n            else { localPlaylistIndex = active.items.length - 1; return; }\r\n        }\r\n        loadPlaylistItem(localPlaylistIndex);\r\n        if (localVideo) localVideo.play().catch(() => {});\r\n        bridge.send(\"NEXT\");\r\n    }\r\n\r\n    function localPrev(): void {\r\n        const active = playlistManager.getActive();\r\n        if (!active || active.items.length === 0) return;\r\n        localPlaylistIndex--;\r\n        if (localPlaylistIndex < 0) {\r\n            if (active.loop) localPlaylistIndex = active.items.length - 1;\r\n            else { localPlaylistIndex = 0; return; }\r\n        }\r\n        loadPlaylistItem(localPlaylistIndex);\r\n        if (localVideo) localVideo.play().catch(() => {});\r\n        bridge.send(\"PREVIOUS\");\r\n    }\r\n\r\n    function onLocalVideoEnded(): void {\r\n        const active = playlistManager.getActive();\r\n        if (active && active.items.length > 1) localNext();\r\n        else if (active && active.loop && localVideo) {\r\n            localVideo.currentTime = 0;\r\n            localVideo.play().catch(() => {});\r\n            // Sync loop restart to display\r\n            bridge.send(\"SEEK\", { time: 0 });\r\n            bridge.send(\"PLAY\");\r\n        }\r\n    }\r\n\r\n    function getCurrentSourceName(): string {\r\n        const active = playlistManager.getActive();\r\n        if (active && active.items[localPlaylistIndex]) {\r\n            const src = sourceManager.getById(active.items[localPlaylistIndex].sourceId);\r\n            if (src) return src.name;\r\n        }\r\n        if (localVideo && localVideo.src && localVideo.src !== window.location.href) {\r\n            const parts = localVideo.src.split(\"/\");\r\n            return parts[parts.length - 1] || \"Video\";\r\n        }\r\n        return \"\";\r\n    }\r\n\r\n    // ---- BIND EVENTS ----\r\n\r\n    // Add URL\r\n    $(\"vp-addUrl\").addEventListener(\"click\", () => {\r\n        const input = $(\"vp-url\") as HTMLInputElement;\r\n        const url = input.value.trim();\r\n        if (url) {\r\n            sourceManager.addUrl(url);\r\n            input.value = \"\";\r\n            renderLibrary();\r\n        }\r\n    });\r\n\r\n    ($(\"vp-url\") as HTMLInputElement).addEventListener(\"keydown\", (e: KeyboardEvent) => {\r\n        e.stopPropagation();\r\n        if (e.key === \"Enter\") ($(\"vp-addUrl\")).click();\r\n    });\r\n\r\n    // Add File\r\n    $(\"vp-chooseFile\").addEventListener(\"click\", () => ($(\"vp-file\") as HTMLInputElement).click());\r\n    ($(\"vp-file\") as HTMLInputElement).addEventListener(\"change\", (e: Event) => {\r\n        const input = e.target as HTMLInputElement;\r\n        if (input.files && input.files[0]) {\r\n            sourceManager.addFile(input.files[0]);\r\n            renderLibrary();\r\n            input.value = \"\";\r\n        }\r\n    });\r\n\r\n    // Cursor toggle persistence\r\n    const cursorCheckbox = $(\"vp-showCursor\") as HTMLInputElement;\r\n    cursorCheckbox.checked = localStorage.getItem(\"mlmap:showCursor\") !== \"false\";\r\n    cursorCheckbox.addEventListener(\"change\", () => {\r\n        localStorage.setItem(\"mlmap:showCursor\", String(cursorCheckbox.checked));\r\n    });\r\n\r\n    // Screen Capture\r\n    $(\"vp-capture\").addEventListener(\"click\", async () => {\r\n        try {\r\n            const cursor = cursorCheckbox.checked ? \"always\" : \"never\";\r\n            const stream = await navigator.mediaDevices.getDisplayMedia({\r\n                video: { cursor } as any,\r\n                audio: true,\r\n            });\r\n            const track = stream.getVideoTracks()[0];\r\n            const label = track?.label || \"Screen Capture\";\r\n            const src = sourceManager.addCapture(stream, label);\r\n            renderLibrary();\r\n            onAddVideoLayer(src.url, src.name, stream);\r\n        } catch {\r\n            // User cancelled the capture picker\r\n        }\r\n    });\r\n\r\n    // Webcam / Camera\r\n    $(\"vp-webcam\").addEventListener(\"click\", async () => {\r\n        try {\r\n            // Enumerate cameras for the user to choose\r\n            const devices = await navigator.mediaDevices.enumerateDevices();\r\n            const cameras = devices.filter(d => d.kind === \"videoinput\");\r\n\r\n            let constraints: MediaStreamConstraints = { video: true, audio: true };\r\n            if (cameras.length > 1) {\r\n                // Let user pick camera\r\n                const options = cameras.map((c, i) => `${i + 1}. ${c.label || `Camera ${i + 1}`}`).join(\"\\n\");\r\n                const choice = prompt(`Select camera:\\n${options}`, \"1\");\r\n                if (!choice) return;\r\n                const idx = parseInt(choice) - 1;\r\n                if (idx >= 0 && idx < cameras.length) {\r\n                    constraints = { video: { deviceId: { exact: cameras[idx].deviceId } }, audio: true };\r\n                }\r\n            }\r\n\r\n            const stream = await navigator.mediaDevices.getUserMedia(constraints);\r\n            const track = stream.getVideoTracks()[0];\r\n            const label = track?.label || \"Webcam\";\r\n            const src = sourceManager.addCapture(stream, label);\r\n            renderLibrary();\r\n            onAddVideoLayer(src.url, src.name, stream);\r\n        } catch {\r\n            // User denied permission or cancelled\r\n        }\r\n    });\r\n\r\n    // Playlist selector\r\n    ($(\"vp-plSelect\") as HTMLSelectElement).addEventListener(\"change\", (e) => {\r\n        playlistManager.setActive((e.target as HTMLSelectElement).value);\r\n        renderPlaylist();\r\n    });\r\n\r\n    $(\"vp-plNew\").addEventListener(\"click\", () => {\r\n        const name = prompt(\"Playlist name:\", \"New Playlist\");\r\n        if (name) {\r\n            const pl = playlistManager.create(name);\r\n            playlistManager.setActive(pl.id);\r\n            renderPlaylistSelector();\r\n            renderPlaylist();\r\n        }\r\n    });\r\n\r\n    $(\"vp-plDel\").addEventListener(\"click\", () => {\r\n        const active = playlistManager.getActive();\r\n        if (active && playlistManager.getAll().length > 1) {\r\n            playlistManager.remove(active.id);\r\n            renderPlaylistSelector();\r\n            renderPlaylist();\r\n        }\r\n    });\r\n\r\n    $(\"vp-loop\").addEventListener(\"click\", () => {\r\n        const active = playlistManager.getActive();\r\n        if (active) {\r\n            playlistManager.toggleLoop(active.id);\r\n            renderPlaylist();\r\n        }\r\n    });\r\n\r\n    // ---- AUDIO ROUTING ----\r\n    const AUDIO_MODE_KEY = \"mlmap:audioMode\";\r\n    let audioMode: \"editor\" | \"output\" | \"both\" =\r\n        (localStorage.getItem(AUDIO_MODE_KEY) as \"editor\" | \"output\" | \"both\") || \"editor\";\r\n    let userMuted = false;\r\n\r\n    function applyAudioRouting(): void {\r\n        if (localVideo) {\r\n            localVideo.muted = userMuted || audioMode === \"output\";\r\n        }\r\n        bridge.send(\"SET_MUTED\", { muted: userMuted || audioMode === \"editor\" });\r\n        updateTransportUI();\r\n    }\r\n\r\n    function syncPlaybackToDisplay(): void {\r\n        if (!localVideo) return;\r\n        bridge.send(\"SEEK\", { time: localVideo.currentTime });\r\n        if (!localVideo.paused) {\r\n            bridge.send(\"PLAY\");\r\n        } else {\r\n            bridge.send(\"PAUSE\");\r\n        }\r\n        bridge.send(\"SET_VOLUME\", { volume: localVideo.volume });\r\n        bridge.send(\"SET_MUTED\", { muted: userMuted || audioMode === \"editor\" });\r\n    }\r\n\r\n    // ---- TRANSPORT CONTROLS (local + remote) ----\r\n    $(\"tp-play\").addEventListener(\"click\", () => {\r\n        // Auto-create video layer if needed\r\n        if (!localVideo) {\r\n            const active = playlistManager.getActive();\r\n            if (active && active.items.length > 0) {\r\n                const item = active.items[0];\r\n                const src = sourceManager.getById(item.sourceId);\r\n                if (src) {\r\n                    onAddVideoLayer(src.url, src.name);\r\n                    setTimeout(() => {\r\n                        if (localVideo) {\r\n                            userMuted = false;\r\n                            applyAudioRouting();\r\n                            loadPlaylistItem(0);\r\n                            setTimeout(() => {\r\n                                if (localVideo) localVideo.play().catch(() => {});\r\n                                sendPlaylistToDisplay();\r\n                                bridge.send(\"PLAY\");\r\n                                updateTransportUI();\r\n                            }, 200);\r\n                        }\r\n                    }, 100);\r\n                }\r\n            }\r\n            return;\r\n        }\r\n\r\n        if (localVideo.paused) {\r\n            // User gesture: unmute according to audio routing\r\n            userMuted = false;\r\n            applyAudioRouting();\r\n            // If no source loaded, load first playlist item\r\n            if (!localVideo.src || localVideo.src === window.location.href) {\r\n                const active = playlistManager.getActive();\r\n                if (active && active.items.length > 0) {\r\n                    loadPlaylistItem(0);\r\n                    setTimeout(() => {\r\n                        if (localVideo) localVideo.play().catch(() => {});\r\n                        updateTransportUI();\r\n                    }, 200);\r\n                }\r\n            } else {\r\n                localVideo.play().catch(() => {});\r\n            }\r\n            bridge.send(\"PLAY\");\r\n            updateTransportUI();\r\n        } else {\r\n            localVideo.pause();\r\n            bridge.send(\"PAUSE\");\r\n        }\r\n    });\r\n\r\n    $(\"tp-stop\").addEventListener(\"click\", () => {\r\n        if (localVideo) {\r\n            localVideo.pause();\r\n            localVideo.currentTime = 0;\r\n        }\r\n        bridge.send(\"STOP\");\r\n        updateTransportUI();\r\n    });\r\n\r\n    $(\"tp-prev\").addEventListener(\"click\", () => localPrev());\r\n    $(\"tp-next\").addEventListener(\"click\", () => localNext());\r\n\r\n    $(\"tp-rw\").addEventListener(\"click\", () => {\r\n        if (localVideo) {\r\n            const t = Math.max(0, localVideo.currentTime - 10);\r\n            localVideo.currentTime = t;\r\n            bridge.send(\"SEEK\", { time: t });\r\n        }\r\n    });\r\n\r\n    $(\"tp-ff\").addEventListener(\"click\", () => {\r\n        if (localVideo) {\r\n            const t = localVideo.currentTime + 10;\r\n            localVideo.currentTime = t;\r\n            bridge.send(\"SEEK\", { time: t });\r\n        }\r\n    });\r\n\r\n    // Seek bar - use input event for live dragging\r\n    const seekBar = $(\"tp-seek\") as HTMLInputElement;\r\n    let seekDragging = false;\r\n    seekBar.addEventListener(\"pointerdown\", () => { seekDragging = true; });\r\n    seekBar.addEventListener(\"pointerup\", () => { seekDragging = false; });\r\n    seekBar.addEventListener(\"input\", () => {\r\n        if (localVideo && localVideo.duration > 0) {\r\n            const time = (parseInt(seekBar.value) / 1000) * localVideo.duration;\r\n            localVideo.currentTime = time;\r\n            bridge.send(\"SEEK\", { time });\r\n        }\r\n    });\r\n\r\n    // Volume & Mute\r\n    ($(\"tp-vol\") as HTMLInputElement).addEventListener(\"input\", (e) => {\r\n        const vol = parseInt((e.target as HTMLInputElement).value) / 100;\r\n        if (localVideo) localVideo.volume = vol;\r\n        bridge.send(\"SET_VOLUME\", { volume: vol });\r\n    });\r\n\r\n    $(\"tp-mute\").addEventListener(\"click\", () => {\r\n        userMuted = !userMuted;\r\n        applyAudioRouting();\r\n    });\r\n\r\n    // Set initial audio routing selector from saved preference\r\n    ($(\"tp-audioOut\") as HTMLSelectElement).value = audioMode;\r\n\r\n    ($(\"tp-audioOut\") as HTMLSelectElement).addEventListener(\"change\", (e) => {\r\n        audioMode = (e.target as HTMLSelectElement).value as \"editor\" | \"output\" | \"both\";\r\n        localStorage.setItem(AUDIO_MODE_KEY, audioMode);\r\n        applyAudioRouting();\r\n    });\r\n\r\n    function setActiveVideo(video: HTMLVideoElement): void {\r\n        // Mute old active video\r\n        if (localVideo && localVideo !== video) localVideo.muted = true;\r\n        localVideo = video;\r\n        video.addEventListener(\"timeupdate\", updateTransportUI);\r\n        video.addEventListener(\"play\", () => {\r\n            if (localVideo === video) applyAudioRouting();\r\n            updateTransportUI();\r\n        });\r\n        video.addEventListener(\"pause\", updateTransportUI);\r\n        video.addEventListener(\"ended\", onLocalVideoEnded);\r\n        video.addEventListener(\"loadedmetadata\", updateTransportUI);\r\n        applyAudioRouting();\r\n    }\r\n\r\n    // Stop key propagation from panel inputs\r\n    mediaContainer.addEventListener(\"keydown\", (e: KeyboardEvent) => {\r\n        const tag = (e.target as HTMLElement).tagName;\r\n        if (tag === \"INPUT\" || tag === \"SELECT\" || tag === \"TEXTAREA\") e.stopPropagation();\r\n    });\r\n\r\n    // ---- UI UPDATE (reads from local video) ----\r\n    function updateTransportUI(): void {\r\n        const v = localVideo;\r\n        const playing = v ? !v.paused : false;\r\n        const currentTime = v?.currentTime || 0;\r\n        const duration = v?.duration || 0;\r\n\r\n        ($(\"tp-play\") as HTMLButtonElement).innerHTML = playing ? \"&#9646;&#9646;\" : \"&#9654;\";\r\n\r\n        if (duration > 0 && !seekDragging) {\r\n            seekBar.value = String(Math.round((currentTime / duration) * 1000));\r\n        }\r\n\r\n        ($(\"tp-time\")).textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;\r\n\r\n        const name = getCurrentSourceName();\r\n        ($(\"tp-now\")).textContent = name || \"No media\";\r\n\r\n        if (v) {\r\n            ($(\"tp-vol\") as HTMLInputElement).value = String(Math.round(v.volume * 100));\r\n            const muteBtn = $(\"tp-mute\") as HTMLButtonElement;\r\n            muteBtn.textContent = userMuted ? \"M\" : \"\\u266A\";\r\n            muteBtn.style.color = userMuted ? \"#f55\" : \"#ccc\";\r\n        }\r\n    }\r\n\r\n    // ---- RENDERING ----\r\n    function renderLibrary(): void {\r\n        const el = $(\"vp-library\");\r\n        if (!el) return;\r\n        const sources = sourceManager.getAll();\r\n        el.innerHTML = \"\";\r\n        if (sources.length === 0) {\r\n            el.innerHTML = '<div style=\"color:#555;font-size:11px;padding:4px;\">No media added yet</div>';\r\n            return;\r\n        }\r\n        sources.forEach(src => {\r\n            const row = document.createElement(\"div\");\r\n            row.className = \"mlmap-media-item\";\r\n\r\n            const name = document.createElement(\"span\");\r\n            name.className = \"name\";\r\n            name.textContent = src.type === \"capture\" ? `[LIVE] ${src.name}` : src.name;\r\n            name.title = src.type === \"capture\" ? \"Screen capture\" : src.url;\r\n            if (src.type === \"capture\") name.style.color = \"#5f5\";\r\n\r\n            const btns = document.createElement(\"span\");\r\n            btns.style.cssText = \"display:flex;gap:2px;flex-shrink:0;\";\r\n\r\n            const layerBtn = document.createElement(\"button\");\r\n            layerBtn.className = \"mlmap-btn\";\r\n            layerBtn.textContent = \"Layer\";\r\n            layerBtn.title = \"Create video layer\";\r\n            layerBtn.style.cssText = \"font-size:10px;padding:2px 4px;\";\r\n            layerBtn.addEventListener(\"click\", () => {\r\n                const stream = sourceManager.getStream(src.id);\r\n                onAddVideoLayer(src.url, src.name, stream);\r\n            });\r\n\r\n            // Only show +PL for non-capture sources\r\n            const plBtn = document.createElement(\"button\");\r\n            if (src.type !== \"capture\") {\r\n                plBtn.className = \"mlmap-btn\";\r\n                plBtn.textContent = \"+PL\";\r\n                plBtn.title = \"Add to playlist\";\r\n                plBtn.style.cssText = \"font-size:10px;padding:2px 4px;\";\r\n                plBtn.addEventListener(\"click\", () => {\r\n                    const active = playlistManager.getActive();\r\n                    if (active) {\r\n                        playlistManager.addItem(active.id, src.id);\r\n                        renderPlaylist();\r\n                    }\r\n                });\r\n            }\r\n\r\n            const delBtn = document.createElement(\"button\");\r\n            delBtn.className = \"mlmap-btn\";\r\n            delBtn.textContent = \"x\";\r\n            delBtn.title = \"Remove\";\r\n            delBtn.style.cssText = \"font-size:10px;padding:2px 4px;color:#f55;\";\r\n            delBtn.addEventListener(\"click\", () => {\r\n                sourceManager.remove(src.id);\r\n                renderLibrary();\r\n            });\r\n\r\n            btns.appendChild(layerBtn);\r\n            btns.appendChild(plBtn);\r\n            btns.appendChild(delBtn);\r\n            row.appendChild(name);\r\n            row.appendChild(btns);\r\n            el.appendChild(row);\r\n        });\r\n    }\r\n\r\n    function renderPlaylistSelector(): void {\r\n        const sel = $(\"vp-plSelect\") as HTMLSelectElement;\r\n        if (!sel) return;\r\n        const playlists = playlistManager.getAll();\r\n        const active = playlistManager.getActive();\r\n        sel.innerHTML = \"\";\r\n        playlists.forEach(pl => {\r\n            const opt = document.createElement(\"option\");\r\n            opt.value = pl.id;\r\n            opt.textContent = pl.name;\r\n            if (active && active.id === pl.id) opt.selected = true;\r\n            sel.appendChild(opt);\r\n        });\r\n    }\r\n\r\n    function renderPlaylist(): void {\r\n        const el = $(\"vp-playlist\");\r\n        if (!el) return;\r\n        const active = playlistManager.getActive();\r\n        el.innerHTML = \"\";\r\n        if (!active) return;\r\n\r\n        ($(\"vp-loop\") as HTMLButtonElement).textContent = `Loop: ${active.loop ? \"ON\" : \"OFF\"}`;\r\n\r\n        if (active.items.length === 0) {\r\n            el.innerHTML = '<div style=\"color:#555;font-size:11px;padding:4px;\">Playlist empty</div>';\r\n            return;\r\n        }\r\n\r\n        active.items.forEach((item, idx) => {\r\n            const src = sourceManager.getById(item.sourceId);\r\n            const row = document.createElement(\"div\");\r\n            row.className = \"mlmap-pl-item\";\r\n\r\n            const label = document.createElement(\"span\");\r\n            label.className = \"name\";\r\n            label.textContent = `${idx + 1}. ${src?.name || \"Unknown\"}`;\r\n\r\n            const btns = document.createElement(\"span\");\r\n            btns.style.cssText = \"display:flex;gap:1px;flex-shrink:0;\";\r\n\r\n            const upBtn = document.createElement(\"button\");\r\n            upBtn.className = \"mlmap-btn\";\r\n            upBtn.innerHTML = \"&#9650;\";\r\n            upBtn.style.cssText = \"font-size:8px;padding:1px 3px;\";\r\n            upBtn.addEventListener(\"click\", () => { playlistManager.moveItem(active.id, item.id, \"up\"); renderPlaylist(); });\r\n\r\n            const downBtn = document.createElement(\"button\");\r\n            downBtn.className = \"mlmap-btn\";\r\n            downBtn.innerHTML = \"&#9660;\";\r\n            downBtn.style.cssText = \"font-size:8px;padding:1px 3px;\";\r\n            downBtn.addEventListener(\"click\", () => { playlistManager.moveItem(active.id, item.id, \"down\"); renderPlaylist(); });\r\n\r\n            const delBtn = document.createElement(\"button\");\r\n            delBtn.className = \"mlmap-btn\";\r\n            delBtn.textContent = \"x\";\r\n            delBtn.style.cssText = \"font-size:9px;padding:1px 3px;color:#f55;\";\r\n            delBtn.addEventListener(\"click\", () => { playlistManager.removeItem(active.id, item.id); renderPlaylist(); });\r\n\r\n            btns.appendChild(upBtn);\r\n            btns.appendChild(downBtn);\r\n            btns.appendChild(delBtn);\r\n            row.appendChild(label);\r\n            row.appendChild(btns);\r\n            el.appendChild(row);\r\n        });\r\n    }\r\n\r\n    function sendPlaylistToDisplay(): void {\r\n        const active = playlistManager.getActive();\r\n        if (!active) return;\r\n        const items = active.items.map(item => {\r\n            const src = sourceManager.getById(item.sourceId);\r\n            return { url: src?.url || \"\", name: src?.name || \"Unknown\" };\r\n        }).filter(i => i.url);\r\n        bridge.send(\"LOAD_PLAYLIST\", { items, loop: active.loop, startIndex: localPlaylistIndex });\r\n    }\r\n\r\n    function togglePlayPause(): void {\r\n        // Simulate clicking the play button (handles all the logic)\r\n        ($(\"tp-play\") as HTMLButtonElement).click();\r\n    }\r\n\r\n    // ---- INIT ----\r\n    renderLibrary();\r\n    renderPlaylistSelector();\r\n    renderPlaylist();\r\n\r\n    return {\r\n        sourceManager,\r\n        playlistManager,\r\n        sendPlaylistToDisplay,\r\n        syncPlaybackToDisplay,\r\n        registerVideoElement,\r\n        setActiveVideo,\r\n        getActiveVideo: () => localVideo,\r\n        togglePlayPause,\r\n    };\r\n}\r\n", "import { WorkflowData, VideoSource, Playlist, ManagedLayer } from \"../types\";\r\nimport { VERSION } from \"../lib/data\";\r\n\r\nconst MANAGED_LAYERS_KEY = \"mlmap.managedLayers\";\r\nconst VIDEO_SOURCES_KEY = \"mlmap:videoSources\";\r\nconst PLAYLISTS_KEY = \"mlmap:playlists\";\r\nconst ACTIVE_PLAYLIST_KEY = \"mlmap:activePlaylist\";\r\nconst CURRENT_WS_KEY = \"mlmap:currentWorkspaceId\";\r\n\r\nexport function exportWorkflow(workspaceName?: string): WorkflowData {\r\n    const wsId = localStorage.getItem(CURRENT_WS_KEY) || \"default\";\r\n    const wsRaw = localStorage.getItem(`mlmap:workspace<${wsId}>`);\r\n    const ws = wsRaw ? JSON.parse(wsRaw) : { id: wsId, name: \"Workspace\", version: \"1.0\", layout: [] };\r\n\r\n    let managedLayers: ManagedLayer[] = [];\r\n    try {\r\n        const raw = localStorage.getItem(MANAGED_LAYERS_KEY);\r\n        if (raw) managedLayers = JSON.parse(raw);\r\n    } catch { /* ignore */ }\r\n\r\n    let videoSources: VideoSource[] = [];\r\n    try {\r\n        const raw = localStorage.getItem(VIDEO_SOURCES_KEY);\r\n        if (raw) videoSources = JSON.parse(raw);\r\n    } catch { /* ignore */ }\r\n    // Only export URL-based sources (blob URLs don't persist)\r\n    videoSources = videoSources.filter(s => s.type === \"url\");\r\n\r\n    let playlists: Playlist[] = [];\r\n    try {\r\n        const raw = localStorage.getItem(PLAYLISTS_KEY);\r\n        if (raw) playlists = JSON.parse(raw);\r\n    } catch { /* ignore */ }\r\n\r\n    const activePlaylistId = localStorage.getItem(ACTIVE_PLAYLIST_KEY);\r\n\r\n    return {\r\n        version: VERSION,\r\n        name: workspaceName || ws.name || \"Workflow\",\r\n        timestamp: Date.now(),\r\n        workspace: {\r\n            id: ws.id,\r\n            name: ws.name,\r\n            layout: ws.layout,\r\n        },\r\n        managedLayers,\r\n        videoSources,\r\n        playlists,\r\n        activePlaylistId,\r\n    };\r\n}\r\n\r\nexport function importWorkflow(data: WorkflowData): void {\r\n    // Generate a new workspace ID so it doesn't conflict with existing ones\r\n    const newWsId = Date.now().toString();\r\n\r\n    const workspace = {\r\n        id: newWsId,\r\n        name: data.name || data.workspace.name || \"Imported\",\r\n        version: \"1.0\",\r\n        layout: data.workspace.layout || [],\r\n    };\r\n    localStorage.setItem(`mlmap:workspace<${newWsId}>`, JSON.stringify(workspace));\r\n    localStorage.setItem(CURRENT_WS_KEY, newWsId);\r\n\r\n    // Import managed layers (shapes only - video layers need their sources)\r\n    if (data.managedLayers) {\r\n        localStorage.setItem(MANAGED_LAYERS_KEY, JSON.stringify(data.managedLayers));\r\n    }\r\n\r\n    // Import video sources (merge with existing, skip duplicates by URL)\r\n    if (data.videoSources && data.videoSources.length > 0) {\r\n        let existing: VideoSource[] = [];\r\n        try {\r\n            const raw = localStorage.getItem(VIDEO_SOURCES_KEY);\r\n            if (raw) existing = JSON.parse(raw);\r\n        } catch { /* ignore */ }\r\n\r\n        const existingUrls = new Set(existing.map(s => s.url));\r\n        for (const src of data.videoSources) {\r\n            if (!existingUrls.has(src.url)) {\r\n                existing.push(src);\r\n                existingUrls.add(src.url);\r\n            }\r\n        }\r\n        localStorage.setItem(VIDEO_SOURCES_KEY, JSON.stringify(existing));\r\n    }\r\n\r\n    // Import playlists\r\n    if (data.playlists && data.playlists.length > 0) {\r\n        localStorage.setItem(PLAYLISTS_KEY, JSON.stringify(data.playlists));\r\n    }\r\n    if (data.activePlaylistId) {\r\n        localStorage.setItem(ACTIVE_PLAYLIST_KEY, data.activePlaylistId);\r\n    }\r\n}\r\n\r\nexport function workflowToBase64(data: WorkflowData): string {\r\n    const json = JSON.stringify(data);\r\n    // Use TextEncoder to handle unicode properly\r\n    const bytes = new TextEncoder().encode(json);\r\n    let binary = \"\";\r\n    for (let i = 0; i < bytes.length; i++) {\r\n        binary += String.fromCharCode(bytes[i]);\r\n    }\r\n    // Standard base64, then make URL-safe\r\n    return btoa(binary).replace(/\\+/g, \"-\").replace(/\\//g, \"_\").replace(/=+$/, \"\");\r\n}\r\n\r\nexport function base64ToWorkflow(encoded: string): WorkflowData | null {\r\n    try {\r\n        // Restore standard base64\r\n        let b64 = encoded.replace(/-/g, \"+\").replace(/_/g, \"/\");\r\n        // Add padding\r\n        while (b64.length % 4) b64 += \"=\";\r\n        const binary = atob(b64);\r\n        const bytes = new Uint8Array(binary.length);\r\n        for (let i = 0; i < binary.length; i++) {\r\n            bytes[i] = binary.charCodeAt(i);\r\n        }\r\n        const json = new TextDecoder().decode(bytes);\r\n        const data = JSON.parse(json);\r\n        // Basic validation\r\n        if (!data.workspace || !data.version) return null;\r\n        return data as WorkflowData;\r\n    } catch {\r\n        return null;\r\n    }\r\n}\r\n\r\nexport function generateShareUrl(data: WorkflowData): string {\r\n    const encoded = workflowToBase64(data);\r\n    const base = window.location.origin + window.location.pathname;\r\n    return `${base}?workflow=${encoded}`;\r\n}\r\n\r\nexport function checkUrlForWorkflow(): boolean {\r\n    const params = new URLSearchParams(window.location.search);\r\n    const encoded = params.get(\"workflow\");\r\n    if (!encoded) return false;\r\n\r\n    const data = base64ToWorkflow(encoded);\r\n    if (!data) {\r\n        console.warn(\"MLMap: Invalid workflow data in URL\");\r\n        return false;\r\n    }\r\n\r\n    importWorkflow(data);\r\n\r\n    // Clean the URL parameter without reloading\r\n    const cleanUrl = window.location.origin + window.location.pathname;\r\n    window.history.replaceState({}, document.title, cleanUrl);\r\n\r\n    return true;\r\n}\r\n\r\nexport function downloadWorkflow(data: WorkflowData): void {\r\n    const json = JSON.stringify(data, null, 2);\r\n    const blob = new Blob([json], { type: \"application/json\" });\r\n    const url = URL.createObjectURL(blob);\r\n    const a = document.createElement(\"a\");\r\n    a.href = url;\r\n    a.download = `${data.name.replace(/[^a-zA-Z0-9_-]/g, \"_\")}.mlmap`;\r\n    document.body.appendChild(a);\r\n    a.click();\r\n    document.body.removeChild(a);\r\n    URL.revokeObjectURL(url);\r\n}\r\n\r\nexport function uploadWorkflow(): Promise<WorkflowData | null> {\r\n    return new Promise((resolve) => {\r\n        const input = document.createElement(\"input\");\r\n        input.type = \"file\";\r\n        input.accept = \".mlmap,.json\";\r\n        input.addEventListener(\"change\", () => {\r\n            const file = input.files?.[0];\r\n            if (!file) { resolve(null); return; }\r\n            const reader = new FileReader();\r\n            reader.onload = () => {\r\n                try {\r\n                    const data = JSON.parse(reader.result as string);\r\n                    if (!data.workspace || !data.version) {\r\n                        alert(\"Invalid workflow file.\");\r\n                        resolve(null);\r\n                        return;\r\n                    }\r\n                    resolve(data as WorkflowData);\r\n                } catch {\r\n                    alert(\"Failed to parse workflow file.\");\r\n                    resolve(null);\r\n                }\r\n            };\r\n            reader.readAsText(file);\r\n        });\r\n        input.click();\r\n    });\r\n}\r\n", "export interface ClipGroup {\r\n    video: HTMLVideoElement;\r\n    baseTargetPoints: number[][];\r\n    masks: Array<{ targetPoints: number[][] }>;\r\n}\r\n\r\nexport class ClipMaskRenderer {\r\n    private canvas: HTMLCanvasElement;\r\n    private ctx: CanvasRenderingContext2D;\r\n    private running = false;\r\n    private rafId = 0;\r\n    private getClipGroups: () => ClipGroup[];\r\n    public zoom = 1;\r\n\r\n    constructor(getClipGroups: () => ClipGroup[]) {\r\n        this.getClipGroups = getClipGroups;\r\n\r\n        this.canvas = document.createElement(\"canvas\");\r\n        this.canvas.style.position = \"fixed\";\r\n        this.canvas.style.top = \"0\";\r\n        this.canvas.style.left = \"0\";\r\n        this.canvas.style.zIndex = \"999999\";\r\n        this.canvas.style.pointerEvents = \"none\";\r\n\r\n        this.ctx = this.canvas.getContext(\"2d\")!;\r\n\r\n        window.addEventListener(\"resize\", () => this.resize());\r\n        this.resize();\r\n    }\r\n\r\n    get canvasElement(): HTMLCanvasElement { return this.canvas; }\r\n\r\n    resize(): void {\r\n        this.canvas.width = window.innerWidth;\r\n        this.canvas.height = window.innerHeight;\r\n    }\r\n\r\n    start(): void {\r\n        if (this.running) return;\r\n        this.running = true;\r\n        this.render();\r\n    }\r\n\r\n    stop(): void {\r\n        this.running = false;\r\n        if (this.rafId) cancelAnimationFrame(this.rafId);\r\n        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);\r\n    }\r\n\r\n    private render(): void {\r\n        if (!this.running) return;\r\n\r\n        const w = this.canvas.width;\r\n        const h = this.canvas.height;\r\n        this.ctx.clearRect(0, 0, w, h);\r\n\r\n        const groups = this.getClipGroups();\r\n\r\n        // Apply workspace zoom (same transform as MLMap canvas)\r\n        if (this.zoom !== 1) {\r\n            this.ctx.save();\r\n            const cx = w / 2;\r\n            const cy = h / 2;\r\n            this.ctx.translate(cx, cy);\r\n            this.ctx.scale(this.zoom, this.zoom);\r\n            this.ctx.translate(-cx, -cy);\r\n        }\r\n\r\n        for (const group of groups) {\r\n            const video = group.video;\r\n            if (video.readyState < 2) continue;\r\n\r\n            // Compute bounding box of the base layer's target points\r\n            const basePts = group.baseTargetPoints;\r\n            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;\r\n            for (const p of basePts) {\r\n                if (p[0] < minX) minX = p[0];\r\n                if (p[1] < minY) minY = p[1];\r\n                if (p[0] > maxX) maxX = p[0];\r\n                if (p[1] > maxY) maxY = p[1];\r\n            }\r\n            const bw = maxX - minX;\r\n            const bh = maxY - minY;\r\n            if (bw <= 0 || bh <= 0) continue;\r\n\r\n            for (const mask of group.masks) {\r\n                const pts = mask.targetPoints;\r\n                if (!pts || pts.length < 3) continue;\r\n\r\n                this.ctx.save();\r\n                this.ctx.beginPath();\r\n                this.ctx.moveTo(pts[0][0], pts[0][1]);\r\n                for (let i = 1; i < pts.length; i++) {\r\n                    this.ctx.lineTo(pts[i][0], pts[i][1]);\r\n                }\r\n                this.ctx.closePath();\r\n                this.ctx.clip();\r\n\r\n                // Draw the video mapped to the base layer's bounding box\r\n                this.ctx.drawImage(video, minX, minY, bw, bh);\r\n                this.ctx.restore();\r\n            }\r\n        }\r\n\r\n        if (this.zoom !== 1) {\r\n            this.ctx.restore();\r\n        }\r\n\r\n        this.rafId = requestAnimationFrame(() => this.render());\r\n    }\r\n}\r\n"],
  "mappings": "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",
  "names": ["STORAGE_KEY", "baseMLMap", "MANAGED_LAYERS_KEY", "ml", "screen"]
}
