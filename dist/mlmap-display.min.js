"use strict";(()=>{var E=(c,e)=>()=>(c&&(e=c(c=0)),e);var Y=(c,e)=>()=>(e||c((e={exports:{}}).exports,e),e.exports);function A(c,e){return{type:c,payload:e,timestamp:Date.now()}}var P,V,R,S,C=E(()=>{"use strict";P="mlmap-sync",V=2e3,R=500,S=6e3});var T,N=E(()=>{"use strict";C();T=class{constructor(e){this.listeners=new Map;this.heartbeatTimer=null;this.lastPong=0;this._connected=!1;this.onConnectionChange=null;this.role=e,this.channel=new BroadcastChannel(P),this.channel.onmessage=t=>this.handleMessage(t.data),e==="control"&&this.startHeartbeat(),e==="display"&&(this.on("PING",()=>this.send("PONG")),setTimeout(()=>this.send("DISPLAY_READY"),100))}get connected(){return this._connected}set onConnectionChanged(e){this.onConnectionChange=e}send(e,t){try{this.channel.postMessage(A(e,t))}catch(i){console.warn("ChannelBridge: Failed to send message",e,i)}}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){let i=this.listeners.get(e);if(i){let a=i.indexOf(t);a>=0&&i.splice(a,1)}}destroy(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.channel.close(),this.listeners.clear()}handleMessage(e){(e.type==="PONG"||e.type==="DISPLAY_READY")&&(this.lastPong=Date.now(),this.setConnected(!0));let t=this.listeners.get(e.type);t&&t.forEach(i=>i(e.payload))}startHeartbeat(){this.heartbeatTimer=window.setInterval(()=>{this.send("PING"),this._connected&&Date.now()-this.lastPong>S&&this.setConnected(!1)},V)}setConnected(e){this._connected!==e&&(this._connected=e,this.onConnectionChange&&this.onConnectionChange(e))}}});var k,_=E(()=>{"use strict";k=(()=>{function c(s,l,n,o){if(n===l.length-1)return o(s);let r,d=l[n],y=Array(d);for(r=d-1;r>=0;--r)y[r]=c(s[r],l,n+1,o);return y}function e(s){let l=[];for(;typeof s=="object";)l.push(s.length),s=s[0];return l}function t(s){let l,n;return typeof s=="object"?(l=s[0],typeof l=="object"?(n=l[0],typeof n=="object"?e(s):[s.length,l.length]):[s.length]):[]}function i(s){let l,n=s.length,o=Array(n);for(l=n-1;l>=0;--l)o[l]=s[l];return o}function a(s){return typeof s!="object"?s:c(s,t(s),0,i)}function f(s,l){l=l||!1;let n,o,r,d,y,u,g,h,v,b=s.length,I=b-1,w=new Array(b);for(l||(s=a(s)),r=0;r<b;++r){for(g=r,u=s[r],v=p(u[r]),o=r+1;o<b;++o)d=p(s[o][r]),d>v&&(v=d,g=o);for(w[r]=g,g!=r&&(s[r]=s[g],s[g]=u,u=s[r]),y=u[r],n=r+1;n<b;++n)s[n][r]/=y;for(n=r+1;n<b;++n){for(h=s[n],o=r+1;o<I;++o)h[o]-=h[r]*u[o],++o,h[o]-=h[r]*u[o];o===I&&(h[o]-=h[r]*u[o])}}return{LU:s,P:w}}function m(s,l){let n,o,r,d,y,u=s.LU,g=u.length,h=a(l),v=s.P;for(n=g-1;n>=0;--n)h[n]=l[n];for(n=0;n<g;++n)for(r=v[n],v[n]!==n&&(y=h[n],h[n]=h[r],h[r]=y),d=u[n],o=0;o<n;++o)h[n]-=h[o]*d[o];for(n=g-1;n>=0;--n){for(d=u[n],o=n+1;o<g;++o)h[n]-=h[o]*d[o];h[n]/=d[n]}return h}let p=Math.abs;return function(s,l,n){return m(f(s,n),l)}})()});function z(c,e){let t=[],i=[];for(let f=0;f<c.length;f++){let m=c[f],p=e[f];t.push([m[0],m[1],1,0,0,0,-m[0]*p[0],-m[1]*p[0]]),i.push(p[0]),t.push([0,0,0,m[0],m[1],1,-m[0]*p[1],-m[1]*p[1]]),i.push(p[1])}let a=k(t,i,!0);return`matrix3d(${a[0]},${a[3]},0,${a[6]},${a[1]},${a[4]},0,${a[7]},0,0,1,0,${a[2]},${a[5]},0,1)`}function L(c,e,t){c.style.transform=z(e,t),c.style.transformOrigin="0px 0px 0px"}var D=E(()=>{"use strict";_()});var x,H=E(()=>{"use strict";x=class{constructor(e){this.running=!1;this.rafId=0;this.zoom=1;this.getClipGroups=e,this.canvas=document.createElement("canvas"),this.canvas.style.position="fixed",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.zIndex="999999",this.canvas.style.pointerEvents="none",this.ctx=this.canvas.getContext("2d"),window.addEventListener("resize",()=>this.resize()),this.resize()}get canvasElement(){return this.canvas}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight}start(){this.running||(this.running=!0,this.render())}stop(){this.running=!1,this.rafId&&cancelAnimationFrame(this.rafId),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}render(){if(!this.running)return;let e=this.canvas.width,t=this.canvas.height;this.ctx.clearRect(0,0,e,t);let i=this.getClipGroups();if(this.zoom!==1){this.ctx.save();let a=e/2,f=t/2;this.ctx.translate(a,f),this.ctx.scale(this.zoom,this.zoom),this.ctx.translate(-a,-f)}for(let a of i){let f=a.video;if(f.readyState<2)continue;let m=a.baseTargetPoints,p=1/0,s=1/0,l=-1/0,n=-1/0;for(let d of m)d[0]<p&&(p=d[0]),d[1]<s&&(s=d[1]),d[0]>l&&(l=d[0]),d[1]>n&&(n=d[1]);let o=l-p,r=n-s;if(!(o<=0||r<=0))for(let d of a.masks){let y=d.targetPoints;if(!(!y||y.length<3)){this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(y[0][0],y[0][1]);for(let u=1;u<y.length;u++)this.ctx.lineTo(y[u][0],y[u][1]);this.ctx.closePath(),this.ctx.clip(),this.ctx.drawImage(f,p,s,o,r),this.ctx.restore()}}}this.zoom!==1&&this.ctx.restore(),this.rafId=requestAnimationFrame(()=>this.render())}}});var M,U=E(()=>{"use strict";N();D();C();H();M=class{constructor(){this.layers=new Map;this.layerInfos=new Map;this.videoElements=new Map;this.activeVideo=null;this.playlist=[];this.playlistIndex=0;this.playlistLoop=!0;this.currentName=null;this.layoutData=[];this.bridge=new T("display"),this.clipMaskRenderer=new x(()=>this.getClipGroups()),document.body.appendChild(this.clipMaskRenderer.canvasElement),this.bindCommands(),this.syncTimer=window.setInterval(()=>{this.bridge.send("SYNC_RESPONSE",this.getState())},R)}getClipGroups(){let e=[],t=new Map;for(let[i,a]of this.layerInfos){if(!a.clipTo)continue;let f=this.videoElements.get(a.clipTo);if(!f)continue;let m=this.layoutData.find(s=>s.id===a.clipTo),p=this.layoutData.find(s=>s.id===i);!m?.targetPoints||!p?.targetPoints||(t.has(a.clipTo)||t.set(a.clipTo,{video:f,baseTargetPoints:m.targetPoints,masks:[]}),t.get(a.clipTo).masks.push({targetPoints:p.targetPoints}))}for(let i of t.values())e.push(i);return e}updateClipMaskState(){let e=new Set;for(let[t,i]of this.layerInfos){if(!i.clipTo)continue;let a=this.layers.get(t);a&&(a.style.opacity="0"),e.add(i.clipTo)}for(let t of e){let i=this.layers.get(t);i&&(i.style.opacity="0");let a=this.videoElements.get(t);a&&a.paused&&a.src&&a.src!==window.location.href&&a.play().catch(()=>{})}e.size>0?this.clipMaskRenderer.start():this.clipMaskRenderer.stop()}getState(){let e=this.activeVideo;return{playing:e?!e.paused:!1,currentTime:e?.currentTime||0,duration:e?.duration||0,volume:e?.volume||1,muted:e?.muted??!0,currentName:this.currentName,playlistIndex:this.playlistIndex,isFullscreen:!!document.fullscreenElement}}bindCommands(){this.bridge.on("ADD_LAYER",e=>{if(this.layers.has(e.id)){this.layerInfos.set(e.id,e),this.updateClipMaskState();return}this.layerInfos.set(e.id,e);let t=this.createLayerElement(e);document.body.appendChild(t),this.layers.set(e.id,t),this.updateClipMaskState()}),this.bridge.on("REMOVE_LAYER",e=>{let t=this.layers.get(e.id);t&&(t.remove(),this.layers.delete(e.id),this.layerInfos.delete(e.id),this.videoElements.delete(e.id)),this.updateClipMaskState()}),this.bridge.on("UPDATE_LAYOUT",e=>{if(e.layout){this.layoutData=e.layout;for(let t of e.layout){let i=this.layers.get(t.id),a=this.layerInfos.get(t.id);a&&a.clipTo||i&&t.sourcePoints&&t.targetPoints&&L(i,t.sourcePoints,t.targetPoints)}this.updateClipMaskState()}}),this.bridge.on("LOAD_PLAYLIST",e=>{this.playlist=e.items||[],this.playlistLoop=e.loop??!0,this.playlistIndex=e.startIndex||0}),this.bridge.on("LOAD_VIDEO",e=>{e.url&&this.activeVideo&&(this.currentName=e.name||null,this.activeVideo.src=e.url,this.activeVideo.load())}),this.bridge.on("PLAY",()=>{this.activeVideo&&((!this.activeVideo.src||this.activeVideo.src===window.location.href)&&this.playlist.length>0&&this.loadCurrentItem(),this.activeVideo.play().catch(()=>{}))}),this.bridge.on("PAUSE",()=>{this.activeVideo&&this.activeVideo.pause()}),this.bridge.on("STOP",()=>{this.activeVideo&&(this.activeVideo.pause(),this.activeVideo.currentTime=0)}),this.bridge.on("SEEK",e=>{typeof e.time=="number"&&this.activeVideo&&(this.activeVideo.currentTime=e.time)}),this.bridge.on("NEXT",()=>this.next()),this.bridge.on("PREVIOUS",()=>this.previous()),this.bridge.on("SET_VOLUME",e=>{let t=Math.max(0,Math.min(1,e.volume));this.activeVideo&&(this.activeVideo.volume=t)}),this.bridge.on("SET_MUTED",e=>{typeof e.muted=="boolean"&&this.activeVideo&&(this.activeVideo.muted=e.muted)}),this.bridge.on("FULLSCREEN_ENTER",()=>{document.documentElement.requestFullscreen().catch(()=>{})}),this.bridge.on("FULLSCREEN_EXIT",()=>{document.fullscreenElement&&document.exitFullscreen().catch(()=>{})}),this.bridge.on("SEND_VIDEO_DATA",e=>{let t=this.videoElements.get(e.layerId);if(!t)return;let i=new Blob([e.data],{type:e.mimeType||"video/mp4"}),a=URL.createObjectURL(i);t.src=a,t.load(),this.updateClipMaskState()}),this.bridge.on("INIT_STATE",e=>{if(e.layers){for(let t of e.layers)if(!this.layers.has(t.id)){this.layerInfos.set(t.id,t);let i=this.createLayerElement(t);document.body.appendChild(i),this.layers.set(t.id,i)}}if(e.layout){this.layoutData=e.layout;for(let t of e.layout){let i=this.layers.get(t.id),a=this.layerInfos.get(t.id);a&&a.clipTo||i&&t.sourcePoints&&t.targetPoints&&L(i,t.sourcePoints,t.targetPoints)}}e.playlist&&(this.playlist=e.playlist.items||[],this.playlistLoop=e.playlist.loop??!0,this.playlistIndex=e.playlist.startIndex||0),this.updateClipMaskState()})}createLayerElement(e){let t=document.createElement("div");if(t.id=e.id,t.style.position="fixed",t.style.top="0px",t.style.left="0px",t.style.width=e.width+"px",t.style.height=e.height+"px",t.style.overflow="hidden",e.type==="video"){t.style.background="#000";let i=document.createElement("video");e.videoUrl&&(i.src=e.videoUrl),i.style.width="100%",i.style.height="100%",i.style.objectFit="contain",i.muted=!0,i.playsInline=!0,i.addEventListener("ended",()=>this.onVideoEnded()),t.appendChild(i),this.videoElements.set(e.id,i),this.activeVideo=i}else if(e.type==="iframe"&&e.iframeUrl){t.style.background="#000";let i=document.createElement("iframe");i.src=e.iframeUrl,i.style.width="100%",i.style.height="100%",i.style.border="none",i.style.pointerEvents="none",i.setAttribute("allow","autoplay; encrypted-media"),t.appendChild(i)}else e.type==="shape"&&(e.shapeType==="circle"?(t.style.background="white",t.style.borderRadius="50%"):e.shapeType==="triangle"?(t.style.width="0",t.style.height="0",t.style.borderLeft=e.width/2+"px solid transparent",t.style.borderRight=e.width/2+"px solid transparent",t.style.borderBottom=e.height+"px solid white",t.style.background="transparent"):t.style.background="white");return t}loadCurrentItem(){if(!this.activeVideo||this.playlist.length===0)return;let e=this.playlist[this.playlistIndex];e&&(this.currentName=e.name,this.activeVideo.src=e.url,this.activeVideo.load())}next(){this.playlist.length!==0&&(this.playlistIndex++,!(this.playlistIndex>=this.playlist.length&&(this.playlistIndex=this.playlistLoop?0:this.playlist.length-1,!this.playlistLoop))&&(this.loadCurrentItem(),this.activeVideo&&this.activeVideo.play().catch(()=>{})))}previous(){this.playlist.length!==0&&(this.playlistIndex--,!(this.playlistIndex<0&&(this.playlistIndex=this.playlistLoop?this.playlist.length-1:0,!this.playlistLoop))&&(this.loadCurrentItem(),this.activeVideo&&this.activeVideo.play().catch(()=>{})))}onVideoEnded(){this.playlist.length>0&&this.next()}}});var B=Y(()=>{U();function G(){let c=document.getElementById("activate-overlay");c&&(c.addEventListener("click",()=>{c.classList.add("hidden"),document.documentElement.requestFullscreen().catch(()=>{console.log("MLMap Display: Fullscreen not available, continuing without it.")})}),document.addEventListener("fullscreenchange",()=>{!document.fullscreenElement&&c.classList.contains("hidden")&&(c.querySelector("span").textContent="Click to re-enter fullscreen",c.classList.remove("hidden"))}));try{new M,console.log("MLMap Display: Renderer initialized.")}catch(e){console.error("MLMap Display: Failed to initialize renderer.",e)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",G):G()});B();})();
